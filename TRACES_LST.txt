$%3
$m140000
$P>
$F>
$N-
$S&
$S>
'            TRACES anim5,medres,imatbase en inv grab gerep
'         de afbreek=0 is in de anim naar het begin, geeft problemen? hoop niet
'         de roteerscene doet frame 1 bij poly herbereken45!!!
'         TRACETYPE:    env in object is skybuf uitlezen
'         TRACETYPE: 1: normalen herberekend bij render
'
version$="1.166"
'    -in fileselect maakt ~lock 40 bytes zoek, ook copperlijsten doen!
init
main
FUNCTION init
  > PROCEDURE init
    initanim
    initstructvars
    ON ERROR GOSUB sluit
    ON BREAK GOSUB sluit
    a$="iff.library"+CHR$(0)
    iiffbase%=OpenLibrary(V:a$,15)
    IF iiffbase%=0
      PRINT "Kan ifflib niet openen"
      END
    ENDIF
    RBOX 0
    DIM si_reg%(15),reg%(15),plotreg%(15),li_reg%(15)
    DIM ocfac(2),ocmin&(2),ocmax&(2),oc!(3400)
    DIM col&(15,2),pcol%(1),ppcol%(1),c&(2),er&(736*3),quad&(31),r|(511),g|(511),b|(511),dit&(15)
    DIM asinhor&(0),asinver&(0)
    DIM blove%(128),blovl%(128),m28&(255),m34&(255)
    DIM gr&(2,1),gr(2),rt%(80,3),poly%(1),spoly%(1)
    DIM sn(3),sn&(3),sn%(3),snp1%(50),snp2%(50),u(50),v(50),p&(50)
    DIM persmat(2,2),persinv(2,2),mat(2,2),tmat(2,2),t2mat(2,2),q(5,3),imat(2,2),persmat2(2,2)
    DIM bmat(2,2),cmat(2,2),omat(2,2)
    DIM min%(2),max%(2),min&(2),max&(2),obs%(2),tar%(2)
    DIM x(2),y(2),z(2)
    DIM t%(2),u%(2),p%(10,3),p1%(8,2),labda(8,2),labda1(8,2)
    DIM muis%(2),raw|(90),ps&(32),sovl%(1),sovt%(1)
    DIM texmin&(12),texmax&(12),texdef&(12),textu$(40),adrtex%(50),tex$(15)
    DIM temp%(2,10),sym$(16)
    '
    INLINE symbols%,1200
    INLINE machplot%,200
    INLINE machpoint%,200
    INLINE adraco%,1040
    '
    INLINE calcsnijps%,1150
    ' inl_load(calcsnijps%,1150)
    ADD calcsnijps%,32
    sndata%={calcsnijps%}+calcsnijps%
    ADD calcsnijps%,4
    matmul%={calcsnijps%}+calcsnijps%
    ADD calcsnijps%,4
    '
    INLINE hash%,1820
    INLINE nnoise%,600
    ' inl_load(nnoise%,600)
    ADD nnoise%,32
    INLINE bezier%,200
    '  inl_load(bezier%,200)
    ADD bezier%,32
    '
    INLINE pointbr%,350
    ' inl_load(pointbr%,350)
    ADD pointbr%,32
    '
    INLINE lib1%,950
    ' inl_load(lib1%,950)           ! Colorcalc, OcRead en Noise
    ADD lib1%,32
    LET colorcalc%={lib1%}+lib1%
    ADD lib1%,4
    colcdata%={lib1%}+lib1%
    ADD lib1%,4
    {colcdata%+0}=V:r|(0)
    {colcdata%+4}=V:g|(0)
    {colcdata%+8}=V:b|(0)
    {colcdata%+20}=V:dit&(0)
    {colcdata%+32}=V:er&(0)
    ocread%={lib1%}+lib1%
    ADD lib1%,4
    ocrdata%={lib1%}+lib1%
    ADD lib1%,4
    noise%={lib1%}+lib1%
    '
    INLINE stack%,50
    ' inl_load(stack%,50)
    ADD stack%,32
    '
    INLINE lib2%,600
    ' inl_load(lib2%,600)           ! LtoW 1/2/3 en NormalWrd
    ADD lib2%,32
    ltow%={lib2%}+lib2%
    ADD lib2%,4
    ltow1%={lib2%}+lib2%
    ADD lib2%,4
    ltow2%={lib2%}+lib2%
    ADD lib2%,4
    normalwrd%={lib2%}+lib2%
    '
    INLINE lib3%,1400
    ' inl_load(lib3%,1400)           ! laad & schrijfiff mplot/mpoint
    ADD lib3%,32
    laadiff%={lib3%}+lib3%
    ADD lib3%,4
    schrijfiff%={lib3%}+lib3%
    ADD lib3%,4
    bmplot%={lib3%}+lib3%
    ADD lib3%,4
    mplot%={lib3%}+lib3%
    ADD lib3%,4
    mpoint%={lib3%}+lib3%
    ADD lib3%,4
    schrijfpart%={lib3%}+lib3%
    '
    INLINE lib4%,200
    ' inl_load(lib4%,200)           ! LIfMul, ASR & Pow2
    ADD lib4%,32
    lifmul%={lib4%}+lib4%
    ADD lib4%,4
    shr%={lib4%}+lib4%
    ADD lib4%,4
    pow2%={lib4%}+lib4%
    '
    INLINE lib5%,12500
    '                               Plotham, Makecoltab
    ' inl_load(lib5%,12500)
    ADD lib5%,32
    maketab%={lib5%}+lib5%
    ADD lib5%,4
    ctabel%={lib5%}+lib5%
    ADD lib5%,4
    bmham%={lib5%}+lib5%
    ADD lib5%,4
    clrbuf%={lib5%}+lib5%
    ADD lib5%,4
    fillbuf24%={lib5%}+lib5%
    ADD lib5%,4
    LET colorcalc2%={lib5%}+lib5%
    ADD lib5%,4
    LET colcdata%={lib5%}+lib5%
    ADD lib5%,4
    LET compile%={lib5%}+lib5%
    ADD lib5%,4
    LET displine%={lib5%}+lib5%
    {colcdata%+0}=V:r|(0)
    {colcdata%+4}=V:g|(0)
    {colcdata%+8}=V:b|(0)
    {colcdata%+20}=V:dit&(0)
    {colcdata%+32}=V:er&(0)
    '
    INLINE lib6%,2500
    ' inl_load(lib6%,2500)           ! MoveTo2D
    ADD lib6%,32
    m2dcomp%={lib6%}+lib6%
    ADD lib6%,4
    mto2d%={lib6%}+lib6%
    ADD lib6%,4
    m2data%={lib6%}+lib6%
    ADD lib6%,4
    c_clp%={lib6%}+lib6%
    '
    INLINE m2q%,1200
    ' inl_load(m2q%,1200)           ! MoveTo2D
    ADD m2q%,32
    mto2dq%={m2q%}+m2q%
    ADD m2q%,4
    m3data%={m2q%}+m2q%
    ADD m2q%,4
    c_clp2%={m2q%}+m2q%
    '
    INLINE zlib%,1100
    ' inl_load(zlib%,1100)
    ADD zlib%,32
    initzbuf%={zlib%}+zlib%
    ADD zlib%,4
    initpoly%={zlib%}+zlib%
    ADD zlib%,4
    initzread%={zlib%}+zlib%
    ADD zlib%,4
    fillz%={zlib%}+zlib%
    ADD zlib%,4
    readz%={zlib%}+zlib%
    ADD zlib%,4
    pixelbuf%={zlib%}+zlib%
    ADD zlib%,4
    '
    INLINE spec%,100
    ' inl_load(spec%,100)
    ADD spec%,32
    '
    wf0%=&H8080800
    wf1%=&H0
    wf2%=&HC0C0A00
    wf3%=&HF080F00
    wf4%=&H6060800
    wf5%=&HC090F00
    wfs%=&HF000000
    '
    OPENS 2,0,0,320,56,6,2048
    OPENW #2,0,0,320,56,&HC0508,&H10000+2048,2
    TITLEW #2,""
    CLEARW #2
    BYTE{WINDOW(2)+55}=0
    invisible(2)
    pointer%={*pcol%()}+4
    RESTORE pal1
    FOR a&=0 TO 15
      READ b&
      FOR c&=0 TO 2
        READ b&
        col&(a&,c&)=b&
      NEXT c&
      SETCOLOR a&,col&(a&,0),col&(a&,1),col&(a&,2)
    NEXT a&
    SETCOLOR 0,BYTE{V:wf0%},BYTE{V:wf0%+1},BYTE{V:wf0%+2}
    pal1:
    DATA 0,0,0,0
    DATA 1,13,13,12
    DATA 2,4,1,11
    DATA 3,7,8,11
    DATA 4,8,11,1
    DATA 5,5,11,7
    DATA 6,3,5,0
    DATA 7,4,7,4
    DATA 8,13,3,5
    DATA 9,12,9,1
    DATA 10,7,0,7
    DATA 11,8,3,10
    DATA 12,7,5,6
    DATA 13,10,10,10
    DATA 14,4,1,0
    DATA 15,14,4,11
    '
    ldfont("univers",11,testfont%)
    OPENS 1,0,0,640,512,3,32772
    TITLES #1," "
    rp%=SCREEN(1)+84
    IF SCREEN(1)<>0 AND testfont%<>0
      ~SetFont(rp%,testfont%)
      ~SetSoftStyle(rp%,0,AskSoftStyle(rp%))
    ENDIF
    bitnep1%=@allocblock(50,&H10001)
    bitnep2%=@allocblock(50,&H10001)
    BMOVE SCREEN(1)+184,bitnep1%,50
    BYTE{bitnep1%+5}=1
    BMOVE bitnep1%,bitnep2%,50
    {bitnep2%+8}={bitnep2%+12}
    '
    OPENW #1,0,0,640,56,1
    PLOT 0,0
    CLEARW #1
    laadinl(symbols%,1)
    GET 1,5,15,12,sym$(0)
    GET 20,5,34,12,sym$(1)
    GET 45,4,49,8,sym$(2)
    GET 64,4,68,8,sym$(3)
    GET 77,0,93,17,sym$(4)
    GET 96,0,112,17,sym$(5)
    GET 115,0,131,17,sym$(6)
    GET 134,0,150,17,sym$(7)
    GET 153,0,169,11,sym$(8)
    GET 172,0,188,11,sym$(9)
    GET 195,5,201,9,sym$(10)
    GET 214,5,220,9,sym$(11)
    GET 223,0,243,17,sym$(12)
    GET 249,0,269,17,sym$(13)
    GET 274,0,294,17,sym$(14)
    GET 296,4,305,12,sym$(15)
    GET 306,4,315,12,sym$(16)
    CLOSEW #1
    OPENW #1,0,0,640,492,&HC0518,71936+512,1
    BYTE{WINDOW(1)+55}=0
    CLEARW #1
    WORD{SCREEN(1)+20}=&H100 OR WORD{SCREEN(1)+20}
    setfont(1,testfont%)
    SETCOLOR 0,BYTE{V:wf0%},BYTE{V:wf0%+1},BYTE{V:wf0%+2}
    SETCOLOR 1,BYTE{V:wf1%},BYTE{V:wf1%+1},BYTE{V:wf1%+2}
    SETCOLOR 2,BYTE{V:wf2%},BYTE{V:wf2%+1},BYTE{V:wf2%+2}
    SETCOLOR 3,BYTE{V:wf3%},BYTE{V:wf3%+1},BYTE{V:wf3%+2}
    SETCOLOR 4,BYTE{V:wf5%},BYTE{V:wf5%+1},BYTE{V:wf5%+2}
    SETCOLOR 5,BYTE{V:wf5%},BYTE{V:wf5%+1},BYTE{V:wf5%+2}
    SETCOLOR 6,BYTE{V:wf5%},BYTE{V:wf5%+1},BYTE{V:wf5%+2}
    SETCOLOR 7,BYTE{V:wf5%},BYTE{V:wf5%+1},BYTE{V:wf5%+2}
    SETCOLOR 17,BYTE{V:wfs%},BYTE{V:wfs%+1},BYTE{V:wfs%+2}
    SETCOLOR 21,15,0,0
    '
    OPENS 12,0,0,640,512,1,32772
    TITLES #12," "
    OPENW #12,0,0,640,512,8,2048,12
    BYTE{WINDOW(12)+55}=0
    CLEARW #12
    invisible(12)
    bitm1%=SCREEN(1)+184
    BYTE{bitm1%+5}=2
    bitpl3%={bitm1%+16}
    bitm1%=SCREEN(12)+184
    bitpl12%={bitm1%+8}
    '
    '                               init sprite
    sprite$=MKL$(&H2000000)+MKL$(0)
    sprite$=STRING$(3,sprite$)
    sprite$=MKL$(0)+sprite$+MKL$(&HA8A80000)+MKL$(0)+sprite$
    spr.mem%=@allocblock(200,&H10003)
    BMOVE V:sprite$,spr.mem%+50,LEN(sprite$)
    spr%=GetSprite(spr.mem%,-1)
    IF spr%=0
      spr%=GetSprite(spr.mem%,-1)
    ENDIF
    vpspr%=SCREEN(1)+44
    ~ChangeSprite(vpspr%,spr.mem%,spr.mem%+50)
    WORD{spr.mem%+4}=13
    ~MoveSprite(vpspr%,spr.mem%,320-14,260-12)
    '
    ucoplist%=AllocMem(16,&H10001)
    PLOT 0,0
    CLS
    CLEARW #1
    OPENW #1
    FRONTS 1
    rastplot(2)
    ON ERROR GOSUB fout
    ON BREAK GOSUB sluit
    a$="nil:"+CHR$(0)
    nil%=Open(V:a$,1004)
    init2
  RETURN
  > PROCEDURE initanim
    '
    spline%=@allocblock(4000,&H10001)
    sspline%=@allocblock(4000,&H10001)
    quat%=@allocblock(4000,&H10001)
    '
    xmem%=@allocblock(200,&H10001)
    ymem%=@allocblock(200,&H10001)
    zmem%=@allocblock(200,&H10001)
    rmem%=@allocblock(200,&H10001)
    '
    INLINE trace.dec%,150
    ' inl_load(trace.dec%,150)
    ADD trace.dec%,32
    '
    INLINE anim5.dec%,750
    ' inl_load(anim5.dec%,750)
    ADD anim5.dec%,32
    '
    INLINE fra.int%,250
    ' inl_load(fra.int%,250)
    initint(fra.int%,150)
    {fra.int%+104}=V:picdelta&        ! Variabele
    '
    INLINE key.int%,400
    ' inl_load(key.int%,400)
    initint(key.int%,350)
    {key.int%+350}=0
    {key.int%+354}=V:aspeed&           ! Variabele
    {key.int%+358}=V:exit&            ! Variabele
    {key.int%+362}=V:ss&              ! Variabele
    {key.int%+366}=V:enter&           ! Variabele
    {key.int%+370}=V:loop&            ! Variabele
    {key.int%+374}=V:first&           ! Variabele
    snp&=2
    sdp&=2
  RETURN
  > PROCEDURE initstructvars
    '    Base pointers
    b.f&=6
    b.s&=8
    b.v&=12
    b.l&=24
    b.sf&=26
    b.d&=32
    b.o&=36
    b.q&=48
    b.m&=80
    b.n&=152
    b.p&=172
    b.t&=180
    b.ma&=184
    b.w&=196
    b.r&=204
    b.i&=228
    '     Object pointers
    o.f&=4
    o.p&=40
    o.c&=52
    o.dt&=53
    o.k&=54
    o.e&=62
    '   Kleurblok pointers
    c.t&=26
    c.l&=62
    '   Texture pointers
    t.c&=6
    t.d&=18
    t.o&=32
    t.n&=56
    t.if&=68
    t.ia&=112
    '   Vlak/vertex pointers
    v.1&=8
    v.2&=10
    v.3&=22
    v.4&=24
    '  Poly pointers
    p.f&=22
    p.d&=36
    '  Lampblok pointers
    l.t&=34
    '  Moveblok pointers
    m.qf&=36
    m.qfo&=50
    m.f&=54
    m.pd&=58
    m.fd&=62
    '  2D spline pointers
    s.2bs&=32              ! size off base
    s.2ds&=32              ! size off datablock
    s.2h&=4
  RETURN
  > PROCEDURE init2
    zbufy&=129
    exp&=128
    wmode&=4
    buttex&=1
    frs&=80
    app&=63
    point%=@allocblock(100,&H10001)
    {sndata%}=point%
    sndata%=point%
    ABSOLUTE uv1&,sndata%
    ABSOLUTE uv2&,sndata%+2
    ABSOLUTE cox%,sndata%+4
    ABSOLUTE coy%,sndata%+8
    ABSOLUTE coz%,sndata%+12
    ABSOLUTE xn&,sndata%+16
    ABSOLUTE yn&,sndata%+18
    ABSOLUTE zn&,sndata%+20
    ABSOLUTE tex&,sndata%+22
    ABSOLUTE tey&,sndata%+24
    ABSOLUTE tez&,sndata%+26
    ABSOLUTE orxn&,sndata%+28
    ABSOLUTE oryn&,sndata%+30
    ABSOLUTE orzn&,sndata%+32
    wrld%=@allocblock(100,&H10001)
    kleurw3%=@allocblock(30,&H10001)
    kleurw4%=@allocblock(30,&H10001)
    adrtex%(0)=@allocblock(152,&H10001)
    wtex%=@allocblock(152,&H10001)
    a%=adrtex%(0)
    WORD{a%+t.d&}=1
    WORD{a%+t.d&+2}=1
    WORD{a%+t.d&+4}=1
    BYTE{a%+3}=255
    BYTE{a%+4}=128
    BYTE{a%+5}=255
    kub%=@allocblock(36,&H10001)
    workbase%=@allocblock(256,&H10001)
    b%=workbase%
    BYTE{b%+b.f&}=12
    WORD{b%+b.l&}=&HFFFF
    WORD{b%+b.sf&}=1
    FLOAT{b%+b.q&}=1
    FLOAT{b%+b.m&}=1
    FLOAT{b%+b.m&+32}=1
    FLOAT{b%+b.m&+64}=1
    omat(0,0)=1
    omat(1,1)=1
    omat(2,2)=1
    FOR a&=1 TO 31
      b&=b&+a&
      quad&(a&)=b&/8+a&
    NEXT a&
    '
    FOR c&=1 TO 255
      m28&(c&)=28*c&
      m34&(c&)=34*c&
    NEXT c&
    pumanorm&=0
    totvert&=0
    totvlak&=0
    c&=0
    ma&=1
    sview&=1
    view&=46
    tratex&=-1
    hie&=-1
    buf24$="Dh1:24bitsTrace"
    picsdir$="Dh1:trace/pics/"
    skybuf$="Dh1:Sky.buf"
    script$="ram:script"
    tracetype&=0
    layact&=1
    resol&=5
    points&=BSET(0,resol&)
    cfra&=1
    sfra&=1
    efra&=80
    rawdata:
    DATA 240,49,50,51,52,53,54,55,56,57,48,&H2d,240,240,240,240
    DATA &H71,&H77,&H65,&H72,&H74,&H79,&H75,&H69,&H6f,&H70,240,240,240,240,240,240
    DATA &H61,&H73,&H64,&H66,&H67,&H68,&H6a,&H6b,&H6c,&H3a,240,240,240,240,240,240,240
    DATA &H7a,&H78,&H63,&H76,&H62,&H6e,&H6d,&H2c,&H2e,&H2f,240,240,240,240,240,240
    RESTORE rawdata
    FOR a&=0 TO 64
      READ raw|(a&)
    NEXT a&
    mist%=30000
    lay&=1
    tradep&=2
    schermfront(1,2)
    wmode&=1
    pleksh&=40
    bcsrgb=0
    {V:bcsrgb}=&H80808080
    {V:bcsrgb+4}=&H80808080
    ham&=-1
    grond&=0
    grid%=40000
    totex&=0
    actex&=0
    persp&=-1
    dproj=1
    dpar=1
    rad=PI/18
    size&=2
    dither&=-1
    BYTE{wrld%}=200   !horiz
    BYTE{wrld%+5}=200   !zenith
    BYTE{wrld%+6}=40   !ambient
    BYTE{wrld%+7}=30
    BYTE{wrld%+8}=30
    BYTE{wrld%+9}=130  !grond
    BYTE{wrld%+10}=20
    BYTE{wrld%+11}=35
    BYTE{wrld%+18}=3
    {wrld%+28}=&H2020202
    obs%(2)=30000
    obs%(1)=-100000
    lens&=28
    bepaalphitheta(1)
    theta=-0.5*PI
    phi=1.04
    setviewdata(1)
    firstview%=a%
    calcphitheta
    fastprojektie
    RESTORE strdata5a
    FOR a&=0 TO 14
      READ tex$(a&)
    NEXT a&
    RESTORE ditdata
    FOR a&=0 TO 3
      FOR b&=0 TO 3
        READ dit&(SHL(a&,2)+b&)
      NEXT b&
    NEXT a&
    ditdata:
    DATA 0,7,10,13
    DATA 11,14,1,4
    DATA 5,8,15,2
    DATA 12,3,6,9
    briconsat
    inithamplot2(2)
  RETURN
  > PROCEDURE bufcompressie
    '
    IF (spic&=-1)
      a$="copy "+buf24$+" "+back24$+RIGHT$("000"+STR$(pic),4)+CHR$(0)
    ELSE
      a$="compres24b "+picsdir$+RIGHT$("000"+STR$(ppic&),4)+" "+buf24$
      a$=a$+" "+back24$+RIGHT$("000"+STR$(pic),4)+".dlta"+CHR$(0)
    ENDIF
    ' ~Execute(V:a$,Input(),Output())
    IF nil%
      ~Execute(V:a$,nil%,Output())
    ENDIF
    '
    buf24$=picsdir$+RIGHT$("000"+STR$(ppic&),4)
    IF EXIST(buf24$)
      KILL buf24$
    ENDIF
    '
  RETURN
  > PROCEDURE anim
    afbreek&=0
    ont&=cfra&
    anim&=TRUE
    back24$=buf24$
    '
    fpic&=-1
    spic&=-1
    kpic&=-1
    ppic&=-1
    lpic&=-1
    '
    IF efra&>0
      FOR pic=sfra& TO efra&
        cfra&=pic
        IF script&
          doscript
        ENDIF
        IF bits24&
          buf24$=picsdir$+RIGHT$("000"+STR$(cfra&),4)
        ENDIF
        init.zbuf.shade
        EXIT IF afbreek& OR fout&
        '
        tijd%=(tijd%+100)/200
        h&=tijd%/3600
        SUB tijd%,h&*3600
        m&=tijd%/60
        SUB tijd%,m&*60
        tijd$=STR$(h&)+":"+RIGHT$("00"+STR$(m&),2)+":"+RIGHT$("00"+STR$(tijd%),2)+CHR$(0)
        OPENW #4
        COLOR 2,0
        TEXT 200,12,"Time: "+LEFT$(tijd$,LEN(tijd$)-1)+" "
        '
        IF bits24&
          IF diskc&
            IF fpic&=-1
              fpic&=cfra&
            ELSE IF spic&=-1
              spic&=cfra&
            ENDIF
            kpic&=ppic&
            ppic&=lpic&
            lpic&=cfra&
            bufcompressie
          ENDIF
        ELSE IF ODD(cfra&-sfra&) OR icomp&=0
          IF fpic&=-1
            fpic&=cfra&
          ELSE IF spic&=-1
            spic&=cfra&
          ENDIF
          kpic&=ppic&
          ppic&=lpic&
          lpic&=cfra&
          '
          pic$=picsdir$+RIGHT$("000"+STR$(pic),4)
          initfase("Saving image",0,0)
          schrijfiff(pic$,5)
          pic$=pic$+CHR$(0)
          ~SetComment(V:pic$,V:tijd$)
          IF diskc&
            diskcompressie
          ENDIF
        ENDIF
      NEXT pic
      d%=lens&*20
      IF persp&=-1 OR persp&=0
        d%=dproj*lens&*20
        rho%=3*dia/dproj
      ENDIF
    ENDIF
    IF diskc& AND (bits24&=0)
      makecyclic
    ENDIF
    '
    cfra&=ont&
    buf24$=back24$
    pic=0
    fout&=0
    FRONTS 1
    OPENW #1
    anim&=FALSE
  RETURN
  > PROCEDURE doscript
    LOCAL g3&
    xscript&=-1
    fout&=0
    afbreek&=0
    a$=""
    IF EXIST(script$)
      OPEN "i",#1,script$
      WHILE a$<>"END" OR EOF(#1) OR afbreek&
        INPUT #1,a$
        EXIT IF EOF(#1)
        scr&=0
        IF @compstr(a$,"BYTE")
          scr&=1
        ELSE IF @compstr(a$,"WORD")
          scr&=2
        ELSE IF @compstr(a$,"LONG")
          scr&=3
        ELSE IF @compstr(a$,"FLOAT")
          scr&=8
        ELSE IF @compstr(a$,"LOAD")
          scr&=4
        ELSE IF @compstr(a$,"REND")
          scr&=5
        ELSE IF @compstr(a$,"ANIM")
          scr&=6
        ELSE IF @compstr(a$,"SAVI")
          scr&=7
        ELSE IF @compstr(a$,"PICS")
          scr&=9
        ENDIF
        SELECT scr&
        CASE 1,2,3,8
          INPUT #1,a$
          IF LEN(a$)
            a$=RIGHT$(a$,LEN(a$)-1)
          ENDIF
          EXIT IF EOF(#1)
          a&=INSTR(a$," ")
          IF a&
            s&=VAL(RIGHT$(a$,LEN(a$)-a&))
            a$=LEFT$(a$,a&-1)+STRING$(14,0)
          ELSE
            s&=0
            a$=a$+STRING$(14,0)
          ENDIF
          base%=firstbase%
          adr%=0
          IF LEN(a$)
            WHILE base%
              IF @comp(V:a$,base%+b.n&)
                IF s&=WORD{base%+b.n&+14}
                  adr%=base%
                ENDIF
              ENDIF
              EXIT IF adr%
              base%={base%}
            WEND
          ENDIF
          INPUT #1,a$
          EXIT IF EOF(#1)
          IF @compstr(a$,"BASE")
          ELSE IF @compstr(a$,"BADA")
            IF adr%
              adr%={adr%+b.d&}
            ENDIF
          ELSE IF @compstr(a$,"TEX")
            a&=INSTR(a$," ")
            s&=VAL(RIGHT$(a$,LEN(a$)-a&))
            IF s&>0 AND s&<100
              adr%=adrtex%(s&)
            ENDIF
          ELSE IF @compstr(a$,"LENS")
            IF scr&=2
              adr%=V:lens&
            ENDIF
          ELSE
            adr%=0
          ENDIF
          IF NOT EOF(#1) AND adr%<>0
            INPUT #1,a$
            ADD adr%,@val(a$)
            IF NOT EOF(#1)
              INPUT #1,a$
              sf&=@val(a$)
              IF NOT EOF(#1)
                INPUT #1,a$
                ef&=@val(a$)
                IF NOT EOF(#1)
                  INPUT #1,a$
                  x1=@val(a$)
                  IF NOT EOF(#1)
                    INPUT #1,a$
                    x2=@val(a$)
                    IF NOT EOF(#1)
                      INPUT #1,a$  !interpoltype
                    ENDIF
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          IF EOF(#1) OR (scr&<>1 AND ODD(adr%))
            okee("Syntax error")
            fout&=-1
          ELSE
            b1&=0
            b2&=0
            g3&=0
            a$=RIGHT$(a$,LEN(a$)-1)
            IF LEFT$(a$,1)="i"
              g3&=-1
            ENDIF
            IF @compstr(a$,"EASE")
              INPUT #1,a$
              b1&=@val(a$)
              IF NOT EOF(#1)
                INPUT #1,a$
                b2&=@val(a$)
              ENDIF
            ENDIF
            EXIT IF EOF(#1)
            IF adr%>10000
              IF (cfra&>=sf& AND cfra&<=ef&) OR (ef&=0 AND sf&=0)
                fac=ef&-sf&
                IF fac=0
                  fac=1
                ELSE
                  IF b1& OR b2&
                    fac=@ease(cfra&-sf&,ef&-sf&,b1&,b2&)
                  ELSE
                    fac=(cfra&-sf&)/(fac)
                    IF fac<0
                      fac=0
                    ELSE IF fac>1
                      fac=1
                    ENDIF
                  ENDIF
                ENDIF
              ELSE IF g3&
                fac=-1
              ELSE IF cfra&<sf&
                fac=0
              ELSE
                fac=1
              ENDIF
              IF fac<>-1
                IF scr&=8
                  FLOAT{adr%}=((1-fac)*x1+fac*x2)
                ELSE
                  t%=ROUND((1-fac)*x1+fac*x2)
                  IF scr&=1
                    BYTE{adr%}=t%
                  ELSE IF scr&=2
                    WORD{adr%}=t%
                  ELSE
                    LONG{adr%}=t%
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ENDIF
        CASE 4
          IF NOT EOF(#1)
            INPUT #1,a$
            a$=RIGHT$(a$,LEN(a$)-1)
            IF EXIST(a$)
              IF RINSTR(a$,"/")
                di$=LEFT$(a$,RINSTR(a$,"/"))
                fi$=RIGHT$(a$,LEN(a$)-RINSTR(a$,"/"))
              ELSE IF RINSTR(a$,":")
                di$=LEFT$(a$,RINSTR(a$,":"))
                fi$=RIGHT$(a$,LEN(a$)-RINSTR(a$,":"))
              ELSE
                di$=""
                fi$=a$
              ENDIF
              leesscene
            ELSE
              okee("Can't read:"+a$)
              afbreek&=1
            ENDIF
          ENDIF
        CASE 5  !render
          a&=INSTR(a$," ")
          IF a&
            cfra&=VAL(RIGHT$(a$,LEN(a$)-a&))
            IF cfra&<1
              cfra&=1
            ENDIF
          ENDIF
          butmes&=30
          buttons(5)
        CASE 6  !anim
          butmes&=29
          buttons(5)
        CASE 7  !schrijf image
          INPUT #1,a$
          EXIT IF EOF(#1)
          IF LEN(a$)
            a$=RIGHT$(a$,LEN(a$)-1)
          ENDIF
          IF WINDOW(6)
            schrijfiff(a$,5)
          ENDIF
        CASE 9  !dir$
          EXIT IF EOF(#1)
          INPUT #1,a$
          IF LEN(a$)
            picsdir$=RIGHT$(a$,LEN(a$)-1)
          ENDIF
        ENDSELECT
        EXIT IF fout& OR afbreek&
      WEND
      CLOSE #1
    ELSE
      okee("No script there!")
    ENDIF
    xscript&=0
  RETURN
  > PROCEDURE hiresham
    LOCAL g1&,g2&,g3&
    '
    g3&=WORD{_GfxBase+164}
    '
    coplist%={SCREEN(1)+44+8}
    copins%={coplist%+12}
    ins&=0
    WHILE WORD{copins%+ins&}<>WORD(&HF08E)
      ADD ins&,2
    WEND
    '
    hstart&=WORD{copins%+ins&+2} AND &HFF
    ddfstrt&=((hstart&-17)/2) AND &HFFF8
    ddfstop&=ddfstrt&+(320/2-8)
    '
    bplcon1&=hstart&-2*ddfstrt&-17
    bplcon1&=bplcon1&+SHL(bplcon1&,4)
    '
    IF SCREEN(1)
      ~CWait(ucoplist%,12,0)
      ~CBump(ucoplist%)
      '
      ~CMove(ucoplist%,&H100,&H200 OR g3&)         ! display uit
      ~CBump(ucoplist%)
      FOR g1&=1 TO 15
        g2&=SHL(col&(g1&,0),8)+SHL(col&(g1&,1),4)+col&(g1&,2)
        ~CMove(ucoplist%,&H180+2*g1&,g2&)       ! zet kleur
        ~CBump(ucoplist%)
      NEXT g1&
      '
      ~CMove(ucoplist%,&H92,ddfstrt&)       ! ddfstrt
      ~CBump(ucoplist%)
      ~CMove(ucoplist%,&H94,ddfstop&)       ! ddfstop
      ~CBump(ucoplist%)
      ~CMove(ucoplist%,&H102,bplcon1&)       ! ddfstop
      ~CBump(ucoplist%)
      '
      temp%=SCREEN(2)+184+8
      FOR g1&=0 TO 5                         ! bitplanes
        ~CMove(ucoplist%,&HE0+4*g1&,WORD{temp%})
        ~CBump(ucoplist%)
        ~CMove(ucoplist%,&HE2+4*g1&,WORD{temp%+2})
        ~CBump(ucoplist%)
        ADD temp%,4
      NEXT g1&
      '
      ~CMove(ucoplist%,&H108,0)         ! modulo 0
      ~CBump(ucoplist%)
      ~CMove(ucoplist%,&H10A,0)
      ~CBump(ucoplist%)
      '
      ~CWait(ucoplist%,14,0)
      ~CBump(ucoplist%)
      '
      ~CMove(ucoplist%,&H100,&H6A00 OR g3&)         ! display aan
      ~CBump(ucoplist%)
      '
      ' **************************************         weer naar hiresscherm
      '
      '
      ~CWait(ucoplist%,116,0)
      ~CBump(ucoplist%)
      ~CMove(ucoplist%,&H100,&H200 OR g3&)         ! display uit
      ~CBump(ucoplist%)
      '
      ddfstrt&=((hstart&-9)/2) AND &HFFFC
      ddfstop&=ddfstrt&+(640/4-8)
      '
      bplcon1&=hstart&-2*ddfstrt&-9
      bplcon1&=bplcon1&+SHL(bplcon1&,4)
      '
      cmap%={SCREEN(1)+48}
      ctable%={cmap%+4}
      FOR g1&=1 TO 3
        ~CMove(ucoplist%,&H180+2*g1&,WORD{ctable%+2*g1&})       ! zet kleur
        ~CBump(ucoplist%)
      NEXT g1&
      '
      ~CMove(ucoplist%,&H92,ddfstrt&)       ! ddfstrt
      ~CBump(ucoplist%)
      ~CMove(ucoplist%,&H94,ddfstop&)       ! ddfstop
      ~CBump(ucoplist%)
      ~CMove(ucoplist%,&H102,bplcon1&)       ! ddfstop
      ~CBump(ucoplist%)
      '
      temp%=SCREEN(1)+184+8
      FOR g1&=0 TO 1                        ! bitplanes lof
        bitpl%={temp%}+118*80
        ~CMove(ucoplist%,&HE0+4*g1&,WORD{V:bitpl%})
        ~CBump(ucoplist%)
        ~CMove(ucoplist%,&HE2+4*g1&,WORD{V:bitpl%+2})
        ~CBump(ucoplist%)
        ADD temp%,4
      NEXT g1&
      '
      temp%=SCREEN(1)+184+8
      FOR g1&=0 TO 1                        ! bitplanes shf
        bitpl%={temp%}+119*80
        ~CMove(ucoplist%,&HE0+4*g1&,WORD{V:bitpl%})
        ~CBump(ucoplist%)
        ~CMove(ucoplist%,&HE2+4*g1&,WORD{V:bitpl%+2})
        ~CBump(ucoplist%)
        ADD temp%,4
      NEXT g1&
      '
      coplist%={ucoplist%+4}
      copins%={coplist%+12}+2
      temp%=SHL(&HE2+4*g1&-4,16)+CARD{V:bitpl%+2}
      '
      g1&=0
      WHILE {copins%}<>temp% AND g1&<100
        ADD copins%,6
        ADD g1&,1
      WEND
      IF g1&<100
        WORD{copins%-2}=&H4000
        WORD{copins%-8}=&H8000
        WORD{copins%-14}=&H4000
        WORD{copins%-20}=&H8000
      ELSE
        OPENS 1
        OPENW #0
        copins%={coplist%+12}
        FOR a%=0 TO 100 STEP 4
          PRINT HEX$({coplist%+a%},8),,HEX$(WORD{copins%},4),HEX$({copins%+2},8)
          ADD copins%,6
        NEXT a%
      ENDIF
      '
      ~CMove(ucoplist%,&H108,&H50)         ! modulo een regel
      ~CBump(ucoplist%)
      ~CMove(ucoplist%,&H10A,&H50)
      ~CBump(ucoplist%)
      '
      ~CWait(ucoplist%,118,0)
      ~CBump(ucoplist%)
      '
      ~CMove(ucoplist%,&H100,&HA204 OR g3&)         ! display aan
      ~CBump(ucoplist%)
      '
    ENDIF
  RETURN
  > PROCEDURE copkleur
    LOCAL y1&,y2&,g1&,g1%
    '
    IF main&=2
      g1%=kleurw3%
      WORD{g1%}=5
      WORD{g1%+2}=0
      WORD{g1%+4}=256*BYTE{V:wf4%}+16*BYTE{V:wf4%+1}+BYTE{V:wf4%+2}
      WORD{g1%+6}=42
      a1%=wrld%+3
      WORD{g1%+8}=SHL(BYTE{a1%} AND &HF0,4)+(BYTE{a1%+1} AND &HF0)+SHR(BYTE{a1%+2},4)
      WORD{g1%+10}=54
      a1%=wrld%
      WORD{g1%+12}=SHL(BYTE{a1%} AND &HF0,4)+(BYTE{a1%+1} AND &HF0)+SHR(BYTE{a1%+2},4)
      WORD{g1%+14}=68
      a1%=wrld%+9
      WORD{g1%+16}=SHL(BYTE{a1%} AND &HF0,4)+(BYTE{a1%+1} AND &HF0)+SHR(BYTE{a1%+2},4)
      WORD{g1%+18}=80
      a1%=wrld%+6
      WORD{g1%+20}=SHL(BYTE{a1%} AND &HF0,4)+(BYTE{a1%+1} AND &HF0)+SHR(BYTE{a1%+2},4)
    ELSE IF main&=3
      g1%=kleurw3%
      WORD{g1%}=4
      WORD{g1%+2}=0
      WORD{g1%+4}=256*BYTE{V:wf4%}+16*BYTE{V:wf4%+1}+BYTE{V:wf4%+2}
      WORD{g1%+6}=58
      a1%=adrcol%
      WORD{g1%+8}=SHL(BYTE{a1%} AND &HF0,4)+(BYTE{a1%+1} AND &HF0)+SHR(BYTE{a1%+2},4)
      WORD{g1%+10}=78
      a1%=adrcol%+11
      WORD{g1%+12}=SHL(BYTE{a1%} AND &HF0,4)+(BYTE{a1%+1} AND &HF0)+SHR(BYTE{a1%+2},4)
      WORD{g1%+14}=98
      a1%=adrcol%+14
      WORD{g1%+16}=SHL(BYTE{a1%} AND &HF0,4)+(BYTE{a1%+1} AND &HF0)+SHR(BYTE{a1%+2},4)
    ELSE IF main&=4
      g1%=kleurw3%
      WORD{g1%}=2
      WORD{g1%+2}=0
      WORD{g1%+4}=256*BYTE{V:wf4%}+16*BYTE{V:wf4%+1}+BYTE{V:wf4%+2}
      WORD{g1%+6}=58
      a1%=adrla%+10
      WORD{g1%+8}=SHL(BYTE{a1%} AND &HF0,4)+(BYTE{a1%+1} AND &HF0)+SHR(BYTE{a1%+2},4)
    ENDIF
    IF WINDOW(4)
      IF main&<>5
        g1%=kleurw4%
        WORD{g1%}=3
        WORD{g1%+2}=86
        a1%=wtex%+t.c&
        WORD{g1%+4}=SHL(BYTE{a1%} AND &HF0,4)+(BYTE{a1%+1} AND &HF0)+SHR(BYTE{a1%+2},4)
        WORD{g1%+6}=104
        ADD a1%,3
        WORD{g1%+8}=SHL(BYTE{a1%} AND &HF0,4)+(BYTE{a1%+1} AND &HF0)+SHR(BYTE{a1%+2},4)
        WORD{g1%+10}=122
        ADD a1%,3
        WORD{g1%+12}=SHL(BYTE{a1%} AND &HF0,4)+(BYTE{a1%+1} AND &HF0)+SHR(BYTE{a1%+2},4)
      ELSE
        g1%=kleurw4%
        WORD{g1%}=1
        WORD{g1%+2}=6
        a1%=V:col%
        WORD{g1%+4}=SHL(BYTE{a1%},8)+SHL(BYTE{a1%+1},4)+BYTE{a1%+2}
      ENDIF
    ENDIF
    '
    ~UCopperListInit(ucoplist%,400)
    '
    IF rondje&=-1 AND (main&=1 OR main&>4)
    ELSE IF rondje&=-2
      hiresham
    ELSE IF rondje&=-1
      hiresham
    ENDIF
    '
    IF WINDOW(7)=0
      IF WINDOW(4)
        y1&=WORD{WINDOW(4)+6}
        g1%=kleurw4%+2
        FOR g1&=1 TO WORD{kleurw4%}
          y2&=y1&+WORD{g1%}
          col1&=WORD{g1%+2}
          ~CWait(ucoplist%,y2&,0)
          ~CBump(ucoplist%)
          ~CMove(ucoplist%,390,col1&)
          ~CBump(ucoplist%)
          ADD g1%,4
        NEXT g1&
      ENDIF
    ENDIF
    IF WINDOW(3)
      y1&=WORD{WINDOW(3)+6}
      g1%=kleurw3%+2
      FOR g1&=1 TO WORD{kleurw3%}
        y2&=y1&+WORD{g1%}
        col1&=WORD{g1%+2}
        ~CWait(ucoplist%,y2&,0)
        ~CBump(ucoplist%)
        ~CMove(ucoplist%,390,col1&)
        ~CBump(ucoplist%)
        ADD g1%,4
      NEXT g1&
    ENDIF
    ~CWait(ucoplist%,10000,256)
    ~CBump(ucoplist%)
    vp%=SCREEN(1)+44
    {vp%+20}=ucoplist%
    ~RemakeDisplay()
  RETURN
  > PROCEDURE visible(s&)
    screen%=SCREEN(s&)
    IF screen%
      IF {screen%+338}<>0
        fscreen%={_IntBase+60}
        WHILE {fscreen%}<>0
          fscreen%={fscreen%}
        WEND
        {fscreen%}=screen%
        {screen%+338}=0
        {screen%}=0
      ENDIF
    ENDIF
  RETURN
  > PROCEDURE invisible(s&)
    screen%=SCREEN(s&)
    IF screen%
      IF {screen%+338}=0
        ~ScreenToBack(screen%)
        fscreen%={_IntBase+60}
        WHILE {fscreen%}<>screen%
          fscreen%={fscreen%}
        WEND
        {fscreen%}=0
        {screen%+338}=1
      ENDIF
    ENDIF
  RETURN
  > PROCEDURE schermfront(s1%,s2%)
    IF (SCREEN(s1%)<>0) AND (SCREEN(s2%)<>0)
      screen1st%=SCREEN(s1%)
      fronts%={_IntBase+60}
      IF screen1st%<>fronts%
        ~ScreenToFront(screen1st%)
        fronts%=screen1st%
      ENDIF
      screen2nd%=SCREEN(s2%)
      IF ({fronts%}<>screen2nd%) AND (fronts%<>screen2nd%)
        thscreen%={_IntBase+60}
        REPEAT
          thscreen%={thscreen%}
        UNTIL ({thscreen%}=screen2nd%) OR (thscreen%=0)
        IF thscreen%
          {thscreen%}={{thscreen%}}
          {screen2nd%}={screen1st%}
          {screen1st%}=screen2nd%
          ~RemakeDisplay()
        ENDIF
      ENDIF
    ENDIF
  RETURN
  > PROCEDURE ldfont(font$,size&,VAR font%)
    LOCAL l$,t$
    '
    l$="diskfont.library"+CHR$(0)
    IF dfont_lib%=0
      ~FRE(0)
      dfont_lib%=OpenLibrary(V:l$,0)
    ENDIF
    '
    IF dfont_lib%
      '
      IF font%<>0
        ~CloseFont(font%)
        ~RemFont(font%)
        font%=0
      ENDIF
      '
      font$=font$+".font"+CHR$(0)
      ~FRE(0)
      t$=MKL$(V:font$)+MKI$(size&)+MKI$(0)
      font%=OpenFont(V:t$)                ! ROM-Font?
      IF (font%=0) OR (INT(font%)<>size&)
        font%=OpenDiskFont(V:t$)          ! DISK-Font
      ENDIF
      IF font%=0
        PRINT font$;" not found !"
      ENDIF
    ELSE
      PRINT "can't open diskfont.library !"
    ENDIF
  RETURN
  > PROCEDURE clfont(VAR font%)
    IF font%<>0
      ~RemFont(font%)
      ~CloseFont(font%)
      font%=0
    ENDIF
  RETURN
  > PROCEDURE setfont(wi%,font%)
    IF WINDOW(wi%)
      rp%={WINDOW(wi%)+50}
      IF rp%<>0 AND font%<>0
        ~SetFont(rp%,font%)
        ~SetSoftStyle(rp%,0,AskSoftStyle(rp%))
        '    PRINT CHR$(27);"c"                            ! Für Print
      ENDIF
    ENDIF
  RETURN
  > PROCEDURE actuheader
    h$="TRACES "+version$+" Ob:"+STR$(totobj&)+" La:"+STR$(totlamp&)+" Mo:"+STR$(totmove&)
    h$=h$+" Ve:"+STR$(totvert&)+" Fa:"+STR$(totvlak&)
    h$=h$+" View:"+STR$(sview&)+" Dia:"+STR$(ROUND(dia/1000))
    h$=h$+" Fra:"+STR$(cfra&)+" "
    SELECT relasize&
    CASE 0
      h$=h$+" SizAll"
    CASE 1
      h$=h$+" Size X"
    CASE 2
      h$=h$+" Size Y"
    CASE 3
      h$=h$+" Size Z"
    CASE 4
      h$=h$+" SizVie"
    CASE 5
      h$=h$+" Shear "
    ENDSELECT
    IF cursor&=-1
      h$=h$+" Curs"
    ELSE
      h$=h$+" Cent"
    ENDIF
    h$=h$+" Mem:"+STR$(INT(AvailMem(0)/1000))+"  "
    ~Move(SCREEN(1)+84,0,9)
    ~SetAPen(SCREEN(1)+84,2)
    ~SetBPen(SCREEN(1)+84,1)
    ~Text(SCREEN(1)+84,V:h$,LEN(h$))
  RETURN
  > PROCEDURE initfase(a$,min%,max%)
    OPENW #4
    COLOR 0
    PBOX 20,4,220,14
    COLOR 2,0
    TEXT 20,12,a$
    IF max%-min%<>0
      COLOR 0
      PBOX 20,18,620,23
      fafac=600
      fafac=fafac/(max%-min%)
      faseo&=0
    ENDIF
    OPENW #6
  RETURN
  > PROCEDURE fase(g1&)
    fase&=fafac*g1&
    IF fase&<>faseo&
      OPENW #4
      COLOR 2
      PBOX 20+faseo&,18,20+fase&,23
      faseo&=fase&
    ENDIF
    OPENW #6
  RETURN
  > PROCEDURE hifiselect(mode&,t$,d$,f$)
    SELECT mode&
    CASE 0
      DIM a$(1)
      IF main&>1 AND main&<5
        copkleur
      ENDIF
      IF WINDOW(3)
        g1&=WORD{WINDOW(3)+6}-331
      ELSE
        g1&=60
      ENDIF
      OPENW #7,135,g1&,371,331,&HC0518,2048+4096+65536+512,1
      BYTE{WINDOW(7)+55}=0
      copkleur
      TITLEW #7,""
      COLOR 0
      CLEARW #7
      border(7)
      setfont(7,testfont%)
      COLOR 1
      PBOX 2,2,368,328
      COLOR 0
      PBOX 30,38,265,282
      PBOX 9,38,19,282
      PBOX 0,26,315,27
      PBOX 0,294,315,295
      PBOX 0,310,315,311
      PBOX 315,0,318,330
      BOX 324,294,364,324
      BOX 325,295,363,323
      COLOR 2,1
      TEXT 335,313,"OK"
      COLOR 2
      PBOX 11,40,17,280
      TEXT 35,20,t$
      COLOR 2
      PBOX 285,7,297,21
      COLOR 1,2
      TEXT 288,18,"P"
      IF LEFT$(t$,4)="SAVE"
        PUT 334,10,sym$(12)
      ELSE
        PUT 334,10,sym$(14)
      ENDIF
      IF app& AND 128
        RESTORE appdata
        FOR a&=0 TO 5
          COLOR 2,1
          READ a$
          TEXT 328,49+24*a&,a$
          COLOR 0
          BOX 324,37+24*a&,364,54+24*a&
          BOX 325,38+24*a&,363,53+24*a&
          IF BTST(app&,a&)
            GRAPHMODE 3
            PBOX 325,38+24*a&,363,53+24*a&
            GRAPHMODE 1
          ENDIF
        NEXT a&
      ENDIF
      appdata:
      DATA "View","World"," Obj","Lamp","Move","Displ"
      root%={_DosBase+34}      !finddevs
      dosinfo%=4*{root%+24}
      devinfo%=4*{dosinfo%+4}
      DIM dev$(10)
      dev&=0
      dev$(0)="DH1:"
      OPENW #1
      LOCATE 1,3
      WHILE devinfo%<>0
        ' string%=4*{devinfo%+40}
        ' len&=BYTE{string%}
        ' a$=SPACE$(len&)
        ' FOR a&=1 TO len&
        ' BYTE{V:a$+a&-1}=BYTE{string%+a&}
        ' NEXT a&
        ' PRINT {devinfo%+4},{devinfo%+8},
        ' PRINT a$
        IF {devinfo%+4}=0 AND {devinfo%+8}<>0
          string%=4*{devinfo%+40}
          len&=BYTE{string%}
          a$=SPACE$(len&)
          FOR a&=1 TO len&
            BYTE{V:a$+a&-1}=BYTE{string%+a&}
          NEXT a&
          IF a$="NFS"
            a$="IRIS"
          ENDIF
          a$=a$+":"
          IF a$<>dev$(0)
            ADD dev&,1
            dev$(dev&)=a$
          ENDIF
        ENDIF
        devinfo%=4*{devinfo%}
        EXIT IF dev&=10
      WEND
      OPENW #7
      QSORT dev$(+),dev&+1
      FOR a&=0 TO dev&
        COLOR 3,1
        TEXT 276,49+24*a&,dev$(a&)
        COLOR 0
        BOX 272,37+24*a&,307,54+24*a&
        BOX 273,38+24*a&,306,53+24*a&
      NEXT a&
      di$=d$
      fi$=f$
      hifiselect(2,"","","")
      wi&=0
      b2&=0
      b3&=0
      t%=0
      WHILE wi&=0
        waitsignal(1)
        IF menu2%=68
          wi&=1
          IF fi$<>""
            IF INSTR(fi$," ")
              fi$=LEFT$(fi$,INSTR(fi$," ")-1)
            ENDIF
          ENDIF
        ENDIF
        IF MOUSEK
          ' PAUSE 1
          IF (LPEEK(WINDOW(7)+24) AND 8192)
            xm&=MOUSEX
            ym&=MOUSEY
            b1&=INT((ym&-51)/12)+1
            IF b1&>=0 AND b1&<20 AND xm&<260
              IF xm&>35                       ! SEL FILE/DIR
                GRAPHMODE 3
                PBOX 35,39+b1&*12,260,b1&*12+12+39
                WHILE MOUSEK
                WEND
                PBOX 35,39+b1&*12,260,b1&*12+12+39
                GRAPHMODE 1
                COLOR 2,1
                a$=LEFT$(a$(b1&+b2&),25)
                IF LEFT$(a$,1)=CHR$(0)
                  IF RIGHT$(di$,1)=":" OR RIGHT$(di$,1)="/"
                    a$=RIGHT$(a$,LEN(a$)-1)
                  ELSE
                    MID$(a$,1)="/"
                  ENDIF
                  WHILE RIGHT$(a$,1)=" "
                    a$=LEFT$(a$,LEN(a$)-1)
                  WEND
                  di$=di$+a$
                  hifiselect(2,"","","")
                ELSE
                  fi$=LEFT$(a$(b1&+b2&),30)
                  TEXT 35,324,fi$
                  IF TIMER-t%<40
                    IF fi$<>""
                      wi&=-1
                      IF INSTR(fi$," ")
                        fi$=LEFT$(fi$,INSTR(fi$," ")-1)
                      ENDIF
                    ENDIF
                  ENDIF
                  t%=TIMER
                ENDIF
              ELSE IF xm&>10 AND xm&<20        ! scroll
                IF t&>20
                  GRAPHMODE 3
                  PBOX 9,38,19,282
                  GRAPHMODE 1
                  b4&=b3&
                  WHILE MOUSEK        !b2& is eind b3& is start
                    b2&=(MOUSEY-ym&)/fac1+b4&
                    hifiselect(1,"","","")
                  WEND
                  IF ym&=MOUSEY
                    IF ym&>150
                      b2&=b4&+1
                    ELSE
                      b2&=b4&-1
                    ENDIF
                    hifiselect(1,"","","")
                  ENDIF
                  GRAPHMODE 3
                  PBOX 9,38,19,282
                  GRAPHMODE 1
                ENDIF
              ENDIF
            ELSE IF xm&<308
              IF xm&>284 AND xm&<300 AND ym&>6 AND ym&<22  ! PARENT
                GRAPHMODE 3
                PBOX 285,7,297,21
                WHILE MOUSEK
                WEND
                PBOX 285,7,297,21
                GRAPHMODE 1
                IF di$<>""
                  IF RIGHT$(di$,1)="/"
                    di$=LEFT$(di$,LEN(di$)-1)
                  ENDIF
                  a&=RINSTR(di$,":")
                  b&=RINSTR(di$,"/")
                  IF a&=0 AND b&=0
                    d$="ram:"
                  ELSE IF b&=0
                    d$=LEFT$(di$,a&)
                  ELSE
                    d$=LEFT$(di$,b&-1)
                  ENDIF
                  IF d$<>di$
                    di$=d$
                    hifiselect(2,"","","")
                  ENDIF
                ENDIF
              ELSE IF xm&>270 AND ym&>36 AND ym&<54+24*dev&  ! SELECT DEV
                b1&=(ym&-37)/24
                GRAPHMODE 3
                PBOX 272,37+24*b1&,307,54+24*b1&
                WHILE MOUSEK
                WEND
                PBOX 272,37+24*b1&,307,54+24*b1&
                GRAPHMODE 1
                di$=dev$(b1&)
                hifiselect(2,"","","")
              ELSE IF ym&>294 AND ym&<326        !TEXT
                GRAPHMODE 3
                IF ym&<310
                  a$=di$
                  b1&=0
                ELSE
                  a$=fi$
                  b1&=17
                ENDIF
                GRAPHMODE 1
                tekstbut(35,307+b1&,2,1,30,a$)
                IF b&=13
                  IF b1&
                    fi$=a$
                    wi&=-1
                  ELSE
                    IF EXIST(a$)
                      IF RIGHT$(a$,1)<>":" AND RIGHT$(a$,1)<>"/"
                        dos$=a$+"/"+CHR$(0)
                      ELSE
                        dos$=a$+CHR$(0)
                      ENDIF
                      lock%=Lock(V:dos$,-2)
                      t&=0
                      IF lock%
                        mem%=AllocMem(300,&H10001)
                        IF mem%
                          ~Info(lock%,mem%)
                          b1&=Examine(lock%,mem%)
                          b2&=WORD{mem%+6}
                          ~FreeMem(mem%,300)
                        ELSE
                          b1&=0
                        ENDIF
                        ~UnLock(lock%)
                        IF (b1&<>0) AND b2&>0
                          di$=a$
                          hifiselect(2,"","","")
                        ELSE
                          COLOR 1
                          PBOX 4,296,314,309
                          COLOR 2,1
                          TEXT 35,307,di$
                          ~DisplayBeep(0)
                        ENDIF
                      ENDIF
                    ELSE
                      COLOR 1
                      PBOX 4,296,314,309
                      COLOR 2,1
                      TEXT 35,307,di$
                    ENDIF
                  ENDIF
                ELSE
                  IF b1&
                    fi$=a$
                  ELSE
                    di$=a$
                  ENDIF
                ENDIF
              ENDIF
            ELSE IF xm&>323                       ! OK en append
              IF app& AND 128
                IF xm&<365 AND ym&<290
                  a&=INT((ym&-38)/24)
                  IF a&>=0 AND a&<6
                    GRAPHMODE 3
                    PBOX 325,38+24*a&,363,53+24*a&
                    GRAPHMODE 1
                    IF BTST(app&,a&)
                      app&=BCLR(app&,a&)
                    ELSE
                      app&=BSET(app&,a&)
                    ENDIF
                    WHILE MOUSEK
                    WEND
                  ENDIF
                ENDIF
              ENDIF
              IF xm&<365 AND ym&<365 AND ym&>293
                GRAPHMODE 3
                PBOX 324,294,364,324
                WHILE MOUSEK
                WEND
                PBOX 324,294,364,324
                GRAPHMODE 1
                wi&=-1
                IF fi$<>""
                  IF INSTR(fi$," ")
                    fi$=LEFT$(fi$,INSTR(fi$," ")-1)
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ELSE
            wi&=-1
            fi$=""
          ENDIF
        ENDIF
      WEND
      IF RIGHT$(di$,1)<>":" AND RIGHT$(di$,1)<>"/"
        di$=di$+"/"
      ENDIF
      ERASE a$(),dev$()
      CLOSEW #7
      OPENW #1
      IF main&>1 AND main&<5
        copkleur
      ENDIF
      '
    CASE 1            !************scroll bar
      IF b2&>=t&-20
        b2&=t&-20
      ELSE IF b2&<0
        b2&=0
      ENDIF
      IF b2&-b3&>20
        b3&=b2&-20
      ELSE IF b2&-b3&<-20
        b3&=b2&+20
      ENDIF
      IF b3&>=t&-20
        b3&=t&-20
      ELSE IF b3&<0
        b3&=0
      ENDIF
      IF b2&<>b3&
        COLOR 1,0
        SCROLL 0,4*(b3&-b2&),30,40,265,278
        SCROLL 0,4*(b3&-b2&),30,40,265,278
        SCROLL 0,4*(b3&-b2&),30,40,265,278
        b5&=0
        c&=-1
        IF b2&>b3&
          c&=1
          b5&=19
        ENDIF
        WHILE b3&<>b2&
          ADD b3&,c&
          a$=LEFT$(a$(b5&+b3&),25)
          b$=RIGHT$(a$(b5&+b3&),10)
          IF LEFT$(a$,1)=CHR$(0)
            COLOR 2,0
            a$=RIGHT$(a$,24)
          ELSE
            COLOR 1,0
          ENDIF
          TEXT 35,48+12*(b3&-b2&+b5&),a$
          TEXT 195,48+12*(b3&-b2&+b5&),b$
        WEND
        b5&=fac1*b3&
        COLOR 3
        PBOX 9,38,19,282
        COLOR 1
        PBOX 11,40+b5&,17,282*fac+b5&
      ENDIF
    CASE 2          !************ get dir
      ERASE a$()
      DIM a$(100)
      COLOR 1
      PBOX 4,296,314,309
      COLOR 2,1
      IF RIGHT$(di$,1)<>":" AND RIGHT$(di$,1)<>"/"
        dos$=di$+"/"+CHR$(0)
      ELSE
        dos$=di$+CHR$(0)
      ENDIF
      TEXT 35,324,fi$
      TEXT 35,307,di$
      lock%=Lock(V:dos$,-2)
      t&=0
      IF lock%
        mem%=AllocMem(300,&H10001)
        ~Info(lock%,mem%)
        IF MKL$({mem%+24})="DOS"+CHR$(0)
          a%=({mem%+12}-{mem%+16}-2)*{mem%+20}
          IF a%<0
            a%=0
          ENDIF
          COLOR 0,1
          TEXT 204,20,LEFT$(STR$(a%)+SPACE$(10),10)
        ENDIF
        b1&=Examine(lock%,mem%)
        IF (b1&<>0) AND {mem%+4}>0
          WHILE ExNext(lock%,mem%)
            a&=1
            IF {mem%+4}>0
              a&=2
            ENDIF
            a%=mem%+8
            a$=CHR$(0)+SPACE$(29)
            WHILE BYTE{a%}<>0
              MID$(a$,a&)=CHR$(BYTE{a%})
              ADD a%,1
              INC a&
            WEND
            b$=""
            IF {mem%+124}<>0
              b$=LEFT$(STR$({mem%+124}),9)
            ENDIF
            a$(t&)=a$+SPACE$(10-LEN(b$))+b$
            INC t&
            EXIT IF t&=101 OR MOUSEK
          WEND
          WHILE MOUSEK
          WEND
        ELSE
          ~DisplayBeep(0)
        ENDIF
        ~FreeMem(mem%,300)
      ENDIF
      IF t&>1
        QSORT a$(),t&
      ENDIF
      COLOR 0
      PBOX 30,38,265,282
      FOR a&=0 TO t&-1
        a$=LEFT$(a$(a&),25)
        b$=RIGHT$(a$(a&),10)
        IF LEFT$(a$,1)=CHR$(0)
          a$=RIGHT$(a$,24)
          COLOR 2,0
        ELSE
          COLOR 1,0
        ENDIF
        IF a&<20
          TEXT 35,48+12*a&,a$
          TEXT 195,48+12*a&,b$
        ENDIF
      NEXT a&
      IF t&>20
        fac=20
        fac=fac/t&
        COLOR 0
        PBOX 11,38,17,282
        COLOR 2
        PBOX 11,40,17,280*fac
        fac1=280*(1-fac)/(t&-20)
      ELSE
        COLOR 2
        PBOX 11,40,17,280
      ENDIF
      b2&=0
      b3&=0
    ENDSELECT
  RETURN
  '
ENDFUNC
RBOX quaternions
> PROCEDURE fillquat
  IF WORD{base%+4}=-2
    ob%={base%+b.d&}
    b1&=WORD{ob%+m.qf&}
    button("Fill Quat Degrees",-3600,3600,b1&)
    IF a%
      WORD{ob%+m.qf&}=b1&
      b2&=WORD{ob%+m.qf&+2}
      b4&=WORD{ob%+m.f&}
      button("Ease in",0,b4&,b2&)
      IF a%
        WORD{ob%+m.qf&+2}=b2&
        b4&=WORD{ob%+m.f&}
        b3&=WORD{ob%+m.qf&+4}
        button("Ease out",0,b4&-b2&,b3&)
        IF a%
          WORD{ob%+m.qf&+4}=b3&
          okee("Load vector?")
          IF a%
            WORD{ob%+m.qf&+8}=32767*persinv(0,2)
            WORD{ob%+m.qf&+10}=32767*persinv(1,2)
            WORD{ob%+m.qf&+12}=32767*persinv(2,2)
          ENDIF
        ENDIF
      ENDIF
    ENDIF
  ENDIF
RETURN
> PROCEDURE warp(g1&)
  adrob%=ob%(a&)
  exit&=-1
  IF {adrob%+100}<>0  !er is een naam
    adr%=hieradr%
    FOR b&=1 TO tothiera&
      ADD adr%,18
      IF exit&
        IF WORD{adr%}=a&       !naam in struct is object
          b1&=WORD{adr%+2}     !parentnr
          IF b1&>0
            a1&=WORD{hieradr%+18*b1&}   !parentobj
            b1&=WORD{hieradr%+18*b1&+2}   !2e parentnr
            IF b1&
              a2&=WORD{hieradr%+18*b1&}   !2e parentobj
              IF WORD{ob%(a1&)}=-2 AND WORD{ob%(a2&)}=-1
                exit&=0
              ENDIF
            ENDIF
          ENDIF
        ENDIF
      ENDIF
    NEXT b&
  ENDIF
  IF exit&=-1
    okee("Can't warp")
  ELSE
    okee("  WARP  ")
    IF a%
      adrve%=adrob%+WORD{adrob%+6}
      tot&=WORD{adrob%+4}
      adrven%=@allocblock(tot&*18,&H10001)
      fr&=WORD{ob%(a1&)+6}
      '     eerst het plus en minblok vullen met y-lengtes en quats
      '
      aplus%=@allocblock(fr&*20,&H10001)
      amin%=@allocblock(fr&*20,&H10001)
      y%=0
      ymax%={adrob%+28}
      cf&=cfra&
      a1%=@calcquat(a1&,a&,cf&)
      SINGLE{aplus%+4}=1
      SINGLE{amin%+4}=1
      q(1,0)=-SINGLE{a1%}
      q(1,1)=SINGLE{a1%+4}
      q(1,2)=SINGLE{a1%+8}
      q(1,3)=SINGLE{a1%+12}
      ap%=aplus%+20
      WHILE y%<ymax%
        a1%=@calcpath(a2&,a&,cf&)
        a2%=@calcpath(a2&,a&,cf&+1)
        ADD y%,SQR(({a1%}-{a2%})^2+({a1%+4}-{a2%+4})^2+({a1%+8}-{a2%+8})^2)
        {ap%}=y%
        a1%=@calcquat(a1&,a&,cf&+1)
        q(2,0)=SINGLE{a1%}
        q(2,1)=SINGLE{a1%+4}
        q(2,2)=SINGLE{a1%+8}
        q(2,3)=SINGLE{a1%+12}
        quadmul(2,1,2)
        SINGLE{ap%+4}=q(2,0)
        SINGLE{ap%+8}=q(2,1)
        SINGLE{ap%+12}=q(2,2)
        SINGLE{ap%+16}=q(2,3)
        ADD cf&,1
        ADD ap%,20
        IF fr&>cfra&+10
          EXIT IF y%=0
        ENDIF
      WEND
      '
      IF y%=0
        okee("Can't warp")
      ELSE
        ap%=amin%+20
        cf&=cfra&
        y%=0
        WHILE y%<ymax%
          a1%=@calcpath(a2&,a&,cf&)
          a2%=@calcpath(a2&,a&,cf&-1)
          ADD y%,SQR(({a1%}-{a2%})^2+({a1%+4}-{a2%+4})^2+({a1%+8}-{a2%+8})^2)
          {ap%}=y%
          a1%=@calcquat(a1&,a&,cf&-1)
          q(2,0)=SINGLE{a1%}
          q(2,1)=SINGLE{a1%+4}
          q(2,2)=SINGLE{a1%+8}
          q(2,3)=SINGLE{a1%+12}
          quadmul(2,1,2)
          SINGLE{ap%+4}=q(2,0)
          SINGLE{ap%+8}=q(2,1)
          SINGLE{ap%+12}=q(2,2)
          SINGLE{ap%+16}=q(2,3)
          ADD cf&,-1
          ADD ap%,20
          IF fr&<cfra&+10
            EXIT IF y%=0
          ENDIF
        WEND
        IF y%=0
          okee("Can't warp")
        ELSE
          FOR a&=1 TO tot&
            xt%={adrve%}
            yt%={adrve%+4}
            zt%={adrve%+8}
            IF yt%>0
              ofset&=0
              WHILE yt%>{aplus%+20*ofset&}
                ADD ofset&,1
              WEND
              a%=aplus%+20*ofset&+4
              q(4,0)=SINGLE{a%}
              q(4,1)=SINGLE{a%+4}
              q(4,2)=SINGLE{a%+8}
              q(4,3)=SINGLE{a%+12}
            ELSE IF yt%<0
              ofset&=0
              WHILE ABS(yt%)>{amin%+20*ofset&}
                ADD ofset&,1
              WEND
              a%=amin%+20*ofset&+4
              q(4,0)=SINGLE{a%}
              q(4,1)=SINGLE{a%+4}
              q(4,2)=SINGLE{a%+8}
              q(4,3)=SINGLE{a%+12}
            ELSE
              q(4,0)=1
              q(4,1)=0
              q(4,2)=0
              q(4,3)=0
            ENDIF
            quatmulvec
            {adrve%}=xt%
            {adrve%+4}=yt%
            {adrve%+8}=zt%
            ADD adrve%,18
          NEXT a&
        ENDIF
      ENDIF
      freeblock(amin%)
      freeblock(aplus%)
      freeblock(adrven%)
    ENDIF
  ENDIF
RETURN
> PROCEDURE track
  IF basact%
    base%=firstbase%
    t&=0
    x1%={basact%+b.r&}
    y1%={basact%+b.r&+4}
    z1%={basact%+b.r&+8}
    DEFLINE &HF0F0
    WHILE base%
      IF lay& AND WORD{base%+b.l&}
        IF BYTE{base%+b.f&} AND 1
          IF base%<>basact%
            t&=-1
            moveto2d(x1%,y1%,z1%,{base%+b.r&},{base%+b.r&+4},{base%+b.r&+8})
          ENDIF
        ENDIF
      ENDIF
      base%={base%}
    WEND
    IF t&
      moving&=-1
      COLOR 2
      col&=2
      base%=basact%
      DEFLINE 1
      tekenbase
      moving&=0
      okee("Track to yellow?")
      COLOR 0
      DEFLINE &HF0F0
      base%=firstbase%
      WHILE base%
        IF lay& AND WORD{base%+b.l&}
          IF BYTE{base%+b.f&} AND 1
            IF base%<>basact%
              moveto2d(x1%,y1%,z1%,{base%+b.r&},{base%+b.r&+4},{base%+b.r&+8})
              IF a%
                {base%+b.t&}=basact%
              ENDIF
            ENDIF
          ENDIF
        ENDIF
        base%={base%}
      WEND
      moving&=0
      IF a%
        calcu&=-1
        fastprojektie
        calcu&=0
      ELSE
        base%=basact%
        tekenbase
      ENDIF
    ENDIF
  ENDIF
RETURN
> PROCEDURE quatinterpol(g1&)
  IF WORD{ob%(a&)}=-2
    ~DisplayBeep(0)
    ARRAYFILL er&(),0
    a%=ob%(a&)+124
    f&=WORD{ob%(a&)+6}
    q&=0
    temp%=quat%+96
    temp&=FALSE
    FOR b&=1 TO f&
      IF WORD{a%}
        {temp%}=32767*SINGLE{a%+2}
        {temp%+4}=32767*SINGLE{a%+6}
        {temp%+8}=32767*SINGLE{a%+10}
        {temp%+12}=32767*SINGLE{a%+14}
        IF temp&                       ! contrôle op omklappen
          inp%=WORD{temp%+2}*WORD{temp%-46}+WORD{temp%+6}*WORD{temp%-42}
          ADD inp%,WORD{temp%+10}*WORD{temp%-38}+WORD{temp%+14}*WORD{temp%-34}
          IF inp%<-10000000
            {temp%}=-{temp%}
            {temp%+4}=-{temp%+4}
            {temp%+8}=-{temp%+8}
            {temp%+12}=-{temp%+12}
            ' SINGLE{a%+2}=-SINGLE{a%+2}
            ' SINGLE{a%+6}=-SINGLE{a%+6}
            ' SINGLE{a%+10}=-SINGLE{a%+10}
            ' SINGLE{a%+14}=-SINGLE{a%+14}
          ENDIF
        ENDIF
        temp&=TRUE
        ADD temp%,48
        er&(q&)=b&
        ADD q&,1
      ENDIF
      ADD a%,18
    NEXT b&
    '
    IF q&
      cyclic&=TRUE
      np&=q&+2
      er&(q&)=er&(0)+f&
      ADD q&,1
      cycliq
      FOR b&=2 TO np&
        qalchandle(b&)
      NEXT b&
      ' cycliq
      resol&=5
      points&=BSET(0,resol&)
      '
      c%=@allocblock((points&+1)*q&*16+1048,&H10001)
      q%=c%
      FOR b&=2 TO np&-1
        beziersq
      NEXT b&
      a%=ob%(a&)+124
      FOR b&=0 TO q&-2
        aantal=er&(b&+1)-er&(b&)
        FOR c&=er&(b&)+1 TO er&(b&+1)-1
          p=((c&-er&(b&))*32)/aantal
          t00=FRAC(p)
          t01=1-t00
          x1%=q%+33*b&*16+16*INT(p)
          x2%=x1%+16
          l&=c&
          IF c&>f&
            l&=c&-f&
          ENDIF
          a1%=a%+18*l&+2-18
          SINGLE{a1%}=t01*SINGLE{x1%}+t00*SINGLE{x2%}
          SINGLE{a1%+4}=t01*SINGLE{x1%+4}+t00*SINGLE{x2%+4}
          SINGLE{a1%+8}=t01*SINGLE{x1%+8}+t00*SINGLE{x2%+8}
          SINGLE{a1%+12}=t01*SINGLE{x1%+12}+t00*SINGLE{x2%+12}
        NEXT c&
      NEXT b&
      freeblock(q%)
    ENDIF
  ENDIF
RETURN
> PROCEDURE quatclear
  okee("Quat clear?")
  IF a%
    base%=firstbase%
    WHILE base%
      IF lay& AND WORD{base%+b.l&}
        IF BYTE{base%+b.f&} AND 1
          FLOAT{base%+b.q&}=1
          FLOAT{base%+b.q&+8}=0
          FLOAT{base%+b.q&+16}=0
          FLOAT{base%+b.q&+24}=0
          BYTE{base%+b.f&}=BSET(BYTE{base%+b.f&},2)
        ENDIF
      ENDIF
      base%={base%}
    WEND
    calcu&=-1
    fastprojektie
    calcu&=0
  ENDIF
RETURN
> PROCEDURE beziersq
  LOCAL a&
  '
  temp%=quat%+48*b&
  bezier({temp%},{temp%+32},{temp%+64},{temp%+48},rmem%)
  rgem%=gem%
  rshift&=shift&
  '
  ADD temp%,4
  bezier({temp%},{temp%+32},{temp%+64},{temp%+48},xmem%)
  xgem%=gem%
  xshift&=shift&
  '
  ADD temp%,4
  bezier({temp%},{temp%+32},{temp%+64},{temp%+48},ymem%)
  ygem%=gem%
  yshift&=shift&
  '
  ADD temp%,4
  bezier({temp%},{temp%+32},{temp%+64},{temp%+48},zmem%)
  zgem%=gem%
  zshift&=shift&
  '
  x%=xmem%
  y%=ymem%
  z%=zmem%
  r%=rmem%
  '
  FOR a&=0 TO points&
    x1%=SHL(WORD{x%},xshift&)+xgem%
    ADD x%,2
    y1%=SHL(WORD{y%},yshift&)+ygem%
    ADD y%,2
    z1%=SHL(WORD{z%},zshift&)+zgem%
    ADD z%,2
    r1%=SHL(WORD{r%},rshift&)+rgem%
    ADD r%,2
    len=1/SQR(x1%*x1%+y1%*y1%+z1%*z1%+r1%*r1%)
    SINGLE{c%}=r1%*len
    ADD c%,4
    SINGLE{c%}=x1%*len
    ADD c%,4
    SINGLE{c%}=y1%*len
    ADD c%,4
    SINGLE{c%}=z1%*len
    ADD c%,4
  NEXT a&
RETURN
> PROCEDURE cycliq
  IF cyclic&
    BMOVE quat%+96,quat%+np&*48,96
    BMOVE quat%+(np&-2)*48,quat%,96
  ELSE
    temp%=quat%+(np&-2)*48
    FOR t&=0 TO 1
      FOR temp&=0 TO 2
        {temp%+96}=SHL({temp%+48},1)-{temp%}
        ADD temp%,4
      NEXT temp&
      ADD temp%,36
    NEXT t&
    '
    temp%=quat%
    FOR t&=0 TO 1
      FOR temp&=0 TO 2
        {temp%}=SHL({temp%+48},1)-{temp%+96}
        ADD temp%,4
      NEXT temp&
      ADD temp%,36
    NEXT t&
    '
  ENDIF
RETURN
> PROCEDURE quatinter(q1&,q2&,i1,q3&)
  i2=1-i1
  q(q3&,0)=i2*q(q1&,0)+i1*q(q2&,0)
  q(q3&,1)=i2*q(q1&,1)+i1*q(q2&,1)
  q(q3&,2)=i2*q(q1&,2)+i1*q(q2&,2)
  q(q3&,3)=i2*q(q1&,3)+i1*q(q2&,3)
  '
  i2=1/SQR(q(q3&,0)^2+q(q3&,1)^2+q(q3&,2)^2+q(q3&,3)^2)
  '
  q(q3&,0)=i2*q(q3&,0)
  q(q3&,1)=i2*q(q3&,1)
  q(q3&,2)=i2*q(q3&,2)
  q(q3&,3)=i2*q(q3&,3)
RETURN
> PROCEDURE quadtomat(q&,VAR mat())
  qd=q(q&,0)
  qa=q(q&,1)
  qb=q(q&,2)
  qc=q(q&,3)
  '
  qdd=qd*qd
  qda=2*qd*qa
  qdb=2*qd*qb
  qdc=2*qd*qc
  qaa=qa*qa
  qab=2*qa*qb
  qac=2*qa*qc
  qbb=qb*qb
  qbc=2*qb*qc
  qcc=qc*qc
  '
  mat(0,0)=qdd+qaa-qbb-qcc
  mat(0,1)=-qdc+qab
  mat(0,2)=qdb+qac
  mat(1,0)=qdc+qab
  mat(1,1)=qdd-qaa+qbb-qcc
  mat(1,2)=-qda+qbc
  mat(2,0)=-qdb+qac
  mat(2,1)=qda+qbc
  mat(2,2)=qdd-qaa-qbb+qcc
RETURN
> PROCEDURE quadmul(q1&,q2&,q3&)
  qw1=q(q1&,0)
  qx1=q(q1&,1)
  qy1=q(q1&,2)
  qz1=q(q1&,3)
  '
  qw2=q(q2&,0)
  qx2=q(q2&,1)
  qy2=q(q2&,2)
  qz2=q(q2&,3)
  '
  q(q3&,0)=qw1*qw2-qx1*qx2-qy1*qy2-qz1*qz2
  q(q3&,1)=qw1*qx2+qx1*qw2+qy1*qz2-qz1*qy2
  q(q3&,2)=qw1*qy2+qy1*qw2+qz1*qx2-qx1*qz2
  q(q3&,3)=qw1*qz2+qz1*qw2+qx1*qy2-qy1*qx2
RETURN
> PROCEDURE quatmulvec
  quadtomat(4,mat())
  x(0)=xt%
  x(1)=yt%
  x(2)=zt%
  RBOX y()=mat()*x()
  xt%=y(0)
  yt%=y(1)
  zt%=y(2)
RETURN
> PROCEDURE qalchandle(b&)
  temp%=quat%+48*(b&-1)
  '
  dx1=({temp%}*{temp%+48}+{temp%+4}*{temp%+52}+{temp%+8}*{temp%+56}+{temp%+12}*{temp%+60})/&H40000000
  IF dx1<-0.01
    dx1=-dx1
    {temp%+48}=-{temp%+48}
    {temp%+52}=-{temp%+52}
    {temp%+56}=-{temp%+56}
    {temp%+60}=-{temp%+60}
  ENDIF
  IF ABS(dx1)>1
    dx1=SGN(dx1)
  ENDIF
  '
  dx2=({temp%+96}*{temp%+48}+{temp%+100}*{temp%+52}+{temp%+104}*{temp%+56}+{temp%+108}*{temp%+60})/&H40000000
  IF dx2<-0.01
    dx2=-dx2
    {temp%+96}=-{temp%+96}
    {temp%+100}=-{temp%+100}
    {temp%+104}=-{temp%+104}
    {temp%+108}=-{temp%+108}
  ENDIF
  IF ABS(dx2)>1
    dx2=SGN(dx2)
  ENDIF
  '
  vx={temp%+96}-{temp%}
  vy={temp%+100}-{temp%+4}
  vz={temp%+104}-{temp%+8}
  vr={temp%+108}-{temp%+12}
  lenh=3*SQR(vx*vx+vy*vy+vz*vz+vr*vr)/&H8000
  '
  IF lenh
    len1=ACOS(dx1)/lenh
    len2=ACOS(dx2)/lenh
  ELSE
    len1=1
    len2=1
  ENDIF
  '
  ADD temp%,48+16
  {temp%}=-vx*len1
  {temp%+4}=-vy*len1
  {temp%+8}=-vz*len1
  {temp%+12}=-vr*len1
  '
  {temp%+16}=vx*len2
  {temp%+20}=vy*len2
  {temp%+24}=vz*len2
  {temp%+28}=vr*len2
RETURN
'
ENDFUNC
FUNCTION menu
> PROCEDURE main
  OPENW #5,0,494,640,18,&HC0118,2048+4096+65536+512,1
  BYTE{WINDOW(5)+55}=0
  setfont(5,testfont%)
  COLOR 1,1
  CLEARW #5
  main&=1
  maino&=1
  layo&=1
  PUT 3,6,sym$(1),&H60
  totbut&=22
  but%=2+32*totbut&
  {WINDOW(5)+120}=@allocblock(but%,&H10001)
  WORD{{WINDOW(5)+120}}=totbut&
  v1&=-1  !vlag pbox in defbut
  defbutton(5,6,5,48,V:main&,580,0,60,15,1,5,"DISPLAY")
  defbutton(6,6,5,48,V:main&,540,0,60,15,1,6,"MOVE")
  defbutton(2,6,5,48,V:main&,490,0,40,15,1,2,"WORLD")
  defbutton(3,6,5,48,V:main&,435,0,40,15,1,3,"OBJECT")
  defbutton(4,6,5,48,V:main&,395,0,40,15,1,4,"LAMP")
  defbutton(1,6,5,48,V:main&,355,0,40,15,1,1,"VIEW")
  defbutton(7,2,5,32,V:lay&,50,2,14,15,1,1,"1")
  defbutton(8,2,5,33,V:lay&,65,2,14,15,1,1,"2")
  defbutton(9,2,5,34,V:lay&,80,2,14,15,1,1,"3")
  defbutton(10,2,5,35,V:lay&,95,2,14,15,1,1,"4")
  defbutton(11,2,5,36,V:lay&,110,2,14,15,1,1,"5")
  defbutton(12,2,5,37,V:lay&,130,2,14,15,1,1,"6")
  defbutton(13,2,5,38,V:lay&,145,2,14,15,1,1,"7")
  defbutton(14,2,5,39,V:lay&,160,2,14,15,1,1,"8")
  defbutton(15,2,5,40,V:lay&,175,2,14,15,1,1,"9")
  defbutton(16,2,5,41,V:lay&,190,2,14,15,1,1,"0")
  defbutton(17,2,5,42,V:lay&,210,2,14,15,1,1,"1")
  defbutton(18,2,5,43,V:lay&,225,2,14,15,1,1,"2")
  defbutton(19,2,5,44,V:lay&,240,2,14,15,1,1,"3")
  defbutton(20,2,5,45,V:lay&,255,2,14,15,1,1,"4")
  defbutton(21,2,5,46,V:lay&,270,2,14,15,1,1,"5")
  defbutton(22,2,5,48,V:hie&,17,2,18,15,1,1,"H")
  WHILE 1=1
    activatewindow(WINDOW(1))
    IF keypr&=0
      waitsignal(1)
    ELSE
      keypr&=0
    ENDIF
    qual&=menu3%
    IF (MOUSEK=2 AND MOUSEY<10) OR menu2%=&H40
      spacemenu
    ELSE IF MOUSEK
      dobutton
      IF wi&=1
        OPENW #1
        @menumuis
      ELSE IF wi&=6
        schermfront(1,2)
        OPENW #1
        OPENS 1
        ~ActivateWindow(WINDOW(1))
      ELSE IF butmes&
        mainbuttons
        menu2%=-1
      ENDIF
    ENDIF
    OPENW #1
    qual&=menu3%
    but&=menu2%
    IF menu1%=1024 AND but&<96
      ~MoveSprite(vpspr%,spr.mem%,-124,-127)
      WHILE INKEY$<>""
      WEND
      SELECT but&
      CASE 80
        IF sdir$=""
          sdir$="ram:"
        ENDIF
        OPENW #1
        OPENS 1
        IF qual& AND 3
          ADD app&,128
          hifiselect(0,"APPEND INDICATED",sdir$,sfile$)
        ELSE
          hifiselect(0,"LOAD SCENE",sdir$,sfile$)
        ENDIF
        leesscene
        IF app& AND 128
          SUB app&,128
        ENDIF
      CASE 81
        schrijfscene
      CASE 82
        IF idir$=""
          idir$="ram:"
        ENDIF
        IF qual& AND &H3
          OPENW #1
          OPENS 1
          hifiselect(0,"LOAD PALETTE",idir$,ifile$)
          IF LEN(fi$)
            getpalette(di$+fi$)
          ENDIF
        ELSE
          IF SCREEN(5)
            OPENW #1
            OPENS 1
            hifiselect(0,"SAVE IMAGE",idir$,ifile$)
            IF fi$<>""
              a%=-1
              IF EXIST(di$+fi$)
                okee("   SAVE OVER?")
              ENDIF
              IF a%
                idir$=di$
                LET ifile$=fi$
                schrijfiff(idir$+ifile$,5)
              ENDIF
            ENDIF
          ENDIF
        ENDIF
      CASE &H45  !esc
        IF main&<>1
          main&=1
          setbutton(1,5)
          setbutton(maino&,5)
          sluitwin(4)
          sluitwin(3)
          maino&=1
        ENDIF
      CASE 83
        IF main&<>4 AND WORD{basact%+4}=2
          main&=4
          setbutton(4,5)
          setbutton(maino&,5)
          sluitwin(4)
          sluitwin(3)
          butopen(4)
          maino&=4
        ENDIF
      CASE 84
        IF main&<>3 AND (WORD{basact%+4} AND 1)
          main&=3
          setbutton(3,5)
          setbutton(maino&,5)
          sluitwin(4)
          sluitwin(3)
          butopen(3)
          maino&=3
        ENDIF
      CASE 85
        IF main&<>2
          main&=2
          setbutton(2,5)
          setbutton(maino&,5)
          sluitwin(4)
          sluitwin(3)
          butopen(2)
          maino&=2
        ENDIF
      CASE 86
        IF main&<>6
          main&=6
          setbutton(6,5)
          setbutton(maino&,5)
          sluitwin(4)
          sluitwin(3)
          @openmovewin
          maino&=6
        ENDIF
      CASE 87
        IF main&<>5
          main&=5
          setbutton(5,5)
          setbutton(maino&,5)
          sluitwin(4)
          sluitwin(3)
          butopen(5)
          maino&=5
        ELSE
          butmes&=30
          buttons(5)
        ENDIF
      CASE 88
        IF SCREEN(5)
          temp%=SCREEN(5)+44            ! viewport
          IF WORD{temp%+32} AND 4       ! interlace
            temp&=(512-yscherm&)/2
          ELSE
            temp&=(256-yscherm&)/2
          ENDIF
          WORD{temp%+30}=temp&          ! yoffset
          '
          IF WORD{temp%+32} AND &H8000  ! hires
            temp&=(640-xscherm&)/2
          ELSE
            temp&=(320-xscherm&)/2
          ENDIF
          WORD{temp%+28}=temp&          ! xoffset
          '
          FRONTS 5
          activatewindow(WINDOW(6))
          REPEAT
            VSYNC
            VSYNC
            waitsignal(0)               ! alle boodschappen wissen
          UNTIL ret&=0
          REPEAT
            waitsignal(1)
            IF ret&
              EXIT IF menu1%<>1024
              temp%=SCREEN(5)+44          ! viewport
              SELECT menu2%
              CASE &H4C
                WORD{temp%+30}=WORD{temp%+30}-1
                ret&=FALSE
              CASE &H4D
                WORD{temp%+30}=WORD{temp%+30}+1
                ret&=FALSE
              CASE &H4E
                WORD{temp%+28}=WORD{temp%+28}+1
                ret&=FALSE
              CASE &H4F
                WORD{temp%+28}=WORD{temp%+28}-1
                ret&=FALSE
              ENDSELECT
              IF menu2% AND &H80         ! toets loslaten
                ret&=FALSE
              ENDIF
            ENDIF
            EXIT IF ret&
            ~RemakeDisplay()
          UNTIL menu1%=&H80000          ! deactivate window
          temp%=SCREEN(5)+44            ! viewport
          {temp%+28}=0
          BACKS 5
          activatewindow(WINDOW(1))
        ENDIF
      CASE 89
        IF WINDOW(8)=0
          OPENW #8,0,100,400,400,&HC071C,4096+65536+1024+512+64+8+2+1,1
          TITLEW #8,""
          wi2d%=WINDOW(8)
          BYTE{wi2d%+57}=3
        ENDIF
      ENDSELECT
      IF ebase%
        SELECT but&
        CASE &H37,&H17,&H33,&H34,&H22,&H12,&H25,&H26
          beziertoets
          but&=-1
        ENDSELECT
      ENDIF
      SELECT but&
      CASE 29,30,31,45,46,47,61,62,63,&H4A,&H5E,15
        perspbuttons
        fastprojektie
        calcu&=0
      CASE 32  !a
        IF (qual& AND 128)=128
          apply(0)
        ELSE
          deselectall
        ENDIF
      CASE 53  !b
        IF (qual& AND 128)=128
          maakbol
        ELSE IF qual& AND 3
          kader
        ELSE
          @selector
        ENDIF
      CASE 51  !c
        IF menu3% AND 8
          '    fillquat
        ELSE IF (qual& AND 128)=128
          copycolorblocks
        ELSE
          centre
        ENDIF
      CASE 34  !d
        IF qual& AND 3
          addduplicate
        ELSE
          button("Trace Depth",0,4,tradep&)
        ENDIF
      CASE 18  !e
        IF (qual& AND 128)=128
        ELSE
          extrudepoly
        ENDIF
      CASE 35  !f
        IF (qual& AND 128)=128
          apply(1)
        ELSE
          b1&=lens&
          button("Focus",20,120,lens&)
          IF b1&<>lens&
            calcphitheta
            fastprojektie
          ENDIF
        ENDIF
      CASE 36  !g
        IF qual& AND 3
          b1&=grid%/1000
          b2&=b1&
          button("Grid size",1,500,b1&)
          grid%=b1&*1000
          IF b1&<>b2&
            fastprojektie
          ENDIF
        ELSE
          grabber
        ENDIF
      CASE 37  !h
        IF qual& AND 3
          okee("herbereken 45")
          base%=basact%
          herbereken45
        ELSE
          hie&=NOT hie&
          setbutton(22,5)
          calcu&=-1
          fastprojektie
          calcu&=0
        ENDIF
      CASE 23  !i
        IF (qual& AND 128)=128
          okee("imasize to mat?")
          IF a%
            imawraptomat
          ENDIF
        ENDIF
      CASE 39  !k
        IF (qual& AND 128)=128
          wordruimtekleiner
        ELSE
          okee(" Add Cube")
          IF a%
            mode&=1
            addbase(1)
          ENDIF
        ENDIF
      CASE 40  !l
        IF qual& AND 3
          okee(" ADD LAMP")
          IF a%
            addbase(2) !lamp
          ENDIF
        ENDIF
      CASE 55  !m
        IF qual& AND 3
          okee("ADD MOVEBASE?")
          IF a%
            addbase(-2)
          ENDIF
        ELSE IF (qual& AND 32)=32
          matclear
        ELSE IF (qual& AND 128)=128
          makemoveobj
        ELSE IF qual& AND 8
          copymat
        ELSE
          movetolayer
        ENDIF
      CASE 54   !n
        OPENW #1
        IF (qual& AND 128)=128
          herberekennorm
        ELSE
          COLOR 1,0
          a$=SPACE$(14)
          base%=firstbase%
          WHILE base%
            IF lay& AND WORD{base%+b.l&}
              COLOR 1,0
              IF BYTE{base%+b.f&} AND 1
                COLOR 3,0
              ENDIF
              IF WORD{base%+b.s&}<>3200
                a$=SPACE$(14)
                BMOVE base%+b.n&,V:a$,14
                teststring(a$)
                a&=WORD{base%+b.n&+14}
                IF a&
                  a$=a$+"."+STR$(a&)
                ENDIF
                a&=-2
                IF WORD{base%+4}<0
                  a&=6
                ENDIF
                TEXT WORD{base%+b.s&},a&+WORD{base%+b.s&+2},a$
              ENDIF
            ENDIF
            base%={base%}
          WEND
        ENDIF
      CASE 24  !o
        IF (qual& AND 32)=32
          originclear
        ELSE IF qual& AND 3
          okee("Observer Parent?")
          IF a% AND basact%<>0
            opar%=basact%
          ELSE IF basact%=0
            opar%=0
          ENDIF
        ELSE IF but&=24 AND persp&<>-2
          movedinges(1,obs%())
        ENDIF
      CASE 25  !p
        IF qual& AND 3
          okee("   ADD PLANE")
          IF a%
            mode&=0
            addbase(1)
          ENDIF
        ELSE IF (qual& AND 32)=32
          parentclear
        ELSE IF (qual& AND 128)=128
          makeparent
        ELSE
          IF main&=5
            paletreq
          ELSE
            button("Use Pointmass",0,1,pumanorm&)
          ENDIF
        ENDIF
      CASE 16  !q
        IF (qual& AND 32)=32
          quatclear
        ELSE IF qual& AND 8
          copyquat
        ELSE
          okee("OK: QUIT TRACES")
          IF a%
            sluit
          ENDIF
        ENDIF
      CASE 19  !r
        rotate
      CASE 33  !s
        IF qual& AND 3
          okee("   ADD SPHERE")
          IF a%
            addbase(3)
          ENDIF
        ELSE IF (qual& AND 128)=128
          okee("Execute script?")
          IF a%
            doscript
          ENDIF
        ELSE
          size
        ENDIF
      CASE 20  !t
        IF (qual& AND 128)=128
          track
        ELSE IF (qual& AND 32)=32
          trackclear
        ELSE IF qual& AND 3
          okee("Target Parent?")
          IF a% AND basact%<>0
            tpar%=basact%
          ELSE IF basact%=0
            tpar%=0
          ENDIF
        ELSE
          movedinges(3,tar%())
        ENDIF
      CASE 22  !u
        IF (qual& AND 128)=128
          copyvertvlak
        ENDIF
      CASE 52  !v
        IF (qual& AND 128)=128
          button("Store View:",1,8,sview&)
          IF a%
            setviewdata(sview&)
          ENDIF
        ELSE IF qual& AND 3
          showspotvolume
        ELSE
          showviewvolume
        ENDIF
      CASE 17  !w
        IF (qual& AND 128)=128
          ' warp(objact&)
        ELSE IF (qual& AND 128)=128
          ' warpclear
        ELSE
          workfieldbuttons
        ENDIF
      CASE 50  !x
        IF qual& AND 3
          okee("   ERASE ALL")
          IF a%
            wisalles
            fastprojektie
          ENDIF
        ELSE IF (qual& AND 128)=128
          copyeffect
        ELSE
          deleteobj
          ' button("Exposure:",1,256,exp&)
        ENDIF
      CASE 49  !z
      CASE &H1B  !]
        cursor&=NOT cursor&
        actuheader
      CASE &H1A  ![
        ADD relasize&,1
        IF relasize&=6
          relasize&=0
        ENDIF
        actuheader
      CASE 0
        lay&=32767
        FOR a&=0 TO 14
          setbutton(a&+7,5)
        NEXT a&
        fastprojektie
      CASE 1 TO 15,&H41,&H46
        IF (qual& AND 128)=128 AND but&<9
          leesviewdata(but&)
          IF but&
            sview&=but&
            IF persp&=-2
              bepaalphitheta(1)
            ELSE
              bepaalphitheta(0)
            ENDIF
            calcphitheta
            fastprojektie
          ENDIF
        ELSE
          wi&=5
          butmuis&=1
          IF qual& AND 3
            butmuis&=2
          ENDIF
          IF but&=&H41
            but&=14
          ELSE IF but&=&H46
            but&=15
          ENDIF
          lay&=BCHG(lay&,but&-1)
          butmes&=but&+6
          setbutton(butmes&,5)
          mainbuttons
        ENDIF
      CASE &H5F
        button("Trace type",0,5,tracetype&)
      CASE &H4C,&H4D,&H4E,&H4F  ! pijltjes
        IF hie&
          REPEAT
            IF but&=&H4C
              ADD cfra&,10
              IF cfra&>efra& AND cfra&<efra&+9
                cfra&=efra&
              ENDIF
            ELSE IF but&=&H4D
              SUB cfra&,10
              IF cfra&<1 AND cfra&>-9
                cfra&=1
              ENDIF
            ELSE IF but&=&H4F
              IF menu3% AND 3
                cfra&=1
                ret&=FALSE
              ELSE
                SUB cfra&,1
              ENDIF
            ELSE IF but&=&H4E
              IF menu3% AND 3
                cfra&=efra&
                ret&=FALSE
              ELSE
                ADD cfra&,1
              ENDIF
            ELSE
              IF but&<&H80
                ret&=FALSE
                keypr&=TRUE
              ENDIF
            ENDIF
            WHILE cfra&<1
              ADD cfra&,efra&
            WEND
            WHILE cfra&>efra&
              SUB cfra&,efra&
            WEND
            a$=" "
            IF main&=6
              setbutton(3,3)
            ELSE IF main&=5
              setbutton(38,3)
            ENDIF
            IF ret&
              IF but&<&H80
                waitsignal(1)
              ELSE
                PAUSE 5
                waitsignal(0)
              ENDIF
              IF ret&
                IF menu1%=&H400
                  but&=menu2%
                ELSE
                  ret&=FALSE
                ENDIF
              ENDIF
            ENDIF
          UNTIL ret&=FALSE
          calcu&=-1
          fastprojektie
          calcu&=0
        ENDIF
      CASE 67,68  !enter
        proj2
      ENDSELECT
      i$=""
      WHILE menu2%<90 AND menu2%>0 AND NOT keypr&
        waitsignal(1)
      WEND
    ENDIF
    actuheader
    ' ENDIF
  WEND
RETURN
> PROCEDURE spacemenu
  LOCAL a&,gx&,gy&,b1&,b2&
  '
  SWAP gx&,x&
  SWAP gy&,y&
  '
  DIM a&(12,1)
  OPENW #1
  b2&=294
  x&=MOUSEX-b2&/2
  y&=MOUSEY-30
  IF x&>639-b2&
    x&=639-b2&
  ELSE IF x&<0
    x&=0
  ENDIF
  b1&=0
  IF main&>1 AND main&<5 AND rondje&
    b1&=110
  ELSE
    FRONTS 1
  ENDIF
  IF y&>418
    y&=418
  ELSE IF y&<b1&
    y&=b1&
  ENDIF
  OPENW #7,x&,y&,294,92,&HC0518,2048+4096+65536+512,1
  BYTE{WINDOW(7)+55}=0
  TITLEW #7,""
  COLOR 3,0
  CLEARW #7
  border(7)
  setfont(7,testfont%)
  h&=ABS(h&)
  IF h&>11
    h&=0
  ENDIF
  spacedata
  FOR b2&=0 TO 5
    COLOR 1
    PBOX 5,5+14*b2&,48,16+14*b2&
  NEXT b2&
  FOR b2&=0 TO 5
    COLOR 1
    PBOX 245,5+14*b2&,289,16+14*b2&
  NEXT b2&
  FOR b1&=1 TO 2
    FOR b2&=0 TO 5
      COLOR 2
      PBOX -40+95*b1&,5+14*b2&,48+95*b1&,16+14*b2&
      READ a$,a&(2*b2&+b1&,0),a&(2*b2&+b1&,1)
      COLOR 1,2
      TEXT -39+95*b1&,14+14*b2&,a$
    NEXT b2&
  NEXT b1&
  COLOR 3,1
  TEXT 6,14,"Tools"
  TEXT 6,28,"View1"
  TEXT 6,42,"View2"
  TEXT 6,56,"Add"
  TEXT 6,70,"Snap"
  TEXT 6,84,"Special"
  TEXT 246,14,"Base"
  TEXT 246,28,"Object"
  TEXT 246,42,"Bezier"
  TEXT 246,56,""
  TEXT 246,70,""
  TEXT 246,84,""
  GRAPHMODE 3
  b11&=-1
  b22&=-1
  IF h&>=6
    PBOX 245,5+14*(h&-6),289,16+14*(h&-6)
  ELSE
    PBOX 5,5+14*h&,48,16+14*h&
  ENDIF
  '  PBOX 5,5,48,16
  WHILE MOUSEK
  WEND
  WHILE but&>0 AND but&<90
    waitsignal(1)
    but&=menu2%
  WEND
  WHILE MOUSEK=0
    waitsignal(1)
    but&=menu2%
    EXIT IF but&>0 AND but&<90
    b1&=MOUSEX
    IF b1&<50
      b1&=0
    ELSE IF b1&>250
      IF b1&<320
        b1&=3
      ENDIF
    ELSE
      b1&=1+(b1&-50)/95
    ENDIF
    b2&=MOUSEY/14
    IF b1&<>b11& OR b2&<>b22&
      IF b2&>=0 AND MOUSEX>0
        IF b1&<4 AND b2&<6
          IF b1&=0
            PBOX 5,5+14*b2&,48,16+14*b2&
          ELSE IF b1&=3
            PBOX 245,5+14*b2&,289,16+14*b2&
          ELSE
            PBOX -40+95*b1&,5+14*b2&,48+95*b1&,16+14*b2&
          ENDIF
          IF b11&>0 AND b22&<>-1 AND b11&<>3
            PBOX -40+95*b11&,5+14*b22&,48+95*b11&,16+14*b22&
          ENDIF
          IF b1&=0 OR b1&=3
            IF h&>=6
              PBOX 245,5+14*(h&-6),289,16+14*(h&-6)
            ELSE
              PBOX 5,5+14*h&,48,16+14*h&
            ENDIF
            IF h&<>b2&-6*(b1&=3)
              h&=b2&-6*(b1&=3)
              spacedata
              COLOR 2
              GRAPHMODE 1
              FOR b11&=1 TO 2
                FOR b22&=0 TO 5
                  PBOX -40+95*b11&,5+14*b22&,48+95*b11&,16+14*b22&
                  READ a$,a&(2*b22&+b11&,0),a&(2*b22&+b11&,1)
                  COLOR 1,2
                  TEXT -39+95*b11&,14+14*b22&,a$
                  COLOR 2
                NEXT b22&
              NEXT b11&
              GRAPHMODE 3
            ENDIF
          ENDIF
          b11&=b1&
          b22&=b2&
        ENDIF
      ENDIF
    ENDIF
    EXIT IF b1&<0 OR b1&>3 OR b2&<-1 OR b2&>7
  WEND
  WHILE but&>0 AND but&<90
    waitsignal(1)
    but&=menu2%
  WEND
  IF MOUSEK OR menu2%=67 OR menu2%=68
    GRAPHMODE 1
    CLOSEW #7
    WHILE MOUSEK
    WEND
    IF b11&>=0 AND b11&<=3 AND b22&>-1 AND b22&<8
      IF a&(2*b22&+b11&,0)=1 !snaps
        but&=a&(2*b22&+b11&,1)
        SELECT but&
        CASE 0 !cur-obj
          IF basact%
            muis%(0)={basact%+b.r&}
            muis%(1)={basact%+b.r&+4}
            muis%(2)={basact%+b.r&+8}
            tekendinges(4,muis%())
          ENDIF
        CASE 1 !cur-grid
          ~DisplayBeep(0)
          x=grid%
          muis%(0)=grid%*ROUND((muis%(0))/x)
          muis%(1)=grid%*ROUND((muis%(1))/x)
          muis%(2)=grid%*ROUND((muis%(2))/x)
          tekendinges(4,muis%())
        CASE 2,6  !obj-grid/muis
          x=grid%
          base%=firstbase%
          WHILE base%
            IF lay& AND WORD{base%+b.l&}
              IF BYTE{base%+b.f&} AND 1
                moving&=1
                tekenbase
                IF but&=6
                  dx%={base%+b.r&}-muis%(0)
                  dy%={base%+b.r&+4}-muis%(1)
                  dz%={base%+b.r&+8}-muis%(2)
                ELSE
                  dx%={base%+b.r&}-grid%*ROUND(({base%+b.r&})/x)
                  dy%={base%+b.r&+4}-grid%*ROUND(({base%+b.r&+4})/x)
                  dz%={base%+b.r&+8}-grid%*ROUND(({base%+b.r&+8})/x)
                ENDIF
                IF {base%+b.p&} AND hie&<>0
                  parentgrab
                  RBOX cmat()=mat()
                  x%=cmat(0,0)*dx%+cmat(0,1)*dy%+cmat(0,2)*dz%
                  dx%=x%
                  y%=cmat(1,0)*dx%+cmat(1,1)*dy%+cmat(1,2)*dz%
                  dy%=y%
                  dz%=cmat(2,0)*dx%+cmat(2,1)*dy%+cmat(2,2)*dz%
                  b%=base%+b.o&
                ELSE
                  b%=base%+b.v&
                ENDIF
                {b%}={b%}-dx%
                {b%+4}={b%+4}-dy%
                {b%+8}={b%+8}-dz%
                moving&=0
                calcu&=-1
                tekenbase
                calcu&=0
              ENDIF
            ENDIF
            base%={base%}
          WEND
        CASE 7,8 !grid-cur/obj
          b%=0
          IF basact% AND but&=8
            b%=basact%+b.r&
          ELSE IF but&=7
            b%=V:muis%(0)
          ENDIF
          IF b%
            x=grid%
            dx%=grid%*ROUND({b%}/x)
            dy%=grid%*ROUND({b%+4}/x)
            dz%=grid%*ROUND({b%+8}/x)
            ADD xc%,{b%}-dx%
            ADD yc%,{b%+4}-dy%
            ADD zc%,{b%+8}-dz%
            {b%}=dx%
            {b%+4}=dy%
            {b%+8}=dz%
            fastprojektie
          ENDIF
        ENDSELECT
      ENDIF
    ENDIF
  ELSE
    GRAPHMODE 1
    CLOSEW #7
    WHILE MOUSEK
    WEND
  ENDIF
  ERASE a&()
  '
  SWAP gx&,x&
  SWAP gy&,y&
  '
RETURN
> PROCEDURE spacedata
  SELECT h&
  CASE 0
    RESTORE toolsdata
  CASE 1
    RESTORE view1data
  CASE 2
    RESTORE view2data
  CASE 3
    RESTORE adddata
  CASE 4
    RESTORE snapdata
  CASE 5
    RESTORE specialdata
  CASE 6
    RESTORE basedata
  CASE 7
    RESTORE objectdata
  CASE 8
    RESTORE bezierdata
  CASE 9
    RESTORE edata
  CASE 10
    RESTORE edata
  CASE 11
    RESTORE edata
  ENDSELECT
  toolsdata:
  DATA "g Grabber",12,0,"r Rotate",12,0,"s Size",12,0
  DATA "",12,0,"{ Cursor",12,0,"} Relasize",12,0
  DATA "b Bord sel",12,0,"a Desel all",12,0,"",12,0
  DATA "",12,0,"",12,0,"",12,0
  view2data:
  DATA "o Obs move",12,0,"t Tar move",12,0,"f Focus",12,0
  DATA "n Names",12,0,"c Centre",12,0,"C ZeroCentre",12,0
  DATA "w Workf set",12,0,"G Gridsize",12,0,"@1-8 StView",12,0
  DATA "@v StoreView",12,0,"",12,0,"",12,0
  view1data:
  DATA "7 Top",12,0,"1 Front",12,0,"3 Right",12,0
  DATA "2 4 6 8 Move",12,0,"0 Observer",12,0,"5 Par/persp",12,0
  DATA "<ent> Wire",12,0,"9 Redraw",12,0,"",12,0
  DATA "",12,0,"- Zoom out",12,0,"+ Zoom in",12,0
  adddata:
  DATA "S Sphere",12,0,"L Lamp",12,0,"K Cube",12,0
  DATA "P Plane",12,0,"D Duplicate",12,0,"M MoveBase",12,0
  DATA "",12,0,"",12,0,"",12,0
  DATA "",12,0,"",12,0,"X Delete",12,0
  snapdata:
  DATA "  Curs->Obj",1,0,"  Curs->Grid",1,1,"  Obj->Grid",1,2
  DATA "",1,3,"",1,4,"  Obj->Path",1,5
  DATA "  Obj->Curs",1,6,"  Grid->Curs",1,7,"  Grid->Obj",1,8
  DATA "",1,9,"",1,10,"  Path->Obj",1,11
  specialdata:
  DATA "Q Quit",12,0,"d Tracedepth",12,0,"p Pointmass",12,0
  DATA "B Render Bor",12,0,"@e Erase all",12,0,"@s XScript",12,0
  DATA "v ViewVolume",12,0,"V SpotVolume",12,0,"h Hierarchy",12,0
  DATA "",12,0,"",12,0,"",12,0
  objectdata:
  DATA "",12,0,"@f Fit word",12,0,"@n RecNormal",12,0
  DATA "@c Copy col",12,0,"@m Mov->Obj",12,0,"@x Copy Efx",12,0
  DATA "",12,0,"",12,0,"",12,0
  DATA "",12,0,"",12,0,"",12,0
  basedata:
  DATA "m MoveToLay",12,0,"@p MakePar",12,0,"@t Track",12,0
  DATA "@w Warp",12,0,"",12,0,"",12,0
  DATA "@a Apply",12,0,"Alt p ClrPar",12,0,"Alt t ClrTrac",12,0
  DATA "Alt w ClrWarp",12,0,"Alt m ClrMat",12,0,"Alt q ClrQuat",12,0
  bezierdata:
  DATA "",12,0,"e Add ",12,0,"",12,0
  DATA "i Insert",12,0,"d Delete",12,0,"c Cyclic",12,0
  DATA "hH CalcHandle",12,0,"vV VectHandle",12,0,"j Speed",12,0
  DATA "",12,0,"",12,0,"m Move",12,0
  edata:
  DATA "",12,0,"",12,0,"",12,0
  DATA "",12,0,"",12,0,"",12,0
  DATA "",12,0,"",12,0,"",12,0
  DATA "",12,0,"",12,0,"",12,0
RETURN
> PROCEDURE perspbuttons
  IF qual& AND 3
    initgrabvars(xc%,yc%,zc%)
    dx&=0
    dy&=0
    IF but&=62
      dy&=-30
    ELSE IF but&=30
      dy&=30
    ELSE IF but&=45
      dx&=-30
    ELSE IF but&=47
      dx&=30
    ENDIF
    IF dx& OR dy&
      IF persp&=-2
        persp&=-1
      ENDIF
      ADD xc%,dx&*mulx1+dy&*muly1
      ADD yc%,dx&*mulx2+dy&*muly2
      ADD zc%,mulz*dy&
      calcphitheta
    ENDIF
    IF but&=&H4A OR but&=&H5E
      x%=0.05*(obs%(0)-tar%(0))
      y%=0.05*(obs%(1)-tar%(1))
      z%=0.05*(obs%(2)-tar%(2))
      IF but&=&H4A
        ADD obs%(0),x%
        ADD obs%(1),y%
        ADD obs%(2),z%
      ELSE
        ADD obs%(0),-x%
        ADD obs%(1),-y%
        ADD obs%(2),-z%
      ENDIF
      bepaalphitheta(1)
      calcphitheta
    ENDIF
    but&=0
  ELSE
    IF persp&=-2
      persp&=-1
    ENDIF
    SELECT but&
    CASE 29,30,31,45,47,61,62
      view&=but&
    ENDSELECT
    SELECT but&
    CASE 63
      thetao=theta
      phio=phi
      bepaalphitheta(1)
      theta=thetao
      phi=phio
      calcu&=-1
    CASE 62
      phi=phi-rad
    CASE 30
      phi=phi+rad
    CASE 45
      theta=theta-rad
    CASE 47
      theta=theta+rad
    CASE 61
      theta=-0.5*PI
      phi=0
    CASE 29
      theta=-0.5*PI
      phi=0.5*PI
    CASE 31
      theta=0
      phi=0.5*PI
    CASE &H5E
      IF dproj<50
        dproj=dproj*1.2
      ELSE
        okee("Too far!")
      ENDIF
    CASE &H4A
      IF dproj>0.005
        dproj=dproj*0.83333
      ELSE
        okee("Too close")
      ENDIF
    CASE 46
      IF persp&=0
        persp&=-1
      ELSE
        persp&=0
      ENDIF
    CASE 15  !0
      persp&=-2
      theta=thetao
      phi=phio
      bepaalphitheta(1)
      view&=0
    ENDSELECT
    calcphitheta
  ENDIF
RETURN
> PROCEDURE menumuis
  IF MOUSEY>10
    OPENW #1
    xm&=MOUSEX
    ym&=MOUSEY
    IF MOUSEK=1
      IF sprof&=0
        pointer1%=@allocblock(100,&H10003)             ! pointer uitschakelen
        ~SetPointer(WINDOW(1),pointer1%,0,0,0,0)
        initgrabvars(muis%(0),muis%(1),muis%(2))
        WHILE MOUSEK
          xm&=MOUSEX
          ym&=MOUSEY
          dx&=xm&-xmo&
          dy&=ym&-ymo&
          dx%=dx&*mulx1+dy&*muly1
          dy%=dx&*mulx2+dy&*muly2
          dz%=mulz*dy&
          ADD muis%(0),dx%
          ADD muis%(1),dy%
          ADD muis%(2),dz%
          xmo&=xm&
          ymo&=ym&
          ~MoveSprite(vpspr%,spr.mem%,xm&-14,ym&-12)
          waitsignal(1)
        WEND
        ~ClearPointer(WINDOW(1))
        freeblock(pointer1%)
      ENDIF
    ELSE IF MOUSEK AND 2
      x&=60
      IF ebase%
        base%=ebase%
        IF (MOUSEK AND 4)<>0 OR (qual& AND 64)=64
          ebase%=0
          tekenbase
          IF lay& AND WORD{base%+b.l&}
            drawdp(0,3)
          ENDIF
        ELSE IF lay& AND WORD{base%+b.l&}
          tekenbase
          beziermuis
        ENDIF
        x&=100
      ELSE IF firstbase%
        base%=firstbase%
        WHILE base%
          IF lay& AND WORD{base%+b.l&}
            y&=ABS(xm&-WORD{base%+b.s&})+ABS(ym&-WORD{base%+b.s&+2})
            IF basact%=base%
              ADD y&,10
            ENDIF
            IF y&<x&
              x&=y&
              sel%=base%
            ENDIF
          ENDIF
          base%={base%}
        WEND
      ENDIF
      IF x&<60
        IF (qual& AND 3)=0
          deselectall
        ENDIF
        IF sel%
          base%=sel%
          IF BYTE{base%+b.f&} AND 1
            BYTE{base%+b.f&}=BYTE{base%+b.f&}-1
          ELSE
            BYTE{base%+b.f&}=BYTE{base%+b.f&}+1
          ENDIF
          IF (MOUSEK AND 4)<>0 OR (qual& AND 64)=64
            IF WORD{base%+4}=-2
              BYTE{base%+b.f&}=BSET(BYTE{base%+b.f&},0)
              ebase%=base%
              dp&=2
            ENDIF
          ENDIF
          tekenbase
          actuheader
          IF main&=3 AND (WORD{base%+4} AND 1)
            IF basact%<>sel%
              basact%=sel%
              adrob%={base%+b.d&}
              colact&=1
              OPENW #3
              IF WORD{base%+4}=3
                adrcol%=adrob%+32
                colt&=1
              ELSE
                adrcol%=adrob%+80
                colt&=BYTE{adrob%+o.c&}
              ENDIF
              defbutton(11,5,3,48,V:colact&,170,58,80,17,1,colt&,STR$(colt&)+" Col:")
              @printobjectdata
            ENDIF
          ELSE IF main&=4 AND WORD{base%+4}=2
            @printlampdata
          ELSE IF main&=6
            OPENW #3
            GRAPHMODE 1
            COLOR 0,0
            PBOX 50,6,176,18
            IF {sel%+b.n&}<>0
              a$=SPACE$(14)
              BMOVE sel%+b.n&,V:a$,14
              teststring(a$)
              a&=WORD{sel%+b.n&+14}
              IF a&
                a$=a$+"."+STR$(a&)
              ENDIF
              COLOR 1,0
              TEXT 52,16,a$
            ENDIF
            sta&=WORD{sel%+b.sf&}
            a$="Sta:"
            setbutton(8,3)
            leesflags(sel%)
            FOR a&=24 TO 32
              setbutton(a&,3)
            NEXT a&
            setbutton(35,3)
            IF WORD{sel%+4}=-2
              ob%={sel%+b.d&}
              frs&=WORD{ob%+m.f&}
              a$="Len:"
              setbutton(15,3)
              cycl&=((BYTE{ob%+m.f&+2} AND 1)=1)
              bez&=({ob%}<>0)
              qke&=({ob%+12}<>0)
              qfi&=(WORD{ob%+m.qf&}<>0)
              qfo&=(WORD{ob%+m.qfo&}<>0)
              mke&=({ob%+20}<>0)
            ELSE
              CLR cycl&,bez&,qke&,qfi&,qfo&,mke&
            ENDIF
            setbutton(14,3)
            FOR a&=16 TO 20
              setbutton(a&,3)
            NEXT a&
          ENDIF
          basact%=sel%
        ENDIF
      ENDIF
    ENDIF
    WHILE MOUSEK
      EXIT IF MOUSEK=4
    WEND
  ENDIF
RETURN
> PROCEDURE nearestpoint
  drawdp(0,3)
  dpo&=dp&
  xm&=MOUSEX
  ym&=MOUSEY
  IF dp&
    handlepoints
    persp(hx1%,hy1%,hz1%)
    afst1%=(xm&-x&)^2+(ym&-y&)^2
    persp(hx2%,hy2%,hz2%)
    afst2%=(xm&-x&)^2+(ym&-y&)^2
    mafst%=MIN(afst1%,afst2%)
  ELSE
    mafst%=100
  ENDIF
  IF mafst%<30
    IF afst1%<afst2%
      hand&=1
    ELSE
      hand&=2
    ENDIF
    handle&=TRUE
  ELSE
    mafst%=1000000
    dp&=0
    temp%=spline%+72
    FOR b&=2 TO np&-1
      persp({temp%},{temp%+4},{temp%+8})
      x&=ABS(xm&-x&)+ABS(ym&-y&)
      IF x&<mafst%
        mafst%=x&
        dp&=b&
      ENDIF
      ADD temp%,36
    NEXT b&
    handle&=FALSE
  ENDIF
  drawdp(2,3)
RETURN
> PROCEDURE beziermuis
  handle&=0
  nearestpoint
  IF dpo&=dp&
    IF handle&
      pointer1%=@allocblock(100,&H10003)             ! pointer uitschakelen
      ~SetPointer(WINDOW(1),pointer1%,0,0,0,0)
      ~ActivateWindow(WINDOW(1))
      changehandles
      WHILE MOUSEK=2
        waitsignal(1)
      WEND
      ~ClearPointer(WINDOW(1))
      freeblock(pointer1%)
      handle&=0
      beziertobase
    ELSE
      handle&=0
      IF dp&
        IF mafst%<30
          temp2%=spline%+36*dp&
          xorg%={temp2%}
          yorg%={temp2%+4}
          zorg%={temp2%+8}
          initgrabvars(xorg%,yorg%,zorg%)
          '
          b1&=dp&-1
          b2&=dp&
          IF NOT cyclic&
            IF b1&<2
              b1&=2
            ENDIF
            IF b2&>np&-2
              b2&=np&-2
            ENDIF
          ENDIF
          ' pointer1%=@allocblock(100,&H10003)             ! pointer uitschakelen
          ' ~SetPointer(WINDOW(1),pointer1%,0,0,0,0)
          ' ~ActivateWindow(WINDOW(1))
          xo&=MOUSEX
          yo&=MOUSEY
          change&=0
          WHILE MOUSEK=2
            xm&=MOUSEX
            ym&=MOUSEY
            IF xo&<>xm& OR yo&<>ym&
              change&=-1
              tekenstuk(b1&,b2&,0)
              drawdp(0,0)
              IF speed&
                {temp2%}=xm&
                {temp2%+4}=ym&
              ELSE
                dx&=xm&-xo&
                dy&=ym&-yo&
                xo&=xm&
                yo&=ym&
                {temp2%}={temp2%}+dx&*mulx1+dy&*muly1
                {temp2%+4}={temp2%+4}+dx&*mulx2+dy&*muly2
                {temp2%+8}={temp2%+8}+mulz*dy&
              ENDIF
              tekenstuk(b1&,b2&,3)
              drawdp(2,3)
            ENDIF
            waitsignal(1)
          WEND
          ' IF MOUSEK AND 4
          ' {temp2%}=xorg%
          ' {temp2%+4}=yorg%
          ' {temp2%+8}=zorg%
          ' ENDIF
          ' ~ClearPointer(WINDOW(1))
          ' freeblock(pointer1%)
          IF change&
            beziertobase
          ENDIF
        ENDIF
      ENDIF
    ENDIF
  ENDIF
RETURN
> PROCEDURE beziertoets
  change&=0
  base%=ebase%
  tekenbase
  IF cyclic&
    b1&=np&-1
  ELSE
    b1&=np&-2
  ENDIF
  i&=menu2%
  SELECT i&
  CASE &H37   ! M
    ' IF speed&
    ' snelheid
    ' perspline
    ' ENDIF
    rekenpad(1)
    ' tekenspline.ar(3)
  CASE &H17                 ! Insert
    change&=-1
    IF np&<>2
      IF dp&<np&-1 AND dp&>2
        tekenstuk(2,b1&,0)
        drawdp(0,0)
        s1%=spline%-36+36*dp&
        s3%=s1%+72
        len1%=SQR(({s1%}-muis%(0))^2+({s1%+4}-muis%(1))^2+({s1%+8}-muis%(2))^2)
        len%=SQR(({s3%}-muis%(0))^2+({s3%+4}-muis%(1))^2+({s3%+8}-muis%(2))^2)
        IF len1%<len%
          BMOVE spline%+36*dp&,spline%+36+36*dp&,36*(np&-dp&)
          s%=spline%+36*dp&
        ELSE
          BMOVE spline%+36+36*dp&,spline%+72+36*dp&,36*(np&-dp&-1)
          s%=spline%+36*dp&+36
          ADD dp&,1
        ENDIF
        ADD np&,1
        {s%}=muis%(0)
        {s%+4}=muis%(1)
        {s%+8}=muis%(2)
        calchandles(np&-1)
        tekenstuk(2,b1&+1,3)
        drawdp(2,3)
      ENDIF
    ELSE
    ENDIF
  CASE &H33                 ! CyclicBezier
    IF speed&=FALSE
      change&=-1
      vv%={{ebase%+b.d&}}
      cyclic&=BTST(BYTE{vv%+2},0)
      cyclic&=NOT cyclic&
      IF cyclic&
        cyclic
        tekenstuk(2,np&-2,0)
        BYTE{vv%+2}=BSET(BYTE{vv%+2},0)
        tekenstuk(2,np&-1,3)
      ELSE
        tekenstuk(2,np&-1,0)
        BYTE{vv%+2}=BCLR(BYTE{vv%+2},0)
        tekenstuk(2,np&-2,3)
      ENDIF
    ENDIF
  CASE &H34                 ! Vector
    change&=-1
    tekenstuk(2,b1&,0)
    drawdp(0,0)
    IF menu3% AND 3
      start&=2
      eind&=np&-1-cyclic&
    ELSE
      start&=dp&
      eind&=dp&
    ENDIF
    IF start&
      temp%=spline%+start&*36
      FOR a&=start& TO eind&
        {temp%+12}=(2*{temp%}+{temp%-36})/3-{temp%}
        {temp%+16}=(2*{temp%+4}+{temp%-32})/3-{temp%+4}
        {temp%+20}=(2*{temp%+8}+{temp%-28})/3-{temp%+8}
        {temp%+24}=(2*{temp%}+{temp%+36})/3-{temp%}
        {temp%+28}=(2*{temp%+4}+{temp%+40})/3-{temp%+4}
        {temp%+32}=(2*{temp%+8}+{temp%+44})/3-{temp%+8}
        ADD temp%,36
      NEXT a&
    ENDIF
    tekenstuk(2,b1&,3)
    drawdp(2,3)
  CASE &H22                 ! Delete
    change&=-1
    IF dp& AND np&>(4+speed&)
      tekenstuk(2,b1&,0)
      drawdp(0,0)
      temp%=spline%+dp&*36
      len%=(np&-dp&)*36
      BMOVE temp%+36,temp%,len%
      SUB np&,1
      IF dp&<>2
        SUB dp&,1
      ENDIF
      cyclic
      tekenstuk(2,b1&-1,3)
      drawdp(2,3)
    ENDIF
  CASE &H12                ! E
    change&=-1
    ' IF speed&
    ' {temp%}=smx&
    ' {temp%+4}=smy&
    ' {temp%}=xmo&
    ' {temp%+4}=ymo&
    ' ELSE
    tekenstuk(2,b1&,0)
    drawdp(0,0)
    temp%=0
    IF dp&=np&-1
      temp%=spline%+36*np&
      ADD dp&,1
    ELSE IF dp&=2
      temp%=spline%+72
      BMOVE temp%,temp%+36,np&*36
    ENDIF
    IF temp%=0
      tekenstuk(2,b1&,3)
      drawdp(2,3)
    ELSE
      {temp%}=muis%(0)
      {temp%+4}=muis%(1)
      {temp%+8}=muis%(2)
      ADD np&,1
      ' calchandles(dp&)
      cyclic
      calchandle(dp&)
      IF cyclic&
        calchandle(2)
        calchandle(np&)
      ENDIF
      tekenstuk(2,b1&+1,3)
      drawdp(2,3)
    ENDIF
  CASE &H25                ! Handle
    change&=-1
    tekenstuk(2,b1&,0)
    drawdp(0,0)
    IF (menu3% AND 3)=0
      IF dp&
        calchandle(dp&)
      ENDIF
    ELSE
      FOR a&=2 TO np&+(cyclic&=0)
        calchandle(a&)
      NEXT a&
    ENDIF
    tekenstuk(2,b1&,3)
    drawdp(2,3)
  CASE &H26                ! (J) Swap
    ' snelheid
    ' IF speed&
    ' visible(12)
    ' FRONTS 12
    ' PLOT 0,0
    ' CLEARW #12
    ' OPENW #12
    ' COLOR 1
    ' BOX 0,256,700,257
    ' tekenspline.ar(2)
    ' ELSE
    ' invisible(12)
    ' FRONTS 1
    ' OPENW #1
    ' perspline
    ' ENDIF
  ENDSELECT
  IF change&
    beziertobase
  ENDIF
RETURN
> PROCEDURE beziertobase
  base%=ebase%
  parentbase(base%)
  ob%={base%+b.d&}
  vv%={ob%}
  WORD{vv%}=np&
  a%={vv%}
  freeblock(vv%)
  vv%=@allocblock(4+(np&-2)*36,&H10001)
  {ob%}=vv%
  {vv%}=a%
  s%=spline%+72
  a%=vv%+4
  mb&=0
  IF @eenh.mat(V:mat(0,0))=0
    mb&=-1
    RBOX bmat()=mat()
  ENDIF
  s1%=spline%+60+36*(np&-2)
  b1&=3
  FOR s%=spline%+72 TO s1% STEP 12
    IF b1&=3
      b1&=0
      x%={s%}-xt%
      y%={s%+4}-yt%
      z%={s%+8}-zt%
    ELSE
      x%={s%}
      y%={s%+4}
      z%={s%+8}
    ENDIF
    IF mb& !is een andere mb, zie boven
      {a%}=bmat(0,0)*x%+bmat(0,1)*y%+bmat(0,2)*z%
      {a%+4}=bmat(1,0)*x%+bmat(1,1)*y%+bmat(1,2)*z%
      {a%+8}=bmat(2,0)*x%+bmat(2,1)*y%+bmat(2,2)*z%
    ELSE
      {a%}=x%
      {a%+4}=y%
      {a%+8}=z%
    ENDIF
    ADD b1&,1
    ADD a%,12
  NEXT s%
  rekenpad(14)
RETURN
> PROCEDURE initgrabvars(x%,y%,z%)
  pointo2d(x%,y%,z%)
  muly=z1/d&
  mulz=-v2*muly
  mulx1=-v1*muly
  mulx2=w1*muly
  muly1=muly*w1w2
  muly2=muly*v1w2
RETURN
> PROCEDURE grabber
  IF firstbase%
    moving&=1
    i$=""
    rt&=0
    base%=firstbase%
    WHILE base%
      IF lay& AND WORD{base%+b.l&}
        a&=BYTE{base%+b.f&}
        IF a& AND 1
          IF rt&=0
            SWAP bitpl3%,bitpl12%
            {SCREEN(1)+184+16}=bitpl12%
            {SCREEN(12)+184+8}=bitpl3%
            CLEARW #12
            OPENW #1
            BYTE{SCREEN(1)+184+5}=3
            initgrabvars({base%+b.r&},{base%+b.r&+4},{base%+b.r&+8})
          ENDIF
          tekenbase
          ADD rt&,1
        ELSE IF hie&
          b%=0
          IF {base%+b.p&}
            b%={base%+b.p&}
            WHILE b%
              IF lay& AND WORD{b%+b.l&}
                EXIT IF BYTE{b%+b.f&} AND 1
              ENDIF
              b%={b%+b.p&}
            WEND
          ENDIF
          IF {base%+b.t&} AND b%=0
            b%=(BYTE{{base%+b.t&}+b.f&} AND 1)
          ENDIF
          IF b%
            BYTE{base%+b.f&}=BSET(a&,1)
            tekenbase
          ELSE
            BYTE{base%+b.f&}=BCLR(a&,1)
          ENDIF
        ENDIF
      ENDIF
      base%={base%}
    WEND
    IF rt&
      ~RemakeDisplay()
      base%=firstbase%
      adrot%=@allocblock(12*rt&,&H10001)
      a%=adrot%
      WHILE base%
        IF lay& AND WORD{base%+b.l&}
          IF BYTE{base%+b.f&} AND 1
            IF {base%+b.p&} AND hie&<>0
              b%=base%+b.o&
            ELSE
              b%=base%+b.v&
            ENDIF
            {a%}={b%}
            {a%+4}={b%+4}
            {a%+8}={b%+8}
            ADD a%,12
          ENDIF
        ENDIF
        base%={base%}
      WEND
      moving&=-1
      xn&=MOUSEX
      yn&=MOUSEY
      xm&=xn&-1
      ym&=yn&
      xg%=0
      yg%=0
      zg%=0
      calcu&=-1
      WHILE MOUSEK=0 AND i$=""
        waitsignal(1)
        but&=menu2%
        IF but&<90 AND but&>0
          i$="a"
          IF but&=64 OR but&=&H45
            i$=" "
          ENDIF
        ENDIF
        IF MOUSEX<>xm& OR MOUSEY<>ym&
          OPENW #1
          xm&=MOUSEX
          ym&=MOUSEY
          dx&=xn&-xm&
          dy&=yn&-ym&
          dx%=dx&*mulx1+dy&*muly1
          dy%=dx&*mulx2+dy&*muly2
          dz%=mulz*dy&
          OPENW #12
          base%=firstbase%
          adro%=adrot%
          WHILE base%
            IF lay& AND WORD{base%+b.l&}
              IF BYTE{base%+b.f&} AND 1
                IF {base%+b.p&} AND hie&<>0
                  parentbase(base%)
                  RBOX cmat()=omat()
                  x%=cmat(0,0)*dx%+cmat(0,1)*dy%+cmat(0,2)*dz%
                  y%=cmat(1,0)*dx%+cmat(1,1)*dy%+cmat(1,2)*dz%
                  z%=cmat(2,0)*dx%+cmat(2,1)*dy%+cmat(2,2)*dz%
                  b%=base%+b.o&
                  {b%}={adro%}-x%
                  {b%+4}={adro%+4}-y%
                  {b%+8}={adro%+8}-z%
                ELSE
                  b%=base%+b.v&
                  {b%}={adro%}-dx%
                  {b%+4}={adro%+4}-dy%
                  {b%+8}={adro%+8}-dz%
                ENDIF
                ADD adro%,12
                tekenbase
              ENDIF
            ENDIF
            base%={base%}
          WEND
          base%=firstbase%
          IF hie&
            WHILE base%
              IF lay& AND WORD{base%+b.l&}
                IF (BYTE{base%+b.f&} AND 2)=2
                  tekenbase
                ENDIF
              ENDIF
              base%={base%}
            WEND
          ENDIF
          SWAP bitpl3%,bitpl12%
          {SCREEN(1)+184+16}=bitpl12%
          {SCREEN(12)+184+8}=bitpl3%
          ~RemakeDisplay()
          CLEARW #12
        ENDIF
      WEND
      OPENW #1
      BYTE{SCREEN(1)+184+5}=2
      ~RemakeDisplay()
      WHILE INKEY$<>""
      WEND
      IF i$=" "
        base%=firstbase%
        adro%=adrot%
        WHILE base%
          IF lay& AND WORD{base%+b.l&}
            IF BYTE{base%+b.f&} AND 1
              IF {base%+b.p&} AND hie&<>0
                b%=base%+b.o&
              ELSE
                b%=base%+b.v&
              ENDIF
              {b%}={adro%}
              {b%+4}={adro%+4}
              {b%+8}={adro%+8}
              ADD adro%,12
            ENDIF
          ENDIF
          base%={base%}
        WEND
      ENDIF
      xg%=0
      yg%=0
      zg%=0
      freeblock(adrot%)
      moving&=0
      base%=firstbase%
      OPENW #1
      WHILE base%
        IF lay& AND WORD{base%+b.l&}
          IF BYTE{base%+b.f&} AND 3
            tekenbase
          ENDIF
        ENDIF
        base%={base%}
      WEND
      calcu&=0
      i$=""
      WHILE MOUSEK
      WEND
    ENDIF
  ENDIF
  moving&=0
RETURN
'  hieronder  misschien niet meer nodig: omat() !
> PROCEDURE parentgrab
  RBOX mat()
  mat(0,0)=1
  mat(1,1)=1
  mat(2,2)=1
  b%={base%+b.p&}
  IF b%<>0 AND hie&
    WHILE b%
      IF WORD{b%+4}=-2
        IF BTST(BYTE{b%+b.f&+1},0)
          quatmograb
          ' matmograb
        ELSE
          ' matmograb
          quatmograb
        ENDIF
      ENDIF
      qb&=BTST(BYTE{b%+b.f&},2)+1
      mb&=BTST(BYTE{b%+b.f&},3)+1
      IF BTST(BYTE{b%+b.f&+1},0)
        quatgrab
        matgrab
      ELSE
        matgrab
        quatgrab
      ENDIF
      b%={b%+b.p&}
    WEND
  ENDIF
RETURN
> PROCEDURE quatgrab
  IF qb&
    IF BTST(BYTE{b%+b.f&+1},1)
      q(0,0)=FLOAT{b%+b.q&}
      q(0,1)=FLOAT{b%+b.q&+8}
      q(0,2)=FLOAT{b%+b.q&+16}
      q(0,3)=FLOAT{b%+b.q&+24}
      quadtomat(0,imat())
      RBOX cmat()=mat()*imat()
      RBOX mat()=cmat()
    ENDIF
  ENDIF
RETURN
> PROCEDURE matgrab
  IF mb&
    IF BTST(BYTE{b%+b.f&+1},4)
      BMOVE b%+b.m&,V:bmat(0,0),72
      RBOX cmat()=mat()*bmat()
      RBOX mat()=cmat()
    ENDIF
  ENDIF
RETURN
> PROCEDURE quatmograb
  ob%={b%+b.d&}
  b1&=0
  IF WORD{ob%+m.qf&}
    calcfillquat
    b1&=-1
  ELSE IF WORD{ob%+m.qfo&}
    followpath
    b1&=-1
  ENDIF
  IF b1&
    quadtomat(0,tmat())
    RBOX cmat()=mat()*tmat()
    RBOX mat()=cmat()
  ENDIF
RETURN
> PROCEDURE matmograb
  BMOVE b%+b.m&,V:tmat(0,0),72
  IF BTST(BYTE{b%+b.f&+1},4)
    x%=xt%
    y%=yt%
    z%=zt%
    xt%=tmat(0,0)*x%+tmat(0,1)*y%+tmat(0,2)*z%
    yt%=tmat(1,0)*x%+tmat(1,1)*y%+tmat(1,2)*z%
    zt%=tmat(2,0)*x%+tmat(2,1)*y%+tmat(2,2)*z%
  ENDIF
  b1&=0
  IF BTST(BYTE{b%+b.f&+1},5)
    b1&=1
  ELSE IF BTST(BYTE{b%+b.f&+1},6)
    b1&=2
  ENDIF
  IF b1&
    IF b1&=1
      RBOX cmat()=mat()*tmat()
    ELSE
      RBOX cmat()=tmat()*mat()
    ENDIF
    RBOX mat()=cmat()
  ENDIF
RETURN
'
> PROCEDURE movedinges(soort&,VAR t%())
  xm&=MOUSEX
  ym&=MOUSEY
  xn&=x&
  yn&=y&
  i$=""
  sn%(0)=t%(0)
  sn%(1)=t%(1)
  sn%(2)=t%(2)
  initgrabvars(t%(0),t%(1),t%(2))
  GRAPHMODE 3
  tekendinges(-soort&,sn%())
  xg%=0
  yg%=0
  zg%=0
  WHILE MOUSEK=0 AND i$=""
    waitsignal(1)
    IF menu1%=&H400
      but&=menu2%
      IF but&<90
        i$="a"
        IF but&=64 OR but&=&H45
          i$=" "
        ENDIF
      ENDIF
    ENDIF
    IF MOUSEX<>xn& OR MOUSEY<>yn&
      xn&=MOUSEX
      yn&=MOUSEY
      sn%(0)=t%(0)-xg%
      sn%(1)=t%(1)-yg%
      sn%(2)=t%(2)-zg%
      tekendinges(-soort&,sn%())
      dx&=xm&-xn&
      dy&=ym&-yn&
      xg%=dx&*mulx1+dy&*muly1
      yg%=dx&*mulx2+dy&*muly2
      zg%=mulz*dy&
      sn%(0)=t%(0)-xg%
      sn%(1)=t%(1)-yg%
      sn%(2)=t%(2)-zg%
      tekendinges(-soort&,sn%())
    ENDIF
  WEND
  WHILE MOUSEK
    VSYNC
  WEND
  WHILE INKEY$<>""
  WEND
  IF i$<>" "
    GRAPHMODE 1
    SUB t%(0),xg%
    SUB t%(1),yg%
    SUB t%(2),zg%
    t00=phi
    t01=theta
    bepaalphitheta(1)
    IF persp&<>-2
      phi=t00
      theta=t01
    ENDIF
    calcphitheta
    fastprojektie
    IF dia>4000000
      IF soort&=1
        okee("Observer too far!")
      ELSE
        okee("Target too far!")
      ENDIF
    ENDIF
  ELSE
    GRAPHMODE 3
    tekendinges(-soort&,sn%())
    GRAPHMODE 1
    tekendinges(soort&,t%())
  ENDIF
  xg%=0
  yg%=0
  zg%=0
  i$=""
RETURN
> PROCEDURE rotate
  IF firstbase%
    moving&=1
    i$=""
    xc&=0
    yc&=0
    rt&=0
    base%=firstbase%
    WHILE base%
      IF lay& AND WORD{base%+b.l&}
        a&=BYTE{base%+b.f&}
        IF a& AND 1
          IF rt&=0
            SWAP bitpl3%,bitpl12%
            {SCREEN(1)+184+16}=bitpl12%
            {SCREEN(12)+184+8}=bitpl3%
            CLEARW #12
            OPENW #1
            BYTE{SCREEN(1)+184+5}=3
            initgrabvars({base%+b.r&},{base%+b.r&+4},{base%+b.r&+8})
          ENDIF
          tekenbase
          ADD xc&,WORD{base%+b.s&}
          ADD yc&,WORD{base%+b.s&+2}
          ADD rt&,1
          BYTE{base%+b.f&}=BCLR(BYTE{base%+b.f&},2) !eenheidsquatflag
        ELSE IF hie&
          b%=0
          IF {base%+b.p&}
            b%={base%+b.p&}
            WHILE b%
              IF lay& AND WORD{b%+b.l&}
                EXIT IF BYTE{b%+b.f&} AND 1
              ENDIF
              b%={b%+b.p&}
            WEND
          ENDIF
          IF {base%+b.t&} AND b%=0
            b%=(BYTE{{base%+b.t&}+b.f&} AND 1)
          ENDIF
          IF b%
            BYTE{base%+b.f&}=BSET(a&,1)
            tekenbase
          ELSE
            BYTE{base%+b.f&}=BCLR(a&,1)
          ENDIF
        ENDIF
      ENDIF
      base%={base%}
    WEND
    IF rt&
      ~RemakeDisplay()
      adrot%=@allocblock(44*rt&,&H10001)
      a%=adrot%
      base%=firstbase%
      WHILE base%
        IF lay& AND WORD{base%+b.l&}
          IF BYTE{base%+b.f&} AND 1
            {a%}={base%+b.v&}
            {a%+4}={base%+b.v&+4}
            {a%+8}={base%+b.v&+8}
            BMOVE base%+b.q&,a%+12,32
            ADD a%,44
          ENDIF
        ENDIF
        base%={base%}
      WEND
      moving&=-1
      calcu&=-1
      xn&=MOUSEX
      yn&=MOUSEY
      IF cursor&
        tekendinges(4,muis%())
        xc&=xm&
        yc&=ym&
        cex%=muis%(0)
        cey%=muis%(1)
        cez%=muis%(2)
      ELSE
        xc&=xc&/rt&
        yc&=yc&/rt&
        IF rt&>1
          y&=-256+yc&
          x&=xc&-320
          SUB cursor&,2
          cex%=x&*mulx1+y&*muly1
          cey%=x&*mulx2+y&*muly2
          cez%=mulz*y&
          IF persp&<>-2
            ADD cex%,xc%
            ADD cey%,yc%
            ADD cez%,zc%
          ENDIF
        ENDIF
      ENDIF
      hoeko=0
      hoek=0.001
      dx1&=MOUSEX-xc&
      dy1&=MOUSEY-yc&
      WHILE MOUSEK=0 AND i$=""
        waitsignal(1)
        but&=menu2%
        qual&=menu3%
        IF but&<90 AND but&>0
          i$="a"
          IF but&=64 OR but&=&H45
            i$=" "
          ENDIF
        ENDIF
        OPENW #1
        dx2&=MOUSEX-xc&
        dy2&=MOUSEY-yc&
        deler=SQR((dx1&^2+dy1&^2)*(dx2&^2+dy2&^2))
        IF deler<>0
          choek=(dx1&*dx2&+dy1&*dy2&)/deler
          dhoek=180*ACOS(choek)*SGN(dx1&*dy2&-dx2&*dy1&)/PI
          '
          IF qual& AND 1
            ADD hoek,dhoek/30
          ELSE
            ADD hoek,dhoek
          ENDIF
          IF hoek>=360
            hoek=hoek-360
          ELSE IF hoek<=-360
            hoek=hoek+360
          ENDIF
          IF qual& AND 8
            IF qual& AND 1
              hoek=ROUND(hoek)
            ELSE
              hoek=5*INT(hoek/5+0.5)
            ENDIF
          ENDIF
          IF ABS(hoek)>=360
            IF hoek>0
              SUB hoek,360
            ELSE
              ADD hoek,360
            ENDIF
          ENDIF
          IF hoek<>hoeko
            dx1&=dx2&
            dy1&=dy2&
            LOCATE 1,6
            PRINT ROUND(hoek,1);"    "
            si=SINQ(hoek/2)
            co=COSQ(hoek/2)
            q(1,0)=co
            q(1,1)=si*persinv(0,2)
            q(1,2)=si*persinv(1,2)
            q(1,3)=si*persinv(2,2)
            quadtomat(1,tmat())
            OPENW #12
            base%=firstbase%
            adro%=adrot%+12
            WHILE base%
              IF lay& AND WORD{base%+b.l&}
                IF BYTE{base%+b.f&} AND 1
                  a&=0
                  IF hie&
                    q(3,0)=1
                    q(3,1)=0
                    q(3,2)=0
                    q(3,3)=0
                    b%={base%+b.p&}
                    IF b%
                      WHILE b%
                        IF BYTE{b%+b.f&+1} AND 12
                          q(5,0)=FLOAT{b%+b.q&}
                          q(5,1)=FLOAT{b%+b.q&+8}
                          q(5,2)=FLOAT{b%+b.q&+16}
                          q(5,3)=FLOAT{b%+b.q&+24}
                          quadmul(5,3,3)
                          IF WORD{b%+4}=-2
                            ob%={b%+b.d&}
                            IF WORD{ob%+m.qf&}
                              calcfillquat
                              quadmul(0,3,3)
                            ELSE IF WORD{ob%+m.qfo&}
                              followpath
                              quadmul(0,3,3)
                            ENDIF
                          ENDIF
                        ENDIF
                        b%={b%+b.p&}
                      WEND
                      a&=-1
                    ENDIF
                    IF {base%+b.t&}
                      BMOVE adro%,base%+b.q&,32
                      q(5,0)=FLOAT{adro%}
                      q(5,1)=FLOAT{adro%+8}
                      q(5,2)=FLOAT{adro%+16}
                      q(5,3)=FLOAT{adro%+24}
                      quadmul(5,3,3)
                      quadtomat(3,mat())
                      xt%={base%+b.r&}
                      yt%={base%+b.r&+4}
                      zt%={base%+b.r&+8}
                      calctrack(base%)
                      q(3,0)=q(0,0)
                      q(3,1)=q(0,1)
                      q(3,2)=q(0,2)
                      q(3,3)=q(0,3)
                      a&=-1
                    ENDIF
                  ENDIF
                  q(5,0)=FLOAT{adro%}
                  q(5,1)=FLOAT{adro%+8}
                  q(5,2)=FLOAT{adro%+16}
                  q(5,3)=FLOAT{adro%+24}
                  IF a&
                    quadmul(3,5,5)
                    quadmul(1,5,5)
                    q(3,0)=-q(3,0)
                    quadmul(3,5,2)
                  ELSE
                    quadmul(1,5,2)
                  ENDIF
                  FLOAT{base%+b.q&}=q(2,0)
                  FLOAT{base%+b.q&+8}=q(2,1)
                  FLOAT{base%+b.q&+16}=q(2,2)
                  FLOAT{base%+b.q&+24}=q(2,3)
                  IF cursor& AND a&=0
                    x(0)={adro%-12}-cex%
                    x(1)={adro%-8}-cey%
                    x(2)={adro%-4}-cez%
                    RBOX y()=tmat()*x()
                    {base%+b.v&}=y(0)+cex%
                    {base%+b.v&+4}=y(1)+cey%
                    {base%+b.v&+8}=y(2)+cez%
                  ENDIF
                  tekenbase
                  ADD adro%,44
                ENDIF
              ENDIF
              base%={base%}
            WEND
            base%=firstbase%
            IF hie&
              WHILE base%
                IF lay& AND WORD{base%+b.l&}
                  IF (BYTE{base%+b.f&} AND 2)=2
                    tekenbase
                  ENDIF
                ENDIF
                base%={base%}
              WEND
            ENDIF
            SWAP bitpl3%,bitpl12%
            {SCREEN(1)+184+16}=bitpl12%
            {SCREEN(12)+184+8}=bitpl3%
            ~RemakeDisplay()
            CLEARW #12
          ENDIF
        ENDIF
        hoeko=hoek
      WEND
      OPENW #1
      BYTE{SCREEN(1)+184+5}=2
      ~RemakeDisplay()
      WHILE INKEY$<>""
      WEND
      moving&=0
      IF i$=" " OR hoek=0
        base%=firstbase%
        adro%=adrot%
        WHILE base%
          IF lay& AND WORD{base%+b.l&}
            IF BYTE{base%+b.f&} AND 1
              BMOVE adro%,base%+b.v&,12
              BMOVE adro%+12,base%+b.q&,32
              ADD adro%,44
              IF FLOAT{base%+b.q&}=1
                BYTE{base%+b.f&}=BSET(BYTE{base%+b.f&},2)
              ENDIF
              tekenbase
            ENDIF
          ENDIF
          base%={base%}
        WEND
        base%=firstbase%
        WHILE base%
          IF lay& AND WORD{base%+b.l&}
            IF BYTE{base%+b.f&} AND 2
              tekenbase
            ENDIF
          ENDIF
          base%={base%}
        WEND
        calcu&=0
      ELSE
        calcu&=0
        base%=firstbase%
        OPENW #1
        WHILE base%
          IF lay& AND WORD{base%+b.l&}
            IF BYTE{base%+b.f&} AND 1
              IF FLOAT{base%+b.q&}=1
                BYTE{base%+b.f&}=BSET(BYTE{base%+b.f&},2)
              ENDIF
              tekenbase
            ELSE IF BYTE{base%+b.f&} AND 2
              tekenbase
            ENDIF
          ENDIF
          base%={base%}
        WEND
      ENDIF
      freeblock(adrot%)
      adrot%=0
      i$=""
      WHILE MOUSEK
      WEND
    ENDIF
  ENDIF
  moving&=0
  IF cursor&=-2
    cursor&=0
  ENDIF
RETURN
> PROCEDURE size
  IF firstbase%
    moving&=1
    i$=""
    xc&=0
    yc&=0
    rt&=0
    base%=firstbase%
    WHILE base%
      IF lay& AND WORD{base%+b.l&}
        a&=BYTE{base%+b.f&}
        IF a& AND 1
          IF rt&=0
            SWAP bitpl3%,bitpl12%
            {SCREEN(1)+184+16}=bitpl12%
            {SCREEN(12)+184+8}=bitpl3%
            CLEARW #12
            OPENW #1
            BYTE{SCREEN(1)+184+5}=3
            initgrabvars({base%+b.r&},{base%+b.r&+4},{base%+b.r&+8})
          ENDIF
          tekenbase
          ADD xc&,WORD{base%+b.s&}
          ADD yc&,WORD{base%+b.s&+2}
          ADD rt&,1
          BYTE{base%+b.f&}=BCLR(BYTE{base%+b.f&},3) !eenheidsmatflag
        ELSE IF hie&
          b%=0
          IF {base%+b.p&}
            b%={base%+b.p&}
            WHILE b%
              IF lay& AND WORD{b%+b.l&}
                EXIT IF BYTE{b%+b.f&} AND 1
              ENDIF
              b%={b%+b.p&}
            WEND
          ENDIF
          IF {base%+b.t&} AND b%=0
            b%=(BYTE{{base%+b.t&}+b.f&} AND 1)
          ENDIF
          IF b%
            BYTE{base%+b.f&}=BSET(a&,1)
            tekenbase
          ELSE
            BYTE{base%+b.f&}=BCLR(a&,1)
          ENDIF
        ENDIF
      ENDIF
      base%={base%}
    WEND
    IF rt&
      ~RemakeDisplay()
      adrot%=@allocblock(84*rt&,&H10001)
      a%=adrot%
      base%=firstbase%
      WHILE base%
        IF lay& AND WORD{base%+b.l&}
          IF BYTE{base%+b.f&} AND 1
            {a%}={base%+b.v&}
            {a%+4}={base%+b.v&+4}
            {a%+8}={base%+b.v&+8}
            BMOVE base%+b.m&,a%+12,72
            ADD a%,84
          ENDIF
        ENDIF
        base%={base%}
      WEND
      moving&=-1
      calcu&=-1
      IF cursor&
        tekendinges(4,muis%())
        xc&=xm&
        yc&=ym&
        cex%=muis%(0)
        cey%=muis%(1)
        cez%=muis%(2)
      ELSE
        xc&=xc&/rt&
        yc&=yc&/rt&
        IF rt&>1
          y&=-256+yc&
          x&=xc&-320
          SUB cursor&,2
          cex%=x&*mulx1+y&*muly1
          cey%=x&*mulx2+y&*muly2
          cez%=mulz*y&
          IF persp&<>-2
            ADD cex%,xc%
            ADD cey%,yc%
            ADD cez%,zc%
          ENDIF
        ENDIF
      ENDIF
      ym&=MOUSEY
      xm&=MOUSEX
      IF yc&=ym& AND xc&=xm&
        ADD yc&,1
      ENDIF
      i$=""
      fac=SQR((yc&-ym&)^2+(xm&-xc&)^2)
      sizexo=1
      sizeyo=-1
      sizezo=1
      WHILE MOUSEK=0 AND i$=""
        waitsignal(1)
        but&=menu2%
        qual&=menu3%
        IF but&<90 AND but&>0
          i$="a"
          IF but&=64 OR but&=&H45
            i$=" "
          ENDIF
        ENDIF
        OPENW #1
        xn&=MOUSEX
        yn&=MOUSEY
        IF relasize&>=4
          dx&=xm&-xn&
          dy&=ym&-yn&
          sizex=1-dx&*0.005
          sizey=1+dy&*0.005
          sizez=1
        ELSE
          sizex=SQR((yc&-yn&)^2+(xn&-xc&)^2)/fac
          sizey=sizex
          sizez=sizex
          IF relasize&=1
            sizey=1
            sizez=1
          ELSE IF relasize&=2
            sizez=1
            sizex=1
          ELSE IF relasize&=3
            sizex=1
            sizey=1
          ENDIF
        ENDIF
        IF qual& AND 8
          sizex=(ROUND(10*sizex))/10
          sizey=(ROUND(10*sizey))/10
          sizez=(ROUND(10*sizez))/10
        ENDIF
        IF sizex<>sizexo OR sizey<>sizeyo OR sizez<>sizezo
          LOCATE 1,4
          PRINT "x: ";ROUND(sizex,3);"    "
          PRINT "y: ";ROUND(sizey,3);"    "
          PRINT "z: ";ROUND(sizez,3);"    "
          '
          OPENW #12
          base%=firstbase%
          adro%=adrot%+12
          WHILE base%
            IF lay& AND WORD{base%+b.l&}
              IF BYTE{base%+b.f&} AND 1
                BMOVE adro%,V:bmat(0,0),72
                BMOVE adro%,base%+b.m&,72
                IF relasize&>=4
                  parentbase(base%)
                  RBOX cmat()=mat()
                  RBOX bmat()=persmat()*cmat()
                  IF relasize&=4
                    bmat(0,0)=bmat(0,0)*sizex
                    bmat(0,1)=bmat(0,1)*sizex
                    bmat(0,2)=bmat(0,2)*sizex
                    bmat(1,0)=bmat(1,0)*sizey
                    bmat(1,1)=bmat(1,1)*sizey
                    bmat(1,2)=bmat(1,2)*sizey
                  ELSE
                    fi=sizex-1
                    RBOX cmat()
                    cmat(0,0)=1
                    cmat(1,1)=1
                    cmat(2,2)=1
                    cmat(0,1)=fi
                    RBOX imat()=cmat()*bmat()
                    RBOX bmat()=imat()
                  ENDIF
                  RBOX cmat()=persinv()*bmat()
                  RBOX bmat()=mat()
                  RBOX mat()=bmat()*cmat()
                  BMOVE adro%,V:bmat(0,0),72
                  RBOX cmat()=bmat()*mat()
                  BMOVE V:cmat(0,0),base%+b.m&,72
                ELSE IF relasize&=0
                  RBOX bmat(),sizex
                  BMOVE V:bmat(0,0),base%+b.m&,72
                ELSE
                  bmat(0,0)=bmat(0,0)*sizex
                  bmat(1,1)=bmat(1,1)*sizey
                  bmat(2,2)=bmat(2,2)*sizez
                  BMOVE V:bmat(0,0),base%+b.m&,72
                ENDIF
                IF cursor& AND relasize&<4
                  {base%+b.v&}=sizex*({adro%-12}-cex%)+cex%
                  {base%+b.v&+4}=sizex*({adro%-8}-cey%)+cey%
                  {base%+b.v&+8}=sizex*({adro%-4}-cez%)+cez%
                ENDIF
                tekenbase
                ADD adro%,84
              ENDIF
            ENDIF
            base%={base%}
          WEND
          base%=firstbase%
          IF hie&
            WHILE base%
              IF lay& AND WORD{base%+b.l&}
                IF BYTE{base%+b.f&} AND 2
                  tekenbase
                ENDIF
              ENDIF
              base%={base%}
            WEND
          ENDIF
          SWAP bitpl3%,bitpl12%
          {SCREEN(1)+184+16}=bitpl12%
          {SCREEN(12)+184+8}=bitpl3%
          ~RemakeDisplay()
          CLEARW #12
        ENDIF
      WEND
      OPENW #1
      BYTE{SCREEN(1)+184+5}=2
      ~RemakeDisplay()
      WHILE INKEY$<>""
      WEND
      moving&=0
      IF i$=" "
        base%=firstbase%
        adro%=adrot%
        WHILE base%
          IF lay& AND WORD{base%+b.l&}
            IF BYTE{base%+b.f&} AND 1
              BMOVE adro%,base%+b.v&,12
              BMOVE adro%+12,base%+b.m&,72
              IF @eenh.mat(base%+b.m&)
                BYTE{base%+b.f&}=BSET(BYTE{base%+b.f&},3)
              ENDIF
              ADD adro%,84
              tekenbase
            ENDIF
          ENDIF
          base%={base%}
        WEND
        base%=firstbase%
        WHILE base%
          IF lay& AND WORD{base%+b.l&}
            IF BYTE{base%+b.f&} AND 2
              tekenbase
            ENDIF
          ENDIF
          base%={base%}
        WEND
        calcu&=0
      ELSE
        calcu&=0
        base%=firstbase%
        OPENW #1
        WHILE base%
          IF lay& AND WORD{base%+b.l&}
            IF BYTE{base%+b.f&} AND 1
              IF @eenh.mat(base%+b.m&)
                BYTE{base%+b.f&}=BSET(BYTE{base%+b.f&},3)
              ENDIF
              tekenbase
            ELSE IF BYTE{base%+b.f&} AND 2
              tekenbase
            ENDIF
          ENDIF
          base%={base%}
        WEND
      ENDIF
      freeblock(adrot%)
      adrot%=0
      i$=""
      WHILE MOUSEK
      WEND
    ENDIF
  ENDIF
  IF cursor&=-2
    cursor&=0
  ENDIF
  moving&=0
RETURN
'
> PROCEDURE addbase(soort&)
  IF lastbase%
    base%=@allocblock(256,&H10001)
    IF base%
      {lastbase%}=base%
      lastbase%=base%
    ENDIF
  ELSE
    firstbase%=@allocblock(256,&H10001)
    lastbase%=firstbase%
    base%=firstbase%
  ENDIF
  IF base%=0
    okee("Not enough memory")
  ELSE IF soort&
    IF soort& AND 1
      ADD totobj&,1
    ELSE IF soort&=2
      ADD totlamp&,1
    ELSE IF soort&<0
      ADD totmove&,1
    ENDIF
    WORD{base%+4}=soort&
    BYTE{base%+b.f&}=12
    BYTE{base%+b.f&+1}=42
    {base%+b.v&}=muis%(0)
    {base%+b.v&+4}=muis%(1)
    {base%+b.v&+8}=muis%(2)
    l&=layact&
    button("To Layer:",1,15,l&)
    WORD{base%+b.l&}=SHL(1,l&-1)
    WORD{base%+b.sf&}=1
    FLOAT{base%+b.q&}=1
    FLOAT{base%+b.m&}=1
    FLOAT{base%+b.m&+32}=1
    FLOAT{base%+b.m&+64}=1
    {base%+b.r&}=muis%(0)
    {base%+b.r&+4}=muis%(1)
    {base%+b.r&+8}=muis%(2)
    IF soort&=1  !vlak/vertex
      ob%=@allocblock(80+64,&H10001)
      {base%+b.d&}=ob%
      BYTE{ob%+o.c&}=1
      BYTE{ob%+o.c&+1}=1
      adrcol%=ob%+80
      {adrcol%}=&HF0F0F00C
      maaksurf
      IF mode&=0
        a$="Plane"
      ELSE
        a$="Cube"
      ENDIF
      newname
    ELSE IF soort&=2  !lamp
      ob%=@allocblock(70,&H10001)
      {base%+b.d&}=ob%
      {ob%+6}=5*dia
      {ob%+10}=&HFFFFFFFF
      BYTE{ob%+16}=1
      {ob%+l.t&+4}=&H1040104
      {ob%+l.t&+8}=&H1040104
      a$="Lamp"
      newname
    ELSE IF soort&=3  !perf sphere
      ob%=@allocblock(96,&H10001)
      {base%+b.d&}=ob%
      {ob%+4}=dia/5
      {ob%+8}=dia/5
      adrcol%=ob%+32
      {adrcol%}=&HF028280D
      a$="Sphere"
      newname
    ELSE IF soort&=-2  !move
      ob%=@allocblock(80,&H10001)
      {base%+b.d&}=ob%
      WORD{ob%+m.f&}=frs&
      BYTE{ob%+m.f&+2}=1
      vv%=@allocblock(4+72,&H10001)
      {ob%}=vv%
      WORD{vv%}=4
      {vv%+4}=-0.5*dia
      {vv%+40}=0.5*dia
      BMOVE vv%+4,spline%+72,72
      np&=4
      snp&=2
      cyclic&=0
      cyclic
      FOR a&=2 TO 3
        calchandle(a&)
      NEXT a&
      BMOVE spline%+72,vv%+4,72
      rekenpad(14)
      a$="Move"
      newname
    ENDIF
    IF soort&=1 OR soort&=3
      a%=adrcol%
      {a%+4}=&HC8C83200
      {a%+8}=&HF0F0
      {a%+12}=&HF0F0F0F0
      {a%+16}=&HF0000000
      {a%+c.t&+4}=&H9000000
      {a%+c.t&+8}=&H9000000
      {a%+c.t&+12}=&H9000000
      {a%+c.t&+16}=&H9000000
    ENDIF
    IF lay& AND WORD{base%+b.l&}
      tekenbase
    ENDIF
  ENDIF
RETURN
> PROCEDURE maaksurf
  IF mode&=0
    len%=32+16*2+12*4
  ELSE
    len%=32+16*12+12*8
  ENDIF
  vv%=@allocblock(len%,&H10001)  !vlak/vertexblok
  {ob%}=vv%
  adrve%=vv%+32
  IF mode&=0
    {vv%}=4
    {vv%+4}=2
    adrvl%=vv%+32+12*4
  ELSE
    {vv%}=8
    {vv%+4}=12
    adrvl%=vv%+32+12*8
  ENDIF
  x%=dia/5
  WORD{vv%+v.1&}=1  !teller
  {ob%+o.f&}=x%    !fastdr data
  {ob%+o.f&+16}=x%
  {vv%+v.2&}=x%    !afmx en -y
  {vv%+v.2&+4}=x%
  IF mode&
    {vv%+v.2&+8}=x%
    {ob%+o.f&+32}=x%
    BYTE{vv%+v.3&+1}=4
  ELSE
    BYTE{vv%+v.3&+1}=8
  ENDIF
  '
  c&=4
  IF mode&=1
    c&=8
  ENDIF
  FOR a&=1 TO c&
    SELECT a&
    CASE 1,2,5,6
      {adrve%}=-x%
    CASE 3,4,7,8
      {adrve%}=x%
    ENDSELECT
    SELECT a&
    CASE 2,3,6,7
      {adrve%+4}=x%
    CASE 1,4,5,8
      {adrve%+4}=-x%
    ENDSELECT
    IF mode&=1
      SELECT a&
      CASE 1,2,3,4
        {adrve%+8}=-x%
      CASE 5,6,7,8
        {adrve%+8}=x%
      ENDSELECT
    ENDIF
    WORD{adrve%+16}=32767
    ADD adrve%,12
  NEXT a&
  wordruimte(vv%)
  c&=0
  FOR a&=0 TO mode&
    WORD{adrvl%}=1+4*a&
    WORD{adrvl%+2}=2+4*a&
    WORD{adrvl%+4}=3+4*a&
    WORD{adrvl%+10}=-32767
    ADD adrvl%,16
    WORD{adrvl%}=3+4*a&
    WORD{adrvl%+2}=4*a&
    WORD{adrvl%+4}=1+4*a&
    WORD{adrvl%+10}=-32767
    ' BYTE{adrvl%+15}=BSET(c&,7)
    ADD adrvl%,16
  NEXT a&
  IF mode&=1
    FOR a&=0 TO 2  !zijvlakken
      WORD{adrvl%}=a&+1
      WORD{adrvl%+2}=a&
      WORD{adrvl%+4}=a&+4
      ADD adrvl%,16
      WORD{adrvl%}=a&+1
      WORD{adrvl%+2}=a&+5
      WORD{adrvl%+4}=a&+4
      ADD adrvl%,16
    NEXT a&
    WORD{adrvl%}=3
    WORD{adrvl%+2}=0
    WORD{adrvl%+4}=4
    ADD adrvl%,16
    WORD{adrvl%}=3
    WORD{adrvl%+2}=4
    WORD{adrvl%+4}=7
    ADD adrvl%,16
    tot&=8
    vlak&=12
    adrve%=vv%+32
    adrvl%=vv%+32+12*8
    normalen
  ENDIF
RETURN
> PROCEDURE addduplicate
  okee(" ADD DUPLICATE")
  IF a%<>0
    totdup&=0  !teller aantal dups voor parent
    base%=firstbase%
    WHILE base%
      IF lay& AND WORD{base%+b.l&}
        IF BYTE{base%+b.f&} AND 1
          ADD totdup&,1
        ENDIF
      ENDIF
      base%={base%}
    WEND
    IF totdup&
      ablock%=@allocblock(8*totdup&,&H10001)
      ab%=ablock%
    ENDIF
    b%=firstbase%
    lbase%=lastbase%
    OPENW #1
    WHILE b%
      IF lay& AND WORD{b%+b.l&}
        IF BYTE{b%+b.f&} AND 1
          IF TRUE !WORD{b%+4}<>-2
            addbase(0)
            {ab%}=b%
            {ab%+4}=base%
            ADD ab%,8
            IF base%
              BMOVE b%+4,base%+4,252
              ' {base%+b.p&}=0
              soort&=WORD{base%+4}
              IF soort& AND 1
                ADD totobj&,1
              ELSE IF soort&=2
                ADD totlamp&,1
              ELSE IF soort&<0
                ADD totmove&,1
              ENDIF
              ob%={b%+b.d&}
              IF ob%
                len%={ob%-8}-16
                a%=@allocblock(len%,&H10001)
                BMOVE ob%,a%,len%
                {base%+b.d&}=a%
                BYTE{b%+b.f&}=BYTE{b%+b.f&}-1
                IF WORD{base%+4}=1
                  WORD{{ob%}+v.1&}=WORD{{ob%}+v.1&}+1
                ELSE IF WORD{base%+4}=7
                  WORD{{ob%+o.p&}+4}=WORD{{ob%+o.p&}+4}+1
                ELSE IF WORD{base%+4}=-2
                  s%={base%+b.d&}
                  FOR s1%=ob% TO ob%+28 STEP 4
                    IF {s1%}
                      len%={{s1%}-8}-16
                      a%=@allocblock(len%,&H10001)
                      BMOVE {s1%},a%,len%
                      {s%}=a%
                    ENDIF
                    ADD s%,4
                  NEXT s1%
                  ob%={base%+b.d&}
                  {ob%+m.fd&}=0
                  {ob%+m.pd&}=0
                  rekenpad(14)
                ENDIF
              ENDIF
              a$=""
              newname
            ENDIF
          ENDIF
        ENDIF
      ENDIF
      EXIT IF b%=lbase%
      b%={b%}
    WEND
    ' parents aan elkaar knopen
    base%={lbase%}
    WHILE base%
      ab%=ablock%
      FOR a&=1 TO totdup&
        IF {base%+b.p&}={ab%}
          {base%+b.p&}={ab%+4}
          BYTE{base%+b.f&}=BYTE{base%+b.f&}-1
        ENDIF
        ADD ab%,8
      NEXT a&
      base%={base%}
    WEND
    freeblock(ablock%)
    '
    grabber
    base%=firstbase%
    WHILE base%
      IF lay& AND WORD{base%+b.l&}
        IF BYTE{base%+b.f&} AND 1
        ELSE
          tekenbase
        ENDIF
      ENDIF
      base%={base%}
    WEND
  ENDIF
RETURN
> PROCEDURE newname
  LOCAL g1%
  IF INSTR(a$,".")
    a$=LEFT$(a$,INSTR(a$,".")-1)
  ENDIF
  IF LEN(a$)
    BMOVE V:a$,base%+b.n&,LEN(a$)
  ENDIF
  g1%=firstbase%
  a&=0
  WHILE g1%
    IF g1%<>base%
      IF @comp(base%+b.n&,g1%+b.n&)
        IF a&<=WORD{g1%+b.n&+14}
          a&=WORD{g1%+b.n&+14}+1
        ENDIF
      ENDIF
    ENDIF
    g1%={g1%}
  WEND
  WORD{base%+b.n&+14}=a&
RETURN
> PROCEDURE makemoveobj
  IF basact% AND {basact%+b.p&}<>0
    IF WORD{basact%+4} AND 1
      okee("Make Move->object?")
      IF a%
        DIM m&(4)
        a%={basact%+b.p&}
        IF WORD{a%+4}=-2
          n&=WORD{{a%+b.d&}+m.f&}
        ELSE
          n&=40
        ENDIF
        button("Frames:",1,1000,n&)
        IF a%
          m&(0)=n&
          n&=4
          button("Vertices per ring:",1,32,n&)
          IF a%
            m&(1)=n&
            ob%={basact%+b.d&}
            IF WORD{basact%+4}=1
              vv%={ob%}
              r%=MAX({vv%+v.2&},{vv%+v.2&+4},{vv%+v.2&+8})
            ELSE IF WORD{basact%}=3
              r%=MAX({ob%+8},{ob%+12},{ob%+16})
            ENDIF
            n&=0
            button("Cyclic:",0,1,n&)
            IF a%
              m&(3)=n&
              addbase(0)
              WORD{base%+4}=1
              ADD totobj&,1
              BYTE{base%+b.f&}=12
              BYTE{base%+b.f&+1}=42
              WORD{base%+b.l&}=WORD{basact%+b.l&}
              WORD{base%+b.sf&}=1
              FLOAT{base%+b.q&}=1
              FLOAT{base%+b.m&}=1
              FLOAT{base%+b.m&+32}=1
              FLOAT{base%+b.m&+64}=1
              ob%=@allocblock(80+64,&H10001)
              {base%+b.d&}=ob%
              a$="MoveObj"
              newname
              '
              BYTE{ob%+o.c&}=1
              BYTE{ob%+o.c&+1}=1
              a%=ob%+80
              {a%}=&HF0F0F00C
              {a%+4}=&HC8C83200
              {a%+8}=&HF0F0
              {a%+12}=&HF0F0F0F0
              {a%+16}=&HF0000000
              {a%+c.t&+4}=&H9000000
              {a%+c.t&+8}=&H9000000
              {a%+c.t&+12}=&H9000000
              {a%+c.t&+16}=&H9000000
              '
              tot&=m&(0)*m&(1)
              vlak&=2*tot&
              IF m&(3)=0
                SUB vlak&,2*m&(1)
              ENDIF
              vv%=@allocblock(32+12*tot&+16*vlak&,&H10001)
              {ob%}=vv%
              {vv%}=tot&
              {vv%+4}=vlak&
              WORD{vv%+8}=1
              '
              x1=360  !init polygoon
              x1=x1/m&(1)
              y1=0
              FOR a&=1 TO m&(1)
                rt%(a&,0)=r%*COSQ(y1)
                rt%(a&,1)=-r%*SINQ(y1)
                rt%(a&,2)=0
                ADD y1,x1
              NEXT a&
              '
              f1&=cfra&  !maak vertices
              adrve%=vv%+32
              FOR c&=0 TO 2
                min%(c&)=2^28
                max%(c&)=-2^28
              NEXT c&
              FOR cfra&=1 TO m&(0)
                parentbase(basact%)
                FOR a&=1 TO m&(1)
                  {adrve%}=xt%+mat(0,0)*rt%(a&,0)+mat(0,1)*rt%(a&,1)
                  {adrve%+4}=yt%+mat(1,0)*rt%(a&,0)+mat(1,1)*rt%(a&,1)
                  {adrve%+8}=zt%+mat(2,0)*rt%(a&,0)+mat(2,1)*rt%(a&,1)
                  b1&=0
                  FOR c&=0 TO 2
                    IF min%(c&)>{adrve%+b1&}
                      min%(c&)={adrve%+b1&}
                    ENDIF
                    IF max%(c&)<{adrve%+b1&}
                      max%(c&)={adrve%+b1&}
                    ENDIF
                    ADD b1&,4
                  NEXT c&
                  ADD adrve%,12
                NEXT a&
              NEXT cfra&
              cfra&=f1&
              '
              x%=(min%(0)+max%(0))/2  !min max, vector en wordruimte
              y%=(min%(1)+max%(1))/2
              z%=(min%(2)+max%(2))/2
              ob%={base%+b.d&}
              vv%={ob%}
              IF base%=0 OR vv%=0 OR ob%=0
                okee("error")
                '  sluit
              ENDIF
              tot&={vv%}
              vlak&={vv%+4}
              {base%+b.v&}=x%
              {base%+b.v&+4}=y%
              {base%+b.v&+8}=z%
              {vv%+v.2&}=(max%(0)-min%(0))/2
              {vv%+v.2&+4}=(max%(1)-min%(1))/2
              {vv%+v.2&+8}=(max%(2)-min%(2))/2
              a%=MAX({vv%+v.2&},{vv%+v.2&+4},{vv%+v.2&+8})
              fac=32767
              fac=fac/a%
              SINGLE{vv%+v.4&}=1/fac
              adrve%=vv%+32
              FOR a&=1 TO tot&
                WORD{adrve%}=fac*({adrve%}-x%)
                WORD{adrve%+2}=fac*({adrve%+4}-y%)
                WORD{adrve%+4}=fac*({adrve%+8}-z%)
                ADD adrve%,12
              NEXT a&
              '
              adrvl%=vv%+32+12*tot&  !maak vlakken
              FOR f&=0 TO m&(0)-2+m&(3)
                v&=m&(1)*f&
                a%=adrvl%
                FOR p&=0 TO m&(1)-2
                  WORD{adrvl%}=v&+p&
                  WORD{adrvl%+2}=v&+p&+m&(1)
                  WORD{adrvl%+4}=v&+p&+m&(1)+1
                  BYTE{adrvl%+15}=32
                  ADD adrvl%,16
                  WORD{adrvl%}=v&+p&
                  WORD{adrvl%+2}=v&+p&+m&(1)+1
                  WORD{adrvl%+4}=v&+p&+1
                  BYTE{adrvl%+15}=128+64+32
                  ADD adrvl%,16
                NEXT p&
                IF m&(1)<>2
                  WORD{adrvl%}=v&+m&(1)-1
                  WORD{adrvl%+2}=v&
                  WORD{adrvl%+4}=v&+m&(1)
                  BYTE{adrvl%+15}=128+64+32
                  ADD adrvl%,16
                  WORD{adrvl%}=v&+m&(1)-1
                  WORD{adrvl%+2}=v&+m&(1)
                  WORD{adrvl%+4}=v&+2*m&(1)-1
                  BYTE{adrvl%+15}=128
                  ADD adrvl%,16
                ENDIF
              NEXT f&
              IF m&(3)  !cyclisch
                adrvl%=a%
                FOR p&=0 TO 2*(m&(1)-1)+1
                  FOR c&=0 TO 4 STEP 2
                    IF WORD{adrvl%+c&}>=tot&
                      WORD{adrvl%+c&}=WORD{adrvl%+c&}-tot&
                    ENDIF
                  NEXT c&
                  ADD adrvl%,16
                NEXT p&
              ENDIF
              adrve%=vv%+32
              adrvl%=adrve%+12*tot&
              normalen
              calcu&=-1
              fastprojektie
              calcu&=0
            ENDIF
          ENDIF
          ERASE m&()
        ENDIF
      ENDIF
    ENDIF
  ENDIF
RETURN
> PROCEDURE extrudepoly
  IF WORD{basact%+4}=7
    okee("Extrude poly?")
    IF a%
      ob%={basact%+b.d&}
      vv%={ob%+o.p&}
      n&=WORD{vv%+24}
      button("Depth % ",0,100,n&)
      IF a%
        IF WORD{vv%+24}<>n&
          WORD{vv%+24}=n&
          fac=SINGLE{vv%+18}
          t00=WORD{vv%+34}*fac*n&/100
          base%=basact%
          moving&=1
          tekenbase
          {vv%+14}=t00
          moving&=0
          calcu&=-1
          tekenbase
          calcu&=0
        ENDIF
      ENDIF
      n&=WORD{vv%+26}
      button("45 Face+ % ",0,100,n&)
      IF a%
        WORD{vv%+26}=n&
      ENDIF
      n&=WORD{vv%+28}
      button("45 Face- % ",0,100,n&)
      IF a%
        WORD{vv%+28}=n&
      ENDIF
      IF {vv%+26}
        IF {vv%+36}=0
          p&=WORD{vv%}
          vorm&=WORD{vv%+2}
          adr%=@allocblock(6*p&,&H10001)
          {vv%+36}=adr%
          a%=vv%+64
          FOR a&=1 TO vorm&
            p&=WORD{a%}
            ADD a%,2
            FOR b&=1 TO p&
              '
              IF b&=1
                a1%=a%+6*(p&-1)
              ELSE
                a1%=a%-6
              ENDIF
              a2%=a%
              IF b&=p&
                a3%=a%-6*(p&-1)
              ELSE
                a3%=a%+6
              ENDIF
              x1&=WORD{a1%}
              x2&=WORD{a2%}
              x3&=WORD{a3%}
              y1&=WORD{a1%+2}
              y2&=WORD{a2%+2}
              y3&=WORD{a3%+2}
              IF (x1&=x2& AND y1&=y2&)
                IF b&=2
                  a1%=a%+6*(p&)
                ENDIF
                x1&=WORD{a1%-6}
                y1&=WORD{a1%-4}
              ENDIF
              IF (x2&=x3& AND y2&=y3&)
                IF b&=p&-1
                  a3%=a%-6*(p&-2)
                ENDIF
                x3&=WORD{a3%+6}
                y3&=WORD{a3%+8}
              ENDIF
              pconst=(x2&-x1&)*y1&+(y1&-y2&)*x1&-(x2&-x1&)*y3&-(y1&-y2&)*x3&
              IF y2&-y1&=0 OR y3&-y2&=0 OR pconst=0
                y2&=y2&+3
              ENDIF
              IF x1&-x2&=0 OR x2&-x3&=0
                x2&=x2&+3
              ENDIF
              t01=SQR((y2&-y1&)^2+(x1&-x2&)^2)
              t02=SQR((y3&-y2&)^2+(x2&-x3&)^2)
              x1=(x1&-x2&)/t01
              x2=(x3&-x2&)/t02
              y1=(y1&-y2&)/t01
              y2=(y3&-y2&)/t02
              fi=x1*x2+y1*y2
              fi=ACOS(fi)
              fi=SIN(fi/2)
              IF (fi<>0) AND (fi<>1)
                d=1000/fi
                d=d/SQR((y2+y1)^2+(x1+x2)^2)
                IF x1*y2-y1*x2<0
                  d=-d
                ENDIF
                WORD{adr%}=-d*(x1+x2)
                WORD{adr%+2}=-d*(y1+y2)
                WORD{adr%+4}=-1000
              ENDIF
              ADD adr%,6
              ADD a%,6
            NEXT b&
          NEXT a&
        ENDIF
      ELSE IF {vv%+36}
        freeblock({vv%+36})
        {vv%+36}=0
      ENDIF
    ENDIF
  ENDIF
RETURN
> PROCEDURE herbereken45
  IF WORD{base%+4}=7
    ob%={base%+b.d&}
    vv%={ob%+o.p&}
    IF {vv%+26}
      IF {vv%+36}<>0
        p&=WORD{vv%}
        vorm&=WORD{vv%+2}
        adr%={vv%+36}
        a%=vv%+64
        FOR a&=1 TO vorm&
          p&=WORD{a%}
          ADD a%,2
          FOR b&=1 TO p&
            '
            IF b&=1
              a1%=a%+6*(p&-1)
            ELSE
              a1%=a%-6
            ENDIF
            a2%=a%
            IF b&=p&
              a3%=a%-6*(p&-1)
            ELSE
              a3%=a%+6
            ENDIF
            x1&=WORD{a1%}
            x2&=WORD{a2%}
            x3&=WORD{a3%}
            y1&=WORD{a1%+2}
            y2&=WORD{a2%+2}
            y3&=WORD{a3%+2}
            IF (x1&=x2& AND y1&=y2&)
              IF b&=2
                a1%=a%+6*(p&-2)
              ELSE
                a1%=a1%-6
              ENDIF
              x1&=WORD{a1%}
              y1&=WORD{a1%+2}
            ENDIF
            IF (x2&=x3& AND y2&=y3&)
              IF b&=p&-1
                a3%=a%-6*(p&-2)
              ELSE
                a3%=a3%+6
              ENDIF
              x3&=WORD{a3%}
              y3&=WORD{a3%+2}
            ENDIF
            pconst=(x2&-x1&)*y1&+(y1&-y2&)*x1&-(x2&-x1&)*y3&-(y1&-y2&)*x3&
            IF y2&-y1&=0 OR y3&-y2&=0 OR pconst=0
              y2&=y2&+3
            ENDIF
            IF x1&-x2&=0 OR x2&-x3&=0
              x2&=x2&+3
            ENDIF
            t01=SQR((y2&-y1&)^2+(x1&-x2&)^2)
            t02=SQR((y3&-y2&)^2+(x2&-x3&)^2)
            x1=(x1&-x2&)/t01
            x2=(x3&-x2&)/t02
            y1=(y1&-y2&)/t01
            y2=(y3&-y2&)/t02
            fi=x1*x2+y1*y2
            IF fi==1
              fi=0
            ELSE
              fi=ACOS(fi)
            ENDIF
            fi=SIN(fi/2)
            IF (fi<>0) AND (fi<>1)
              d=1000/fi
              d=d/SQR((y2+y1)^2+(x1+x2)^2)
              IF x1*y2-y1*x2<0
                d=-d
              ENDIF
              WORD{adr%}=-d*(x1+x2)
              WORD{adr%+2}=-d*(y1+y2)
              WORD{adr%+4}=-1000
            ENDIF
            ADD adr%,6
            ADD a%,6
          NEXT b&
        NEXT a&
      ENDIF
    ENDIF
  ENDIF
RETURN
> PROCEDURE deleteobj
  okee("ERASE SELECTED ")
  IF a%
    base%=firstbase%
    lbase%=0
    moving&=1
    OPENW #1
    WHILE base%
      IF (lay& AND WORD{base%+b.l&})<>0 AND (BYTE{base%+b.f&} AND 1)<>0
        tekenbase
        delbase
      ELSE
        lbase%=base%
      ENDIF
      base%={base%}
    WEND
    base%=firstbase%
    WHILE base%
      IF {base%+b.p&}
        IF {{base%+b.p&}-4}<>CVL("BLCK")
          {base%+b.p&}=0
        ENDIF
      ENDIF
      IF {base%+b.t&}
        IF {{base%+b.t&}-4}<>CVL("BLCK")
          {base%+b.t&}=0
        ENDIF
      ENDIF
      IF {base%+b.w&}
        IF {{base%+b.w&}-4}<>CVL("BLCK")
          {base%+b.w&}=0
        ENDIF
      ENDIF
      IF (WORD{base%+4} AND 1) OR WORD{base%+4}=2
        IF WORD{base%+4}=1 OR WORD{base%+4}=7
          a%={base%+b.d&}+80+c.t&+20
          colt&=BYTE{{base%+b.d&}+o.c&}
        ELSE IF WORD{base%+4}=2
          a%={base%+b.d&}+l.t&+16
          colt&=1
        ELSE
          a%={base%+b.d&}+32+c.t&+20
          colt&=1
        ENDIF
        FOR a&=1 TO colt&
          FOR b&=0 TO 3
            IF {a%+4*b&}
              IF {{a%+4*b&}-4}<>CVL("BLCK")
                {a%+4*b&}=0
              ENDIF
            ENDIF
          NEXT b&
          ADD a%,64
        NEXT a&
      ENDIF
      base%={base%}
    WEND
  ENDIF
  '
  a%=wrld%+32
  FOR b&=0 TO 7
    IF {a%+4*b&}
      IF {{a%+4*b&}-4}<>CVL("BLCK")
        {a%+4*b&}=0
      ENDIF
    ENDIF
    IF b&=3
      a%=wrld%+40
    ENDIF
  NEXT b&
  '
  basact%=0
  moving&=0
RETURN
> PROCEDURE delbase
  ob%={base%+b.d&}
  IF ob%
    IF (WORD{base%+4} AND 1) OR WORD{base%+4}=2
      IF WORD{base%+4}=1 OR WORD{base%+4}=7
        a%=ob%+80+c.t&+20
        colt&=BYTE{ob%+o.c&}
      ELSE IF WORD{base%+4}=2
        a%=ob%+l.t&+16
        colt&=1
      ELSE
        a%=ob%+32+c.t&+20
        colt&=1
      ENDIF
      FOR a&=1 TO colt&
        FOR b&=0 TO 3
          IF {a%+4*b&}
            BYTE{{a%+4*b&}+b.i&}=BYTE{{a%+4*b&}+b.i&}-1
          ENDIF
        NEXT b&
        ADD a%,64
      NEXT a&
    ENDIF
    IF WORD{base%+4}=1
      vv%={ob%}
      WORD{vv%+v.1&}=WORD{vv%+v.1&}-1
      IF WORD{vv%+v.1&}=0
        freeblock(vv%)
      ENDIF
    ELSE IF WORD{base%+4}=7
      vv%={ob%+o.p&}
      WORD{vv%+4}=WORD{vv%+4}-1
      IF WORD{vv%+4}=0
        IF {vv%+p.d&}
          freeblock({vv%+p.d&})
        ENDIF
        freeblock(vv%)
      ENDIF
    ELSE IF WORD{base%+4}=-2
      FOR b%=ob% TO ob%+28 STEP 4
        IF {b%}
          freeblock({b%})
        ENDIF
      NEXT b%
    ENDIF
    freeblock(ob%)
  ENDIF
  soort&=WORD{base%+4}
  IF soort& AND 1
    ADD totobj&,-1
  ELSE IF soort&=2
    ADD totlamp&,-1
  ELSE IF soort&<0
    ADD totmove&,-1
  ENDIF
  IF base%=ebase%
    ebase%=0
  ENDIF
  IF base%=opar%
    opar%=0
  ENDIF
  IF base%=tpar%
    tpar%=0
  ENDIF
  IF base%<>firstbase%
    {lbase%}={base%}
  ELSE
    firstbase%={base%}
  ENDIF
  IF base%=lastbase%
    IF lbase%
      {lbase%}=0
      lastbase%=lbase%
    ELSE
      lastbase%=0
      firstbase%=0
    ENDIF
  ENDIF
  IF firstbase%=0
    lastbase%=0
  ENDIF
  freeblock(base%)
RETURN
> PROCEDURE wisalles
  base%=firstbase%
  lbase%=0
  WHILE base%
    delbase
    lbase%=base%
    base%={base%}
  WEND
  FOR a&=1 TO totex&
    textu$(a&)=""
    x1%={adrtex%(a&)+112}
    IF x1%<>0
      freeblock(x1%)
    ENDIF
    x2%={adrtex%(a&)+116}
    IF x2%<>0
      freeblock(x2%)
    ENDIF
    FOR b&=a&+1 TO totex&
      IF x1%={adrtex%(b&)+112}
        {adrtex%(b&)+112}=0
      ENDIF
      IF x2%={adrtex%(b&)+116}
        {adrtex%(b&)+116}=0
      ENDIF
    NEXT b&
    freeblock(adrtex%(a&))
  NEXT a&
  parent&=0
  IF {firstview%}
    a%={firstview%}
    WHILE a%
      freeblock(a%)
      a%={a%}
    WEND
    {firstview%}=0
  ENDIF
  {wrld%+24}=0
  {wrld%+48}=0
  a%=wrld%+32
  FOR b&=0 TO 7
    {a%+4*b&}=0
    IF b&=3
      a%=wrld%+40
    ENDIF
  NEXT b&
  totex&=0
  totobj&=0
  totlamp&=0
  totvlak&=0
  totvert&=0
  totmove&=0
  sview&=1
  CLEARW #2
  main&=1
  sluitwin(4)
  sluitwin(3)
  setbutton(main&,5)
  setbutton(maino&,5)
  maino&=main&
RETURN
'
> PROCEDURE deselectall
  IF ebase%
    base%=ebase%
    ebase%=0
    tekenbase
    drawdp(0,3)
  ENDIF
  base%=firstbase%
  WHILE base%
    IF lay& AND WORD{base%+b.l&}
      IF BYTE{base%+b.f&} AND 1
        BYTE{base%+b.f&}=BYTE{base%+b.f&}-1
        tekenbase
      ENDIF
    ENDIF
    base%={base%}
  WEND
  basact%=0
RETURN
> PROCEDURE parentclear
  okee("Clear parent?")
  IF a%
    base%=firstbase%
    WHILE base%
      IF lay& AND WORD{base%+b.l&}
        IF BYTE{base%+b.f&} AND 1
          {base%+b.p&}=0
        ENDIF
      ENDIF
      base%={base%}
    WEND
    calcu&=-1
    fastprojektie
    calcu&=0
  ENDIF
RETURN
> PROCEDURE trackclear
  okee("Clear tracking?")
  IF a%
    base%=firstbase%
    WHILE base%
      IF lay& AND WORD{base%+b.l&}
        IF BYTE{base%+b.f&} AND 1
          {base%+b.t&}=0
        ENDIF
      ENDIF
      base%={base%}
    WEND
    calcu&=-1
    fastprojektie
    calcu&=0
  ENDIF
RETURN
> PROCEDURE matclear
  okee("Mat clear?")
  IF a%
    RBOX mat()
    mat(0,0)=1
    mat(1,1)=1
    mat(2,2)=1
    base%=firstbase%
    WHILE base%
      IF lay& AND WORD{base%+b.l&}
        IF BYTE{base%+b.f&} AND 1
          BMOVE V:mat(0,0),base%+b.m&,72
          BYTE{base%+b.f&}=BSET(BYTE{base%+b.f&},3)
        ENDIF
      ENDIF
      base%={base%}
    WEND
    calcu&=-1
    fastprojektie
    calcu&=0
  ENDIF
RETURN
> PROCEDURE originclear
  okee("Origin clear?")
  IF a%
    base%=firstbase%
    WHILE base%
      IF lay& AND WORD{base%+b.l&}
        IF BYTE{base%+b.f&} AND 1
          {base%+b.o&}=0
          {base%+b.o&+4}=0
          {base%+b.o&+8}=0
        ENDIF
      ENDIF
      base%={base%}
    WEND
    calcu&=-1
    fastprojektie
    calcu&=0
  ENDIF
RETURN
> PROCEDURE snaptopath
  IF padact&<>0 AND objact&<>0
    a%=ob%(padact&)
    IF WORD{a%}=-1 !pad
      ADD a%,116
      IF {a%}
        c&=WORD{ob%(padact&)+6}
        t%=12*((cfra&-1) MOD c&)
        {ob%(objact&)+12}={{a%}+t%}+{a%-104}
        {ob%(objact&)+16}={{a%}+4+t%}+{a%-100}
        {ob%(objact&)+20}={{a%}+8+t%}+{a%-96}
        fastprojektie
      ENDIF
    ENDIF
  ENDIF
RETURN
> PROCEDURE centre
  IF persp&<>2
    IF qual& AND 3
      xc%=0
      yc%=0
      zc%=0
      muis%(0)=0
      muis%(1)=0
      muis%(2)=0
      dproj=1
    ELSE
      initgrabvars(muis%(0),muis%(1),muis%(2))
      dx&=-320+xmo&
      dy&=-256+ymo&
      dx%=dx&*mulx1+dy&*muly1
      dy%=dx&*mulx2+dy&*muly2
      dz%=mulz*dy&
      ADD xc%,dx%
      ADD yc%,dy%
      ADD zc%,dz%
    ENDIF
    calcphitheta
    fastprojektie
  ENDIF
RETURN
> PROCEDURE maakbol
  okee("Maak bol")
  IF a%
    base%=basact%
    IF WORD{base%+4}=1
      ob%={base%+b.d&}
      vv%={ob%}
      tot&={vv%}
      vlak&={vv%+4}
      p%={base%+b.p&}
      {base%+b.p&}=0
      parentbase(base%)
      fac=SINGLE{vv%+v.4&}
      RBOX mat(),fac
      {base%+b.p&}=p%
      adrve%=vv%+32
      fac=1/32767
      FOR a&=1 TO tot&
        x1=fac*WORD{adrve%}
        y1=fac*WORD{adrve%+2}
        r=(x1*x1+y1*y1)
        a=SQR(ABS(1-r))
        IF r<1
          WORD{adrve%+4}=32767*a
        ELSE
          WORD{adrve%+4}=0
        ENDIF
        ADD adrve%,12
      NEXT a&
    ENDIF
  ENDIF
RETURN
> PROCEDURE wordruimtekleiner
  okee("wordruimte 5% kleiner")
  IF a%
    base%=basact%
    IF WORD{base%+4}=1
      ob%={base%+b.d&}
      vv%={ob%}
      tot&={vv%}
      fac=0.95
      SINGLE{vv%+v.4&}=SINGLE{vv%+v.4&}/fac
      adrve%=vv%+32
      FOR a&=1 TO tot&
        WORD{adrve%}=fac*WORD{adrve%}
        WORD{adrve%+2}=fac*WORD{adrve%+2}
        WORD{adrve%+4}=fac*WORD{adrve%+4}
        ADD adrve%,12
      NEXT a&
    ENDIF
  ENDIF
RETURN
> PROCEDURE apply(g1&)
  IF g1&=0
    okee("Apply mat/quat?")
  ELSE
    okee("Fit in wordspace?")
  ENDIF
  IF a%
    base%=firstbase%
    WHILE base%
      IF lay& AND WORD{base%+b.l&}
        IF BYTE{base%+b.f&} AND 1
          ob%=0
          IF WORD{base%+4}=-2
            p%={base%+b.p&}
            {base%+b.p&}=0
            parentbase(base%)
            {base%+b.p&}=p%
            ob%={base%+b.d&}
            vv%={ob%}
            g1&=0
            IF vv%
              a1%=vv%+4+36*(np&-2)-12
              FOR a%=vv%+4 TO a1% STEP 12
                a2%=mat(0,0)*{a%}+mat(0,1)*{a%+4}+mat(0,2)*{a%+8}
                a3%=mat(1,0)*{a%}+mat(1,1)*{a%+4}+mat(1,2)*{a%+8}
                {a%+8}=mat(2,0)*{a%}+mat(2,1)*{a%+4}+mat(2,2)*{a%+8}
                {a%}=a2%
                {a%+4}=a3%
              NEXT a%
            ELSE
              ob%=0
            ENDIF
          ELSE IF WORD{base%+4}=1
            ob%={base%+b.d&}
            vv%={ob%}
            IF WORD{vv%+v.1&}>1
              okee("Don't apply a clone!")
              ob%=0
            ELSE
              tot&={vv%}
              vlak&={vv%+4}
              p%={base%+b.p&}
              {base%+b.p&}=0
              parentbase(base%)
              fac=SINGLE{vv%+v.4&}
              RBOX mat(),fac
              {base%+b.p&}=p%
              adrve%=vv%+32
              FOR c&=0 TO 2
                min%(c&)=2^28
                max%(c&)=-2^28
              NEXT c&
              FOR a&=1 TO tot&
                x1&=WORD{adrve%}
                y1&=WORD{adrve%+2}
                z1&=WORD{adrve%+4}
                {adrve%+8}=mat(2,0)*x1&+mat(2,1)*y1&+mat(2,2)*z1&
                {adrve%+4}=mat(1,0)*x1&+mat(1,1)*y1&+mat(1,2)*z1&
                {adrve%}=mat(0,0)*x1&+mat(0,1)*y1&+mat(0,2)*z1&
                b1&=0
                FOR c&=0 TO 2
                  IF min%(c&)>{adrve%+b1&}
                    min%(c&)={adrve%+b1&}
                  ENDIF
                  IF max%(c&)<{adrve%+b1&}
                    max%(c&)={adrve%+b1&}
                  ENDIF
                  ADD b1&,4
                NEXT c&
                ADD adrve%,12
              NEXT a&
              {vv%+v.2&}=(max%(0)-min%(0))/2
              {vv%+v.2&+4}=(max%(1)-min%(1))/2
              {vv%+v.2&+8}=(max%(2)-min%(2))/2
              x%=(min%(0)+max%(0))/2
              y%=(min%(1)+max%(1))/2
              z%=(min%(2)+max%(2))/2
              '
              a%=MAX({vv%+v.2&},{vv%+v.2&+4},{vv%+v.2&+8})
              fi=32767
              fac=fi/a%
              IF g1&=0
                x1=fac
                y1=fac
                z1=fac
              ELSE
                x1=1
                y1=1
                z1=1
                IF {vv%+v.2&}
                  x1=fi/{vv%+v.2&}
                  {vv%+v.2&}=fi/fac
                ENDIF
                IF {vv%+v.2&+4}
                  y1=fi/{vv%+v.2&+4}
                  {vv%+v.2&+4}=fi/fac
                ENDIF
                IF {vv%+v.2&+8}
                  z1=fi/{vv%+v.2&+8}
                  {vv%+v.2&+8}=fi/fac
                ENDIF
              ENDIF
              SINGLE{vv%+v.4&}=1/fac
              adrve%=vv%+32
              {base%+b.v&}={base%+b.v&}-x%
              {base%+b.v&+4}={base%+b.v&+4}-y%
              {base%+b.v&+8}={base%+b.v&+8}-z%
              FOR a&=1 TO tot&
                WORD{adrve%}=x1*({adrve%}-x%)
                WORD{adrve%+2}=y1*({adrve%+4}-y%)
                WORD{adrve%+4}=z1*({adrve%+8}-z%)
                ADD adrve%,12
              NEXT a&
              adrve%=vv%+32
              adrvl%=vv%+32+12*tot&
              normalen
            ENDIF
          ENDIF
          IF ob%
            RBOX mat()
            IF g1&=0
              mat(0,0)=1
              mat(1,1)=1
              mat(2,2)=1
              BYTE{base%+b.f&}=BYTE{base%+b.f&} OR 12
            ELSE
              mat(0,0)=fac/x1
              mat(1,1)=fac/y1
              mat(2,2)=fac/z1
              BYTE{base%+b.f&}=BYTE{base%+b.f&} OR 4
              BYTE{base%+b.f&}=BCLR(BYTE{base%+b.f&},5)
            ENDIF
            BMOVE V:mat(0,0),base%+b.m&,72
            FLOAT{base%+b.q&}=1
            FLOAT{base%+b.q&+8}=0
            FLOAT{base%+b.q&+16}=0
            FLOAT{base%+b.q&+24}=0
            IF WORD{base%+4}=-2
              rekenpad(14)
            ENDIF
          ENDIF
        ENDIF
      ENDIF
      base%={base%}
    WEND
    calcu&=-1
    fastprojektie
    calcu&=0
  ENDIF
RETURN
> PROCEDURE makeparent
  IF basact%
    base%=basact%
    BYTE{base%+b.f&}=BCLR(BYTE{base%+b.f&},0)
    moving&=-1
    COLOR 2
    col&=2
    tekenbase
    moving&=0
    IF WORD{base%+4}=-2 AND {{base%+b.d&}}<>0
      {workbase%+b.p&}=base%
      parentbase(workbase%)
      x1%=xt%
      y1%=yt%
      z1%=zt%
    ELSE
      x1%={base%+b.r&}
      y1%={base%+b.r&+4}
      z1%={base%+b.r&+8}
    ENDIF
    base%=firstbase%
    DEFLINE &HF0F0
    WHILE base%
      IF lay& AND WORD{base%+b.l&}
        IF BYTE{base%+b.f&} AND 1
          b%={base%+b.p&}+b.p&
          IF b%<>b.p&
            COLOR 0
            moveto2d({b%},{b%+4},{b%+8},{base%+b.r&},{base%+b.r&+4},{base%+b.r&+8})
            COLOR 2
          ENDIF
          moveto2d(x1%,y1%,z1%,{base%+b.r&},{base%+b.r&+4},{base%+b.r&+8})
        ENDIF
      ENDIF
      base%={base%}
    WEND
    DEFLINE 1
    okee("Make Yellow Parent?")
    base%=basact%
    IF a%
      base%=firstbase%
      WHILE base%
        IF lay& AND WORD{base%+b.l&}
          IF BYTE{base%+b.f&} AND 1
            IF base%<>basact%
              {base%+b.p&}=basact%
              b%=base%
              WHILE b% !test op loop
                b%={b%+b.p&}
                EXIT IF b%=base%
              WEND
              IF b%
                {base%+b.p&}=0
                okee("Loop in parents")
              ELSE
                {base%+b.o&}={base%+b.r&}-x1%
                {base%+b.o&+4}={base%+b.r&+4}-y1%
                {base%+b.o&+8}={base%+b.r&+8}-z1%
              ENDIF
            ENDIF
          ENDIF
        ENDIF
        base%={base%}
      WEND
      ' deselectall
      calcu&=-1
      fastprojektie
      calcu&=0
    ELSE
      BYTE{base%+b.f&}=BSET(BYTE{base%+b.f&},0)
      fastprojektie
    ENDIF
  ENDIF
RETURN
> PROCEDURE copyvertvlak
  IF basact%
    base%=basact%
    BYTE{base%+b.f&}=BCLR(BYTE{base%+b.f&},0)
    moving&=-1
    COLOR 2
    col&=2
    tekenbase
    moving&=0
    IF WORD{base%+4}=-2 AND {{base%+b.d&}}<>0
      {workbase%+b.p&}=base%
      parentbase(workbase%)
      x1%=xt%
      y1%=yt%
      z1%=zt%
    ELSE
      x1%={base%+b.r&}
      y1%={base%+b.r&+4}
      z1%={base%+b.r&+8}
    ENDIF
    okee("Copy VertVlak")
    IF a% AND WORD{basact%+4}=1
      x1%={{basact%+b.d&}}
      base%=firstbase%
      WHILE base%
        IF lay& AND WORD{base%+b.l&}
          IF BYTE{base%+b.f&} AND 1
            IF base%<>basact% AND WORD{base%+4}=1
              ob%={base%+b.d&}
              WORD{{ob%}+v.1&}=WORD{{ob%}+v.1&}-1
              IF WORD{{ob%}+v.1&}<=0
                freeblock({ob%})
              ENDIF
              {ob%}=x1%
              WORD{{ob%}+v.1&}=WORD{{ob%}+v.1&}+1
            ENDIF
          ENDIF
        ENDIF
        base%={base%}
      WEND
      calcu&=-1
      fastprojektie
      calcu&=0
    ELSE
      BYTE{base%+b.f&}=BSET(BYTE{base%+b.f&},0)
      fastprojektie
    ENDIF
  ENDIF
RETURN
> PROCEDURE movetolayer
  l&=layact&
  button("To Layer:",0,15,l&)
  IF a%
    IF l&=0
      l1&=32767
    ELSE
      l1&=0
      l1&=BSET(l1&,l&-1)
    ENDIF
    base%=firstbase%
    moving&=1
    OPENW #1
    WHILE base%
      IF lay& AND WORD{base%+b.l&}
        IF BYTE{base%+b.f&} AND 1
          WORD{base%+b.l&}=l1&
          IF lay& AND WORD{base%+b.l&}
          ELSE
            tekenbase
          ENDIF
        ENDIF
      ENDIF
      base%={base%}
    WEND
    moving&=0
  ENDIF
RETURN
> PROCEDURE selector
  xn&=xminb&
  yn&=xmaxb&
  zn&=yminb&
  n&=ymaxb&
  a&=0  !geen getallen printen
  kader
  yminb&=512-yminb&
  ymaxb&=512-ymaxb&
  SWAP yminb&,ymaxb&
  sel&=1
  IF butmuis&=2
    sel&=0
  ENDIF
  base%=firstbase%
  WHILE base%
    IF lay& AND WORD{base%+b.l&}
      a%=base%+b.s&
      IF WORD{a%}>xminb& AND WORD{a%}<xmaxb&
        IF WORD{a%+2}>yminb& AND WORD{a%+2}<ymaxb&
          IF sel&
            IF ((BYTE{base%+b.f&} AND 1)=0)
              BYTE{base%+b.f&}=BYTE{base%+b.f&}+1
              tekenbase
            ENDIF
          ELSE
            IF BYTE{base%+b.f&} AND 1
              BYTE{base%+b.f&}=BYTE{base%+b.f&}-1
              tekenbase
            ENDIF
          ENDIF
        ENDIF
      ENDIF
    ENDIF
    base%={base%}
  WEND
  xminb&=xn&
  xmaxb&=yn&
  yminb&=zn&
  ymaxb&=n&
RETURN
> PROCEDURE copycolorblocks
  IF WORD{basact%+4} AND 1
    moving&=-1
    COLOR 2
    col&=2
    base%=basact%
    tekenbase
    moving&=0
    okee("Copy color from yellow?")
    IF a%
      ob%={basact%+b.d&}
      IF WORD{base%+4}=3
        colt&=1
        a1%=ob%+32
      ELSE
        colt&=BYTE{ob%+o.c&}
        a1%=ob%+80
      ENDIF
      base%=firstbase%
      WHILE base%
        IF base%<>basact%
          IF lay& AND WORD{base%+b.l&}
            IF BYTE{base%+b.f&} AND 1
              IF WORD{base%+4} AND 1
                ob%={base%+b.d&}
                IF WORD{base%+4}=3
                  c&=1
                  a%=ob%+32
                ELSE
                  c&=BYTE{ob%+o.c&}
                  a%=ob%+80
                ENDIF
                IF colt&=c&
                  BMOVE a1%,a%,64*colt&
                ENDIF
              ENDIF
            ENDIF
          ENDIF
        ENDIF
        base%={base%}
      WEND
    ENDIF
    base%=basact%
    tekenbase
  ENDIF
RETURN
> PROCEDURE copyeffect
  IF WORD{basact%+4} AND 1
    moving&=-1
    COLOR 2
    col&=2
    base%=basact%
    tekenbase
    moving&=0
    okee("Copy effect from yellow?")
    IF a%
      ob%={basact%+b.d&}
      base%=firstbase%
      WHILE base%
        IF base%<>basact%
          IF lay& AND WORD{base%+b.l&}
            IF BYTE{base%+b.f&} AND 1
              IF WORD{base%+4}=1
                ~DisplayBeep(0)
                b%={base%+b.d&}
                WORD{b%+o.e&}=WORD{ob%+o.e&}
                {b%+o.e&+2}={ob%+o.e&+2}
              ENDIF
            ENDIF
          ENDIF
        ENDIF
        base%={base%}
      WEND
    ENDIF
    base%=basact%
    tekenbase
  ENDIF
RETURN
> PROCEDURE copyquat
  IF basact%
    moving&=-1
    COLOR 2
    col&=2
    base%=basact%
    tekenbase
    moving&=0
    okee("Copy quat from yellow?")
    IF a%
      base%=firstbase%
      WHILE base%
        IF base%<>basact%
          IF lay& AND WORD{base%+b.l&}
            IF BYTE{base%+b.f&} AND 1
              BMOVE basact%+b.q&,base%+b.q&,32
              BYTE{base%+b.f&}=BCLR(BYTE{base%+b.f&},2)
            ENDIF
          ENDIF
        ENDIF
        base%={base%}
      WEND
    ENDIF
    base%=basact%
    tekenbase
  ENDIF
RETURN
> PROCEDURE copymat
  IF basact%
    moving&=-1
    COLOR 2
    col&=2
    base%=basact%
    tekenbase
    moving&=0
    okee("Copy mat from yellow?")
    IF a%
      base%=firstbase%
      WHILE base%
        IF base%<>basact%
          IF lay& AND WORD{base%+b.l&}
            IF BYTE{base%+b.f&} AND 1
              BMOVE basact%+b.m&,base%+b.m&,72
              BYTE{base%+b.f&}=BCLR(BYTE{base%+b.f&},3)
            ENDIF
          ENDIF
        ENDIF
        base%={base%}
      WEND
    ENDIF
    base%=basact%
    tekenbase
  ENDIF
RETURN
> PROCEDURE centocentroid
  okee("Centre->Centroid?")
  IF a%
    adrob%=ob%(objact&)
    IF lay& AND BYTE{adrob%+82}
      IF WORD{adrob%}>0
        totve&=WORD{adrob%+4}
        adrve%=adrob%+WORD{adrob%+6}
        x1%=0
        y1%=0
        z1%=0
        FOR p&=0 TO totve&-1
          ADD x1%,{adrve%}
          ADD y1%,{adrve%+4}
          ADD z1%,{adrve%+8}
          ADD adrve%,18
        NEXT p&
        x=totve&
        x1%=x1%/x
        y1%=y1%/x
        z1%=z1%/x
        adrve%=adrob%+WORD{adrob%+6}
        FOR p&=0 TO totve&-1
          {adrve%}={adrve%}-x1%
          {adrve%+4}={adrve%+4}-y1%
          {adrve%+8}={adrve%+8}-z1%
          ADD adrve%,18
        NEXT p&
        {adrob%+12}={adrob%+12}+x1%
        {adrob%+16}={adrob%+16}+y1%
        {adrob%+20}={adrob%+20}+z1%
        fastprojektie
      ENDIF
    ENDIF
  ENDIF
RETURN
> PROCEDURE imawraptomat
  base%=firstbase%
  WHILE base%
    IF WORD{base%+b.l&} AND lay&
      IF BYTE{base%+b.f&} AND 1
        IF WORD{base%+4} AND 1
          IF WORD{base%+4}=1
            ob%={base%+b.d&}
            IF WORD{base%+4}=3
              c&=1
              a%=ob%+32
            ELSE
              c&=BYTE{ob%+o.c&}
              a%=ob%+80
            ENDIF
            FOR a&=1 TO c&
              FOR b&=0 TO 3
                IF BYTE{a%+c.t&+b&}>0 AND BYTE{adrtex%(BYTE{a%+c.t&+b&})}=5
                  adrtex%=adrtex%(BYTE{a%+c.t&+b&})
                  tabmem%={adrtex%+112}
                  IF tabmem%
                    bmhd%={tabmem%+8}
                    fac=WORD{bmhd%}     !breedte
                    fac=fac/WORD{bmhd%+2}  !hoogte
                    FLOAT{base%+b.m&}=fac
                    FLOAT{base%+b.m&+32}=1
                    FLOAT{base%+b.m&+64}=1
                    BYTE{base%+b.f&}=BYTE{base%+b.f&} AND NOT (8)
                  ENDIF
                ENDIF
              NEXT b&
            NEXT a&
          ENDIF
        ENDIF
      ENDIF
    ENDIF
    base%={base%}
  WEND
RETURN
> PROCEDURE waitsignal(wait&)
  ret&=FALSE
  sig%=0
  menu1%=0
  menu2%=0
  menu3%=0
  FOR win&=1 TO 9
    ' LEES openstaande BOODSCHAPPEN IN
    IF WINDOW(win&)
      ' {WINDOW(win&)+82}=&H340118
      msgport%={WINDOW(win&)+86}
      IF msgport%
        sig%=sig% OR SHL(1,BYTE{msgport%+15})
        ready&=FALSE
        WHILE (NOT ready&) AND (NOT ret&)
          @decodemsg(GetMsg(msgport%))
        WEND
        EXIT IF ret&
      ELSE
        ~DisplayBeep(0)
      ENDIF
    ENDIF
  NEXT win&
  IF (wait&) AND (NOT ret&)
    ~Wait(sig%)
    win&=WINDOW({_IntBase+52})
    IF win&
      msgport%={WINDOW(win&)+86}
      IF msgport%
        @decodemsg(GetMsg(msgport%))
      ENDIF
    ELSE
      FOR win&=0 TO 10
        IF WINDOW(win&)
          msgport%={WINDOW(win&)+86}
          @decodemsg(GetMsg(msgport%))
        ENDIF
        EXIT IF ret&
      NEXT win&
    ENDIF
  ENDIF
  IF (render& OR busy2d&)=0
    IF win&=8
      splinemenu
    ENDIF
  ENDIF
RETURN
> PROCEDURE decodemsg(msg%)
  IF msg%<>0
    menu1%={msg%+20}
    menu2%=WORD{msg%+24}
    menu3%=WORD{msg%+26}
    ' OPENW #1
    ' LOCATE 1,2
    ' PRINT HEX$(menu1%,8)
    ' PRINT HEX$(menu2%,8)
    ' PRINT HEX$(menu3%,8)
    ' PRINT win&
    IF menu1% AND &HC0000
      task%=FindTask(0)
      IF WINDOW({_IntBase+52})  ! Is een Traces window aktief?
        ~SetTaskPri(task%,0)
        IF WINDOW({_IntBase+52})=1
          ~MoveSprite(vpspr%,spr.mem%,xmo&-14,ymo&-12)
        ELSE
          ~MoveSprite(vpspr%,spr.mem%,-128,-127)
        ENDIF
      ELSE
        ~SetTaskPri(task%,-1)
        ~MoveSprite(vpspr%,spr.mem%,-128,-127)
      ENDIF
    ELSE IF menu1%<>16
      IF menu1%
        ret&=TRUE
      ENDIF
    ENDIF
    ~ReplyMsg(msg%)
  ELSE
    ready&=TRUE
  ENDIF
RETURN
'
ENDFUNC
RBOX buttons
> PROCEDURE dobutton
LOCAL b1&,b2&,b3&,b5&,s%,g2%
'
SWAP g2%,a%
'
GRAPHMODE 1
wi&=1
FOR a&=3 TO 7
  IF a&<>6
    a%=WINDOW(a&)
    IF a%
      IF WORD{a%+12}>0 AND WORD{a%+14}>0
        IF WORD{a%+12}<WORD{a%+10}
          IF WORD{a%+14}<WORD{a%+8}
            wi&=a&
            a&=7
          ENDIF
        ENDIF
      ENDIF
    ENDIF
  ENDIF
NEXT a&
butmes&=0
butmuis&=MOUSEK
IF (LPEEK(WINDOW(6)+24) AND 8192)
  wi&=6
ENDIF
IF wi&=3 OR wi&=4
  IF main&=3 AND (WORD{basact%+4} AND 1)=0
    wi&=-1
  ELSE IF main&=4 AND WORD{basact%+4}<>2
    wi&=-1
  ENDIF
ENDIF
IF wi&>1 AND WINDOW(wi&)
  a%=wi&
  OPENW #a%
  mx&=MOUSEX
  my&=MOUSEY
  a%={WINDOW(wi&)+120}+2
  totbut&=WORD{a%-2}
  FOR a&=1 TO totbut&
    IF mx&>=WORD{a%+8}
      IF my&>=WORD{a%+10}-1
        IF mx&=<WORD{a%+12}
          IF my&=<WORD{a%+14}+1
            butmes&=a&
            var&=WORD{a%+2}
            type&=WORD{a%} AND 15
            IF type&=1
              push(a%)
              WHILE MOUSEK
              WEND
              push(a%)
            ELSE IF type&=2
              push(a%)
              WHILE MOUSEK
              WEND
              GRAPHMODE 1
              IF var& AND 16
                IF var& AND 32
                  WORD{{a%+4}}=NOT (WORD{{a%+4}})
                ELSE
                  BYTE{{a%+4}}=NOT (BYTE{{a%+4}})
                ENDIF
              ELSE
                b1&=(var& AND 15)
                IF var& AND 32
                  WORD{{a%+4}}=BCHG(WORD{{a%+4}},b1&)
                ELSE
                  BYTE{{a%+4}}=BCHG(BYTE{{a%+4}},b1&)
                ENDIF
              ENDIF
            ELSE IF type&=9 !driestand
              push(a%)
              b3&=(WORD{a%+8}+WORD{a%+12})/2
              b4&=(WORD{a%+10}+WORD{a%+14})/2-11
              WHILE MOUSEK
              WEND
              COLOR 1
              PBOX b3&-2,b4&+1,b3&+2,b4&-1
              GRAPHMODE 1
              IF var& AND 16
                IF var& AND 32
                  WORD{{a%+4}}=NOT (WORD{{a%+4}})
                ELSE
                  BYTE{{a%+4}}=NOT (BYTE{{a%+4}})
                ENDIF
              ELSE
                b1&=(var& AND 15)
                IF var& AND 32
                  IF BTST(WORD{{a%+4}+2},b1&)
                    WORD{{a%+4}}=BCLR(WORD{{a%+4}},b1&)
                    WORD{{a%+4}+2}=BCLR(WORD{{a%+4}+2},b1&)
                  ELSE IF BTST(WORD{{a%+4}},b1&)
                    push(a%)
                    WORD{{a%+4}+2}=BSET(WORD{{a%+4}+2},b1&)
                    COLOR 2
                    PBOX b3&-2,b4&+1,b3&+2,b4&-1
                  ELSE
                    WORD{{a%+4}}=BSET(WORD{{a%+4}},b1&)
                  ENDIF
                ELSE
                  BYTE{{a%+4}}=BCHG(BYTE{{a%+4}},b1&)
                ENDIF
              ENDIF
            ELSE IF type&=3 OR type&=6
              s%={a%+16}
              but%={WINDOW(wi&)+120}
              FOR b1&=1 TO totbut&
                t%=but%+2+32*(b1&-1)
                IF WORD{t%}=6 OR WORD{t%}=3
                  IF {t%+16}=s%
                    g&=-1
                    IF (var& AND 64)
                      IF BYTE{{t%+4}}<>{t%+20}
                        g&=0
                      ENDIF
                    ELSE IF (var& AND 32) AND WORD{{t%+4}}<>{t%+20}
                      g&=0
                    ENDIF
                    IF g&
                      IF WORD{t%}=6
                        a$=MKL$({t%+24})+MKL$({t%+28})
                        WHILE RIGHT$(a$,1)=" "
                          a$=LEFT$(a$,LEN(a$)-1)
                        WEND
                        COLOR 0,1
                        TEXT WORD{t%+8}+2,WORD{t%+14}-2,a$
                      ELSE
                        push(t%)
                      ENDIF
                    ENDIF
                  ENDIF
                ENDIF
              NEXT b1&
              IF type&=6
                COLOR 2,1
                a$=MKL$({a%+24})+MKL$({a%+28})
                WHILE RIGHT$(a$,1)=" "
                  a$=LEFT$(a$,LEN(a$)-1)
                WEND
                TEXT WORD{a%+8}+2,WORD{a%+14}-2,a$
              ELSE
                push(a%)
              ENDIF
              WORD{{a%+4}}={a%+20}
              WHILE MOUSEK
              WEND
            ELSE IF type&=4   !*********  schuifje
              IF var& AND 32
                b1&=WORD{{a%+4}}
              ELSE
                b1&=BYTE{{a%+4}}
              ENDIF
              ay&=WORD{a%+14}-WORD{a%+10}
              f=WORD{a%+12}-WORD{a%+8}-ay&
              f=f/{a%+20}
              b3&=b1&
              push(a%)
              a$=MKI$(WORD{a%+24})
              s%=0
              IF RIGHT$(a$,1)=" "
                s%=1
                copkleur
              ENDIF
              WHILE MOUSEK
                waitsignal(1)
                qual&=menu3%
                IF qual& AND 3
                  b2&=(MOUSEX-mx&)/(6*f)+b1&
                ELSE
                  b2&=(MOUSEX-mx&)/f+b1&
                  IF qual& AND 8
                    b2&=10*INT(b2&/10)
                  ENDIF
                ENDIF
                IF b3&<>b2&
                  COLOR 2
                  PBOX WORD{a%+8}+f*b3&,WORD{a%+10},WORD{a%+8}+f*b3&+ay&,WORD{a%+14}
                  IF b2&>{a%+20}
                    b2&={a%+20}
                  ELSE IF b2&<{a%+16}
                    b2&={a%+16}
                  ENDIF
                  COLOR 1,0
                  b3&=b2&
                  TEXT WORD{a%+8}-22,WORD{a%+14}+2,LEFT$(STR$(b2&)+"  ",3)
                  PBOX WORD{a%+8}+f*b2&,WORD{a%+10},WORD{a%+8}+f*b2&+ay&,WORD{a%+14}
                  IF var& AND 32
                    WORD{{a%+4}}=b2&
                  ELSE
                    BYTE{{a%+4}}=b2&
                  ENDIF
                  IF s%
                    copkleur
                  ENDIF
                ENDIF
              WEND
              IF b3&=b1&
                b2&=b1&
                b1&=WORD{a%+8}+f*b3&
                IF mx&>b1&
                  INC b2&
                ELSE
                  DEC b2&
                ENDIF
                IF b2&>{a%+20}
                  b2&={a%+20}
                ELSE IF b2&<{a%+16}
                  b2&={a%+16}
                ENDIF
                COLOR 2
                PBOX WORD{a%+8}+f*b3&,WORD{a%+10},WORD{a%+8}+f*b3&+ay&,WORD{a%+14}
                COLOR 1,0
                TEXT WORD{a%+8}-22,WORD{a%+14}+2,LEFT$(STR$(b2&)+"  ",3)
                PBOX WORD{a%+8}+f*b2&,WORD{a%+10},WORD{a%+8}+f*b2&+ay&,WORD{a%+14}
              ENDIF
              push(a%)
              IF var& AND 32
                WORD{{a%+4}}=b2&
              ELSE
                BYTE{{a%+4}}=b2&
              ENDIF
              IF s%
                copkleur
              ENDIF
            ELSE IF type&=5  !******* trekgetalschuif
              push(a%)
              IF MOUSEK=2
                stepx={a%+20}/4000
              ELSE
                stepx={a%+20}/1000
              ENDIF
              IF var& AND 32
                var%=WORD{{a%+4}}
              ELSE
                var%=BYTE{{a%+4}}
              ENDIF
              ofs&={a%+24}
              x$=""
              x1%=var%
              IF stepx<0.1
                stepx=0.1
              ENDIF
              WHILE MOUSEK
                IF ABS(MOUSEX-mx&)>2 OR ABS(MOUSEY-my&)>2
                  WHILE MOUSEK
                    waitsignal(1)
                    qual&=menu3%
                    IF qual& AND 1
                      x1%=INT(0.1*(MOUSEX-mx&)*stepx)+INT(0.1*(my&-MOUSEY)*stepx)+var%
                    ELSE
                      x1%=INT((MOUSEX-mx&)*stepx)+INT((my&-MOUSEY)*stepx)+var%
                      IF qual& AND 8
                        x1%=10*INT(x1%/10)
                      ENDIF
                    ENDIF
                    IF x1%<{a%+16}
                      x1%={a%+16}
                    ELSE IF x1%>{a%+20}
                      x1%={a%+20}
                    ENDIF
                    x$=STR$(x1%)
                    COLOR 0
                    PBOX WORD{a%+8}+ofs&,WORD{a%+10}+2,WORD{a%+12}-1,WORD{a%+14}-2
                    COLOR 2,0
                    TEXT WORD{a%+8}+ofs&,WORD{a%+14}-4,x$
                  WEND
                ENDIF
              WEND
              IF x$=""
                IF MOUSEX>WORD{a%+8}+ofs&
                  ADD x1%,1
                ELSE
                  SUB x1%,1
                ENDIF
                IF x1%<{a%+16}
                  x1%={a%+16}
                ELSE IF x1%>{a%+20}
                  x1%={a%+20}
                ENDIF
                x$=STR$(x1%)
                COLOR 0
                PBOX WORD{a%+8}+ofs&,WORD{a%+10}+2,WORD{a%+12}-1,WORD{a%+14}-2
                COLOR 2,0
                TEXT WORD{a%+8}+ofs&,WORD{a%+14}-4,x$
              ENDIF
              push(a%)
              IF var& AND 32
                WORD{{a%+4}}=x1%
              ELSE
                BYTE{{a%+4}}=x1%
              ENDIF
              COLOR 1,0
            ELSE IF type&=7
              GRAPHMODE 3
              ' PBOX x&,y&-2,x&+ax&,y&+ay&-2
              PBOX WORD{a%+8}+1,WORD{a%+10}+2,WORD{a%+12},WORD{a%+14}-1
              GRAPHMODE 1
              WHILE MOUSEK
              WEND
              WORD{{a%+4}}=NOT (WORD{{a%+4}})
            ELSE IF type&=8
              push(a%)
              t00%=a%
              x1&=WORD{a%+8}+2
            ENDIF
            a&=totbut&
          ENDIF
        ENDIF
      ENDIF
    ENDIF
    ADD a%,32
  NEXT a&
ELSE
  OPENW #1
ENDIF
GRAPHMODE 1
'
SWAP g2%,a%
'
RETURN
> PROCEDURE defbutton(nr&,type&,wi&,var&,g1%,gx&,gy&,ax&,ay&,a1%,a2%,a$)
LOCAL a&,b%,g1&
SWAP gx&,x&
SWAP gy&,y&
SWAP g1%,a%
'
b%=WINDOW(wi&)
IF b%
  b%={b%+120}
  IF b%
    totbut&=WORD{b%}
    IF nr&<=totbut&
      ADD b%,2+32*(nr&-1)
      ttype&=type& AND 240
      type&=type& AND 15
      WORD{b%}=type&
      WORD{b%+2}=var&
      {b%+4}=a%
      WORD{b%+8}=x&
      WORD{b%+10}=y&
      WORD{b%+12}=x&+ax&
      WORD{b%+14}=y&+ay&
      {b%+16}=a1%
      {b%+20}=a2%
      IF var& AND 16
        IF var& AND 32
          b1&=WORD{a%}
        ELSE
          b1&=BYTE{a%}
        ENDIF
      ELSE
        b1&=(var& AND 15)
        IF var& AND 32
          b1&=BTST(WORD{a%},b1&)
        ELSE
          b1&=BTST(BYTE{a%},b1&)
        ENDIF
      ENDIF
      IF type&=4
        COLOR 1
        PBOX x&,y&,x&+ax&,y&+ay&
        f=ax&-ay&
        g1&=b1&*f/a2%
        COLOR 2,1
        PBOX x&+g1&,y&,x&+g1&+ay&,y&+ay&
        COLOR 1,0
        TEXT x&+ax&+3,y&+ay&+2,a$
        TEXT x&-22,y&+ay&+2,STR$(b1&)
      ELSE IF type&=7
        {b%+24}=x&+ax&/2
        {b%+28}=y&+ay&/2
        COLOR 1
        PBOX x&,y&,x&+ax&,y&+ay&-1
        PUT x&,y&+2,sym$(a1%)
        IF WORD{a%}
          GRAPHMODE 3
          PBOX x&+1,y&+2,x&+ax&,y&+ay&-1
          GRAPHMODE 1
        ENDIF
      ELSE
        COLOR 1,0
        IF type&<>6
          IF v1&
            COLOR 0
            PBOX x&,y&,x&+ax&,y&+ay&
            COLOR 1,0
          ENDIF
          TEXT x&+6,y&+ay&-4,a$
          IF type&=5
            ofs&=8*LEN(a$)+2
            {b%+24}=ofs&
            TEXT x&+ofs&,y&+ay&-4,STR$(b1&)
          ENDIF
          IF ttype& AND 16
            COLOR 1
            PBOX x&,y&,x&+ax&,y&+ay&
            COLOR 2,1
            TEXT x&+6,y&+ay&-4,a$
            BOX x&,y&,x&+ax&,y&+1
            LINE x&,y&,x&,y&+ay&-1
          ELSE
            COLOR 2
            BOX x&,y&,x&+ax&,y&+1
            COLOR 1
            BOX x&,y&+ay&,x&+ax&,y&-1+ay&
            LINE x&+ax&,y&+1,x&+ax&,y&+ay&
            COLOR 2
            LINE x&,y&,x&,y&+ay&-1
          ENDIF
          IF (type&=2 OR type&=1) AND b1&
            push(b%)
          ELSE IF type&=3
            IF b1&=a2%
              push(b%)
            ENDIF
          ELSE IF type&=9
            b1&=(var& AND 15)
            b3&=(WORD{b%+8}+WORD{b%+12})/2
            b4&=(WORD{b%+10}+WORD{b%+14})/2-11
            COLOR 1
            PBOX b3&-2,b4&+1,b3&+2,b4&-1
            IF var& AND 32
              IF BTST(WORD{{b%+4}+2},b1&)
                push(b%)
                COLOR 2
                PBOX b3&-2,b4&+1,b3&+2,b4&-1
              ELSE IF BTST(WORD{{b%+4}},b1&)
                push(b%)
              ENDIF
            ELSE
            ENDIF
          ENDIF
        ELSE
          COLOR 0,1
          TEXT x&+2,y&+ay&-2,a$
          IF b1&=a2%
            COLOR 2,1
            TEXT x&+2,y&+ay&-2,a$
          ENDIF
        ENDIF
      ENDIF
      IF type&=4 OR type&=6
        a$=a$+"        "
        {b%+24}={V:a$}
        {b%+28}={V:a$+4}
      ENDIF
    ENDIF
  ENDIF
ENDIF
'
SWAP gx&,x&
SWAP gy&,y&
SWAP g1%,a%
RETURN
> PROCEDURE setbutton(g1&,wi&)
LOCAL b1&,g1%
'
SWAP g1%,a%
'
wi%=wi&
IF WINDOW(wi%)
  OPENW #wi%
  a%={WINDOW(wi&)+120}+2+32*(g1&-1)
  var&=WORD{a%+2}
  type&=WORD{a%} AND 15
  IF type&
    IF type&=1 OR type&=2
      IF POINT(WORD{a%+8},WORD{a%+10})=1
        push(a%)
      ENDIF
      IF var& AND 16
        IF var& AND 32
          IF WORD{{a%+4}}
            push(a%)
          ENDIF
        ELSE
          IF BYTE{{a%+4}}
            push(a%)
          ENDIF
        ENDIF
      ELSE
        IF var& AND 32
          IF BTST(WORD{{a%+4}},(var& AND 15))
            push(a%)
          ENDIF
        ELSE
          IF BTST(BYTE{{a%+4}},(var& AND 15))
            push(a%)
          ENDIF
        ENDIF
      ENDIF
    ELSE IF type&=9
      b3&=(WORD{a%+8}+WORD{a%+12})/2
      b4&=(WORD{a%+10}+WORD{a%+14})/2-11
      IF POINT(WORD{a%+8},WORD{a%+10})=1
        push(a%)
      ENDIF
      COLOR 1
      PBOX b3&-2,b4&+1,b3&+2,b4&-1
      b1&=(var& AND 15)
      IF var& AND 32
        IF BTST(WORD{{a%+4}+2},b1&)
          push(a%)
          COLOR 2
          PBOX b3&-2,b4&+1,b3&+2,b4&-1
        ELSE IF BTST(WORD{{a%+4}},b1&)
          push(a%)
        ENDIF
      ELSE
      ENDIF
    ELSE IF type&=3
      IF POINT(WORD{a%+8},WORD{a%+10})=1
        push(a%)
      ENDIF
      IF var& AND 32
        IF WORD{{a%+4}}={a%+20}
          push(a%)
        ENDIF
      ELSE
        IF BYTE{{a%+4}}={a%+20}
          push(a%)
        ENDIF
      ENDIF
    ELSE IF type&=4
      COLOR 1
      PBOX WORD{a%+8},WORD{a%+10},WORD{a%+12},WORD{a%+14}
      IF var& AND 32
        b1&=WORD{{a%+4}}
      ELSE
        b1&=BYTE{{a%+4}}
      ENDIF
      ay&=WORD{a%+14}-WORD{a%+10}
      f=WORD{a%+12}-WORD{a%+8}-ay&
      f=f/{a%+20}
      COLOR 1,0
      TEXT WORD{a%+8}-22,WORD{a%+14}+2,LEFT$(STR$(b1&)+"  ",3)
      COLOR 2
      PBOX WORD{a%+8}+f*b1&,WORD{a%+10},WORD{a%+8}+f*b1&+ay&,WORD{a%+14}
    ELSE IF type&=5
      COLOR 0
      PBOX WORD{a%+8}+2,WORD{a%+10}+2,WORD{a%+12}-2,WORD{a%+14}-2
      COLOR 1,0
      TEXT WORD{a%+8}+6,WORD{a%+14}-4,a$
      ofs&=8*LEN(a$)+2
      {a%+24}=ofs&
      IF var& AND 32
        var&=WORD{{a%+4}}
      ELSE
        var&=BYTE{{a%+4}}
      ENDIF
      TEXT WORD{a%+8}+ofs&,WORD{a%+14}-4,STR$(var&)
    ELSE IF type&=6
      a$=MKL$({a%+24})+MKL$({a%+28})
      WHILE RIGHT$(a$,1)=" "
        a$=LEFT$(a$,LEN(a$)-1)
      WEND
      IF WORD{{a%+4}}={a%+20}
        COLOR 2,1
      ELSE
        COLOR 0,1
      ENDIF
      TEXT WORD{a%+8}+2,WORD{a%+14}-2,a$
    ENDIF
  ENDIF
ENDIF
'
SWAP g1%,a%
'
RETURN
> PROCEDURE push(g1%)
LOCAL x1&,y1&,x2&,y2&,c1&,c2&
'
SWAP g1%,a%
'
c1&=WORD{WINDOW(wi&)+6}
c2&=WORD{WINDOW(wi&)+4}
x1&=c2&+WORD{a%+8}
y1&=c1&+WORD{a%+10}
x2&=WORD{a%+12}-x1&+c2&+1
y2&=WORD{a%+14}-y1&+c1&+1
blit(bitnep1%,bitnep2%)
blit(bitnep2%,bitnep1%)
blit(bitnep1%,bitnep2%)
'
SWAP g1%,a%
RETURN
> PROCEDURE blit(bitnep1%,bitnep2%)
ARRAYFILL reg%(),0
reg%(8)=bitnep1%
reg%(0)=x1&
reg%(1)=y1&
reg%(9)=bitnep2%
reg%(2)=x1&
reg%(3)=y1&
reg%(4)=x2&
reg%(5)=y2&
reg%(6)=&H60
reg%(7)=1
reg%(10)=0
reg%(14)=_GfxBase
RCALL _GfxBase-30,reg%()
~WaitBlit()
RETURN
> PROCEDURE tekstbut(gx&,gy&,c1&,c2&,max&,VAR a$)
' c1& is pen  c2& is paper
LOCAL b$,c$
'
SWAP gx&,x&
SWAP gy&,y&
'
teststring(a$)
FOR l&=1 TO LEN(a$)
  EXIT IF MOUSEX<(x&+TextLength(SCREEN(1)+84,{*a$},l&))
NEXT l&
'
a$=a$+" "
c$=a$
b$=MID$(a$,l&,1)
a1&=TextLength(SCREEN(1)+84,{*a$},l&-1)
COLOR c1&,c2&
TEXT x&,y&,a$+"  "
COLOR c2&,c1&
TEXT x&+a1&,y&,b$
'
WHILE MOUSEK
  waitsignal(1)
WEND
'
b&=0
WHILE MOUSEK=0 AND b&<>13 AND b&<>27
  b$=""
  activatewindow(WINDOW(5))
  REPEAT
    VSYNC
    b$=INKEY$
  UNTIL MOUSEK OR LEN(b$)
  b&=ASC(b$)
  SELECT b&
  CASE 155
    b&=BYTE{V:b$+1}
    IF b&=68 OR b&=67
      IF b&=68
        DEC l&
      ELSE
        INC l&
      ENDIF
      IF l&<1
        l&=1
      ELSE IF l&>LEN(a$)
        l&=LEN(a$)
      ENDIF
    ELSE IF b&=32
      b&=BYTE{V:b$+2}
      IF b&=65                ! shift links
        l&=1
      ELSE IF b&=64           ! shift rechts
        l&=LEN(a$)
      ENDIF
    ELSE IF b&=63
      a$=c$
    ENDIF
  CASE 8,127
    IF b&=8
      IF l&>1
        a$=LEFT$(a$,l&-2)+RIGHT$(a$,LEN(a$)-l&+1)
        DEC l&
      ENDIF
    ELSE
      IF l&>0 AND l&<LEN(a$)
        a$=LEFT$(a$,l&-1)+RIGHT$(a$,LEN(a$)-l&)
      ENDIF
    ENDIF
    '    CASE 32 TO 255
  CASE 27
    a$=c$
  CASE 33 TO 255
    IF l&<max&
      IF b&<>240
        a$=LEFT$(a$,l&-1)+CHR$(b&)+RIGHT$(a$,LEN(a$)-l&+1)
        b&=0
        INC l&
      ENDIF
    ENDIF
  ENDSELECT
  b$=MID$(a$,l&,1)
  a1&=TextLength(SCREEN(1)+84,{*a$},l&-1)
  COLOR c1&,c2&
  TEXT x&,y&,a$+"  "
  COLOR c2&,c1&
  TEXT x&+a1&,y&,b$
WEND
COLOR c1&,c2&
TEXT x&,y&,a$+"  "
IF a$<>""
  a$=LEFT$(a$,LEN(a$)-1)
ENDIF
activatewindow(WINDOW(1))
'
SWAP gx&,x&
SWAP gy&,y&
'
RETURN
> PROCEDURE teststring(VAR a$)
IF LEN(a$)
  IF INSTR(a$," ")>0
    a$=LEFT$(a$,INSTR(a$," ")-1)
  ENDIF
  IF INSTR(a$,CHR$(0))>0
    a$=LEFT$(a$,INSTR(a$,CHR$(0))-1)
  ENDIF
ENDIF
RETURN
> PROCEDURE border(wi&)
' LOCAL b1&,b2&
IF WINDOW(wi&)
  b1&=WORD{WINDOW(wi&)+8}
  b2&=WORD{WINDOW(wi&)+10}
  COLOR 1
  LINE 0,b2&-1,b1&-1,b2&-1
  LINE 0,b2&-2,b1&-1,b2&-2
  LINE b1&-1,0,b1&-1,b2&-1
  COLOR 2
  LINE 0,0,b1&-1,0
  LINE 0,1,b1&-2,1
  LINE 0,0,0,b2&-2
ENDIF
RETURN
'                           ******
> PROCEDURE paletreq
' schermfront(1,2)
OPENW #4,0,120,640,44,&HC0518,2048+4096+65536+512,1
BYTE{WINDOW(4)+55}=0
TITLEW #4,""
COLOR 1,0
CLEARW #4
border(4)
setfont(4,testfont%)
CLEARW #2
OPENW #2
OPENS 2
SETCOLOR 0,col&(0,0),col&(0,1),col&(0,2)
FOR a&=0 TO 15
  COLOR a&
  PBOX 6+a&*14,10,a&*14+18,50
NEXT a&
OPENW #4
totbut&=19
but%=2+32*totbut&
{WINDOW(4)+120}=@allocblock(but%,&H10001)
WORD{{WINDOW(4)+120}}=totbut&
col%=0
BYTE{V:col%}=col&(1,0)
BYTE{V:col%+1}=col&(1,1)
BYTE{V:col%+2}=col&(1,2)
v1&=0  !vlag pbox in defbut
defbutton(1,4,4,80,V:col%,504,8,80,4,0,15,"R ")
defbutton(2,4,4,80,V:col%+1,504,19,80,4,0,15,"G ")
defbutton(3,4,4,80,V:col%+2,504,30,80,4,0,15,"B ")
col&=1
FOR a&=0 TO 15
  defbutton(4+a&,3,4,48,V:col&,12+a&*28,2,24,14,1,a&," ")
NEXT a&
OPENW #4
OPENS 1
COLOR 3
PBOX 12,22,464,34
r&=rondje&
rondje&=-2
waitsignal(1)
~MoveSprite(vpspr%,spr.mem%,140,150)
wi&=0
copkleur
OPENS 1
WHILE wi&<>-1
  waitsignal(1)
  OPENW #4
  IF MOUSEK
    IF MOUSEY>0
      IF MOUSEY<50
        dobutton
        IF butmes&>3 AND butmes&<20
          b&=butmes&-4
          BYTE{V:col%}=col&(b&,0)
          BYTE{V:col%+1}=col&(b&,1)
          BYTE{V:col%+2}=col&(b&,2)
          setbutton(1,4)
          setbutton(2,4)
          setbutton(3,4)
          copkleur
        ELSE IF butmes&<4
          col&(col&,0)=BYTE{V:col%}
          col&(col&,1)=BYTE{V:col%+1}
          col&(col&,2)=BYTE{V:col%+2}
          OPENS 2
          SETCOLOR col&,col&(col&,0),col&(col&,1),col&(col&,2)
          OPENS 1
        ENDIF
      ELSE
        wi&=-1
      ENDIF
    ENDIF
  ENDIF
WEND
' col2&=col1&
rondje&=r&
sluitwin(4)
' beweegscherm(1,50)
OPENS 2
SETCOLOR 0,BYTE{V:wf0%},BYTE{V:wf0%+1},BYTE{V:wf0%+2}
CLEARW #2
inithamplot2(2)
OPENW #1
FRONTS 1
RETURN
> PROCEDURE mainbuttons
IF wi&=5
  OPENW #1
  IF main&<>maino&
    IF main&=3 AND (WORD{base%+4}<>1 OR WORD{basact%+4}<>3)
      a&=main&
      main&=maino&
      setbutton(a&,5)
      setbutton(main&,5)
    ELSE IF main&=4 AND WORD{basact%+4}<>2
      a&=main&
      main&=maino&
      setbutton(a&,5)
      setbutton(main&,5)
    ELSE
      sluitwin(4)
      sluitwin(3)
      SELECT main&
      CASE 1
        maino&=main&
      CASE 2
        butopen(2)
        maino&=main&
      CASE 3
        butopen(3)
        maino&=main&
      CASE 4
        butopen(4)
        maino&=main&
      CASE 5
        butopen(5)
        maino&=main&
      CASE 6
        @openmovewin
        maino&=main&
      ENDSELECT
    ENDIF
  ELSE
    IF butmes&>=7 AND butmes&<22
      IF butmuis&=1
        FOR a&=7 TO 21
          IF BTST(lay&,a&-7)
            lay&=BCLR(lay&,a&-7)
            setbutton(a&,5)
          ENDIF
        NEXT a&
        lay&=BSET(lay&,butmes&-7)
        setbutton(butmes&,5)
      ENDIF
      a&=butmes&-7
      layact&=a&+1
      IF lay&=0
        lay&=BSET(lay&,a&)
        setbutton(butmes&,5)
      ELSE
        fastprojektie
      ENDIF
    ELSE
      fastprojektie
    ENDIF
  ENDIF
ELSE
  SELECT main&
  CASE 2
    buttons(2)
  CASE 3
    buttons(3)
  CASE 4
    buttons(4)
  CASE 5
    buttons(5)
  CASE 6
    movebuttons
  ENDSELECT
ENDIF
RETURN
> PROCEDURE workfieldbuttons
IF main&=1
  OPENW #3,0,436,640,56,&HC0518,2048+4096+65536+512,1
  BYTE{WINDOW(3)+55}=0
  setfont(3,testfont%)
  COLOR 1,0
  CLEARW #3
  border(3)
  totbut&=8
  but%=2+32*totbut&
  {WINDOW(3)+120}=@allocblock(but%,&H10001)
  WORD{{WINDOW(3)+120}}=totbut&
  b6&=0
  v1&=0  !vlag pbox in defbut
  defbutton(1,3,3,48,V:b6&,10,10,72,17,1,0,"Paper")
  defbutton(2,3,3,48,V:b6&,90,10,72,17,1,1,"Pen")
  defbutton(3,3,3,48,V:b6&,10,30,72,17,1,2,"Symbols")
  defbutton(4,3,3,48,V:b6&,90,30,72,17,1,3,"Select")
  defbutton(5,3,3,48,V:b6&,170,10,72,17,1,4,"Sprite")
  defbutton(6,4,3,80,V:wf0%,290,12,100,4,0,15," R")
  defbutton(7,4,3,80,V:wf0%+1,290,24,100,4,0,15," G")
  defbutton(8,4,3,80,V:wf0%+2,290,36,100,4,0,15," B")
  COLOR 0
  PBOX 458,4,472,52
  waitsignal(1)
  ~MoveSprite(vpspr%,spr.mem%,140,150)
  wi&=3
  s%=V:wf0%
  WHILE wi&=3
    waitsignal(1)
    OPENW #3
    IF MOUSEK AND MOUSEY<56
      dobutton
      IF butmes& AND butmes&<6
        IF butmes&=1
          s%=V:wf0%
        ELSE IF butmes&=2
          s%=V:wf1%
        ELSE IF butmes&=3
          s%=V:wf2%
        ELSE IF butmes&=4
          s%=V:wf3%
        ELSE
          s%=V:wfs%
        ENDIF
        but%={WINDOW(3)+120}+2+160
        {but%+4}=s%
        {but%+32+4}=s%+1
        {but%+64+4}=s%+2
        setbutton(6,3)
        setbutton(7,3)
        setbutton(8,3)
      ENDIF
      IF butmes&>0
        b2&=b6&
        IF b6&=4
          b2&=17
        ENDIF
        COLOR b6&
        PBOX 458,4,472,52
        OPENS 1
        SETCOLOR b2&,BYTE{s%},BYTE{s%+1},BYTE{s%+2}
        IF b2&=17
          SETCOLOR 21,BYTE{s%},BYTE{s%+1},BYTE{s%+2}
        ENDIF
        IF b2&=0
          OPENS 2
          SETCOLOR b2&,BYTE{s%},BYTE{s%+1},BYTE{s%+2}
        ENDIF
      ENDIF
    ENDIF
  WEND
  sluitwin(3)
ENDIF
RETURN
> PROCEDURE opentextuwin
g1&=WORD{WINDOW(3)+6}
OPENW #4,0,g1&-144,640,144,&HC0518,2048+4096+65536+512,1
BYTE{WINDOW(4)+55}=0
TITLEW #4,""
COLOR 1,0
CLEARW #4
border(4)
setfont(4,testfont%)
strdata5a:
DATA "None ","Color","Wood ","Marble","Magic"
DATA "Image","Tiles","Blend","Stucci","","","","","","",""
totbut&=58
but%=2+32*totbut&
{WINDOW(4)+120}=@allocblock(but%,&H10001)
WORD{{WINDOW(4)+120}}=totbut&
a&=0
texture&=BYTE{adrtex%(actex&)}
inittexture
BMOVE adrtex%(actex&),wtex%,152
v1&=0  !vlag pbox in defbut
FOR a&=1 TO 9  !textures, tot&met 15
  defbutton(a&,3,4,48,V:texture&,a&*52-46,6,50,17,1,a&-1,tex$(a&-1))
NEXT a&
a&=0
defbutton(16,1,4,48,V:a&,7,26,150,17,1,0,"Name:")
defbutton(17,2,4,48,V:septex&,159,26,42,17,1,0,"Sepa")
defbutton(18,5,4,48,V:zoom&,203,26,40,17,0,4,"Zm:")
defbutton(21,1,4,48,V:a&,330,26,40,17,1,0,"Load")
defbutton(22,1,4,48,V:a&,372,26,40,17,1,0,"Save")
defbutton(23,1,4,48,V:a&,414,26,34,17,1,0,"New")
defbutton(24,1,4,48,V:a&,450,26,34,17,1,0,"Del")
defbutton(25,17,4,48,V:a&,546,26,88,17,1,0,"     OK")
'
defbutton(57,2,4,66,wtex%+2,7,66,54,17,0,1,"Blend")
defbutton(19,2,4,64,wtex%+2,64,66,66,17,1,0,"Stencil")
defbutton(58,2,4,65,wtex%+2,133,66,50,17,1,0,"Limit")
defbutton(20,5,4,80,wtex%+1,185,66,59,17,0,10,"Type:")
FOR a&=0 TO 5
  x&=116
  t$="+ "
  min&=0
  IF a&<3
    x&=7
    t$="/ "
    min&=1
  ENDIF
  y&=86+(a& MOD 3)*18
  defbutton(48+a&,5,4,48,wtex%+t.o&+2*a&,x&,y&,107,17,texmin&(a&),texmax&(a&),textu$(a&))
  defbutton(26+a&,5,4,48,wtex%+t.o&+2*a&+12,x&+218,y&,107,17,texmin&(a&+6),texmax&(a&+6),textu$(a&+6))
  defbutton(32+a&,5,4,48,wtex%+t.d&+2*a&,x&/1.9+444,y&,56,17,min&,4000,t$)
NEXT a&
a&=0
defbutton(38,1,4,64,V:a&,7,46,34,17,1,0,"File:")
'
defbutton(39,3,4,48,V:texcol&,570,86,36,17,2,0,"C 1")
defbutton(40,3,4,48,V:texcol&,570,104,36,17,2,1,"C 2")
defbutton(41,3,4,48,V:texcol&,570,122,36,17,2,2,"C 3")
copkleur
COLOR 1
PBOX 610,86,633,102
PBOX 610,104,633,120
PBOX 610,122,633,138
COLOR 3
PBOX 611,88,633,102
PBOX 611,106,633,120
PBOX 611,124,633,138
a%=wtex%+t.c&+3*texcol&
defbutton(42,4,4,80,a%,546,52,70,5,0,255,"R ")
defbutton(43,4,4,80,a%+1,546,63,70,5,0,255,"G ")
defbutton(44,4,4,80,a%+2,546,74,70,5,0,255,"B ")
a%=wtex%+3
defbutton(45,4,4,80,a%,424,52,64,5,0,255,"Col")
defbutton(46,4,4,80,a%+1,424,63,64,5,0,255,"Nor")
defbutton(47,4,4,80,a%+2,424,74,64,5,0,255,"Int")
a%=wtex%+t.c&+9
defbutton(54,4,4,80,a%,294,52,64,5,0,255,"Lim1")
defbutton(55,4,4,80,a%+1,294,63,64,5,0,255,"Lim2")
defbutton(56,4,4,80,a%+2,294,74,64,5,0,255,"Lim3")
IF BYTE{wtex%}=5
  COLOR 1,0
  TEXT 45,62,RIGHT$(pfile$,26)
ENDIF
RETURN
> PROCEDURE openmovewin
OPENW #3,0,406,640,86,&HC0518,2048+4096+65536+512,1
BYTE{WINDOW(3)+55}=0
setfont(3,testfont%)
COLOR 1,0
CLEARW #3
border(3)
actuheader
momode&=1
a$=SPACE$(14)
sta&=1
IF basact%
  IF {basact%+b.n&}<>0
    a$=SPACE$(14)
    BMOVE basact%+b.n&,V:a$,14
    teststring(a$)
    a&=WORD{basact%+b.n&+14}
    IF a&
      a$=a$+"."+STR$(a&)
    ENDIF
  ENDIF
  sta&=WORD{basact%+b.sf&}
  leesflags(basact%)
  IF WORD{basact%+4}=-2
    ob%={basact%+b.d&}
    frs&=WORD{ob%+m.f&}
    cycl&=((BYTE{ob%+m.f&+2} AND 1)=1)
    bez&=({ob%}<>0)
    qke&=({ob%+12}<>0)
    qfi&=(WORD{ob%+m.qf&}<>0)
    qfo&=(WORD{ob%+m.qfo&}<>0)
    mke&=({ob%+20}<>0)
  ELSE
    CLR cycl&,bez&,qke&,qfi&,qfo&
  ENDIF
ENDIF
totbut&=35
but%=2+32*totbut&
{WINDOW(3)+120}=@allocblock(but%,&H10001)
WORD{{WINDOW(3)+120}}=totbut&
aa&=0
sp&=1
v1&=0  !vlag pbox in defbut
defbutton(1,1,3,48,V:aa&,574,4,50,17,1,1,"Anim")
defbutton(2,2,3,48,V:loop&,520,4,48,17,1,1,"Compr")
defbutton(3,5,3,48,V:cfra&,465,4,50,17,1,999," ")
defbutton(4,5,3,48,V:sfra&,465,24,75,17,1,999,"Sta:")
defbutton(5,5,3,48,V:efra&,546,24,79,17,1,999,"End:")
defbutton(6,3,3,48,V:wire&,465,64,45,17,3,0,"Fast")
defbutton(33,3,3,48,V:wire&,515,64,60,17,3,1,"Wire Sel")
defbutton(34,3,3,48,V:wire&,580,64,45,17,3,2,"Wire")
defbutton(7,1,3,48,V:aa&,10,4,180,17,1,1," ")        !naam
defbutton(8,5,3,48,V:sta&,10,24,75,17,1,999,"Sta:")
defbutton(9,1,3,48,V:aa&,88,24,30,17,0,1,"Vec")
defbutton(10,1,3,48,V:aa&,121,24,33,17,1,1,"Quat")
defbutton(11,1,3,48,V:aa&,157,24,33,17,1,2,"Mat")
defbutton(12,1,3,48,V:aa&,10,44,50,17,1,1,"Track")
defbutton(13,1,3,48,V:aa&,10,64,50,17,1,1,"Warp")
defbutton(14,1,3,48,V:bez&,290,4,50,17,1,1,"Bezier")
defbutton(15,5,3,48,V:frs&,357,4,87,17,1,999,"Len:")
defbutton(16,1,3,48,V:qke&,290,24,44,17,1,1,"Q Key")
defbutton(17,1,3,48,V:qfi&,340,24,40,17,1,1,"Q Fill")
defbutton(18,1,3,48,V:qfo&,384,24,60,17,1,1,"Q Follow")
defbutton(19,1,3,48,V:mke&,290,44,60,17,1,1,"Mat Key")
defbutton(20,2,3,48,V:cycl&,384,44,60,17,0,-1,"Cyclic")
defbutton(21,2,3,48,V:aa&,290,64,70,17,1,1,"Duplicate")
defbutton(22,2,3,48,V:aa&,374,64,70,17,1,1,"Delta:")
defbutton(23,5,3,48,V:sp&,465,44,70,17,1,10,"Speed:")
defbutton(24,2,3,48,V:qo&,196,4,27,17,1,1,"Q o")
defbutton(25,3,3,48,V:qm&,227,4,15,17,1,0,"x")
defbutton(26,3,3,48,V:qm&,245,4,18,17,1,1,"lo")
defbutton(27,3,3,48,V:qm&,265,4,18,17,1,2,"gl")
defbutton(28,2,3,48,V:mo&,196,24,27,17,1,1,"M o")
defbutton(29,3,3,48,V:mm&,227,24,15,17,2,0,"x")
defbutton(30,3,3,48,V:mm&,245,24,18,17,2,1,"lo")
defbutton(31,3,3,48,V:mm&,265,24,18,17,2,2,"gl")
defbutton(32,2,3,48,V:qf&,196,44,80,17,1,2,"Quat first")
defbutton(35,2,3,48,V:lm&,196,64,80,17,1,1,"Local Move")
COLOR 1
PBOX 576,6,624,20
COLOR 2,1
TEXT 578,17,"Anim"
COLOR 1,0
TEXT 14,16,"Name: "+a$
RETURN
> PROCEDURE movebuttons
IF wi&=4
ELSE IF wi&=3
  SELECT butmes&
  CASE 3
    calcu&=-1
    fastprojektie
    calcu&=0
  CASE 7  !naam
    donaambutton(52,16)
  CASE 8
    IF basact%
      WORD{basact%+b.sf&}=sta&
    ENDIF
  CASE 15   !len
    IF basact% AND WORD{basact%+4}=-2
      base%=basact%
      ob%={base%+b.d&}
      IF WORD{ob%+m.f&}<>frs&
        WORD{ob%+m.f&}=frs&
      ENDIF
      rekenpad(14)
    ENDIF
  CASE 14
    IF WORD{basact%+4}=-2
      IF bez&
        okee("Delete Bezier?")
        IF a%
          ebase%=0
          bez&=0
          base%=basact%
          moving&=1
          tekenbase
          moving&=0
          ob%={basact%+b.d&}
          IF {ob%}
            freeblock({ob%})
            {ob%}=0
            IF {ob%+4}
              freeblock({ob%+4})
              {ob%+4}=0
            ENDIF
            IF {ob%+8}
              freeblock({ob%+8})
              {ob%+8}=0
            ENDIF
            IF {ob%+28}
              freeblock({ob%+24})
              {ob%+24}=0
            ENDIF
          ENDIF
          tekenbase
        ENDIF
      ELSE
        okee("Make Bezier?")
        IF a%
          bez&=-1
          ob%={basact%+b.d&}
          vv%=@allocblock(4+72,&H10001)
          {ob%}=vv%
          WORD{vv%}=4
          {vv%+4}=-0.5*dia
          {vv%+40}=0.5*dia
          BMOVE vv%+4,spline%+72,72
          np&=4
          snp&=2
          cyclic&=0
          cyclic
          FOR a&=2 TO 3
            calchandle(a&)
          NEXT a&
          BMOVE spline%+72,vv%+4,72
          rekenpad(14)
          base%=basact%
          tekenbase
        ENDIF
      ENDIF
      setbutton(14,3)
    ENDIF
  CASE 16  !q key
  CASE 17  !q fill
    IF WORD{basact%+4}=-2
      ob%={basact%+b.d&}
      base%=basact%
      fillquat
      qfi&=0
      IF WORD{ob%+m.qf&}
        qfi&=-1
      ENDIF
      qfo&=0
      WORD{ob%+m.qfo&}=0
      setbutton(17,3)
      setbutton(18,3)
    ENDIF
  CASE 18  !q foll
    IF WORD{basact%+4}=-2
      ob%={basact%+b.d&}
      IF qfo&
        okee("Delete quatfollow?")
        WORD{ob%+m.qfo&}=0
        qfo&=0
      ELSE
        WORD{ob%+m.qf&}=0
        qfi&=0
        WORD{ob%+m.qfo&}=-1
        qfo&=-1
      ENDIF
      setbutton(17,3)
      setbutton(18,3)
    ENDIF
  CASE 19  !mat key
  CASE 20
    IF basact% AND WORD{basact%+4}=-2
      ob%={basact%+b.d&}
      IF ob%
        IF cycl&
          BYTE{ob%+m.f&+2}=BSET(BYTE{ob%+m.f&+2},0)
        ELSE
          BYTE{ob%+m.f&+2}=BCLR(BYTE{ob%+m.f&+2},0)
        ENDIF
      ENDIF
    ENDIF
  CASE 24 TO 32,35
    IF basact%
      a&=-qf&
      ADD a&,-2*qo&
      ADD a&,-4*(qm&=1)
      ADD a&,-8*(qm&=2)
      ADD a&,-16*mo&
      ADD a&,-32*(mm&=1)
      ADD a&,-64*(mm&=2)
      ADD a&,-128*lm&
      BYTE{basact%+b.f&+1}=a&
      calcu&=-1
      fastprojektie
      calcu&=0
    ENDIF
  CASE 1   !anim
    exit&=0
    sf%=cfra&
    f1&=cfra&
    calcu&=-1
    moving&=-1
    ' deselectall
    esc&=0
    OPENS 10,0,0,640,512,1,32772
    b1&=256*BYTE{V:wf0%}+16*BYTE{V:wf0%+1}+BYTE{V:wf0%+2}
    b2&=256*BYTE{V:wf1%}+16*BYTE{V:wf1%+1}+BYTE{V:wf1%+2}
    SETCOLOR 0,b1&
    SETCOLOR 1,b2&
    OPENW #10,0,0,640,512,8,2048,10
    '
    OPENS 11,0,0,640,512,1,32772
    SETCOLOR 0,b1&
    SETCOLOR 1,b2&
    OPENW #11,0,0,640,512,8,2048,11
    '
    OPENS 9,0,0,640,512,1,32772
    SETCOLOR 0,b1&
    SETCOLOR 1,b2&
    OPENW #9,0,0,640,512,8,2048,9
    '
    pic1%=10
    pic2%=11
    pic3%=9
    BYTE{WINDOW(10)+55}=0
    BYTE{WINDOW(11)+55}=0
    BYTE{WINDOW(9)+55}=0
    IF wire&=1
      but&=67
    ELSE IF wire&=2
      but&=68
    ENDIF
    IF WINDOW(10)
      IF WINDOW(11)
        IF WINDOW(9)
          WHILE exit&=0
            FOR cfra&=sfra& TO efra&
              IF script&
                doscript
              ENDIF
              IF persp&=-2
                bepaalphitheta(1)
                calcphitheta
              ENDIF
              OPENW #pic1%
              COLOR 1,0
              CLEARW #pic1%
              LOCATE 2,2
              PRINT cfra&;"  "
              IF wire&
                proj2
              ELSE
                IF grond&
                  tekengrond
                ENDIF
                COLOR 1
                base%=firstbase%
                WHILE base%
                  IF WORD{base%+b.l&} AND lay&
                    IF WORD{base%+4} AND 1
                      tekenbase
                    ELSE IF WORD{base%+4}=2
                      IF {base%+b.p&}
                        tekenbase
                      ENDIF
                    ENDIF
                  ENDIF
                  base%={base%}
                WEND
              ENDIF
              FRONTS pic1%
              IF loop&
                ~RemakeDisplay()
                IF cfra&=sfra&+1
                  startanim(pic2%,pic1%)
                ELSE IF cfra&>sfra&+1
                  addanim(pic3%,pic1%)
                ENDIF
              ENDIF
              SWAP pic2%,pic3%
              SWAP pic1%,pic2%
              IF MOUSEK
                cfra&=efra&
                exit&=-1
              ENDIF
              EXIT IF esc&
            NEXT cfra&
            IF loop&
              IF NOT esc&
                endanim(pic1%,pic2%,pic3%)
                playanim
              ENDIF
              WHILE animbase%
                animblock%={animbase%}
                freeblock(animbase%)
                animbase%=animblock%
              WEND
              exit&=-1
            ENDIF
            record&=0
          WEND
        ENDIF
      ENDIF
    ENDIF
    cfra&=sf%
    OPENS 1
    OPENW #1
    moving&=0
    REPEAT
      waitsignal(0)
    UNTIL ret&=FALSE
    fastprojektie
    calcu&=0
    CLOSES pic2%
    CLOSES pic3%
    CLOSES pic1%
  ENDSELECT
ENDIF
RETURN
> PROCEDURE butopen(g1&)
SELECT g1&
CASE 2
  OPENW #3,0,392,640,100,&HC0518,2048+4096+65536+512,1
  BYTE{WINDOW(3)+55}=0
  setfont(3,testfont%)
  copkleur
  COLOR 1,0
  CLEARW #3
  COLOR 3
  PBOX 1,2,640,28
  border(3)
  COLOR 1
  BOX 0,29,640,30
  COLOR 2
  BOX 0,31,640,32
  '
  COLOR 1
  PBOX 610,40,633,92
  COLOR 3
  PBOX 611,42,633,92
  COLOR 1
  BOX 610,53,633,54
  BOX 610,67,633,68
  BOX 610,80,633,81
  '
  COLOR 1
  LINE 219,31,219,98
  LINE 465,31,465,98
  COLOR 2
  LINE 220,31,220,98
  LINE 466,31,466,98
  '
  IF buttex&<5
    ADD buttex&,4
  ENDIF
  IF buttex&>4
    actex%=wrld%+24+buttex&-5
  ELSE
    actex%=wrld%+48+buttex&-1
  ENDIF
  actex&=BYTE{actex%}
  BMOVE adrtex%(actex&),wtex%,152
  texture&=BYTE{wtex%}
  IF drietje&
    opentextuwin
  ENDIF
  OPENW #3
  totbut&=29
  but%=2+32*totbut&
  {WINDOW(3)+120}=@allocblock(but%,&H10001)
  WORD{{WINDOW(3)+120}}=totbut&
  v1&=0  !vlag pbox in defbut
  defbutton(1,3+16,3,48,V:buttex&,8,36,48,17,1,1,"")
  defbutton(2,3+16,3,48,V:buttex&,60,36,48,17,1,2,"")
  defbutton(3,3+16,3,48,V:buttex&,112,36,48,17,1,3,"")
  defbutton(4,3+16,3,48,V:buttex&,164,36,48,17,1,4,"")
  defbutton(5,3+16,3,48,V:buttex&,224,36,48,17,1,5,"")
  defbutton(6,3+16,3,48,V:buttex&,276,36,48,17,1,6,"")
  defbutton(7,3+16,3,48,V:buttex&,328,36,48,17,1,7,"")
  defbutton(8,3+16,3,48,V:buttex&,380,36,48,17,1,8,"")
  setbuttex
  a&=0
  defbutton(9,2,3,64,wrld%+19,60,56,63,17,1,2,"Ground")
  defbutton(10,2,3,65,wrld%+19,125,56,35,17,1,2,"Shad")
  defbutton(11,1,3,48,V:a&,7,76,153,17,1,0,"Obj:")
  defbutton(12,2,3,64,wrld%+18,276,56,66,17,1,2,"Sky blend")
  defbutton(13,2,3,65,wrld%+18,344,56,32,17,1,2,"Real")
  defbutton(29,5,3,48,wrld%+72,276,76,100,17,0,15,"GlobShift:")
  defbutton(14,3,3,48,V:wmode&,470,36,30,17,2,1,"Zen")
  defbutton(15,3,3,48,V:wmode&,502,36,30,17,2,0,"Hor")
  defbutton(16,3,3,48,V:wmode&,534,36,30,17,2,3,"Gro")
  defbutton(17,3,3,48,V:wmode&,566,36,30,17,2,2,"Amb")
  a%=wrld%+3*wmode&
  defbutton(18,4,3,80,a%,499,62,85,5,0,255,"R ")
  defbutton(19,4,3,80,a%+1,499,74,85,5,0,255,"G ")
  defbutton(20,4,3,80,a%+2,499,86,85,5,0,255,"B ")
  v1&=-1
  IF buttex&<5
    a%=wrld%+51+buttex&
    tbase%=wrld%+52+4*buttex&
  ELSE
    a%=wrld%+28+buttex&-5
    tbase%=wrld%+28+4*buttex&-16
  ENDIF
  defbutton(21,2,3,68,a%,7,9,153,17,1,0,"Base:")
  col&=1
  IF BTST(BYTE{a%},4)
    col&=2
  ENDIF
  basebutton(13,22)
  IF buttex&>4
    a%=wrld%+28+buttex&-5
  ELSE
    a%=wrld%+28
  ENDIF
  ' defbutton(22,2,3,68,a%,224,9,150,17,1,0,"Base:")
  defbutton(23,2,3,66,a%,380,9,28,17,1,0,"Zen")
  defbutton(24,2,3,65,a%,410,9,28,17,1,0,"Hor")
  defbutton(25,2,3,64,a%,440,9,28,17,1,0,"Ble")
  defbutton(26,8,3,48,V:a&,204,56,34,17,3,1,"[ ]")
  defbutton(27,7,3,48,V:drietje&,586,6,20,20,13,0,"")
  defbutton(28,7,3,48,V:rondje&,610,6,20,20,14,0,"")
  IF rondje&
    IF maino&=1 OR maino&>4
      copkleur
    ENDIF
    IF wmode&=2
      shadenep(4)
    ELSE
      shadenep(1)
    ENDIF
  ENDIF
CASE 3
  IF WORD{basact%+4} AND 1
    base%=basact%
    OPENW #3,0,372,640,120,&HC0518,2048+4096+65536+512,1
    BYTE{WINDOW(3)+55}=0
    COLOR 1,0
    CLEARW #3
    adrob%={basact%+b.d&}
    IF WORD{basact%+4}=3
      adrcol%=adrob%+32
      colt&=1
      eff&=0
      adrdt%=V:aa&
    ELSE
      adrcol%=adrob%+80
      colt&=BYTE{adrob%+o.c&}
      eff&=-BYTE{adrob%+o.e&}
      adrdt%=adrob%+o.dt&
    ENDIF
    copkleur
    '
    COLOR 3
    PBOX 1,2,640,28
    border(3)
    COLOR 1
    BOX 0,29,640,30
    COLOR 2
    BOX 0,31,640,32
    setfont(3,testfont%)
    colact&=1
    olay&=@lay(basact%+b.l&)
    IF buttex&>4
      SUB buttex&,4
    ENDIF
    actex%=adrcol%+c.t&+buttex&-1
    actex&=BYTE{actex%}
    BMOVE adrtex%(actex&),wtex%,152
    texture&=BYTE{wtex%}
    IF drietje&
      opentextuwin
    ENDIF
    OPENW #3
    totbut&=50
    but%=2+32*totbut&
    {WINDOW(3)+120}=@allocblock(but%,&H10001)
    WORD{{WINDOW(3)+120}}=totbut&
    a&=0
    v1&=0  !vlag pbox in defbut
    defbutton(1,1,3,48,V:a&,7,36,150,17,1,0,"Name:")
    defbutton(2,3+16,3,48,V:buttex&,170,36,48,17,1,1,"")
    defbutton(3,3+16,3,48,V:buttex&,222,36,48,17,1,2,"")
    defbutton(4,3+16,3,48,V:buttex&,274,36,48,17,1,3,"")
    defbutton(5,3+16,3,48,V:buttex&,326,36,48,17,1,4,"")
    defbutton(6,8,3,48,V:a&,378,36,34,17,3,1,"[ ]")
    defbutton(7,7,3,48,V:drietje&,586,36,20,20,13,0,"")
    defbutton(8,7,3,48,V:rondje&,610,36,20,20,14,0,"")
    defbutton(9,5,3,48,adrcol%+18,7,58,84,17,0,30000,"Halo:")
    defbutton(10,2,3,48,V:eff&,94,58,63,17,1,0,"Effect")
    defbutton(11,5,3,48,V:colact&,170,58,80,17,1,colt&,STR$(colt&)+" Col:")
    defbutton(12,2,3,64,adrcol%+3,294,58,54,17,1,0,"Smooth")
    defbutton(13,2,3,66,adrcol%+3,350,58,60,17,1,0,"Traceble")
    defbutton(14,2,3,67,adrcol%+3,412,58,60,17,1,0,"Shadows")
    defbutton(15,2,3,68,adrcol%+3,474,58,50,17,1,0,"Shless")
    defbutton(16,2,3,69,adrcol%+3,526,58,30,17,1,0,"Env")
    defbutton(17,3,3,48,V:omode&,570,58,36,17,2,0,"Ref")
    defbutton(18,3,3,48,V:omode&,570,78,36,17,2,1,"Spe")
    defbutton(19,3,3,48,V:omode&,570,98,36,17,2,2,"Mir")
    defbutton(20,5,3,48,V:olay&,7,78,56,17,0,15,"Lay:")
    '
    defbutton(47,5,3,80,adrdt%,67,78,56,17,0,15,"Draw:")
    '
    setbuttex
    COLOR 1
    PBOX 610,58,633,75
    PBOX 610,78,633,95
    PBOX 610,98,633,115
    COLOR 3
    PBOX 611,60,633,75
    PBOX 611,80,633,95
    PBOX 611,100,633,115
    a%=adrcol%
    defbutton(21,4,3,80,a%,465,82,85,5,0,255,"R ")
    defbutton(22,4,3,80,a%+1,465,94,85,5,0,255,"G ")
    defbutton(23,4,3,80,a%+2,465,106,85,5,0,255,"B ")
    defbutton(24,4,3,80,a%+4,320,82,85,5,0,255,"Ref")
    defbutton(25,4,3,80,a%+5,320,94,85,5,0,255,"Spe")
    defbutton(26,4,3,80,a%+6,320,106,85,5,3,127,"Har")
    defbutton(27,4,3,80,a%+7,170,82,85,5,0,255,"Tra")
    defbutton(28,4,3,80,a%+8,170,94,85,5,0,255,"Mir")
    defbutton(29,4,3,80,a%+9,170,106,85,5,0,255,"Ang")
    defbutton(30,4,3,80,a%+10,30,106,78,5,0,255,"Amb")
    v1&=-1
    a&=0
    a%=adrcol%+c.t&+4*buttex&
    ' button 31 is weg
    defbutton(32,2,3,46,a%,7,9,150,17,1,0,"Base:")
    defbutton(33,2,3,45,a%,158,9,30,17,1,0,"UV")
    defbutton(34,2,3,44,a%,189,9,35,17,1,0,"Glob")
    defbutton(35,2,3,43,a%,225,9,40,17,1,0,"Orco")
    defbutton(36,2,3,42,a%,266,9,40,17,1,0,"Orno")
    defbutton(37,2,3,41,a%,307,9,34,17,1,0,"Refl")
    defbutton(38,2,3,40,a%,352,9,27,17,1,0,"Col")
    defbutton(39,2,3,39,a%,380,9,29,17,1,0,"Nor")
    defbutton(40,2,3,38,a%,410,9,35,17,1,0,"Cspe")
    defbutton(41,2,3,37,a%,446,9,32,17,1,0,"Cmir")
    defbutton(42,9,3,36,a%,485,9,29,17,1,0,"Ref")
    defbutton(43,9,3,35,a%,515,9,29,17,1,0,"Spe")
    defbutton(44,9,3,34,a%,545,9,29,17,1,0,"Har")
    defbutton(45,9,3,33,a%,575,9,29,17,1,0,"Tra")
    defbutton(46,9,3,32,a%,605,9,29,17,1,0,"Mir")
    '
    tbase%=adrcol%+c.t&+16+4*buttex&
    col&=1
    IF BTST(WORD{a%},14)
      col&=2
    ENDIF
    basebutton(13,22)
    naambutton
    wi&=0
    IF rondje&
      IF maino&=1 OR maino&>4
        copkleur
      ENDIF
      shadenep(2)
    ENDIF
  ENDIF
CASE 4
  IF WORD{basact%+4}=2
    adrla%={basact%+b.d&}
    base%=basact%
    OPENW #3,0,392,640,100,&HC0518,2048+4096+65536+512,1
    BYTE{WINDOW(3)+55}=0
    setfont(3,testfont%)
    copkleur
    COLOR 1,0
    CLEARW #3
    COLOR 3
    PBOX 1,2,640,28
    border(3)
    COLOR 1
    BOX 0,29,640,30
    COLOR 2
    BOX 0,31,640,32
    border(3)
    COLOR 1
    PBOX 610,58,633,92
    COLOR 3
    PBOX 611,60,633,92
    '
    olay&=@lay(basact%+b.l&)
    IF buttex&>4
      SUB buttex&,4
    ENDIF
    actex%=adrla%+l.t&+buttex&-1
    actex&=BYTE{actex%}
    BMOVE adrtex%(actex&),wtex%,152
    texture&=BYTE{wtex%}
    IF drietje&
      opentextuwin
    ENDIF
    OPENW #3
    totbut&=28
    but%=2+32*totbut&
    {WINDOW(3)+120}=@allocblock(but%,&H10001)
    WORD{{WINDOW(3)+120}}=totbut&
    lampdist&={adrla%+6}/1000
    a&=0
    v1&=0  !vlag pbox in defbut
    defbutton(1,1,3,48,V:a&,7,36,150,17,1,0,"Name:")
    defbutton(2,3+16,3,48,V:buttex&,240,36,48,17,1,1,"")
    defbutton(3,3+16,3,48,V:buttex&,292,36,48,17,1,2,"")
    defbutton(4,3+16,3,48,V:buttex&,344,36,48,17,1,3,"")
    defbutton(5,3+16,3,48,V:buttex&,396,36,48,17,1,4,"")
    setbuttex
    a&=0
    defbutton(6,8,3,48,V:a&,448,36,34,17,3,1,"[ ]")
    defbutton(7,7,3,48,V:drietje&,586,36,20,20,13,0,"")
    defbutton(8,7,3,48,V:rondje&,610,36,20,20,14,0,"")
    defbutton(9,3,3,48,adrla%+4,7,56,40,17,2,0,"Lamp")
    defbutton(10,3,3,48,adrla%+4,49,56,35,17,2,1,"Spot")
    defbutton(11,3,3,48,adrla%+4,85,56,35,17,2,2,"Sun")
    defbutton(12,2,3,64,adrla%+16,122,56,35,17,1,2,"Shad")
    defbutton(13,2,3,65,adrla%+16,160,56,35,17,1,2,"Halo")
    defbutton(14,2,3,66,adrla%+16,197,56,35,17,1,2,"Lay")
    defbutton(15,5,3,48,V:olay&,7,76,56,17,0,15,"Lay:")
    defbutton(16,5,3,48,V:lampdist&,157,76,76,17,1,30000,"Di:")
    a%=adrla%+10
    defbutton(17,4,3,80,a%,465,62,85,5,0,255,"R ")
    defbutton(18,4,3,80,a%+1,465,74,85,5,0,255,"G ")
    defbutton(19,4,3,80,a%+2,465,86,85,5,0,255,"B ")
    defbutton(20,4,3,80,adrla%+13,300,62,85,5,0,255,"HaloInt")
    defbutton(21,4,3,80,adrla%+14,300,74,85,5,0,255,"SpotSi")
    defbutton(22,4,3,80,adrla%+15,300,86,85,5,0,127,"SpotBl")
    v1&=-1
    a%=adrla%+l.t&+2+2*buttex&
    defbutton(23,2,3,42,a%,7,9,150,17,1,0,"Base:")
    defbutton(24,2,3,41,a%,158,9,34,17,1,0,"Glob")
    defbutton(25,2,3,40,a%,193,9,34,17,1,0,"Vec")
    defbutton(26,2,3,34,a%,236,9,28,17,1,0,"Col")
    defbutton(27,2,3,33,a%,265,9,35,17,1,0,"Halo")
    defbutton(28,2,3,32,a%,301,9,35,17,1,0,"Vec")
    '
    tbase%=adrla%+l.t&+8+4*buttex&
    col&=1
    IF BTST(WORD{a%},10)
      col&=2
    ENDIF
    basebutton(13,22)
    naambutton
    IF rondje&
      IF maino&=1 OR maino&>4
        copkleur
      ENDIF
      shadenep(3)
    ENDIF
    wi&=0
  ENDIF
CASE 5
  OPENW #3,0,357,640,135,&HC0518,2048+4096+65536+512,1
  BYTE{WINDOW(3)+55}=0
  setfont(3,testfont%)
  COLOR 1,0
  CLEARW #3
  border(3)
  bcs%=V:bcsrgb
  totbut&=52
  but%=2+32*totbut&
  {WINDOW(3)+120}=@allocblock(but%,&H10001)
  WORD{{WINDOW(3)+120}}=totbut&
  LET dirstr&=0
  IF adr24bits%
    buf&=-1
  ENDIF
  a&=0
  defbutton(1,5,3,48,V:efra&,76,30,68,17,1,999,"End:")
  defbutton(2,5,3,48,V:sfra&,4,30,68,17,1,999,"Sta:")
  defbutton(40,2,3,48,V:script&,4,50,68,17,1,0,"Script")
  defbutton(47,2,3,48,V:diskc&,4,70,68,17,1,0,"Compres")
  defbutton(44,2,3,48,V:icomp&,76,90,68,17,1,0,"IntComp")
  defbutton(45,2,3,48,V:bits24&,4,90,68,17,1,0,"24 Bits")
  defbutton(49,2,3,48,V:anim5&,76,70,68,17,1,0,"Anim 5")
  defbutton(50,5,3,48,V:ssx&,4,110,68,17,1,1280,"SzX:")
  defbutton(51,5,3,48,V:ssy&,76,110,68,17,1,1024,"SzY:")
  ' defbutton(49,2,3,48,V:rempix&,76,90,68,17,1,0,"RemPix")
  defbutton(3,5,3,48,V:size&,154,4,68,17,1,15,"Size:")
  defbutton(4,2,3,48,V:ham&,225,110,68,17,1,0,"HAM")
  defbutton(5,2,3,48,V:b.en.w&,298,110,68,17,1,0,"B&W")
  defbutton(6,2,3,48,V:schaduw&,154,30,68,17,1,0,"Shadows")
  '
  ' defbutton(7,3,3,48,V:lace&,240,70,39,17,1,0,"Low")
  ' defbutton(9,3,3,48,V:lace&,283,70,39,17,1,-1,"Lace")
  ' defbutton(11,3,3,48,V:lace&,326,70,40,17,1,-2,"HiLa")
  '
  defbutton(33,2,3,48,V:osa&,154,70,32,17,1,0,"Osa")
  defbutton(34,2,3,48,V:ali&,190,70,32,17,1,0,"Ali")
  defbutton(7,3,3,48,V:lace&,226,70,32,17,1,0,"Low")
  defbutton(9,3,3,48,V:lace&,262,70,32,17,1,1,"Lac")
  defbutton(52,3,3,48,V:lace&,298,70,32,17,1,2,"Med")
  defbutton(11,3,3,48,V:lace&,334,70,32,17,1,3,"HiLa")
  '
  defbutton(8,2,3,48,V:trace&,226,30,68,17,1,0,"Trace")
  defbutton(10,2,3,48,V:zpaint&,298,30,68,17,1,0,"ZPaint")
  defbutton(12,1,3,48,V:buf&,380,30,60,17,1,0,"Buffer")
  defbutton(13,2,3,48,V:makebuf&,380,50,60,17,1,0,"Make")
  defbutton(16,1,3,48,V:a&,446,50,60,17,1,0,"Clear")
  defbutton(46,2,3,48,V:plotbuf&,446,70,60,17,1,0,"PlotBuf")
  defbutton(48,2,3,48,V:skybuf&,380,70,60,17,1,0,"SkyBuf")
  '
  defbutton(14,1,3,48,V:a&,380,111,250,16,1,0," ")
  defbutton(15,1,3,48,V:a&,446,30,60,17,1,0,"Load")
  defbutton(17,3,3,48,V:dirstr&,380,90,39,17,3,0,"Buf")
  defbutton(41,3,3,48,V:dirstr&,424,90,39,17,3,1,"Pics")
  defbutton(42,3,3,48,V:dirstr&,467,90,39,17,3,2,"Skyb")
  defbutton(43,3,3,48,V:dirstr&,509,90,39,17,3,3,"Scri")
  defbutton(18,3,3,48,V:dither&,154,50,39,17,2,0,"Di 0")
  defbutton(19,3,3,48,V:dither&,197,50,39,17,2,-1,"Di 2")
  defbutton(20,3,3,48,V:dither&,240,50,39,17,2,-2,"Di 4")
  defbutton(21,3,3,48,V:dither&,283,50,39,17,2,-3,"Di R")
  defbutton(22,3,3,48,V:dither&,326,50,40,17,2,-4,"Di F")
  defbutton(23,4,3,80,bcs%+3,544,21,60,4,0,255," R")
  defbutton(24,4,3,80,bcs%+4,544,33,60,4,0,255," G")
  defbutton(25,4,3,80,bcs%+5,544,45,60,4,0,255," B")
  defbutton(26,4,3,80,bcs%,544,57,60,4,0,255,"Br")
  defbutton(27,4,3,80,bcs%+1,544,69,60,4,0,255,"Co")
  defbutton(28,4,3,80,bcs%+2,544,81,60,4,0,255,"Sa")
  defbutton(32,1,3,48,V:a&,568,8,10,8,4,255," ")
  defbutton(29,17,3,48,V:a&,4,4,68,17,1,0,"ANIMATE")
  defbutton(30,17,3,48,V:a&,226,4,68,17,1,0,"RENDER")
  defbutton(31,17,3,48,V:a&,380,4,68,17,1,0,"DISPLAY")
  COLOR 1,0
  TEXT 384,123,buf24$
  defbutton(35,2,3,48,V:border&,153,110,68,17,1,0,"Border")
  defbutton(36,1,3,48,V:a&,153,90,68,17,1,0,"Set Bor")
  defbutton(37,2,3,48,V:newpalette&,298,90,68,17,1,0,"Palette")
  defbutton(38,5,3,48,V:cfra&,298,4,48,17,1,999," ")
  defbutton(39,5,3,48,V:genlock&,225,90,68,17,0,255,"Genl:")
  memcalc
ENDSELECT
RETURN
> PROCEDURE buttons(g1&)
SELECT g1&
CASE 0
  SELECT butmes&
  CASE 38
    IF BYTE{wtex%}=5
      IF actex&<>0
        sel.wrap.file
        a%=wtex%
        l&=BYTE{a%+68}
        IF l&<>0 AND l&<31
          LET pfile$=SPACE$(l&)
          BMOVE a%+70,V:pfile$,l&
        ELSE
          pfile$=""
        ENDIF
        OPENW #4
        COLOR 1,0
        TEXT 45,62,SPACE$(26)
        TEXT 45,62,RIGHT$(pfile$,26)
      ENDIF
    ENDIF
  CASE 25                 !OK
    IF actex&<>0      ! + controle of imwrap vrij moet
      x1%={adrtex%(actex&)+112}
      x2%={adrtex%(actex&)+116}
      IF x1%<>0 AND x1%<>{wtex%+112}
        b2&=0
        FOR b1&=1 TO totex&
          IF {adrtex%(b1&)+112}=x1% AND b1&<>actex&
            b2&=-1
          ENDIF
        NEXT b1&
        IF b2&=0
          freeblock(x1%)
          freeblock(x2%)
        ENDIF
      ENDIF
      BMOVE wtex%,adrtex%(actex&),152
    ENDIF
  CASE 23                  !NEW
    ADD totex&,1
    adrtex%(totex&)=@allocblock(152,&H10001)
    actex&=totex&
    BYTE{actex%}=actex&
    setbuttex
    BYTE{wtex%}=texture&
    BMOVE wtex%,adrtex%(actex&),152
  CASE 1 TO 15           !TEXTURE
    inittexture
    BYTE{wtex%}=texture&
    FOR a&=0 TO 11
      WORD{wtex%+t.o&+2*a&}=texdef&(a&)
    NEXT a&
    @printextudata(4)
    setbuttex
  CASE 39,40,41
    a%=wtex%+t.c&+3*texcol&        !COLORS
    but%={WINDOW(4)+120}+2+41*32
    {but%+4}=a%
    setbutton(42,4)
    {but%+32+4}=a%+1
    setbutton(43,4)
    {but%+64+4}=a%+2
    setbutton(44,4)
    copkleur
  ENDSELECT
CASE 2
  IF wi&=4
    buttons(0)
  ELSE IF wi&=3
    IF butmes&<9
      IF buttex&>4
        actex%=wrld%+24+buttex&-5
      ELSE
        actex%=wrld%+48+buttex&-1
      ENDIF
      actex&=BYTE{actex%}
      IF drietje&
        texture&=BYTE{adrtex%(actex&)}
        inittexture
        BMOVE adrtex%(actex&),wtex%,152
        @printextudata(6)
      ENDIF
      setbuttex
      but%={WINDOW(3)+120}+2
      IF buttex&>4
        b%=wrld%+28+buttex&-5
        b1%=but%+32*22+4
        FOR a&=23 TO 25
          {b1%}=b%
          setbutton(a&,3)
          ADD b1%,32
        NEXT a&
      ENDIF
      IF buttex&<5
        a%=wrld%+51+buttex&
        tbase%=wrld%+52+4*buttex&
      ELSE
        a%=wrld%+28+buttex&-5
        tbase%=wrld%+28+4*buttex&-16
      ENDIF
      b1%=but%+32*20+4
      {b1%}=a%
      setbutton(21,3)
      col&=1
      IF BTST(BYTE{a%},4)
        col&=2
      ENDIF
      basebutton(13,22)
    ELSE IF butmes&>13 AND butmes&<18
      a%=wrld%+3*wmode&
      but%={WINDOW(3)+120}+2
      b1%=but%+32*17+4
      FOR a&=0 TO 2
        {b1%}=a%+a&
        setbutton(18+a&,3)
        ADD b1%,32
      NEXT a&
      copkleur
    ELSE IF butmes&=21
      IF buttex&<5
        a%=wrld%+51+buttex&
        tbase%=wrld%+52+4*buttex&
      ELSE
        a%=wrld%+28+buttex&-5
        tbase%=wrld%+28+4*buttex&-16
      ENDIF
      IF BTST(BYTE{a%},4)
        dobasebutton(50,22)
      ENDIF
    ELSE IF butmes&=27
      IF drietje&
        opentextuwin
      ELSE
        sluitwin(4)
      ENDIF
    ELSE IF butmes&=28
      copkleur
    ELSE IF butmes&=26
      bladertex
    ENDIF
  ENDIF
  IF rondje&
    IF buttex&<5
      shadenep(4)
    ELSE
      shadenep(1)
    ENDIF
  ENDIF
CASE 3
  IF WORD{basact%+4} AND 1
    IF wi&=4
      IF butmes&
        buttons(0)
      ENDIF
    ELSE IF wi&=3
      SELECT butmes&
      CASE 1
        donaambutton(49,48)
      CASE 2 TO 5  !buttex
        actex%=adrcol%+c.t&+buttex&-1
        actex&=BYTE{actex%}
        IF drietje&
          texture&=BYTE{adrtex%(actex&)}
          inittexture
          BMOVE adrtex%(actex&),wtex%,152
          @printextudata(6)
        ENDIF
        setbuttex
        but%={WINDOW(3)+120}+2
        b%=adrcol%+c.t&+4*buttex& !mapping
        b1%=but%+32*31+4
        FOR a&=32 TO 46
          {b1%}=b%
          setbutton(a&,3)
          ADD b1%,32
        NEXT a&
        tbase%=adrcol%+c.t&+16+4*buttex&
        col&=1
        IF BTST(WORD{tbase%-16},14)
          col&=2
        ENDIF
        basebutton(13,22)
      CASE 6
        bladertex
      CASE 8
        copkleur
      CASE 7
        IF drietje&
          opentextuwin
        ELSE
          sluitwin(4)
        ENDIF
      CASE 10
        IF WORD{basact%+4}=1
          ob%={basact%+b.d&}
          IF eff&
            BYTE{ob%+o.e&}=1
            a1&=-BTST(BYTE{ob%+o.e&+1},0)
            a2&=-BTST(BYTE{ob%+o.e&+1},1)
            button("Cyclic",0,1,a1&)
            IF a%
              button("Backwards",0,1,a2&)
              IF a%
                BYTE{ob%+o.e&+1}=a1&+2*a2&
                a1&=WORD{ob%+o.e&+2}
                button("Step",1,1000,a1&)
                IF a%
                  WORD{ob%+o.e&+2}=a1&
                  a1&=WORD{ob%+o.e&+4}
                  button("Length",1,10000,a1&)
                  IF a%
                    WORD{ob%+o.e&+4}=a1&
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ELSE
            BYTE{ob%+o.e&}=0
          ENDIF
        ENDIF
      CASE 11
        IF WORD{basact%+4} AND 1
          adrcol%={basact%+b.d&}+80+64*(colact&-1)
          @printobjectdata
        ENDIF
      CASE 17,18,19
        a%=adrcol%
        IF omode&=1
          a%=adrcol%+11
        ELSE IF omode&=2
          a%=adrcol%+14
        ENDIF
        copkleur
        but%={WINDOW(3)+120}+6+20*32
        {but%}=a%
        {but%+32}=a%+1
        {but%+64}=a%+2
        setbutton(21,3)
        setbutton(22,3)
        setbutton(23,3)
      CASE 20
        olaybutton
      CASE 32 TO 37
        a%=adrcol%+c.t&+4*buttex&
        WORD{a%}=WORD{a%} AND 511
        WORD{a%}=BSET(WORD{a%},46-butmes&)
        FOR a&=32 TO 37
          setbutton(a&,3)
        NEXT a&
        IF butmes&=32
          tbase%=adrcol%+c.t&+16+4*buttex&
          dobasebutton(50,22)
        ENDIF
      ENDSELECT
    ENDIF
    IF rondje&
      shadenep(2)
    ENDIF
  ENDIF
CASE 4
  IF WORD{basact%+4}=2
    base%=basact%
    adrla%={base%+b.d&}
    IF wi&=4
      IF butmes&
        buttons(0)
      ENDIF
    ELSE IF wi&=3
      SELECT butmes&
      CASE 1
        donaambutton(49,49)
      CASE 2 TO 5  !buttex
        actex%=adrla%+l.t&+buttex&-1
        actex&=BYTE{actex%}
        IF drietje&
          texture&=BYTE{adrtex%(actex&)}
          inittexture
          BMOVE adrtex%(actex&),wtex%,152
          @printextudata(6)
        ENDIF
        setbuttex
        but%={WINDOW(3)+120}+2
        b%=adrla%+l.t&+2+2*buttex& !mapping
        b1%=but%+32*22+4
        FOR a&=23 TO 28
          {b1%}=b%
          setbutton(a&,3)
          ADD b1%,32
        NEXT a&
        tbase%=adrla%+l.t&+8+4*buttex&
        col&=1
        a%=adrla%+l.t&+2+2*buttex&
        IF BTST(WORD{a%},10)
          col&=2
        ENDIF
        basebutton(13,22)
      CASE 6
        bladertex
      CASE 9,10,11
        OPENW #1
        sn%(0)={base%+b.r&}
        sn%(1)={base%+b.r&+4}
        sn%(2)={base%+b.r&+8}
        tekendinges(2,sn%())
        OPENW #3
      CASE 8
        copkleur
      CASE 7
        IF drietje&
          opentextuwin
        ELSE
          sluitwin(4)
        ENDIF
      CASE 15
        olaybutton
      CASE 23,24,25
        a%=adrla%+l.t&+2+2*buttex&
        WORD{a%}=WORD{a%} AND 255
        WORD{a%}=BSET(WORD{a%},33-butmes&)
        setbutton(23,3)
        setbutton(24,3)
        setbutton(25,3)
        IF butmes&=23
          tbase%=adrla%+l.t&+8+4*buttex&
          dobasebutton(50,22)
        ENDIF
      ENDSELECT
      {adrla%+6}=lampdist&*1000
    ENDIF
    IF rondje&
      shadenep(3)
    ENDIF
  ENDIF
CASE 5
  IF butmes&=14
    IF dirstr&=0
      tekstbut(384,123,1,0,31,buf24$)
      IF buf24$=""
        TEXT 384,123,"ram:24BitsTrace"
        buf24$="ram:24BitsTrace"
      ENDIF
    ELSE IF dirstr&=2
      tekstbut(384,123,1,0,31,skybuf$)
      IF skybuf$=""
        TEXT 384,123,"ram:skybuf"
        skybuf$="ram:skybuf"
      ENDIF
    ELSE IF dirstr&=3
      tekstbut(384,123,1,0,31,script$)
      IF script$=""
        TEXT 384,123,"ram:script"
        skybuf$="ram:script"
      ENDIF
    ELSE
      tekstbut(384,123,1,0,31,picsdir$)
      IF picsdir$=""
        TEXT 384,123,"ram:"
        picsdir$="ram:"
      ELSE
        IF RIGHT$(picsdir$,1)<>":" AND RIGHT$(picsdir$,1)<>"/"
          IF EXIST(picsdir$+"/")
            picsdir$=picsdir$+"/"
          ENDIF
        ELSE IF RIGHT$(picsdir$,1)="/"
          IF EXIST(picsdir$+"/")
          ELSE
            picsdir$=LEFT$(picsdir$,LEN(picsdir$)-1)
          ENDIF
        ENDIF
      ENDIF
    ENDIF
  ELSE IF butmes&=15   !load buf
    IF EXIST(buf24$)
      esc&=0
      laadiff(-1,buf24$,0)
      IF esc&=0
        buf&=-1
        adr24bits%=bm24%
      ENDIF
      setbutton(12,3)
    ENDIF
  ELSE IF butmes&=16  !clear buf
    make24buf(0,100,100,0,0)
    adr24bits%=0
    buf&=0
    setbutton(12,3)
  ELSE IF butmes&=17 OR (butmes&>40 AND butmes&<44)          !dirstring mode
    COLOR 0
    PBOX 382,113,628,125
    COLOR 1,0
    IF butmes&=17
      TEXT 384,123,buf24$
    ELSE IF butmes&=41
      TEXT 384,123,picsdir$
    ELSE IF butmes&=42
      TEXT 384,123,skybuf$
    ELSE IF butmes&=43
      TEXT 384,123,script$
    ENDIF
  ELSE IF butmes&>22 AND butmes&<29
    briconsat
  ELSE IF butmes&=29         ! ANIM
    fout&=0
    IF SCREEN(5)
      CLOSEW #6
      CLOSES 5
    ENDIF
    a%=-1
    IF lay&<>255
      testlayers
      IF a%=0
        okee("Seperate Layers?")
      ENDIF
    ENDIF
    IF a%
      anim
      FRONTS 1
      CLOSEW #4
      ~MoveScreen(SCREEN(1),0,-WORD{SCREEN(1)+10})
      OPENW #1
    ENDIF
  ELSE IF butmes&=30           !RENDER
    fout&=0
    a%=-1
    IF lay&<>255
      testlayers
      IF a%=0
        okee("Seperate Layers?")
      ENDIF
    ENDIF
    IF a%
      IF SCREEN(5)
        CLOSEW #6
        CLOSES 5
      ENDIF
      init.zbuf.shade
      a=tijd%/200
      n&=0
      IF a>60
        n&=a/60
        a=a-60*n&
      ENDIF
      a$=STR$(ROUND(a,1))
      IF a<10
        a$="0"+a$
      ENDIF
      OPENW #4
      COLOR 2,0
      TEXT 200,12,"Time: "+STR$(n&)+":"+a$+" "
      REPEAT
        waitsignal(1)
        EXIT IF afbreek& OR xscript&
      UNTIL MOUSEK OR menu2%=&H45
      FRONTS 1
      CLOSEW #4
      ~MoveScreen(SCREEN(1),0,-WORD{SCREEN(1)+10})
      IF WINDOW(3)
        OPENW #3
        COLOR 1,0
        TEXT 96,17,STR$(n&)+":"+a$+"  "
      ENDIF
      theta=thetao1
      phi=phio1
      calcphitheta
      persp&=per&
      fastprojektie
      inithamplot2(2)
      setbutton(37,3)
      OPENW #1
      OPENS 1
      activatewindow(WINDOW(1))
      fout&=0
      afbreek&=0
    ENDIF
  ELSE IF butmes&=31           !display
    IF adr24bits%
      adrz%=adr24bits%+8
      initdisplay
      afmx&=SHL(WORD{bm24%},2)
      afmy&=SHR(WORD{bm24%+2},1)
      briconsat
      tijd%=TIMER
      displaylate
      IF WINDOW(3)
        tijd%=TIMER-tijd%
        a=tijd%/200
        n&=0
        IF a>60
          n&=a/60
          a=a-60*n&
        ENDIF
        a$=STR$(ROUND(a,1))
        IF a<10
          a$="0"+a$
        ENDIF
        OPENW #3
        COLOR 1,0
        TEXT 96,17,STR$(n&)+":"+a$+"  "
      ENDIF
      adrz%=0
      IF NOT (afbreek&)
        REPEAT
          waitsignal(1)
        UNTIL MOUSEK OR menu2%=&H45
      ENDIF
      FRONTS 1
      OPENW #3
      setbutton(37,3)
      inithamplot2(2)
    ENDIF
  ELSE IF butmes&=32
    {bcs%}=&H80808080
    {bcs%+4}=&H80808080
    setbutton(23,3)
    setbutton(24,3)
    setbutton(25,3)
    setbutton(26,3)
    setbutton(27,3)
    setbutton(28,3)
  ELSE IF butmes&=36
    kader
  ELSE IF butmes&=38
    fastprojektie
  ELSE IF butmes&=3
    ssizecalc
    a$="SzX:"
    setbutton(50,3)
    a$="SzY:"
    setbutton(51,3)
  ELSE IF butmes&=50 OR butmes&=51
    size&=0
    a$="Size:"
    setbutton(3,3)
  ENDIF
  memcalc
ENDSELECT
RETURN
> PROCEDURE memcalc
IF WINDOW(3)
  ssizecalc
  afmx&=ssx&
  afmy&=ssy&
  IF lace& AND 1
    ADD afmy&,afmy&
  ENDIF
  IF lace& AND 2
    ADD afmx&,afmx&
  ENDIF
  afmx&=afmx&/2
  afmy&=afmy&/2
  LET putzp&=(2*afmx&+1)
  IF ali&
    LET putzp&=putzp&*4
    zres%=16*putzp&*SHR(zbufy&,3)
  ELSE
    zres%=4*putzp&*zbufy&
  ENDIF
  ADD zres%,zres%/2
  ADD zres%,34*totvert&
  ADD zres%,32*totvlak&  !incl 4 my0 lijst
  ADD zres%,100*totlamp&
  OPENW #3
  IF zres%>AvailMem(0)
    COLOR 3,0
  ELSE
    COLOR 1,0
  ENDIF
  TEXT 551,106,"Mem: "+STR$(zres%)+"  "
ENDIF
RETURN
> PROCEDURE olaybutton
WORD{basact%+b.l&}=0
IF olay&
  WORD{basact%+b.l&}=BSET(WORD{basact%+b.l&},olay&-1)
  moving&=1
  OPENW #1
  IF lay& AND WORD{basact%+b.l&}
  ELSE
    base%=basact%
    tekenbase
  ENDIF
  moving&=0
ELSE
  WORD{basact%+b.l&}=32767
ENDIF
RETURN
> PROCEDURE dobasebutton(gx&,gy&)
a$=SPACE$(14)
IF tbase%
  IF {tbase%}
    g2%={tbase%}
    BYTE{g2%+b.i&}=BYTE{g2%+b.i&}-1
    a%={tbase%}+b.n&
    IF {a%}<>0
      BMOVE a%,V:a$,14
      teststring(a$)
      a&=WORD{{tbase%}+b.n&+14}
      IF a&
        a$=a$+"."+STR$(a&)
      ENDIF
    ENDIF
  ENDIF
ENDIF
tekstbut(gx&,gy&,2,0,13,a$)
a&=RINSTR(a$,".")
IF a&
  b&=VAL(RIGHT$(a$,LEN(a$)-a&))
  a$=LEFT$(a$,a&-1)
ELSE
  b&=0
ENDIF
a$=a$+STRING$(14,0)
g1%=firstbase%
g2%=0
a$=a$+SPACE$(14)
WHILE g1%
  ' IF g1%<>basact%
  IF @comp(V:a$,g1%+b.n&)
    IF b&=WORD{g1%+b.n&+14}
      g2%=g1%
      EXIT IF g2%
    ENDIF
  ENDIF
  ' ENDIF
  g1%={g1%}
WEND
IF g2%=0
  okee("No correct base")
  {tbase%}=0
  OPENW #3
  COLOR 0
  PBOX gx&-2,gy&-10,gx&+100,gy&+2
ELSE
  {tbase%}=g2%
  BYTE{g2%+b.i&}=BYTE{g2%+b.i&}+1
ENDIF
RETURN
> PROCEDURE basebutton(gx&,gy&)
a$=SPACE$(14)
IF {tbase%}
  a%={tbase%}+b.n&
  IF {a%}<>0
    BMOVE a%,V:a$,14
    teststring(a$)
    a&=WORD{{tbase%}+b.n&+14}
    IF a&
      a$=a$+"."+STR$(a&)
    ENDIF
  ENDIF
ENDIF
OPENW #3
COLOR 0
PBOX gx&-2,gy&-10,gx&+100,gy&+2
COLOR col&,0
TEXT gx&,gy&,"Base: "+a$
RETURN
> PROCEDURE donaambutton(gx&,gy&)
IF basact%
  a%=basact%+b.n&
  a$=SPACE$(14)
  COLOR 0
  PBOX gx&-2,gy&-10,gx&+100,gy&+2
  IF {a%}<>0
    BMOVE a%,V:a$,14
    teststring(a$)
    a&=WORD{basact%+b.n&+14}
    IF a&
      a$=a$+"."+STR$(a&)
    ENDIF
    COLOR 1,0
    TEXT gx&,gy&,a$
  ENDIF
  tekstbut(gx&,gy&,1,0,13,a$)
  COLOR 0
  PBOX gx&-2,gy&-10,gx&+100,gy&+2
  COLOR 1,0
  TEXT gx&,gy&,a$
  a&=RINSTR(a$,".")
  IF a&
    b&=VAL(RIGHT$(a$,LEN(a$)-a&))
    a$=LEFT$(a$,a&-1)
    WORD{basact%+b.n&+14}=b&
  ELSE
    WORD{basact%+b.n&+14}=0
  ENDIF
  a$=a$+STRING$(14,0)
  a%=basact%+b.n&
  BMOVE V:a$,a%,14
ENDIF
RETURN
> PROCEDURE naambutton
a%=base%+b.n&
a$=SPACE$(14)
IF {a%}<>0
  BMOVE a%,V:a$,14
  teststring(a$)
  a&=WORD{base%+b.n&+14}
  IF a&
    a$=a$+"."+STR$(a&)
  ENDIF
ENDIF
OPENW #3
COLOR 0
PBOX 8,38,156,51
COLOR 1,0
TEXT 11,49,"Name: "+a$
RETURN
> PROCEDURE setbuttex
adr%=0
IF main&=2
  adr%=wrld%+48
  b1&=1
  b3&=8
ELSE IF main&=3
  adr%=adrcol%+c.t&
  b1&=2
  b3&=4
ELSE IF main&=4
  adr%=adrla%+l.t&
  b1&=2
  b3&=4
ENDIF
IF adr%
  OPENW #3
  but%={WINDOW(3)+120}+2+32*(b1&-1)
  FOR a&=1 TO b3&
    COLOR 1
    IF {but%+20}=buttex&
      COLOR 2
    ENDIF
    PBOX WORD{but%+8}+1,WORD{but%+10}+2,WORD{but%+12},WORD{but%+14}
    COLOR 2,1
    IF {but%+20}=buttex&
      COLOR 1,2
    ENDIF
    b2&=BYTE{adr%}
    IF WINDOW(4)
      IF b2&=actex& AND (actex&<>0 OR {but%+20}=buttex&)
        a$=LEFT$(STR$(b2&)+" "+tex$(BYTE{wtex%}),6)
      ELSE
        a$=LEFT$(STR$(b2&)+" "+tex$(BYTE{adrtex%(b2&)}),6)
      ENDIF
    ELSE
      a$=LEFT$(STR$(b2&)+" "+tex$(BYTE{adrtex%(b2&)}),6)
    ENDIF
    TEXT WORD{but%+8}+6,WORD{but%+14}-4,a$
    ADD but%,32
    ADD adr%,1
    IF main&=2
      IF a&=4
        adr%=wrld%+24
      ENDIF
    ENDIF
  NEXT a&
ENDIF
RETURN
> PROCEDURE bladertex
stepx=0.1
stepy=0.1
var%=actex&
x2%=var%
WHILE MOUSEK
  x1%=(MOUSEX-mx&)*stepx+(my&-MOUSEY)*stepy+var%
  IF x1%<0
    x1%=0
  ELSE IF x1%>totex&
    x1%=totex&
  ENDIF
  IF x1%<>x2%
    x2%=x1%
    BYTE{actex%}=x1%
    setbuttex
  ENDIF
WEND
push(t00%)
IF mx&=MOUSEX AND my&=MOUSEY
  IF mx&>x1&+15
    SUB x1%,1
  ELSE
    ADD x1%,1
  ENDIF
  IF x1%<0
    x1%=0
  ELSE IF x1%>totex&
    x1%=totex&
  ENDIF
  BYTE{actex%}=x1%
  setbuttex
ENDIF
IF x1%<>actex&
  actex&=x1%
  IF drietje&
    texture&=BYTE{adrtex%(actex&)}
    inittexture
    BMOVE adrtex%(actex&),wtex%,152
    @printextudata(6)
  ENDIF
ENDIF
RETURN
> PROCEDURE printextudata(g1&)
OPENW #4
IF g1& AND 2           !textures
  texture&=BYTE{adrtex%(actex&)}
  FOR a&=1 TO 15
    setbutton(a&,4)
  NEXT a&
ENDIF
IF g1& AND 4           !getalschuiven en rgb
  but%={WINDOW(4)+120}+2
  a$="Type:"
  setbutton(19,4)
  setbutton(20,4)
  FOR a&=26 TO 31
    a$=textu$(a&-20)
    a%=but%+32*(a&-1)
    {a%+16}=texmin&(a&-20)
    {a%+20}=texmax&(a&-20)
    setbutton(a&,4)
  NEXT a&
  FOR a&=48 TO 53
    a$=textu$(a&-48)
    a%=but%+32*(a&-1)
    {a%+16}=texmin&(a&-48)
    {a%+20}=texmax&(a&-48)
    setbutton(a&,4)
  NEXT a&
  FOR a&=32 TO 37
    a$="/ "
    IF a&>34
      a$="+ "
    ENDIF
    setbutton(a&,4)
  NEXT a&
  '
  IF BYTE{wtex%}=5
    IF BYTE{wtex%+68}
      l&=BYTE{wtex%+68}
      pfile$=SPACE$(l&)
      BMOVE wtex%+70,V:pfile$,l&
    ELSE
      pfile$=""
    ENDIF
    COLOR 1,0
    TEXT 45,62,SPACE$(26)
    TEXT 45,62,RIGHT$(pfile$,26)
  ELSE
    COLOR 1,0
    TEXT 45,62,SPACE$(26)
  ENDIF
  '
  a%=wtex%+t.c&+3*texcol&  !RGB
  {but%+41*32+4}=a%
  setbutton(42,4)
  {but%+42*32+4}=a%+1
  setbutton(43,4)
  {but%+43*32+4}=a%+2
  FOR a&=44 TO 58
    setbutton(a&,4)
    IF a&=47
      a&=53
    ENDIF
  NEXT a&
  copkleur
ENDIF
RETURN
> PROCEDURE printobjectdata
but%={WINDOW(3)+120}+2
b%=adrcol%+c.t&+4*buttex&
b1%=but%+32*31+4
FOR a&=32 TO 46
  {b1%}=b%
  setbutton(a&,3)
  ADD b1%,32
NEXT a&
{but%+8*32+4}=adrcol%+18
a$="Halo:"
setbutton(9,3)
IF WORD{base%+4}=1
  eff&=-BYTE{adrob%+o.e&}
ELSE
  eff&=0
ENDIF
setbutton(10,3)
FOR a&=11 TO 15
  {but%+32*a&+4}=adrcol%+3
  setbutton(a&+1,3)
NEXT a&
olay&=@lay(base%+b.l&)
a$="Lay:"
setbutton(20,3)
IF omode&=0
  a%=adrcol%
ELSE IF omode&=1
  a%=adrcol%+11
ELSE
  a%=adrcol%+14
ENDIF
{but%+20*32+4}=a%
{but%+21*32+4}=a%+1
{but%+22*32+4}=a%+2
setbutton(21,3)
setbutton(22,3)
setbutton(23,3)
FOR a&=23 TO 29
  {but%+a&*32+4}=adrcol%+a&-19
  setbutton(a&+1,3)
NEXT a&
'
a%=adrob%+o.dt&
{but%+46*32+4}=a%
a$="Draw:"
setbutton(47,3)
'
actex%=adrcol%+c.t&+buttex&-1
actex&=BYTE{actex%}
IF drietje&
  texture&=BYTE{adrtex%(actex&)}
  inittexture
  BMOVE adrtex%(actex&),wtex%,152
  @printextudata(6)
ENDIF
setbuttex
copkleur
naambutton
tbase%=adrcol%+c.t&+16+4*buttex&
a%=tbase%-16
col&=1
IF BTST(WORD{a%},14)
  col&=2
ENDIF
basebutton(13,22)
RETURN
> PROCEDURE printlampdata
IF WORD{base%+4}=2
  adrla%={base%+b.d&}
  but%={WINDOW(3)+120}+2
  b%=adrla%+l.t&+2+2*buttex&
  b1%=but%+32*22+4
  FOR a&=23 TO 28
    {b1%}=b%
    setbutton(a&,3)
    ADD b1%,32
  NEXT a&
  {but%+8*32+4}=adrla%+4
  {but%+9*32+4}=adrla%+4
  {but%+10*32+4}=adrla%+4
  {but%+11*32+4}=adrla%+16
  {but%+12*32+4}=adrla%+16
  {but%+13*32+4}=adrla%+16
  lampdist&={adrla%+6}/1000
  {but%+16*32+4}=adrla%+10
  {but%+17*32+4}=adrla%+11
  {but%+18*32+4}=adrla%+12
  {but%+19*32+4}=adrla%+13
  {but%+20*32+4}=adrla%+14
  {but%+21*32+4}=adrla%+15
  FOR a&=9 TO 14
    setbutton(a&,3)
  NEXT a&
  FOR a&=17 TO 22
    setbutton(a&,3)
  NEXT a&
  olay&=@lay(base%+b.l&)
  a$="Lay:"
  setbutton(15,3)
  a$="Di:"
  setbutton(16,3)
  '
  actex%=adrla%+l.t&+buttex&-1
  actex&=BYTE{actex%}
  IF drietje&
    texture&=BYTE{adrtex%(actex&)}
    inittexture
    BMOVE adrtex%(actex&),wtex%,152
    @printextudata(6)
  ENDIF
  setbuttex
  copkleur
  naambutton
  tbase%=adrla%+l.t&+8+4*buttex&
  col&=1
  a%=adrla%+l.t&+2+2*buttex&
  IF BTST(WORD{a%},10)
    col&=2
  ENDIF
  basebutton(13,22)
ENDIF
RETURN
> PROCEDURE sel.wrap.file
LOCAL g1&
' definitie geheugenblok
' 60 bytes pointers
' +0  +68    *string
'     +112   *tabmem
' +4  +116   *geheugenblock picfile
' +8         *bmhd
' +12        *cmap
' +16        *body
' +20        *regeltabel
' +24        *arccoshorztabel
' +28        *arccosverttabel
' +32 +124   9*array
' +50 +142   rotx
' +52 +144   roty
' +54 +148   rotz
' +60        100 bytes file$
' 4*pich& regeltabel
' picw&/2+4 arccoshorztabel
' pich&+4 arccosverttabel
a%=wtex%
l&=BYTE{a%+68}
IF l&<>0 AND l&<31
  LET ifile$=SPACE$(l&)
  BMOVE a%+70,V:ifile$,l&
  IF RINSTR(ifile$,"/")
    g1&=RINSTR(ifile$,"/")
    LET idir$=LEFT$(ifile$,g1&)
    LET ifile$=RIGHT$(ifile$,l&-g1&)
  ELSE IF INSTR(ifile$,":")
    g1&=INSTR(ifile$,":")
    LET idir$=LEFT$(ifile$,g1&)
    LET ifile$=RIGHT$(ifile$,l&-g1&)
  ELSE
    IF idir$=""
      idir$="ram:"
    ENDIF
  ENDIF
ELSE
  LET idir$="ram:"
  LET ifile$=""
ENDIF
IF render&=0
  FRONTS 1
  hifiselect(0,"LOAD PICTURE",idir$,ifile$)
  IF fi$<>""
    idir$=di$
    pfile$=di$+fi$
    @readwrapfile
  ENDIF
ENDIF
RETURN
> PROCEDURE readwrapfile
LOCAL g1&,b1&
file$=pfile$
openfile
IF fout&=0
  checkiff(buf%)
  IF (bmhd% AND body%)<>0
    tabmem%={wtex%+112}
    IF tabmem%<>0
      b1&=-1
      FOR g1&=1 TO totex&  !kijken of vorige ima nog wordt gebruikt
        IF g1&<>actex&
          IF {adrtex%(g1&)+112}=tabmem%
            b1&=0
            g1&=totex&
          ENDIF
        ENDIF
      NEXT g1&
      IF b1&
        picmem%={tabmem%+4}
        IF picmem%
          freeblock(picmem%)
        ENDIF
        freeblock(tabmem%)
      ENDIF
    ENDIF
    picmem%=buf%
    tabellen%=pich&*4+160+pich&+picw&/2+36
    tabmem%=@allocblock(tabellen%,&H10001)
    IF tabmem%<>0
      a%=wtex%
      BYTE{a%+68}=LEN(pfile$)
      BMOVE V:pfile$,a%+70,LEN(pfile$)
      '
      {tabmem%+4}=picmem%
      {tabmem%+8}=bmhd%
      {tabmem%+12}=cmap%
      {tabmem%+16}=body%
      {tabmem%+20}=tabmem%+120              ! *regeltabel
      {tabmem%+24}={tabmem%+20}+4*pich&+10     ! *asinhor
      {tabmem%+28}={tabmem%+24}+4+2*SHR(picw&+3,2)+10   ! *asinver
      {{tabmem%+24}}=picw&/4+3
      {{tabmem%+28}}=pich&/2+3
      adr%=wtex%
      WORD{adr%+124}=&H3FFF
      WORD{adr%+132}=&H3FFF
      WORD{adr%+140}=&H3FFF
      tabeladr%={tabmem%+20}
      ~C:pointbr%(W:x&,W:y&,L:bmhd%,L:body%,L:-tabeladr%)
      asinhor%={tabmem%+24}
      asinver%={tabmem%+28}
      init.imwrap(asinhor%,asinver%)
      {wtex%+112}=tabmem%
      {wtex%+116}=picmem%
      BMOVE wtex%,adrtex%(actex&),152
      IF actex%
        BYTE{actex%}=actex&
      ENDIF
      setbuttex
    ENDIF
  ELSE
    okee("No ILBM file !")
  ENDIF
ENDIF
RETURN
'
> PROCEDURE shadeshadesphere
IF kspec&<>0
  view1&=x&
  view2&=y&
  view3&=50
  ~C:normalwrd%(L:V:view1&,L:V:view2&,L:V:view3&)
  view1&=SHR(view1&+lx&,2)
  view2&=SHR(view2&+ly&,2)
  view3&=SHR(view3&+lz&,2)
  ~C:normalwrd%(L:V:view1&,L:V:view2&,L:V:view3&)
ENDIF
IF tex1&
  x%=adrcol%
  ro&=BYTE{x%}
  gr&=BYTE{x%+1}
  bl&=BYTE{x%+2}
  kshade&=BYTE{x%+4}
  kspec&=BYTE{x%+5}
  spec&=BYTE{x%+6}
  tran&=BYTE{x%+7}
  mirr&=BYTE{x%+8}
  spro&=BYTE{x%+11}
  spgr&=BYTE{x%+12}
  spbl&=BYTE{x%+13}
  miro&=BYTE{x%+14}
  migr&=BYTE{x%+15}
  mibl&=BYTE{x%+16}
  itot&=256
  IF texco& AND 60
    IF viewmode&=0
      tex&=SHL(x&,9-zoom&)
      tey&=SHL(y&,9-zoom&)
      tez&=SHR(12000,zoom&)
    ELSE
      tex&=-SHR(xn&,1+zoom&)
      tey&=SHR(zn&,1+zoom&)
      tez&=SHR(yn&,1+zoom&)
    ENDIF
    cox&=tex&
    coy&=tey&
    coz&=tez&
    uv1&=tex&
    uv2&=tey&
  ENDIF
  IF texco& AND 1
    i&=-SHR(xn&*view1&+yn&*view2&+zn&*view3&,15)
    xr&=SHR(view1&+SHR(xn&*i&,14),zoom&)
    yr&=SHR(view2&+SHR(yn&*i&,14),zoom&)
    zr&=SHR(view3&+SHR(zn&*i&,14),zoom&)
  ENDIF
  orxn&=xn&
  oryn&=zn&
  orzn&=yn&
  tbase%=0
  IF septex&
    IF buttex&=1
      t&=BYTE{tex%}
      map1&=WORD{tex%+4}
      map2&=WORD{tex%+6}
      objectex
    ELSE
      IF BYTE{tex%+buttex&-1}
        t&=BYTE{tex%+buttex&-1}
        map1&=WORD{tex%+4*buttex&}
        map2&=WORD{tex%+2+4*buttex&}
        objectex
      ENDIF
    ENDIF
  ELSE
    t&=BYTE{tex%}
    map1&=WORD{tex%+4}
    map2&=WORD{tex%+6}
    objectex
    IF BYTE{tex%+1}
      t&=BYTE{tex%+1}
      map1&=WORD{tex%+8}
      map2&=WORD{tex%+10}
      objectex
    ENDIF
    IF BYTE{tex%+2}
      t&=BYTE{tex%+2}
      map1&=WORD{tex%+12}
      map2&=WORD{tex%+14}
      objectex
    ENDIF
    IF BYTE{tex%+3}
      t&=BYTE{tex%+3}
      map1&=WORD{tex%+16}
      map2&=WORD{tex%+18}
      objectex
    ENDIF
  ENDIF
ENDIF
inprspec&=0
inpr&=SHR(xn&*lx&+yn&*ly&+zn&*lz&,15)
IF kspec&<>0
  IF inpr&<0
    inpr&=0
  ELSE
    nnh&=0
    x1&=view1&
    x2&=view2&
    x3&=view3&
    nh&=SHR(x1&*xn&+x2&*yn&+x3&*zn&,15)
    IF nh&>speclimit&
      een&=C:spec%(nh&,spec&)
      inprspec&=SHR(kspec&*een&,14)
    ELSE
      nnh&=0
    ENDIF
  ENDIF
ENDIF
CLR r&,g&,b&
IF shless&
  r&=ro&+SHR(spro&*inprspec&,8)
  g&=gr&+SHR(spgr&*inprspec&,8)
  b&=bl&+SHR(spbl&*inprspec&,8)
ELSE
  inprshade&=SHR(kshade&*inpr&,8)
  inprspecr%=SHR(spro&*inprspec&,8)
  inprspecg%=SHR(spgr&*inprspec&,8)
  inprspecb%=SHR(spbl&*inprspec&,8)
  ADD r&,SHR(ambr&*ro&,8)+SHR(ro&*inprshade&,15)+inprspecr%
  ADD g&,SHR(ambg&*gr&,8)+SHR(gr&*inprshade&,15)+inprspecg%
  ADD b&,SHR(ambb&*bl&,8)+SHR(bl&*inprshade&,15)+inprspecb%
ENDIF
RETURN
> PROCEDURE shadenep(g1&)
inithamplot2(2)
IF drietje&
  adrtemp%=adrtex%(actex&)
  adrtex%(actex&)=wtex%
ENDIF
IF klaar&
  ADD pleksh&,60
  IF pleksh&>300
    pleksh&=40
  ENDIF
ENDIF
klaar&=1
radius&=24
gshift&=WORD{wrld%+72}
gloco&=-1
OPENW #2
tweeregelszwart(0)
SELECT g1&
CASE 1          ! **** sky
  wereldinit
  tbase%=0
  tex%=wrld%+24
  tex1&={tex%}<>0 OR BYTE{adrtex%(0)}<>0
  FOR y&=radius& DOWNTO -radius&
    COLOR 0
    LINE pleksh&-radius&,26-y&,pleksh&+radius&,26-y&
    ~C:clrbuf%(-1,-1,-1)
    FOR x&=-radius&-4 TO radius&+4
      IF ABS(x&)<=radius&
        view0&=x&
        view1&=y&
        view2&=2*lens&
        ~C:normalwrd%(L:V:view0&,L:V:view1&,L:V:view2&)
        IF BYTE{wrld%+18} AND 2
          inprz&=SHR(view1&*grond1&+view2&*grond2&,15)
          inprz&=ABS(inprz&)
          inprh&=32767-inprz&
        ELSE
          inprz&=16384+view1&
          inprh&=32767-inprz&
        ENDIF
        IF buttex&>4
          IF tex1&
            ro1&=BYTE{wrld%}
            gr1&=BYTE{wrld%+1}
            bl1&=BYTE{wrld%+2}
            ro2&=BYTE{wrld%+3}
            gr2&=BYTE{wrld%+4}
            bl2&=BYTE{wrld%+5}
            itot&=256
            tex&=view0&
            tey&=view1&
            tez&=2000
            IF zoom&
              tex&=SHR(tex&,zoom&)
              tey&=SHR(tey&,zoom&)
              tez&=SHR(2000,zoom&)
            ENDIF
            IF septex&
              IF buttex&=5
                t&=BYTE{tex%}
                map1&=BYTE{tex%+4}
                skytex
              ELSE
                IF BYTE{tex%+buttex&-5}
                  t&=BYTE{tex%+buttex&-5}
                  map1&=BYTE{tex%+buttex&-1}
                  skytex
                ENDIF
              ENDIF
            ELSE
              t&=BYTE{tex%}
              map1&=BYTE{tex%+4}
              skytex
              IF BYTE{tex%+1}
                t&=BYTE{tex%+1}
                map1&=BYTE{tex%+5}
                skytex
              ENDIF
              IF BYTE{tex%+2}
                t&=BYTE{tex%+2}
                map1&=BYTE{tex%+6}
                skytex
              ENDIF
              IF BYTE{tex%+3}
                t&=BYTE{tex%+3}
                map1&=BYTE{tex%+7}
                skytex
              ENDIF
            ENDIF
            inprh&=32767-inprz&
          ENDIF
        ENDIF
        IF (BYTE{wrld%+18} AND 1)=0
          r&=ro1&
          g&=gr1&
          b&=bl1&
        ELSE
          r&=SHR(ro1&*inprh&+ro2&*inprz&,15)
          g&=SHR(gr1&*inprh&+gr2&*inprz&,15)
          b&=SHR(bl1&*inprh&+bl2&*inprz&,15)
        ENDIF
        ~C:colorcalc2%(0,r&,g&,b&,pleksh&+x&,26-y&)
      ELSE
        ~C:colorcalc2%(0,0,0,0,pleksh&+x&,26-y&)
      ENDIF
      EXIT IF MOUSEK
    NEXT x&
    EXIT IF MOUSEK
  NEXT y&
  IF MOUSEK
    klaar&=0
  ENDIF
CASE 2       !********** sphere
  tex%=adrcol%+c.t&
  texco&=WORD{tex%+4} OR WORD{tex%+8} OR WORD{tex%+12} OR WORD{tex%+16}
  texco&=SHR(texco&,9)
  tex1&={tex%}<>0 OR BYTE{adrtex%(0)}<>0
  lx&=-18918
  ly&=-18918
  lz&=18918
  x%=adrcol%
  ro&=BYTE{x%}
  gr&=BYTE{x%+1}
  bl&=BYTE{x%+2}
  viewmode&=BYTE{x%+3} AND 1
  shless&=BYTE{x%+3} AND 16
  kshade&=BYTE{x%+4}
  kspec&=BYTE{x%+5}
  spec&=BYTE{x%+6}
  tran&=BYTE{x%+7}
  mirr&=BYTE{x%+8}
  spro&=BYTE{x%+11}
  spgr&=BYTE{x%+12}
  spbl&=BYTE{x%+13}
  miro&=BYTE{x%+14}
  migr&=BYTE{x%+15}
  mibl&=BYTE{x%+16}
  ambr&=SHR(BYTE{x%+10}*BYTE{wrld%+6},8)
  ambg&=SHR(BYTE{x%+10}*BYTE{wrld%+7},8)
  ambb&=SHR(BYTE{x%+10}*BYTE{wrld%+8},8)
  inprspec&=0
  IF specindex&=0
    specindex&=1
  ENDIF
  speclimit&=0
  IF kspec&<>0
    htest=((1/kspec&)^(1/specindex&))
    speclimit&=32767*htest
  ENDIF
  afmx&=radius&
  afmy&=radius&
  v&=SHL(radius&,4)
  rsquare%=v&*v&
  FOR y&=radius& DOWNTO -radius&
    COLOR 0
    LINE pleksh&-radius&-4,26-y&,pleksh&+radius&+4,26-y&
    y1&=-SHL(y&,4)
    ysquare%=y1&*y1&
    ~C:clrbuf%(-1,-1,-1)
    FOR x&=-radius&-4 TO radius&+4
      IF ABS(x&)<=radius&
        x1&=-SHL(x&,4)
        xsquare%=x1&*x1&
        IF viewmode&=0
          xn&=0
          yn&=0
          zn&=32767
          shadeshadesphere
        ELSE
          IF xsquare%+ysquare%<rsquare%
            zsquare%=rsquare%-xsquare%-ysquare%
            z&=SQR(zsquare%)
            xn&=x1&
            yn&=y1&
            zn&=z&
            ~C:normalwrd%(L:V:xn&,L:V:yn&,L:V:zn&)
            shadeshadesphere
          ELSE
            r&=0
            g&=0
            b&=0
          ENDIF
        ENDIF
        ~C:colorcalc2%(0,r&,g&,b&,pleksh&+x&,26-y&)
      ELSE
        ~C:colorcalc2%(0,0,0,0,pleksh&+x&,26-y&)
      ENDIF
      EXIT IF MOUSEK
    NEXT x&
    EXIT IF MOUSEK
  NEXT y&
  IF MOUSEK
    klaar&=0
  ENDIF
CASE 3   !************ Lamp
  tex%=adrla%+l.t&
  tex1&={tex%}<>0 OR BYTE{adrtex%(0)}<>0
  coz%=0
  f0%=lampdist&*1000
  l&=32767*(f0%/(dia+f0%))
  lamode&=WORD{adrla%+4}
  tweeregelszwart(0)
  FOR y&=radius& DOWNTO -radius&
    COLOR 0
    LINE pleksh&-radius&,26-y&,pleksh&+radius&,26-y&
    coy%=SHL(y&,8)
    ~C:clrbuf%(-1,-1,-1)
    IF MOUSEK
      klaar&=0
      y&=-radius&
      radius&=-ABS(radius&)
    ENDIF
    FOR x&=-radius&-4 TO radius&+4
      IF ABS(x&)<=radius&
        cox%=-SHL(x&,8)
        IF lamode&=2
          lx&=0
          ly&=0
          lz&=32767
        ELSE
          x%=cox%
          y%=coy%
          z%=4000
          ~C:ltow%(L:V:x%,L:V:y%,L:V:z%)
          lx&=x%
          ly&=y%
          lz&=z%
          ~C:normalwrd%(L:V:lx&,L:V:ly&,L:V:lz&)
        ENDIF
        rla&=BYTE{adrla%+10}
        gla&=BYTE{adrla%+11}
        bla&=BYTE{adrla%+12}
        IF tex1&
          itot&=256
          cox&=lx&
          coy&=ly&
          coz&=lz&
          IF septex&
            IF buttex&=1
              t&=BYTE{tex%}
              map1&=WORD{tex%+4}
              latex
            ELSE
              IF BYTE{tex%+buttex&-1}
                t&=BYTE{tex%+buttex&-1}
                map1&=WORD{tex%+2+2*buttex&}
                latex
              ENDIF
            ENDIF
          ELSE
            t&=BYTE{tex%}
            map1&=WORD{tex%+4}
            latex
            IF BYTE{tex%+1}
              t&=BYTE{tex%+1}
              map1&=WORD{tex%+6}
              latex
            ENDIF
            IF BYTE{tex%+2}
              t&=BYTE{tex%+2}
              map1&=WORD{tex%+8}
              latex
            ENDIF
            IF BYTE{tex%+3}
              t&=BYTE{tex%+3}
              map1&=WORD{tex%+10}
              latex
            ENDIF
          ENDIF
        ENDIF
        IF lamode&=1
          inpr&=lz&
          limit&=SHL(BYTE{adrla%+14},7)
          IF inpr&<limit&
            inpr&=0
          ELSE
            b1&=inpr&-limit&
            b2&=SHL(BYTE{adrla%+15},6)
            IF b1&<b2& AND b2&<>0
              b1&=SHR(b1&,1)
              i&=SWAP(b1&)/b2&
              inpr&=SHR(i&*inpr&,15)
            ELSE IF b1&<0
              inpr&=0
            ENDIF
          ENDIF
          lz&=SHR(lz&*inpr&,15)
        ENDIF
        inpr&=SHR(l&*lz&,15)
        r&=SHR(rla&*inpr&,15)
        g&=SHR(gla&*inpr&,15)
        b&=SHR(bla&*inpr&,15)
        ~C:colorcalc2%(0,r&,g&,b&,pleksh&+x&,26-y&)
      ELSE
        ~C:colorcalc2%(0,0,0,0,pleksh&+x&,26-y&)
      ENDIF
    NEXT x&
  NEXT y&
CASE 4   !********* grond
  ro3&=BYTE{wrld%+12}
  gr3&=BYTE{wrld%+13}
  bl3&=BYTE{wrld%+14}
  ro&=BYTE{wrld%+9}
  gr&=BYTE{wrld%+10}
  bl&=BYTE{wrld%+11}
  tex%=wrld%+48
  tex1&={tex%}<>0 OR BYTE{adrtex%(0)}<>0
  x%=obs%(0)
  y%=obs%(1)
  z%=obs%(2)
  s&=C:ltow%(L:V:x%,L:V:y%,L:V:z%)
  shift&=s&-gshift&
  FOR y&=radius& DOWNTO -radius&
    COLOR 0
    LINE pleksh&-radius&,26-y&,pleksh&+radius&,26-y&
    IF tex1&
      y1&=y&+radius&+30
      y=COSQ(y&+radius&)
      y1&=SHL(y1&,8+shift&)/y
    ENDIF
    ~C:clrbuf%(-1,-1,-1)
    FOR x&=-radius&-4 TO radius&+4
      IF ABS(x&)<=radius&
        inprh&=32767-SHL(y&+radius&,9)
        inprh&=ABS(inprh&)
        ro&=BYTE{wrld%+9}
        gr&=BYTE{wrld%+10}
        bl&=BYTE{wrld%+11}
        itot&=256
        IF tex1&
          x1&=SHR(x&*y1&,15)
          x1&=SHL(x1&,8+shift&)
          cox&=x1&
          coy&=y1&
          coz&=0
          IF zoom&
            cox&=SHR(cox&,zoom&)
            coy&=SHR(coy&,zoom&)
          ENDIF
          IF septex&
            IF buttex&=5
              t&=BYTE{tex%}
              map1&=BYTE{tex%+4}
              grotex
            ELSE
              IF BYTE{tex%+buttex&-5}
                t&=BYTE{tex%+buttex&-5}
                map1&=BYTE{tex%+buttex&-1}
                grotex
              ENDIF
            ENDIF
          ELSE
            t&=BYTE{tex%}
            grotex
            IF BYTE{tex%+1}
              t&=BYTE{tex%+1}
              grotex
            ENDIF
            IF BYTE{tex%+2}
              t&=BYTE{tex%+2}
              grotex
            ENDIF
            IF BYTE{tex%+3}
              t&=BYTE{tex%+3}
              grotex
            ENDIF
          ENDIF
        ENDIF
        r&=ro3&+SHR(ro&*inprh&,15)
        g&=gr3&+SHR(gr&*inprh&,15)
        b&=bl3&+SHR(bl&*inprh&,15)
        ~C:colorcalc2%(0,r&,g&,b&,pleksh&+x&,26-y&)
      ELSE
        ~C:colorcalc2%(0,0,0,0,pleksh&+x&,26-y&)
      ENDIF
      EXIT IF MOUSEK
    NEXT x&
    EXIT IF MOUSEK
  NEXT y&
  IF MOUSEK
    klaar&=0
  ENDIF
ENDSELECT
IF klaar&
  tweeregelszwart(49)
ENDIF
IF drietje&
  adrtex%(actex&)=adrtemp%
ENDIF
RETURN
> PROCEDURE tweeregelszwart(g1&)
LINE pleksh&-radius&,24-y&,pleksh&+radius&,24-y&
col&=0
FOR y&=g1& TO g1&+1
  ~C:clrbuf%(-1,-1,-1)
  FOR x&=-radius&-4 TO radius&+4
    ~C:colorcalc2%(0,0,0,0,pleksh&+x&,y&)
  NEXT x&
NEXT y&
RETURN
> PROCEDURE button(a$,min&,max&,VAR gx&)
LOCAL a&,gy&,b1&
'
SWAP gx&,x&
SWAP gy&,y&
'
IF x&<min&
  x&=min&
ENDIF
s&=x&
OPENW #1
a&=TextLength(SCREEN(1)+84,{*a$},LEN(a$))
b1&=140
IF a&>130
  b1&=a&+140
ENDIF
xm&=MOUSEX-b1&/2-38
ym&=MOUSEY-26
IF xm&>640-b1&-1
  xm&=640-b1&-1
ELSE IF xm&<0
  xm&=0
ENDIF
IF ym&>466
  ym&=466
ELSE IF ym&<0
  ym&=0
ENDIF
OPENW #7,xm&,ym&,b1&,46,&HC0518,2048+4096+65536+512,1
x1&=xm&+100
y1&=ym&+18
x2&=31
y2&=20
BYTE{WINDOW(7)+55}=0
TITLEW #7,""
COLOR 0,0
CLEARW #7
border(7)
setfont(7,testfont%)
COLOR 1
PBOX 9,18,91,35
COLOR 2
PBOX 9,18,91,19
LINE 9,18,9,35
COLOR 2,0
TEXT 20,14,a$
COLOR 2,1
TEXT 20,30,STR$(x&)+"  "
i$=""
BOX 100,18,130,19
LINE 100,18,100,35
COLOR 1,0
TEXT 107,30,"OK"
BOX 100,34,130,35
LINE 130,18,130,35
GRAPHMODE 3
WHILE i$=""
  waitsignal(1)
  IF menu2%=67 OR menu2%=68
    i$=" "
  ELSE IF MOUSEK
    OPENW #7
    xm&=MOUSEX
    ym&=MOUSEY
    PAUSE 1
    IF (LPEEK(WINDOW(7)+24) AND 8192)
      IF xm&>100
        IF xm<130 AND ym&>18 AND ym&<35
          blit(bitnep1%,bitnep2%)
          blit(bitnep2%,bitnep1%)
          blit(bitnep1%,bitnep2%)
          WHILE MOUSEK
          WEND
          i$=" "
        ENDIF
      ELSE
        IF MOUSEK=2
          stepx=max&/4000
        ELSE
          stepx=max&/1000
        ENDIF
        PBOX 9,18,91,35
        GRAPHMODE 1
        COLOR 1,2
        v&=x&
        x$=""
        IF stepx<0.05
          stepx=0.05
        ENDIF
        WHILE MOUSEK
          IF ABS(MOUSEX-xm&)>2 OR ABS(MOUSEY-ym&)>2
            WHILE MOUSEK
              waitsignal(1)
              qual&=menu3%
              IF qual& AND 1
                x&=(MOUSEX-xm&)*stepx*0.1+(ym&-MOUSEY)*stepx*0.1+v&
              ELSE
                x&=(MOUSEX-xm&)*stepx+(ym&-MOUSEY)*stepx+v&
                IF qual& AND 8
                  x&=10*INT(x&/10)
                ENDIF
              ENDIF
              IF x&<min&
                x&=min&
              ELSE IF x&>max&
                x&=max&
              ENDIF
              x$=LEFT$(STR$(x&)+"              ",8)
              TEXT 20,30,x$
            WEND
          ENDIF
        WEND
        IF x$=""
          IF MOUSEX<50
            DEC x&
          ELSE
            INC x&
          ENDIF
          IF x&<min&
            x&=min&
          ELSE IF x&>max&
            x&=max&
          ENDIF
          x$=LEFT$(STR$(x&)+"              ",8)
          TEXT 20,30,x$
        ENDIF
        GRAPHMODE 3
        PBOX 9,18,91,35
      ENDIF
    ELSE
      i$="l"
    ENDIF
  ENDIF
WEND
a%=0
IF i$="l"
  x&=s&
ELSE
  a%=-1
ENDIF
CLOSEW #7
OPENW #1
actuheader
'
SWAP gx&,x&
SWAP gy&,y&
'
RETURN
> PROCEDURE okee(a$)
LOCAL a&,gx&,gy&,g1&,g2&
'
SWAP gx&,x&
SWAP gy&,y&
'
OPENW #1
a&=TextLength(SCREEN(1)+84,{*a$},LEN(a$))
g2&=140
IF a&>130
  g2&=a&+20
ENDIF
x&=MOUSEX-g2&/2
y&=MOUSEY-30
IF x&>639-g2&
  x&=639-g2&
ELSE IF x&<0
  x&=0
ENDIF
g1&=0
IF main&>1 AND main&<5 AND rondje&
  g1&=110
ELSE
  FRONTS 1
ENDIF
IF y&>452
  y&=452
ELSE IF y&<g1&
  y&=g1&
ENDIF
OPENW #7,x&,y&,g2&,60,&HC0518,2048+4096+65536+512,1
BYTE{WINDOW(7)+55}=0
TITLEW #7,""
IF INSTR(a$,"QUIT")
  COLOR 3,1
ELSE
  COLOR 3,0
ENDIF
CLEARW #7
border(7)
setfont(7,testfont%)
COLOR 2
TEXT 10,18,a$
IF INSTR(a$,"ADD")
  PUT 60,25,sym$(14)
ELSE IF INSTR(a$,"QUIT")
  PUT 60,25,sym$(12),30
ELSE
  PUT 60,25,sym$(12)
ENDIF
COLOR 2,0
a%=0
g1&=0
x1&=x&
y1&=y&
x2&=g2&
y2&=60
WHILE g1&=0
  waitsignal(1)
  OPENW #7
  g1&=menu2%
  IF g1&<0 OR g1&>90
    g1&=0
  ENDIF
  IF MOUSEK
    PAUSE 1
    IF (LPEEK(WINDOW(7)+24) AND 8192)
      i&=-1
      blit(bitnep1%,bitnep2%)
      blit(bitnep2%,bitnep1%)
      blit(bitnep1%,bitnep2%)
      WHILE MOUSEK
        IF MOUSEX<0 OR MOUSEX>g2& OR MOUSEY<0 OR MOUSEY>60
          IF i&=-1
            i&=0
            blit(bitnep1%,bitnep2%)
            blit(bitnep2%,bitnep1%)
            blit(bitnep1%,bitnep2%)
          ENDIF
        ELSE IF i&=0
          i&=-1
          blit(bitnep1%,bitnep2%)
          blit(bitnep2%,bitnep1%)
          blit(bitnep1%,bitnep2%)
        ENDIF
      WEND
      g1&=1
      IF i&
        g1&=67
      ENDIF
      GRAPHMODE 1
    ELSE
      g1&=1
    ENDIF
    WHILE MOUSEK
    WEND
  ENDIF
WEND
IF g1&=67 OR g1&=68
  a%=-1
ENDIF
CLOSEW #7
activatewindow(WINDOW(1))
'
SWAP gx&,x&
SWAP gy&,y&
'
RETURN
'
ENDFUNC
RBOX kleuren
> PROCEDURE make.palette
IF WINDOW(4)
initfase("Make palette",0,0)
ENDIF
newpalette&=0
p%=*pcol%()
{p%}=adrp1%
p%=*ppcol%()
{p%}=adrp2%
FOR r&=0 TO 15
r%=r&*16*65536
FOR g&=0 TO 15
  rg%=256*g&*16+r%
  FOR b&=0 TO 15
    ppcol%(b&+16*g&+256*r&)=rg%+16*b&
  NEXT b&
NEXT g&
NEXT r&
QSORT pcol%(-),4096,ppcol%()
WHILE pcol%(16+(genlock&<>0))<>0
min&=10000
mk%=10000
FOR y&=0 TO 20
  IF pcol%(y&)
    ppcol%=ppcol%(y&)
    rcol|=SHR(ppcol%,19)
    gcol|=SHR(ppcol%,11) AND &H1F
    bcol|=SHR(ppcol%,3) AND &H1F
    ak1%=pcol%(y&)
    FOR x&=y&+1 TO 21
      IF pcol%(x&)
        ppcol%=ppcol%(x&)
        rcon|=SHR(ppcol%,19)
        gcon|=SHR(ppcol%,11) AND &H1F
        bcon|=SHR(ppcol%,3) AND &H1F
        rd|=ABS(rcol|-rcon|)
        gd|=ABS(gcol|-gcon|)
        bd|=ABS(bcol|-bcon|)
        d&=quad&(rd|)+quad&(gd|)+quad&(bd|)
        IF d&<=min&
          IF d&=min&
            akt%=ak1%+pcol%(x&)
            IF akt%<mk%
              xo&=x&
              yo&=y&
              mk%=akt%
            ENDIF
          ELSE
            xo&=x&
            yo&=y&
            min&=d&
            mk%=ak1%+pcol%(x&)
          ENDIF
        ENDIF
      ENDIF
    NEXT x&
  ENDIF
NEXT y&
ak1%=pcol%(yo&)
ak2%=pcol%(xo&)
tot%=ak1%+ak2%
IF ak2%>SHR(ak%,8)
  ppcol%=ppcol%(yo&)
  rcol|=SHR(ppcol%,16)
  gcol|=SHR(ppcol%,8) AND &HFF
  bcol|=ppcol% AND &HFF
  ppcol%=ppcol%(xo&)
  rcon|=SHR(ppcol%,16)
  gcon|=SHR(ppcol%,8) AND &HFF
  bcon|=ppcol% AND &HFF
  rt%=ak1%*rcol|+ak2%*rcon|
  gt%=ak1%*gcol|+ak2%*gcon|
  bt%=ak1%*bcol|+ak2%*bcon|
  rcol|=SHR(DIV(SHL(rt%,1),tot%)+1,1)
  gcol|=SHR(DIV(SHL(gt%,1),tot%)+1,1)
  bcol|=SHR(DIV(SHL(bt%,1),tot%)+1,1)
  IF rcol|>255
    rcol|=255
  ENDIF
  IF gcol|>255
    gcol|=255
  ENDIF
  IF bcol|>255
    bcol|=255
  ENDIF
  ppcol%(yo&)=SHL(rcol|,16)+SHL(gcol|,8)+bcol|
ENDIF
pcol%(yo&)=tot%
DELETE pcol%(xo&)
DELETE ppcol%(xo&)
WEND
min&=30200
max&=0
QSORT ppcol%(-),16
IF genlock&
col&(0,0)=SHR(ro1&,4)
col&(0,1)=SHR(gr1&,4)
col&(0,2)=SHR(bl1&,4)
ENDIF
FOR y&=-(genlock&<>0) TO 15
col&(y&,0)=SHR(ppcol%(y&+(genlock&<>0)),20)
col&(y&,1)=SHR(ppcol%(y&+(genlock&<>0)),12) AND &HF
col&(y&,2)=SHR(ppcol%(y&+(genlock&<>0)),4) AND &HF
x&=col&(y&,0)^2+col&(y&,1)^2+col&(y&,2)^2
IF x&<min&
  min&=x&
  y1&=y&
ENDIF
NEXT y&
IF y1&<>0 AND genlock&=0
FOR c&=0 TO 2
  SWAP col&(0,c&),col&(y1&,c&)
NEXT c&
ENDIF
OPENS 5
FOR y&=0 TO 15
SETCOLOR y&,col&(y&,0),col&(y&,1),col&(y&,2)
NEXT y&
OPENS 2
CLEARW #2
FOR y&=1 TO 15
SETCOLOR y&,col&(y&,0),col&(y&,1),col&(y&,2)
NEXT y&
inithamplot2(5)
OPENS 5
freeblock(adrp1%)
freeblock(adrp2%)
adrp1%=0
adrp2%=0
RETURN
> PROCEDURE inithamplot1(scherm%,code%)
inithamvars(scherm%,code%)
BYTE{ctabel%}=col&(0,0)
BYTE{ctabel%+1}=col&(0,1)
BYTE{ctabel%+2}=col&(0,2)
ARRAYFILL pcol%(),0
~C:compile%()
RETURN
> PROCEDURE inithamplot2(scherm%)
IF scherm%=2
c1&=col&(0,0)
c2&=col&(0,1)
c3&=col&(0,2)
col&(0,0)=BYTE{V:wf0%}
col&(0,1)=BYTE{V:wf0%+1}
col&(0,2)=BYTE{V:wf0%+2}
ENDIF
'
inithamvars(scherm%,fastham&)
IF b.en.w&=0 OR scherm%=2
FOR b&=0 TO 15
  BYTE{ctabel%+4*b&}=col&(b&,0)
  BYTE{ctabel%+4*b&+1}=col&(b&,1)
  BYTE{ctabel%+4*b&+2}=col&(b&,2)
NEXT b&
~C:maketab%(-(genlock&<>0),15+(genlock&<>0))
ENDIF
IF scherm%=2
col&(0,0)=c1&
col&(0,1)=c2&
col&(0,2)=c3&
ENDIF
~C:compile%()
RETURN
> PROCEDURE inithamvars(scherm%,code%)
IF bufplot%
freeblock(bufplot%-4)
CLR bufplot%
ENDIF
scherm%=SCREEN(scherm%)
IF scherm%
{bmham%}=scherm%+184
IF WORD{scherm%+76} AND 2048
  WORD{bmham%+8}=0              ! ham
ELSE IF b.en.w&
  WORD{bmham%+8}=1              ! zwart.wit
ELSE
  WORD{bmham%+8}=2              ! 16 kleuren
ENDIF
IF SCREEN(scherm%)<>2
  bufplot%=@allocblock(8*WORD{scherm%+184}+16,&H10001)
  IF bufplot%
    ADD bufplot%,4
  ENDIF
ENDIF
ELSE
{bmham%}=0
ENDIF
{bmham%+4}=code%
WORD{bmham%+10}=0
{bmham%+12}=0
{bmham%+16}=bufplot%
WORD{colcdata%-6}=displaylate& AND 1
{colcdata%-4}=127
'
sat&=2*BYTE{V:bcsrgb+2} AND (b.en.w&=0)
IF {bcs%}=&H80808080 AND WORD{bcs%+4}=&H8080
temp&=FALSE
ELSE
temp&=TRUE
ENDIF
'
WORD{colcdata%+12}=sat&
WORD{colcdata%+14}=(fastham& OR dither&=-4 OR floyd&) AND (newpalette&=0)
WORD{colcdata%+16}=temp&
WORD{colcdata%+18}=dither& AND (newpalette&=0)
WORD{colcdata%+24}=0
WORD{colcdata%+26}=0
WORD{colcdata%+28}=0
WORD{colcdata%+30}=plotbuf& AND (newpalette&=0)
WORD{colcdata%+36}=render&
WORD{colcdata%+38}=genlock&
WORD{colcdata%+40}=displaylate&
ARRAYFILL er&(),0
RETURN
> PROCEDURE minmax.rgb
IF r&>255
r&=255
ENDIF
IF b&>255
b&=255
ENDIF
IF g&>255
g&=255
ENDIF
IF r&<0
r&=0
ENDIF
IF b&<0
b&=0
ENDIF
IF g&<0
g&=0
ENDIF
RETURN
> PROCEDURE minmax.rogrbl
IF ro&>255
ro&=255
ENDIF
IF bl&>255
bl&=255
ENDIF
IF gr&>255
gr&=255
ENDIF
IF ro&<0
ro&=0
ENDIF
IF bl&<0
bl&=0
ENDIF
IF gr&<0
gr&=0
ENDIF
RETURN
> PROCEDURE kieskleur32
b6&=0
t&=10000
FOR c&=0 TO 15
b6&=quad&(ABS(col&(c&,0)-r&))
ADD b6&,quad&(ABS(col&(c&,1)-g&))
ADD b6&,quad&(ABS(col&(c&,2)-b&))
IF b6&<t&
  t&=b6&
  col&=c&
ENDIF
EXIT IF t&<2
NEXT c&
RETURN
> PROCEDURE briconsat
RANDOMIZE 120120
bcs%=V:bcsrgb
x1=256
x1=x1/(BYTE{bcs%}+128)
x2=128
x2=BYTE{bcs%+1}/x2
IF {bcs%}<>&H80808080 OR WORD{bcs%+4}<>&H8080
FOR a&=0 TO 255
  temp&=x1*(x2*(a&-128)+BYTE{bcs%})
  IF BYTE{bcs%+3}=0
    r|(a&)=0
  ELSE
    t&=temp&+BYTE{bcs%+3}-128
    IF t&<0
      t&=0
    ELSE IF t&>255
      t&=255
    ENDIF
    r|(a&)=t&
  ENDIF
  IF BYTE{bcs%+4}=0
    g|(a&)=0
  ELSE
    t&=temp&+BYTE{bcs%+4}-128
    IF t&<0
      t&=0
    ELSE IF t&>255
      t&=255
    ENDIF
    g|(a&)=t&
  ENDIF
  IF BYTE{bcs%+5}=0
    b|(a&)=0
  ELSE
    t&=temp&+BYTE{bcs%+5}-128
    IF t&<0
      t&=0
    ELSE IF t&>255
      t&=255
    ENDIF
    b|(a&)=t&
  ENDIF
NEXT a&
ENDIF
RETURN
'
ENDFUNC
'
RBOX zbuffer
> PROCEDURE init.zbuf.shade
LOCAL g&
' OPEN "o",#1,"ram:tracelog"
IF ali&
IF osa&
alishift&=5
alimax&=32
ELSE
alishift&=4
alimax&=16
ENDIF
ENDIF
render&=-1
tra&=1
tijd%=TIMER
ARRAYFILL blove%(),0
ARRAYFILL blovl%(),0
DIM la%(totlamp&)
totlampren&=0
phio1=phi
thetao1=theta
per&=persp&
bepaalphitheta(1)
calcphitheta
fout&=0
displaylate&=0
' IF tracetype&=1
' zbufy&=64
' ELSE
zbufy&=129
' ENDIF
IF half& OR filt& OR newpalette& OR makebuf& OR (bits24& AND anim&)
displaylate&=-1
ENDIF
initdisplay
'
d&=SHR(lens&*xscherm&+16,5)
SELECT lace&
CASE 0,3
d&=SHR(lens&*xscherm&+16,5)
CASE 1
d&=SHR(lens&*xscherm&+8,4)
CASE 2
ENDSELECT
'
n&=SHL(d&,4)
dsq%=n&*n&
afbreek&=0
briconsat
schrbuf&=0
IF fout&=0
LET putzp&=(2*afmx&+1)
IF ali&
zbufy&=SHR(zbufy&,2)
LET putzp&=putzp&*4
zres%=16*putzp&*zbufy&
IF osa&
  ADD zres%,16*putzp&
ENDIF
ELSE
zres%=4*putzp&*zbufy&
ENDIF
pres%=zres%/2
clipvlak&=0
roteerscene
IF afbreek&=0
OPENW #4
TEXT 300,12,"La:"+STR$(totlampren&)+" Qsf:"+STR$(spheren&)+" Po:"+STR$(polyren&)+" Ve:"+STR$(clipvert&)+" Fa:"+STR$(clipvlak&)+" Frame:"+STR$(cfra&)
initfase("Init Z buffer",0,0)
adrvlz%=@allocblock(clipvlak&*4,&H10001)
IF adrvlz%=0
  fout&=1
ENDIF
octpoint&=0
IF (schaduw& OR trace&) AND zpaint&=0 AND fout&=0
  octree
ENDIF
adr%=adrvlz%
IF fout&=0
  halobj&=0
  FOR a&=0 TO clipvlak&-1
    adrvl%=blovl%(SHR(a&,8))+m28&(a& AND 255)
    adrve1%={adrvl%}
    adrve2%={adrvl%+4}
    adrve3%={adrvl%+8}
    g&=0
    IF adrve1%<=0
      g&=-1
      {adrvl%}=-adrve1%
    ENDIF
    IF g&=0
      my0%=@ltosint(adrve1%+22)
      my1%=@ltosint(adrve2%+22)
      my2%=@ltosint(adrve3%+22)
      IF my0%>my1%
        my3%=my0%
        my0%=my1%
        my1%=my3%
      ENDIF
      IF my1%>my2%
        my3%=my2%
        my2%=my1%
        my1%=my3%
      ENDIF
      IF my0%>my1%
        my3%=my0%
        my0%=my1%
        my1%=my3%
      ENDIF
      my1%=0
      IF my2%>afmiy& OR my0%<afmay&
        IF my0%<afmiy&
          my0%=afmiy&
        ENDIF
        IF my2%>afmay&
          my2%=afmay&
        ENDIF
        WORD{adr%}=my0%
        WORD{adr%+2}=my2%
      ENDIF
    ENDIF
    ADD adr%,4
  NEXT a&
  '
  SELECT lace&
  CASE 0,3
    d&=SHR(lens&*xscherm&+16,5)
  CASE 1
    d&=SHR(lens&*xscherm&+8,4)
  CASE 2
  ENDSELECT
  '
  wereldinit
  ymin&=afmy&+1
  ymax&=afmy&
  '
  IF skybuf&
    IF skybuf%
      freeblock(skybuf%)
    ENDIF
    CLR skybuf%
    IF EXIST(skybuf$)
      fre&=FALSE
      laadiff(-2,skybuf$,0)
      IF NOT (esc&)
        IF h&=yscherm& AND w&=xscherm&
          skybuf%=animem%
        ELSE
          freeblock(animem%)
        ENDIF
        '
      ENDIF
      fre&=TRUE
    ENDIF
  ENDIF
  '
  afmiy2&=afmiy&
  IF skybuf% OR displaylate&
    sbh&=yscherm&
  ENDIF
  IF skybuf% AND (pic=sfra& OR pic=0)
    afmiy2&=-afmy&
    IF afmiy2&<afmy&-yscherm&+1
      afmiy2&=afmy&-yscherm&+1
    ENDIF
  ENDIF
  WHILE ymin&>afmiy2& AND afbreek&=0
    adrz%=@allocblock(zres%,&H10001)
    adrp%=@allocblock(pres%,&H10001)
    IF adrz%=0 OR adrp%=0
      okee("Not enough memory")
    ENDIF
    EXIT IF adrz%=0 OR adrp%=0
    '
    SUB ymin&,zbufy&
    IF ymin&<afmiy2&
      ymin&=afmiy2&
    ENDIF
    ~C:initzbuf%(L:adrz%,L:adrp%,L:V:z0)
    zbuffer
    ' IF ali&
    ' zplot
    ' ENDIF
    IF displaylate& OR skybuf%
      SUB sbh&,ymax&-ymin&+1
      IF sbh&<0
        SUB ymin&,sbh&
      ENDIF
      '            IF plotbuf& AND (newpalette&=0)
      '            make24buf(12,xscherm&,yscherm&,WORD{SCREEN(5)+76},ymax&-ymin&+1)
      '          ELSE
      make24buf(24,xscherm&,yscherm&,WORD{SCREEN(5)+76},ymax&-ymin&+1)
      '          ENDIF
      IF displaylate&
        IF schrbuf&=0
          schrbuf&=-1
          schrijfiff(buf24$,-2)     ! open
        ENDIF
      ENDIF
      IF skybuf%
        li_reg%(12)=-1
        li_reg%(8)=bm24%
        RCALL laadiff%,li_reg%()
      ENDIF
      IF sbh&<0
        ADD ymin&,sbh&            ! hoeft eigenlijk niet
      ENDIF
    ENDIF
    initfase("Shading",0,2*afmy&+1)
    IF osa&
      ~C:initzread%(32,3,7,L:2*(putzp&-4),L:V:adrscz%,L:V:adrscp%,L:V:blovl%(0),L:V:m28&(0),(clipvlak&+1))
    ELSE
      ~C:initzread%(16,3,3,L:2*(putzp&-4),L:V:adrscz%,L:V:adrscp%,L:V:blovl%(0),L:V:m28&(0),(clipvlak&+1))
    ENDIF
    IF afbreek&=0
      shadez
    ENDIF
    IF schrbuf&
      schrijfiff(buf24$,-3)       ! append
    ENDIF
    freeblock(adrz%)
    adrz%=0
    freeblock(adrp%)
    adrp%=0
    SUB ymax&,zbufy&
  WEND
ENDIF
IF schrbuf&
  WHILE ymax&>-afmy&
    SUB ymin&,zbufy&
    IF ymin&<afmiy2&
      ymin&=afmiy2&
    ENDIF
    '
    SUB sbh&,ymax&-ymin&+1
    IF sbh&<0
      SUB ymin&,sbh&
    ENDIF
    '
    make24buf(24,xscherm&,yscherm&,WORD{SCREEN(5)+76},ymax&-ymin&+1)
    IF skybuf%
      li_reg%(12)=-1
      li_reg%(8)=bm24%
      RCALL laadiff%,li_reg%()
    ENDIF
    schrijfiff(buf24$,-3)       ! append
    SUB ymax&,zbufy&
    '
    IF sbh&<0
      ADD ymin&,sbh&             ! hoeft eigenlijk niet
    ENDIF
  WEND
  make24buf(0,0,0,0,0)
  schrijfiff(buf24$,-3)             ! sluiten
ENDIF
'
IF skybuf%
  freeblock(skybuf%)
  CLR skybuf%
ENDIF
ENDIF
'
IF adroct%
freeblock(adroct%)
CLR adroct%
ENDIF
IF adrvlz%<>0
freeblock(adrvlz%)
CLR adrvlz%
ENDIF
IF spheren&
freeblock(adrzsphere%)
CLR adrzsphere%
ENDIF
IF adrha%
freeblock(adrha%)
CLR adrha%
ENDIF
a&=0
WHILE blove%(a&)<>0
freeblock(blove%(a&))
blove%(a&)=0
INC a&
WEND
a&=0
WHILE blovl%(a&)<>0
freeblock(blovl%(a&))
blovl%(a&)=0
INC a&
WEND
FOR a&=1 TO totlampren&
freeblock(la%(a&))
NEXT a&
FOR a&=1 TO polyren&
freeblock(poly%(a&))
NEXT a&
IF half& OR filt& OR newpalette&
IF afbreek&=0 AND fout&=0
  laadiff(-1,buf24$,0)
  make.palette
  displaylate
  make24buf(0,0,0,0,0)
  adr24bits%=0
ENDIF
ENDIF
ENDIF
tijd%=TIMER-tijd%
render&=0
ERASE la%()
' CLOSE #1
RETURN
> PROCEDURE testlayers
a%=1
IF xscript&=0
base%=firstbase%
WHILE base%
IF (lay& AND WORD{base%+b.l&})=0
  IF WORD{base%+4} AND 1
    a%=0
  ENDIF
ENDIF
EXIT IF a%=0
base%={base%}
WEND
ENDIF
RETURN
'
> PROCEDURE zbuffer
IF fout&=0
t00=0.5
t01=0.5
t02=0.5
COLOR 15
IF ali&
ymin4&=4*ymin&
ymax4&=4*ymax&+3
afmix4&=4*afmix&
afmiy4&=4*afmiy&
afmax4&=4*afmax&+3
afmay4&=4*afmay&+3
IF osa&
  SUB ymin4&,2
  ADD ymax4&,2
  SUB afmiy4&,2
  ADD afmay4&,2
ENDIF
initfase("Z buffer Osa",0,clipvlak&)
ELSE
initfase("Z buffer",0,clipvlak&)
ENDIF
zground
FOR a&=1 TO spheren&
zsphere(a&)
NEXT a&
FOR a&=1 TO polyren&
zpoly(a&)
NEXT a&
t00=0.5
t01=0.5
t02=0.5
IF fout&=0
IF ali&
  abuffer
ELSE
  adrvlzs%=adrvlz%-4
  '  OPENW #6
  ' rastplot(6)
  FOR a&=0 TO clipvlak&-1
    ADD adrvlzs%,4
    my0%=WORD{adrvlzs%}
    my2%=WORD{adrvlzs%+2}
    IF my0% OR my2%
      IF my2%>=ymin& AND my0%<=ymax&
        ' IF my2%>ymax&
        ' my2%=ymax&
        ' ENDIF
        adrvl%=blovl%(SHR(a&,8))+m28&(a& AND 255)
        adrve1%={adrvl%}
        adrve2%={adrvl%+4}
        adrve3%={adrvl%+8}
        IF (a& AND 15)=15
          fase(a&)
        ENDIF
        '  col&=(a& MOD 15)+1
        x1=@ltosing(adrve1%+18)
        x2=@ltosing(adrve2%+18)
        x3=@ltosing(adrve3%+18)
        y1=@ltosing(adrve1%+22)
        y2=@ltosing(adrve2%+22)
        y3=@ltosing(adrve3%+22)
        {V:t00}={adrve1%+26}
        {V:t01}={adrve2%+26}
        {V:t02}={adrve3%+26}
        x11=x1-x2
        x22=x2-x3
        y11=y1-y2
        y22=y2-y3
        z1=t00-t01
        z2=t01-t02
        x0=y11*z2-z1*y22
        y0=z1*x22-x11*z2
        z0=x11*y22-y11*x22
        xx1=x0*x1+y0*y1+z0*t00
        IF z0<>0
          IF a&<totvlakren&
            v&=a&+1
          ELSE
            v&=WORD{adrvl%+18}+1
          ENDIF
          '
          y11=MIN(y1,y2,y3)
          y22=MAX(y1,y2,y3)
          my2%=INT(y22)
          '
          zxd=-x0/z0
          zyd=-y0/z0
          zy0=my2%*zyd+xx1/z0+zyd
          '
          my0%=-INT(-y11)
          IF my0%<ymin&
            my0%=ymin&
          ENDIF
          '
          f1&=0
          snijpz(x1,y1,x2,y2)
          snijpz(x2,y2,x3,y3)
          snijpz(x3,y3,x1,y1)
          IF f1&<>7
            '   ~DisplayBeep(0)
          ELSE
            '
            temp&=ymax&-my2%
            x0%=SHL(putzp&*temp&+afmx&,1)
            '
            ~C:initpoly%(v&,L:V:zxd)
            '
            FOR y&=my2% DOWNTO my0%
              SUB zy0,zyd
              '
              sn1&=INT(xs1)
              ADD xs1,dx1
              IF y&<=omsl&
                sn2&=INT(xs3)
                ADD xs3,dx3
              ELSE
                sn2&=INT(xs2)
                ADD xs2,dx2
              ENDIF
              '
              IF sn1&>sn2&
                SWAP sn1&,sn2&
              ENDIF
              ADD sn1&,1
              '
              IF sn2&>afmix& OR sn1&<afmax&
                IF y&>=afmiy& AND y&<=afmay& AND y&<=ymax&
                  IF sn2&>afmax&
                    sn2&=afmax&
                  ENDIF
                  IF sn1&<afmix&
                    sn1&=afmix&
                  ENDIF
                  IF sn1&<=sn2&
                    z0=sn1&*zxd+zy0
                    x1%=x0%+2*sn1&
                    '
                    ~C:fillz%(sn2&-sn1&,L:x1%)
                  ENDIF
                ENDIF
              ENDIF
              ADD x0%,2*putzp&
            NEXT y&
            IF {{msga%}}
              @decodemsg(GetMsg(msgp2%))
              IF menu2%=&H45
                afbreek&=-1
                a&=clipvlak&
              ENDIF
            ENDIF
          ENDIF
        ENDIF
      ENDIF
    ENDIF
  NEXT a&
ENDIF
ENDIF
ENDIF
RETURN
> PROCEDURE abuffer
'
adrvlzs%=adrvlz%-4
'  OPENW #6
' rastplot(6)
FOR a&=0 TO clipvlak&-1
ADD adrvlzs%,4
my0%=WORD{adrvlzs%}
my2%=WORD{adrvlzs%+2}
IF my0% OR my2%
IF my2%>=ymin&-1 AND my0%<=ymax&+1
  adrvl%=blovl%(SHR(a&,8))+m28&(a& AND 255)
  adrve1%={adrvl%}
  adrve2%={adrvl%+4}
  adrve3%={adrvl%+8}
  IF (a& AND 15)=15
    fase(a&)
  ENDIF
  '  col&=(a& MOD 15)+1
  x1=4*@ltosing(adrve1%+18)
  x2=4*@ltosing(adrve2%+18)
  x3=4*@ltosing(adrve3%+18)
  y1=4*@ltosing(adrve1%+22)
  y2=4*@ltosing(adrve2%+22)
  y3=4*@ltosing(adrve3%+22)
  {V:t00}={adrve1%+26}
  {V:t01}={adrve2%+26}
  {V:t02}={adrve3%+26}
  x11=x1-x2
  x22=x2-x3
  y11=y1-y2
  y22=y2-y3
  z1=t00-t01
  z2=t01-t02
  x0=y11*z2-z1*y22
  y0=z1*x22-x11*z2
  z0=x11*y22-y11*x22
  xx1=x0*x1+y0*y1+z0*t00
  IF z0<>0
    IF a&<totvlakren&
      v&=a&+1
    ELSE
      v&=WORD{adrvl%+18}+1
    ENDIF
    '
    y11=MIN(y1,y2,y3)
    my0%=-INT(-y11)
    IF my0%<ymin4&
      my0%=ymin4&
    ENDIF
    '
    y22=MAX(y1,y2,y3)
    my2%=INT(y22)
    ' IF my2%>ymax4&
    ' my2%=ymax4&
    ' ENDIF
    '
    zxd=-x0/z0
    zyd=-y0/z0
    zy0=my2%*zyd+xx1/z0+zyd
    '
    f1&=0
    snijpz(x1,y1,x2,y2)
    snijpz(x2,y2,x3,y3)
    snijpz(x3,y3,x1,y1)
    IF f1&<>7
      '   ~DisplayBeep(0)
    ELSE
      '
      temp&=ymax4&-my2%
      x0%=SHL(putzp&*temp&+4*afmx&,1)
      '
      ~C:initpoly%(v&,L:V:zxd)
      '
      FOR y&=my2% DOWNTO my0%
        SUB zy0,zyd
        '
        sn1&=INT(xs1)
        ADD xs1,dx1
        IF y&<=omsl&
          sn2&=INT(xs3)
          ADD xs3,dx3
        ELSE
          sn2&=INT(xs2)
          ADD xs2,dx2
        ENDIF
        '
        IF sn1&>sn2&
          SWAP sn1&,sn2&
        ENDIF
        ADD sn1&,1
        '
        IF sn2&>afmix4& OR sn1&<afmax4&
          IF y&>=afmiy4& AND y&<=afmay4& AND y&<=ymax4&
            IF sn2&>afmax4&
              sn2&=afmax4&
            ENDIF
            IF sn1&<afmix4&
              sn1&=afmix4&
            ENDIF
            IF sn1&<=sn2&
              z0=sn1&*zxd+zy0
              x1%=x0%+2*sn1&
              '
              ~C:fillz%(sn2&-sn1&,L:x1%)
            ENDIF
          ENDIF
        ENDIF
        ADD x0%,2*putzp&
      NEXT y&
      IF {{msga%}}
        @decodemsg(GetMsg(msgp2%))
        IF menu2%=&H45
          afbreek&=-1
          EXIT IF afbreek&
        ENDIF
      ENDIF
    ENDIF
  ENDIF
ENDIF
ENDIF
NEXT a&
RETURN
> PROCEDURE wereldinit
ro1&=BYTE{wrld%}
gr1&=BYTE{wrld%+1}
bl1&=BYTE{wrld%+2}
ro2&=BYTE{wrld%+3}
gr2&=BYTE{wrld%+4}
bl2&=BYTE{wrld%+5}
ro3&=BYTE{wrld%+6}
gr3&=BYTE{wrld%+7}
bl3&=BYTE{wrld%+8}
skymode&=BYTE{wrld%+18}
IF {wrld%+24}
ADD skymode&,4
ENDIF
grond&=BYTE{wrld%+19}
IF grond&
IF gcol%
freeblock(gcol%)
ENDIF
gcol%=@allocblock(64,&H10001)
BMOVE wrld%+9,gcol%,3
BYTE{gcol%+3}=0
IF BYTE{wrld%+19} AND 2
BYTE{gcol%+3}=8
ENDIF
BYTE{gcol%+4}=240
BYTE{gcol%+17}=8
a%=gcol%+c.t&
{a%}={wrld%+48}
BYTE{a%+22}=ro3&
BYTE{a%+23}=gr3&
BYTE{a%+24}=bl3&
WORD{a%+4}=4096+256
WORD{a%+8}=4096+256
WORD{a%+12}=4096+256
WORD{a%+16}=4096+256
ENDIF
z1%=-1000
gr(0)=0
gr(1)=(z1%)*v2
gr(2)=-(z1%)*w2
len=SQR(gr(1)^2+gr(2)^2)
IF len<>0
DIV gr(1),len
DIV gr(2),len
ENDIF
grond0&=0
grond1&=32767*gr(1)
grond2&=32767*gr(2)
x(0)=-obs%(0)
x(1)=-obs%(1)
x(2)=-obs%(2)
RBOX y()=persmat()*x()
x%=5*dia
grx%=y(0)
gry%=y(1)
grz%=y(2)
RETURN
> PROCEDURE zground
IF grond&
FOR y&=ymax& DOWNTO ymin&
IF grond1&*y&+grond2&*d&>0
  y1=grond1&
  z1=grond2&
  teller=y1*gry%+z1*grz%
  deler=y1*y&+z1*d&
  IF deler<>0
    u=teller/deler
    IF ABS(u)>50000
      u=50000
    ENDIF
    x3=u*d&
    z=(x3/(x3+d&))
    {V:z%}={V:z}
    x1%=2*(putzp&*(ymax&-y&))
    adrscz%=adrz%+2*x1%
    adrscp%=adrp%+x1%
    FOR x&=-afmx& TO afmx&
      {adrscz%}=z%
      WORD{adrscp%}=-1
      ADD adrscz%,4
      ADD adrscp%,2
    NEXT x&
  ENDIF
ENDIF
NEXT y&
ENDIF
RETURN
> PROCEDURE snijpz(x1,y1,x2,y2)
LOCAL g1%
IF y1>y2
SWAP y2,y1
SWAP x2,x1
ENDIF
g1%=INT(y2)
deler=y2-y1
IF deler<>0
teller=x2-x1
labda=teller/deler
' xx1=labda*(my2%-y1)+x1
xx1=labda*(g1%-y1)+x1
ELSE
y1=30000
ENDIF
'
IF y1=y11
IF y2=y22 AND (f1& AND 1)=0
xs1=xx1
dx1=-labda
ADD f1&,1
ELSE
xs3=xx1
dx3=-labda
ADD f1&,2
ENDIF
ELSE
omsl&=INT(y1)
xs2=xx1
dx2=-labda
ADD f1&,4
ENDIF
RETURN
> PROCEDURE zsphere(g1&)
adr%=adrzsphere%+46*(g1&-1)
radiusz=SINGLE{adr%+34}
IF radiusz<>0
IF ali&
radiusn=4*SINGLE{adr%+24}
x1s=4*xps*SINGLE{adr%+16}
y1s=4*yps*SINGLE{adr%+20}
ELSE
radiusn=SINGLE{adr%+24}
x1s=xps*SINGLE{adr%+16}
y1s=yps*SINGLE{adr%+20}
ENDIF
radiusz=radiusz/radiusn
z0=SINGLE{adr%+38}
rsquare=radiusn*radiusn
rsquare%=ROUND(rsquare)
miradiusx&=ROUND((x1s-radiusn))
miradiusy&=ROUND(y1s-radiusn)
maradiusx&=ROUND((x1s+radiusn))
maradiusy&=ROUND(y1s+radiusn)
IF ali&
IF maradiusy&>ymax4&*yps
  maradiusy&=ymax4&*yps
ENDIF
IF miradiusy&<ymin4&*yps
  miradiusy&=ymin4&*yps
ENDIF
IF maradiusx&>afmax4&*xps
  maradiusx&=afmax4&*xps
ENDIF
IF miradiusx&<afmix4&*xps
  miradiusx&=afmix4&*xps
ENDIF
ELSE
IF maradiusy&>ymax&*yps
  maradiusy&=ymax&*yps
ENDIF
IF miradiusy&<ymin&*yps
  miradiusy&=ymin&*yps
ENDIF
IF maradiusx&>afmax&*xps
  maradiusx&=afmax&*xps
ENDIF
IF miradiusx&<afmix&*xps
  miradiusx&=afmix&*xps
ENDIF
ENDIF
s&=clipvlak&+g1&
FOR y&=maradiusy& DOWNTO miradiusy&
ysquare=y&-y1s
ysquare=ysquare*ysquare
ysquare%=INT(ysquare+0.5)
IF ali&
  x1%=2*(putzp&*(ymax4&-y&)+INT(miradiusx&/xps+4*afmx&))
ELSE
  x1%=2*(putzp&*(ymax&-y&)+INT(miradiusx&/xps+afmx&))
ENDIF
adrscz%=adrz%+2*x1%
adrscp%=adrp%+x1%
FOR x=miradiusx& TO maradiusx& STEP xps
  xsquare=x-x1s
  xsquare=xsquare*xsquare
  xsquare%=INT(xsquare+0.5)
  IF xsquare%+ysquare%<rsquare%
    z=SQR(rsquare%-xsquare%-ysquare%)
    zn=radiusz*z+z0
    zv=SINGLE{adrscz%}
    IF {adrscz%}=0
      {adrscz%}={V:zn}
      WORD{adrscp%}=s&
    ELSE IF {V:zn}<{adrscz%}
      {adrscz%}={V:zn}
      WORD{adrscp%}=s&
    ENDIF
  ENDIF
  ADD adrscz%,4
  ADD adrscp%,2
NEXT x
NEXT y&
ENDIF
RETURN
> PROCEDURE zpoly(g1&)
SWAP g1&,a&
adr%=poly%(g1&)
tot&=WORD{adr%}
vorm&=WORD{adr%+2}
'                  eerst afmeting block berekenen
a%=adr%+48
dy%=0
FOR a&=1 TO vorm&
p&=WORD{a%}
ADD a%,2
y2=@ltosing(a%+24*p&-24+16)
IF y2<ymin&-2
y2=ymin&-2
ELSE IF y2>ymax&+2
y2=ymax&+2
ENDIF
FOR b&=1 TO p&
y1=@ltosing(a%+16)
IF y1<ymin&-2
  y1=ymin&-2
ELSE IF y1>ymax&+2
  y1=ymax&+2
ENDIF
ADD dy%,INT(ABS(y1-y2))
y2=y1
ADD a%,24
NEXT b&
ADD dy%,p&
NEXT a&
IF ali&
dy%=4*dy%
ENDIF
'             berekenen alle snijpunten met y scanlijnen
adrp3%=@allocblock(4+dy%*4,&H10001)
IF adrp3%
IF ali&
b11&=ymin4&
b12&=ymax4&
b13&=afmiy4&
b14&=afmay4&
b15&=afmix4&
b16&=afmax4&
ELSE
b11&=ymin&
b12&=ymax&
b13&=afmiy&
b14&=afmay&
b15&=afmix&
b16&=afmax&
ENDIF
{adrp3%}=dy%
p%=*spoly%()
{p%}=adrp3%
ARRAYFILL spoly%(),2^30
a%=adr%+48
t%=adrp3%+4
t&=0
' COLOR 4
FOR a&=1 TO vorm&
p&=WORD{a%}
ADD a%,2
IF p&
  IF ali&
    x2=4*@ltosing(a%+24*p&-24+12)
    y2=4*@ltosing(a%+24*p&-24+16)
  ELSE
    x2=@ltosing(a%+24*p&-24+12)
    y2=@ltosing(a%+24*p&-24+16)
  ENDIF
  FOR b&=1 TO p&
    IF ali&
      x1=4*@ltosing(a%+12)
      y1=4*@ltosing(a%+16)
    ELSE
      x1=@ltosing(a%+12)
      y1=@ltosing(a%+16)
    ENDIF
    IF y1<>y2
      x11=x1
      x22=x2
      y11=y1
      y22=y2
      IF y11>y22
        SWAP x11,x22
        SWAP y11,y22
      ENDIF
      IF y11<b12&+1 AND y22>b11&-1
        my0%=-INT(-y11)
        IF my0%=INT(y11)
          ADD my0%,1
        ENDIF
        my2%=INT(y22)
        IF my0%<b11&-1
          my0%=b11&-1
        ELSE IF my0%>b12&+1
          my0%=b12&+1
        ENDIF
        IF my2%<b11&-1
          my2%=b11&-1
        ELSE IF my2%>b12&+1
          my2%=b12&+1
        ENDIF
        deler=y22-y11
        teller=x22-x11
        labda=teller/deler
        xx1=labda*(my2%-y11)+x11
        FOR y&=my2% DOWNTO my0%
          IF y&>=b13& AND y&<=b14&
            ' PLOT xofs&+INT(xx1)/4,yofs&-y&/4
            WORD{t%}=y&
            CARD{t%+2}=32768+INT(xx1)
            ADD t%,4
            ADD t&,1
            IF t&>dy%
              ~DisplayBeep(0)
              t&=dy%
              SUB t%,4
            ENDIF
          ENDIF
          SUB xx1,labda
        NEXT y&
      ENDIF
    ENDIF
    x2=x1
    y2=y1
    ADD a%,24
  NEXT b&
ENDIF
NEXT a&
'          invullen in zbuffer
IF t&>1
v&=clipvlak&+spheren&+g1&
zxd=FLOAT{adr%+14}
zyd=FLOAT{adr%+22}
xx1=FLOAT{adr%+30}
~C:initpoly%(v&,L:V:zxd)
t%=adrp3%+4
QSORT spoly%(),t&
a&=0
OPENW #6
COLOR 5
WHILE a&<t&
  y&=WORD{t%}
  temp&=b12&-y&
  IF ali&
    x0%=SHL(putzp&*temp&+4*afmx&,1)
  ELSE
    x0%=SHL(putzp&*temp&+afmx&,1)
  ENDIF
  zy0=y&*zyd+xx1
  '
  x2&=CARD{t%+2}-32768
  b1&=0
  y2&=y&
  WHILE y&=y2&
    IF y&>=b11& AND y&<=b12&
      IF ODD(b1&)
        sn1&=x1&
        sn2&=x2&
        IF sn1&>sn2&
          SWAP sn1&,sn2&
        ENDIF
        ADD sn1&,1
        '
        ' lijn(sn1&,y2&,sn2&,y2&)
        IF sn2&>b15& OR sn1&<b16&
          IF sn2&>b16&
            sn2&=b16&
          ENDIF
          IF sn1&<b15&
            sn1&=b15&
          ENDIF
          IF sn1&<=sn2&
            z0=sn1&*zxd+zy0
            x1%=x0%+2*sn1&
            '
            ~C:fillz%(sn2&-sn1&,L:x1%)
          ENDIF
        ENDIF
      ENDIF
    ENDIF
    x1&=x2&
    y1&=y2&
    ADD t%,4
    y2&=WORD{t%}
    x2&=CARD{t%+2}-32768
    ADD a&,1
    ADD b1&,1
  WEND
WEND
ENDIF
freeblock(adrp3%)
ELSE
okee("Not enough memory")
fout&=1
ENDIF
SWAP g1&,a&
RETURN
> PROCEDURE lijn(x1&,y1&,x2&,y2&)
IF x1&>-afmx& AND x1&<afmx&
IF y1&>-afmy& AND y1&<afmy&
IF x2&<afmx& AND x2&>-afmx&
  IF y2&<afmy& AND y2&>-afmy&
    LINE xofs&+x1&,yofs&-y1&,xofs&+x2&,yofs&-y2&
  ENDIF
ENDIF
ENDIF
ENDIF
RETURN
> PROCEDURE zplot
b13&=0
point%=adrp%+2*(4*afmx&+afmix4&)
FOR b11&=ymin4& TO ymax4&
b14&=0
point2%=point%
FOR b12&=afmix4& TO afmax4&
IF WORD{point2%}
  IF WORD{point2%}<21
    COLOR 5
  ELSE
    COLOR 15
  ENDIF
ELSE
  COLOR 0
ENDIF
PLOT b14&,b13&
ADD point2%,2
ADD b14&,1
EXIT IF MOUSEK
NEXT b12&
ADD point%,2*putzp&
ADD b13&,1
EXIT IF MOUSEK
NEXT b11&
RETURN
'
ENDFUNC
RBOX trace
> PROCEDURE traceray(f&,depth&,svlak&,fr&,fg&,fb&,v1&,v2&,v3&,cox%,coy%,coz%,VAR c&())
LOCAL ft&,fm&,m1&,m2&,m3&
svlako&=-32000
x2%=cox%+tra&*v1&
y2%=coy%+tra&*v2&
z2%=coz%+tra&*v3&
IF depth&=-1
point&=0
ELSE
trace
ENDIF
IF snij& AND point&<>0
shade(point&)
' r&=0
' g&=0
' b&=0
' CLR rs&,gs&,bs&
SUB r&,rs&
SUB g&,gs&
SUB b&,bs&
'
f0&=SHR(f&*fr&,8)
f1&=256-f0&
c&(0)=SHR(r&*f0&+c&(0)*f1&,8)
ADD rq&,SHR(f0&*rs&,8)
'
f0&=SHR(f&*fg&,8)
f1&=256-f0&
c&(1)=SHR(g&*f0&+c&(1)*f1&,8)
ADD gq&,SHR(f0&*gs&,8)
'
f0&=SHR(f&*fb&,8)
f1&=256-f0&
c&(2)=SHR(b&*f0&+c&(2)*f1&,8)
ADD bq&,SHR(f0&*bs&,8)
'
fm&=SHR(mirr&*f&,8)
ft&=SHR(tran&*f&,8)
IF fm& AND depth&<tradep&
i&=-SHR(xn&*v1&+yn&*v2&+zn&*v3&,15)
m1&=v1&/2+SHR(xn&*i&,15)
m2&=v2&/2+SHR(yn&*i&,15)
m3&=v3&/2+SHR(zn&*i&,15)
~C:normalwrd%(L:V:m1&,L:V:m2&,L:V:m3&)
fr&=miro&
fg&=migr&
fb&=mibl&
ENDIF
IF ft& AND depth&<tradep&
traceray(ft&,depth&+1,svlak&,ro&,gr&,bl&,v1&,v2&,v3&,cox%,coy%,coz%,c&())
ENDIF
IF fm& AND depth&<tradep&
traceray(fm&,depth&+1,svlak&,fr&,fg&,fb&,m1&,m2&,m3&,cox%,coy%,coz%,c&())
ENDIF
ELSE
sk&=-1
IF grond&
IF grond1&*v2&+grond2&*v3&>0
y1=grond1&
z1=grond2&
x1=y1*gry%+z1*grz%
deler=y1*(y2%-coy%)+z1*(z2%-coz%)
IF deler<>0
  teller=y1*coy%+z1*coz%-x1
  u=-teller/deler
  IF ABS(u)>5000
    u=5000
  ENDIF
  cox%=cox%+u*(x2%-cox%)
  coy%=coy%+u*(y2%-coy%)
  coz%=coz%+u*(z2%-coz%)
  sk&=0
  svlak&=-1
  adrcol%=gcol%
  setshadevars(adrcol%)
  xn&=grond0&
  yn&=grond1&
  zn&=grond2&
  shadelamplusint
ENDIF
ENDIF
ENDIF
IF sk&
view0&=v1&
view1&=v2&
view2&=v3&
IF skymode&
sky
ELSE
r&=ro1&
g&=gr1&
b&=bl1&
ENDIF
ENDIF
r&=SHR(fr&*r&,8)
g&=SHR(fg&*g&,8)
b&=SHR(fb&*b&,8)
f1&=256-f&
c&(0)=SHR(r&*f&+c&(0)*f1&,8)
c&(1)=SHR(g&*f&+c&(1)*f1&,8)
c&(2)=SHR(b&*f&+c&(2)*f1&,8)
ENDIF
RETURN
> PROCEDURE trace
clipoctree
snij&=0
IF c1&
snijp&=0
ARRAYFILL oc!(),0
svlakcontr&=0
IF svlak&<-1
svlak&=totvlakren&-svlak&-1
ENDIF
IF svlak&>0
oc!(svlak&)=-1
ENDIF
ox1&=SHL(x1%-min%(0),10)/ocx%
oy1&=SHL(y1%-min%(1),10)/ocy%
oz1&=SHL(z1%-min%(2),10)/ocz%
ox2&=SHL(x2%-min%(0),10)/ocx%
oy2&=SHL(y2%-min%(1),10)/ocy%
oz2&=SHL(z2%-min%(2),10)/ocz%
ocx1&=SHR(ox1&,10)
ocy1&=SHR(oy1&,10)
ocz1&=SHR(oz1&,10)
ocx2&=SHR(ox2&,10)
ocy2&=SHR(oy2&,10)
ocz2&=SHR(oz2&,10)
labda%=32768
labdao%=0
' IF svlak&>0
' snijpunt(svlak&)
' LOCATE 1,1
' PRINT snij&;"  ";dd6&;"  "
' PRINT labda;"  "
' WHILE MOUSEK=0
' WEND
' ENDIF
IF ocx1&=ocx2& AND ocy1&=ocy2& AND ocz1&=ocz2&
ocread(ocx1&,ocy1&,ocz1&)
ELSE
'
IF ox1&<>ox2&
x1&=ox1& AND 31744
IF ox2&-ox1&>0
  dx&=1024
  ADD x1&,dx&
ELSE
  dx&=-1024
ENDIF
labdax%=SHR(SWAP(ox1&-x1&)/(ox1&-ox2&),1)
ldx%=SHR(SWAP(-dx&)/(ox1&-ox2&),1)
ELSE
labdax%=32768
ldx%=0
ENDIF
'
IF oy1&<>oy2&
y1&=oy1& AND 31744
IF oy2&-oy1&>0
  dy&=1024
  ADD y1&,dy&
ELSE
  dy&=-1024
ENDIF
labday%=SHR(SWAP(oy1&-y1&)/(oy1&-oy2&),1)
ldy%=SHR(SWAP(-dy&)/(oy1&-oy2&),1)
ELSE
labday%=32768
ldy%=0
ENDIF
'
IF oz1&<>oz2&
z1&=oz1& AND 31744
IF oz2&-oz1&>0
  dz&=1024
  ADD z1&,dz&
ELSE
  dz&=-1024
ENDIF
labdaz%=SHR(SWAP(oz1&-z1&)/(oz1&-oz2&),1)
ldz%=SHR(SWAP(-dz&)/(oz1&-oz2&),1)
ELSE
labdaz%=32768
ldz%=0
ENDIF
'
dx&=SGN(dx&)
dy&=SGN(dy&)
dz&=SGN(dz&)
xo&=ocx1&
yo&=ocy1&
zo&=ocz1&
labda%=MIN(labdax%,labday%,labdaz%)
ocread(ocx1&,ocy1&,ocz1&)
'
IF snij&=0
WHILE labda%<32768
  labdao%=labda%
  IF labdax%=labday%
    IF labday%=labdaz%
      ADD xo&,dx&
      ADD labdax%,ldx%
      ADD yo&,dy&
      ADD labday%,ldy%
      ADD zo&,dz&
      ADD labdaz%,ldz%
    ELSE IF labdax%<labdaz%
      ADD xo&,dx&
      ADD labdax%,ldx%
      ADD yo&,dy&
      ADD labday%,ldy%
    ELSE
      ADD zo&,dz&
      ADD labdaz%,ldz%
    ENDIF
  ELSE IF labday%=labdaz%
    IF labdax%<labday%
      ADD xo&,dx&
      ADD labdax%,ldx%
    ELSE
      ADD yo&,dy&
      ADD labday%,ldy%
      ADD zo&,dz&
      ADD labdaz%,ldz%
    ENDIF
  ELSE IF labdax%=labdaz%
    IF labday%<labdaz%
      ADD yo&,dy&
      ADD labday%,ldy%
    ELSE
      ADD xo&,dx&
      ADD labdax%,ldx%
      ADD zo&,dz&
      ADD labdaz%,ldz%
    ENDIF
  ELSE IF labdax%<labday%
    IF labdax%<labdaz%
      ADD xo&,dx&
      ADD labdax%,ldx%
    ELSE
      ADD zo&,dz&
      ADD labdaz%,ldz%
    ENDIF
  ELSE IF labday%<labdaz%
    ADD yo&,dy&
    ADD labday%,ldy%
  ELSE
    ADD zo&,dz&
    ADD labdaz%,ldz%
  ENDIF
  labda%=MIN(labdax%,labday%,labdaz%)
  EXIT IF labda%=labdao%
  ocread(xo&,yo&,zo&)
  EXIT IF snij&
WEND
ENDIF
ENDIF
IF snij&
IF schaduwvoeler&=0
IF snijp&>1
  QSORT snp1%(+),snijp&,snp2%()
ENDIF
labda=snp1%(0)
WORD{V:labda+6}=WORD{V:labda+6}-25
point&=p&(snp2%(0))
u=u(snp2%(0))
v=v(snp2%(0))
ENDIF
ENDIF
ENDIF
RETURN
> PROCEDURE octree
IF adroct%
freeblock(adroct%)
CLR adroct%
ENDIF
octres%=250000
adroct%=@allocblock(octres%,&H10001)
octpoint&=0
initfase("Octree",0,totvlakren&)
FOR c&=0 TO 2
min%(c&)=2^30
max%(c&)=-2^30
NEXT c&
a%=adrzsphere%
FOR s&=1 TO spheren&
IF (BYTE{{a%+42}+3} AND 4)
r%={a%}
FOR c&=0 TO 2
IF min%(c&)>{a%+4+4*c&}-r%
  min%(c&)={a%+4+4*c&}-r%
ENDIF
IF max%(c&)<{a%+4+4*c&}+r%
  max%(c&)={a%+4+4*c&}+r%
ENDIF
NEXT c&
ENDIF
ADD a%,46
NEXT s&
FOR v&=0 TO totvlakren&-1
seta1a2a3(v&)
' IF adrve1%>0
IF BYTE{{adrvl%+18}+3} AND 4
FOR c&=0 TO 2
c1&=4*c&
s%=ABS(adrve1%)+c1&
IF min%(c&)>{s%}
  min%(c&)={s%}
ENDIF
IF max%(c&)<{s%}
  max%(c&)={s%}
ENDIF
s%=adrve2%+c1&
IF min%(c&)>{s%}
  min%(c&)={s%}
ENDIF
IF max%(c&)<{s%}
  max%(c&)={s%}
ENDIF
s%=adrve3%+c1&
IF min%(c&)>{s%}
  min%(c&)={s%}
ENDIF
IF max%(c&)<{s%}
  max%(c&)={s%}
ENDIF
NEXT c&
ENDIF
'  ENDIF
NEXT v&
IF min%(0)=2^30   !lege octree
ELSE
FOR c&=0 TO 2
SUB min%(c&),1000
ADD max%(c&),1000
NEXT c&
ocfac(0)=31.9/(max%(0)-min%(0)+1)
ocfac(1)=31.9/(max%(1)-min%(1)+1)
ocfac(2)=31.9/(max%(2)-min%(2)+1)
ocfacx=ocfac(0)
ocfacy=ocfac(1)
ocfacz=ocfac(2)
ocx%=INT(1/(ocfacx))
ocy%=INT(1/(ocfacy))
ocz%=INT(1/(ocfacz))
t%(0)=ocx%
t%(1)=ocy%
t%(2)=ocz%
t00=max%(0)-min%(0)
t01=max%(1)-min%(1)
t02=max%(2)-min%(2)
t00=MAX(t00,t01,t02)
t00=t00/10000
tra&=INT(t00+1)
' snfacx=32000/(max%(0)-min%(0)+1)
' snfacy=32000/(max%(1)-min%(1)+1)
' snfacz=32000/(max%(2)-min%(2)+1)
IF clipvlak&>3300
ERASE oc!()
DIM oc!(clipvlak&+totobj&)
ENDIF
FOR v&=1 TO totvlakren&
IF (v& AND 15)=15
fase(v&)
ENDIF
seta1a2a3(v&-1)
IF BYTE{{adrvl%+18}+3} AND 4
adrve1%=ABS(adrve1%)
IF adrve1%<>0
  FOR c&=0 TO 2
    b&=4*c&
    rt%(1,c&)=SHL({adrve1%+b&}-min%(c&),10)/t%(c&)
    rt%(4,c&)=SHR(rt%(1,c&),10)
    rt%(2,c&)=SHL({adrve2%+b&}-min%(c&),10)/t%(c&)
    rt%(5,c&)=SHR(rt%(2,c&),10)
    rt%(3,c&)=SHL({adrve3%+b&}-min%(c&),10)/t%(c&)
    rt%(6,c&)=SHR(rt%(3,c&),10)
  NEXT c&
  ARRAYFILL oc!(),0
  FOR c&=0 TO 2
    oc1&=rt%(4,c&)
    oc2&=rt%(5,c&)
    oc3&=rt%(6,c&)
    b1&=MIN(oc1&,oc2&,oc3&)
    b2&=MAX(oc1&,oc2&,oc3&)
    IF b1&<0
      b1&=0
    ENDIF
    IF b2&>31
      b2&=31
    ENDIF
    ocmin&(c&)=b1&
    ocmax&(c&)=b2&
  NEXT c&
  2dda(1,2,0,1,1024)
  2dda(1,2,0,2,0)
  2dda(1,2,1,2,2048)
  2dda(2,3,0,1,1024)
  2dda(2,3,0,2,0)
  2dda(2,3,1,2,2048)
  2dda(3,1,0,1,1024)
  2dda(3,1,0,2,0)
  2dda(3,1,1,2,2048)
  '
  vuldriehoek(0,1,1024)
  vuldriehoek(0,2,0)
  vuldriehoek(1,2,2048)
  '
  FOR x&=ocmin&(0) TO ocmax&(0)
    a&=32*x&
    FOR y&=ocmin&(1) TO ocmax&(1)
      b&=32*y&
      IF oc!(a&+y&+1024)
        FOR z&=ocmin&(2) TO ocmax&(2)
          IF oc!(b&+z&+2048) AND oc!(a&+z&)
            ocwrite(x&,y&,z&)
          ENDIF
        NEXT z&
      ENDIF
    NEXT y&
  NEXT x&
ENDIF
ENDIF
NEXT v&
x0=SQR((1/ocfacx)^2+(1/ocfacy)^2+(1/ocfacz^2))
COLOR 15
FOR s&=1 TO spheren&
a%=adrzsphere%
IF (BYTE{{a%+42}+3} AND 4)
r%={a%}
x1=(r%+x0)^2
x2=(r%-2*x0)^2
FOR c&=0 TO 2
  ocmin&(c&)=ocfac(c&)*({a%+4+4*c&}-r%-min%(c&))
  IF ocmin&(c&)<0
    ocmin&(c&)=0
  ENDIF
  ocmax&(c&)=ocfac(c&)*({a%+4+4*c&}+r%-min%(c&))
  IF ocmax&(c&)>31
    ocmax&(c&)=31
  ENDIF
NEXT c&
v&=clipvlak&+s&
FOR x&=ocmin&(0) TO ocmax&(0)
  x%=min%(0)+(x&+0.5)/ocfacx-{a%+4}
  FOR y&=ocmin&(1) TO ocmax&(1)
    y%=min%(1)+(y&+0.5)/ocfacy-{a%+8}
    FOR z&=ocmin&(2) TO ocmax&(2)
      z%=min%(2)+(z&+0.5)/ocfacz-{a%+12}
      len=x%^2+y%^2+z%^2
      IF len<x1
        IF len>x2
          ocwrite(x&,y&,z&)
        ENDIF
      ENDIF
    NEXT z&
  NEXT y&
NEXT x&
ENDIF
ADD a%,46
NEXT s&
'  LOCATE 5,5
' PRINT "octree: ";16*octpoint&
WORD{ocrdata%+6}=0
{ocrdata%+8}=adroct%
ENDIF
RETURN
> PROCEDURE 2dda(b1&,b2&,c1&,c2&,b3&)
' b3& is ofset  c1/c2 zijn x,y of z
ocx1&=rt%(b1&+3,c1&)
ocy1&=rt%(b1&+3,c2&)
ocx2&=rt%(b2&+3,c1&)
ocy2&=rt%(b2&+3,c2&)
IF ocx1&=ocx2& AND ocy1&=ocy2&
oc!(32*ocx1&+b3&+ocy1&)=-1
ELSE
oc!(32*ocx1&+b3&+ocy1&)=-1
oc!(32*ocx2&+b3&+ocy2&)=-1
ox1&=rt%(b1&,c1&)
ox2&=rt%(b2&,c1&)
oy1&=rt%(b1&,c2&)
oy2&=rt%(b2&,c2&)
'
IF ox1&<>ox2&
x1&=ox1& AND 31744
IF ox2&-ox1&>0
dx&=1024
ADD x1&,dx&
ELSE
dx&=-1024
ENDIF
labdax%=SHR(SWAP(ox1&-x1&)/(ox1&-ox2&),1)
ldx%=SHR(SWAP(-dx&)/(ox1&-ox2&),1)
ELSE
labdax%=32768
ldx%=0
ENDIF
'
IF oy1&<>oy2&
y1&=oy1& AND 31744
IF oy2&-oy1&>0
dy&=1024
ADD y1&,dy&
ELSE
dy&=-1024
ENDIF
labday%=SHR(SWAP(oy1&-y1&)/(oy1&-oy2&),1)
ldy%=SHR(SWAP(-dy&)/(oy1&-oy2&),1)
ELSE
labday%=32768
ldy%=0
ENDIF
'
dx&=SGN(dx&)
dy&=SGN(dy&)
x&=ocx1&
y&=ocy1&
oc!(32*x&+b3&+y&)=-1
labda%=0
WHILE labda%<32768
labdao%=labda%
IF labdax%=labday%
ADD labdax%,ldx%
ADD x&,dx&
ADD labday%,ldy%
ADD y&,dy&
ELSE
IF labdax%<labday%
  ADD labdax%,ldx%
  ADD x&,dx&
ELSE
  ADD labday%,ldy%
  ADD y&,dy&
ENDIF
ENDIF
labda%=MIN(labdax%,labday%)
EXIT IF labda%=labdao%
ADD a&,1
oc!(32*x&+b3&+y&)=-1
WEND
ENDIF
RETURN
> PROCEDURE vuldriehoek(c1&,c2&,b3&)
FOR x&=ocmin&(c1&) TO ocmax&(c1&)
a&=b3&+32*x&
FOR y&=ocmin&(c2&) TO ocmax&(c2&)
IF oc!(a&+y&)
INC y&
WHILE oc!(a&+y&) AND y&<>ocmax&(c2&)
  INC y&
WEND
FOR y1&=ocmax&(c2&) DOWNTO y&+1
  IF oc!(a&+y1&)
    FOR y2&=y& TO y1&
      oc!(a&+y2&)=-1
    NEXT y2&
    y1&=0
  ENDIF
NEXT y1&
y&=ocmax&(c2&)
ENDIF
NEXT y&
NEXT x&
RETURN
> PROCEDURE clipoctree
x1%=cox%
y1%=coy%
z1%=coz%
c1&=0
u1=0
u2=1
dx%=x2%-x1%
IF @cliptest(-dx%,x1%-min%(0)-1)
IF @cliptest(dx%,max%(0)-x1%+1)
dy%=y2%-y1%
IF @cliptest(-dy%,y1%-min%(1)-1)
IF @cliptest(dy%,max%(1)-y1%+1)
  dz%=z2%-z1%
  IF @cliptest(-dz%,z1%-min%(2)-1)
    IF @cliptest(dz%,max%(2)-z1%+1)
      c1&=-1
      IF u2<1
        x2%=x1%+INT(u2*dx%)
        y2%=y1%+INT(u2*dy%)
        z2%=z1%+INT(u2*dz%)
      ENDIF
      IF u1>0
        ADD x1%,INT(u1*dx%)
        ADD y1%,INT(u1*dy%)
        ADD z1%,INT(u1*dz%)
      ENDIF
    ENDIF
  ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
RETURN
> PROCEDURE ocread(gx&,gy&,z&)
'
SWAP gx&,x&
SWAP gy&,y&
'
IF x&>=0 AND x&<32 AND y&>=0 AND y&<32 AND z&>=0 AND z&<32
point&=C:ocread%(x&,y&,z&)
IF point&<>0
IF schaduwvoeler&
IF snij&=0
  IF point&<0
    adr%=adroct%-16*point&
    point&=WORD{adr%}
    c&=0
    WHILE point&<>0 AND snij&=0
      IF oc!(point&)=0
        snijpunt(point&)
      ENDIF
      ADD c&,2
      IF c&=16
        point&=0
      ELSE
        point&=WORD{adr%+c&}
        IF point&<0
          adr%=adroct%-16*point&
          c&=0
          point&=WORD{adr%}
        ENDIF
      ENDIF
    WEND
  ELSE
    IF oc!(point&)=0
      snijpunt(point&)
    ENDIF
  ENDIF
ENDIF
ELSE                      !spiegel & glas
IF point&<0
  adr%=adroct%-16*point&
  point&=WORD{adr%}
  c&=0
  WHILE point&<>0
    snij&=0
    IF oc!(point&)=0
      snijpunt(point&)
    ENDIF
    IF snij&
      snij&=0
      WORD{V:labda+6}=WORD{V:labda+6}+25
      snp1%(snijp&)=INT(labda)
      snp2%(snijp&)=snijp&
      p&(snijp&)=point&
      u(snijp&)=u
      v(snijp&)=v
      ADD snijp&,1
    ENDIF
    ADD c&,2
    IF c&=16
      point&=0
    ELSE
      point&=WORD{adr%+c&}
      IF point&<0
        adr%=adroct%-16*point&
        c&=0
        point&=WORD{adr%}
      ENDIF
    ENDIF
  WEND
  snij&=snijp&
ELSE
  IF oc!(point&)=0
    snij&=0
    snijpunt(point&)
    IF snij&
      WORD{V:labda+6}=WORD{V:labda+6}+25
      snp1%(snijp&)=labda
      snp2%(snijp&)=snijp&
      p&(snijp&)=point&
      u(snijp&)=u
      v(snijp&)=v
      ADD snijp&,1
    ENDIF
  ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
'
SWAP gx&,x&
SWAP gy&,y&
'
RETURN
> PROCEDURE ocwrite(gx&,gy&,z&)
'
SWAP gx&,x&
SWAP gy&,y&
'
x&=SHL(x&,2)
y&=SHL(y&,1)
oc1&=SHR((x& AND 64)+(y& AND 32)+(z& AND 16),3)
oc2&=SHR((x& AND 32)+(y& AND 16)+(z& AND 8),2)
oc3&=SHR((x& AND 16)+(y& AND 8)+(z& AND 4),1)
oc4&=(x& AND 8)+(y& AND 4)+(z& AND 2)
oc5&=SHL((x& AND 4)+(y& AND 2)+(z& AND 1),1)
point&=WORD{adroct%+oc1&}
IF point&=0                   ! 1
ADD octpoint&,1
WORD{adroct%+oc1&}=octpoint&
adr%=adroct%+16*octpoint&
ELSE
adr%=adroct%+16*point&
ENDIF
point&=WORD{adr%+oc2&}
IF point&=0                   ! 2
ADD octpoint&,1
WORD{adr%+oc2&}=octpoint&
adr%=adroct%+16*octpoint&
ELSE
adr%=adroct%+16*point&
ENDIF
point&=WORD{adr%+oc3&}
IF point&=0                   ! 3
ADD octpoint&,1
WORD{adr%+oc3&}=octpoint&
adr%=adroct%+16*octpoint&
ELSE
adr%=adroct%+16*point&
ENDIF
point&=WORD{adr%+oc4&}
IF point&=0                   ! 4
ADD octpoint&,1
WORD{adr%+oc4&}=octpoint&
adr%=adroct%+16*octpoint&
ELSE
adr%=adroct%+16*point&
ENDIF
point&=WORD{adr%+oc5&}
IF point&=0                  ! eind
WORD{adr%+oc5&}=v&
ELSE IF point&>0             ! er staat 1 vlak
' maaknieuwestruct
IF point&<>v&
ADD octpoint&,1
WORD{adr%+oc5&}=-octpoint&
adr%=adroct%+16*octpoint&
WORD{adr%}=point&
WORD{adr%+2}=v&
ENDIF
ELSE                         ! pointer nieuwe struct
adr%=adroct%-16*point&
point&=WORD{adr%}
c&=0
WHILE point&<>0 AND point&<>v&
ADD c&,2
IF c&=16
ADD octpoint&,1
WORD{adr%+14}=-octpoint&
adr%=adroct%+16*octpoint&
WORD{adr%}=point&
c&=2
ENDIF
point&=WORD{adr%+c&}
IF point&<0
adr%=adroct%-16*point&
c&=0
point&=WORD{adr%}
ENDIF
WEND
IF point&=0
WORD{adr%+c&}=v&
ENDIF
ENDIF
'
SWAP gx&,x&
SWAP gy&,y&
'
RETURN
> PROCEDURE snijpunt(v&)
LOCAL a,b,c,r
oc!(v&)=-1
IF snij&=0
IF v&<=clipvlak&
IF v&<>svlak&
SUB v&,1
adrvla%=blovl%(SHR(v&,8))+m28&(v& AND 255)
a1%=ABS({adrvla%})
a2%={adrvla%+4}
a3%={adrvla%+8}
deeledge&=0
IF svlak&>0
  IF a1%=adrve1% OR a1%=adrve2% OR a1%=adrve3%
    ADD deeledge&,1
  ENDIF
  IF a2%=adrve1% OR a2%=adrve2% OR a2%=adrve3%
    ADD deeledge&,1
  ENDIF
  IF a3%=adrve1% OR a3%=adrve2% OR a3%=adrve3%
    ADD deeledge&,1
  ENDIF
ENDIF
'
dd6&=-1
IF schaduwvoeler&=0
  x0&=WORD{adrvla%+12}
  x1&=WORD{adrvla%+14}
  x2&=WORD{adrvla%+16}
  xd1%=C:lifmul%(L:{a1%},x0&)+C:lifmul%(L:{a1%+4},x1&)+C:lifmul%(L:{a1%+8},x2&)
  t20%=x1%-x2%
  t21%=y1%-y2%
  t22%=z1%-z2%
  deler%=C:lifmul%(L:t20%,x0&)+C:lifmul%(L:t21%,x1&)+C:lifmul%(L:t22%,x2&)
  IF deler%<>0
    teller%=C:lifmul%(L:x1%,x0&)+C:lifmul%(L:y1%,x1&)+C:lifmul%(L:z1%,x2&)-xd1%
    IF teller% XOR deler%>=0 !zelfde sign
      IF ABS(teller%)<ABS(deler%)
        labda=teller%
        labda=labda/deler%
        WORD{V:labda+6}=WORD{V:labda+6}+15
        la%=INT(labda)
        IF la%>labda%
          oc!(v&+1)=0
          dd6&=0
        ELSE IF la%<labdao%
          dd6&=0
        ENDIF
      ENDIF
    ENDIF
  ENDIF
ENDIF
'
IF dd6&
  t00=LONG{a3%}-LONG{a1%}
  t01=LONG{a3%+4}-LONG{a1%+4}
  t02=LONG{a3%+8}-LONG{a1%+8}
  t10=LONG{a3%}-LONG{a2%}
  t11=LONG{a3%+4}-LONG{a2%+4}
  t12=LONG{a3%+8}-LONG{a2%+8}
  t20=x1%-x2%
  t21=y1%-y2%
  t22=z1%-z2%
  x0=t11*t22-t12*t21
  x1=t12*t20-t10*t22
  x2=t10*t21-t11*t20
  deeldet=t00*x0+t01*x1+t02*x2
  IF deeldet<>0
    ddabs=ABS(deeldet)
    dd6&=WORD{V:deeldet+6}
    m0=x1%-LONG{a3%}
    m1=y1%-LONG{a3%+4}
    m2=z1%-LONG{a3%+8}
    det1=m0*x0+m1*x1+m2*x2
    IF (WORD{V:det1+6} XOR dd6&)<0 OR det1=0
      IF ABS(det1)<=ddabs
        det2=t00*(m1*t22-m2*t21)
        ADD det2,t01*(m2*t20-m0*t22)
        ADD det2,t02*(m0*t21-m1*t20)
        IF (WORD{V:det2+6} XOR dd6&)<0 OR det2=0
          IF ABS(det2)<=ddabs
            temp=ABS(det1+det2)
            IF temp<ddabs OR temp==ddabs
              det3=t00*(t11*m2-t12*m1)
              ADD det3,t01*(t12*m0-t10*m2)
              ADD det3,t02*(t10*m1-t11*m0)
              IF (WORD{V:det3+6} XOR dd6&)>=0 AND det3<>0
                IF ABS(det3)<ddabs
                  IF schaduwvoeler&=0
                    deeldet=1/deeldet
                    u=det1*deeldet
                    v=det2*deeldet
                    labda=det3*deeldet
                    snij&=-1
                    IF deeledge&
                      IF svlakcontr&=0
                        snijpunt2
                      ENDIF
                      snij&=svlaksnij&
                    ENDIF
                  ELSE
                    snij&=-1
                    IF deeledge&
                      IF svlakcontr&=0
                        snijpunt2
                      ENDIF
                      snij&=svlaksnij&
                    ENDIF
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ENDIF
        ENDIF
      ENDIF
    ENDIF
  ENDIF
ENDIF
ENDIF
ELSE
IF v&<>svlak&
x1=x1%
y1=y1%
z1=z1%
a%=adrzsphere%+46*(v&-clipvlak&-1)
x3%={a%+4}
y3%={a%+8}
z3%={a%+12}
r={a%}
x2=x2%-x1%
y2=y2%-y1%
z2=z2%-z1%
a=x2*x2+y2*y2+z2*z2
IF a<>0
  b=2*(x2*(x1-x3%)+y2*(y1-y3%)+z2*(z1-z3%))
  c=(x3%-x1%)^2+(y3%-y1%)^2+(z3%-z1%)^2-r^2
  r=b^2-4*a*c
  IF r>0
    r=SQR(r)
    a=2*a
    t1=(-b+r)/a
    IF t1>0 AND t1<1
      t2=(-b-r)/a
      IF t2>0 AND t2<1
        labda=MIN(t1,t2)
        snij&=-1
      ENDIF
    ENDIF
  ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
RETURN
> PROCEDURE snijpuntn(v&)
LOCAL a,b,c,r
oc!(v&)=-1
IF snij&=0
IF v&<=clipvlak&
IF v&<>svlak&
SUB v&,1
adrvla%=blovl%(SHR(v&,8))+m28&(v& AND 255)
a1%=ABS({adrvla%})
a2%={adrvla%+4}
a3%={adrvla%+8}
deeledge&=0
IF svlak&>0
  IF a1%=adrve1% OR a1%=adrve2% OR a1%=adrve3%
    ADD deeledge&,1
  ENDIF
  IF a2%=adrve1% OR a2%=adrve2% OR a2%=adrve3%
    ADD deeledge&,1
  ENDIF
  IF a3%=adrve1% OR a3%=adrve2% OR a3%=adrve3%
    ADD deeledge&,1
  ENDIF
ENDIF
'
dd6&=0
t00=LONG{a3%}-LONG{a1%}
t01=LONG{a3%+4}-LONG{a1%+4}
t02=LONG{a3%+8}-LONG{a1%+8}
t10=LONG{a3%}-LONG{a2%}
t11=LONG{a3%+4}-LONG{a2%+4}
t12=LONG{a3%+8}-LONG{a2%+8}
x0=t11*t02-t12*t01
x1=t12*t00-t10*t02
x2=t10*t01-t11*t00
' hierboven de normaal
t20=x2%-x1%
t21=y2%-y1%
t22=z2%-z1%
deler=t20*x0+t21*x1+t22*x2
IF deler<>0
  teller=x0*(x1%-{a1%})+x1*(y1%-{a1%+4})+x2*(z1%-{a1%+8})
  ' xd1={a1%}*x0+{a1%+4}*x1+{a1%+8}*x2
  ' teller=x1%*x0+y1%*x1+z1%*x2-xd1
  IF (WORD{V:teller+6} XOR WORD{V:deler+6})<0
    IF ABS(teller)<ABS(deler)
      labda=teller/deler
      xt%=x1%-labda*t20
      yt%=y1%-labda*t21
      zt%=z1%-labda*t22
      dd6&=-1
      IF schaduwvoeler&=0
        WORD{V:labda+6}=WORD{V:labda+6}+15
        la%=INT(labda)
        IF la%>labda%
          oc!(v&+1)=0
          dd6&=0
        ELSE IF la%<labdao%
          dd6&=0
        ENDIF
      ENDIF
    ENDIF
  ENDIF
ENDIF
'
IF dd6&
  snproj&=BYTE{adrvla%+26} AND 3
  IF snproj&=0
    c1&=0
    c2&=4
    t20=xt%-{a3%}
    t21=yt%-{a3%+4}
  ELSE IF snproj&=1
    c1&=0
    c2&=8
    t01=t02
    t11=t12
    t20=xt%-{a3%}
    t21=zt%-{a3%+8}
  ELSE
    c1&=4
    c2&=8
    t00=t01
    t01=t02
    t10=t11
    t11=t12
    t20=yt%-{a3%+4}
    t21=zt%-{a3%+8}
  ENDIF
  '
  deeldet=t00*t11-t10*t01
  IF deeldet<>0
    dd6&=WORD{V:deeldet+6}
    ddabs=ABS(deeldet)
    det1=t20*t11-t21*t10
    IF (WORD{V:det1+6} XOR dd6&)<0
      IF ABS(det1)<ddabs
        det2=t00*t21-t01*t20
        IF (WORD{V:det2+6} XOR dd6&)<0
          IF ABS(det2)<ddabs
            temp=ABS(det1+det2)
            IF temp<ddabs OR temp==ddabs
              IF schaduwvoeler&=0
                u=det1/deeldet
                v=det2/deeldet
                snij&=-1
                IF deeledge&
                  IF svlakcontr&=0
                    snijpunt2n
                  ENDIF
                  snij&=svlaksnij&
                ENDIF
              ELSE
                snij&=-1
                IF deeledge&
                  IF svlakcontr&=0
                    snijpunt2
                  ENDIF
                  snij&=svlaksnij&
                ENDIF
              ENDIF
            ENDIF
          ENDIF
        ENDIF
      ENDIF
    ENDIF
  ENDIF
ENDIF
ENDIF
ELSE
IF v&<>svlak&
x1=x1%
y1=y1%
z1=z1%
a%=adrzsphere%+46*(v&-clipvlak&-1)
x3%={a%+4}
y3%={a%+8}
z3%={a%+12}
r={a%}
x2=x2%-x1%
y2=y2%-y1%
z2=z2%-z1%
a=x2*x2+y2*y2+z2*z2
IF a<>0
  b=2*(x2*(x1-x3%)+y2*(y1-y3%)+z2*(z1-z3%))
  c=(x3%-x1%)^2+(y3%-y1%)^2+(z3%-z1%)^2-r^2
  r=b^2-4*a*c
  IF r>0
    r=SQR(r)
    a=2*a
    t1=(-b+r)/a
    IF t1>0 AND t1<1
      t2=(-b-r)/a
      IF t2>0 AND t2<1
        labda=MIN(t1,t2)
        snij&=-1
      ENDIF
    ENDIF
  ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
RETURN
> PROCEDURE snijpunt2
svlakcontr&=-1
svlaksnij&=0
t00=LONG{adrve3%}-LONG{adrve1%}
t01=LONG{adrve3%+4}-LONG{adrve1%+4}
t02=LONG{adrve3%+8}-LONG{adrve1%+8}
t10=LONG{adrve3%}-LONG{adrve2%}
t11=LONG{adrve3%+4}-LONG{adrve2%+4}
t12=LONG{adrve3%+8}-LONG{adrve2%+8}
t20=x1%-x2%
t21=y1%-y2%
t22=z1%-z2%
x0=t11*t22-t12*t21
x1=t12*t20-t10*t22
x2=t10*t21-t11*t20
deeldet=t00*x0+t01*x1+t02*x2
IF deeldet<>0
ddabs=ABS(deeldet)
dd6&=WORD{V:deeldet+6}
m0=x1%-LONG{adrve3%}
m1=y1%-LONG{adrve3%+4}
m2=z1%-LONG{adrve3%+8}
det1=m0*x0+m1*x1+m2*x2
IF (WORD{V:det1+6} XOR dd6&)<0 OR det1=0
IF ABS(det1)<=ddabs
det2=t00*(m1*t22-m2*t21)
ADD det2,t01*(m2*t20-m0*t22)
ADD det2,t02*(m0*t21-m1*t20)
IF (WORD{V:det2+6} XOR dd6&)<0 OR det2=0
  IF ABS(det2)<=ddabs
    temp=ABS(det1+det2)
    IF temp<ddabs OR temp==ddabs
      ' det3=t00*(t11*m2-t12*m1)
      ' ADD det3,t01*(t12*m0-t10*m2)
      ' ADD det3,t02*(t10*m1-t11*m0)
      ' IF (WORD{V:det3+6} XOR dd6&)>=0 AND det3<>0
      ' IF ABS(det3)<ddabs
      svlaksnij&=-1
    ENDIF
    ' ENDIF
    ' ENDIF
  ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
RETURN
> PROCEDURE snijpunt2n
svlakcontr&=-1
svlaksnij&=0
t00={adrve3%}-{adrve1%}
t01={adrve3%+4}-{adrve1%+4}
t02={adrve3%+8}-{adrve1%+8}
t10={adrve3%}-{adrve2%}
t11={adrve3%+4}-{adrve2%+4}
t12={adrve3%+8}-{adrve2%+8}
x0=t11*t22-t12*t21
x1=t12*t20-t10*t22
x2=t10*t21-t11*t20
xd1={adrve1%}*x0+{adrve1%+4}*x1+{adrve1%+8}*x2
t20=x2%-x1%
t21=y2%-y1%
t22=z2%-z1%
deler=t20*x0+t21*x1+t22*x2
IF deler<>0
teller=x1%*x0+y1%*x1+z1%*x2-xd1
IF (WORD{V:teller+6} XOR WORD{V:deler+6})<0
IF ABS(teller)<ABS(deler)
labda=teller/deler
xt%=x1%-labda*(x2%-x1%)
yt%=y1%-labda*(y2%-y1%)
zt%=z1%-labda*(z2%-z1%)
dd6&=-1
ENDIF
ENDIF
ENDIF
'
IF dd6&
snproj&=BYTE{adrvl%+26} AND 3
IF snproj&=0
c1&=0
c2&=4
t20=xt%-{adrve3%}
t21=yt%-{adrve3%+4}
ELSE IF snproj&=1
c1&=0
c2&=8
t20=xt%-{adrve3%}
t21=zt%-{adrve3%+8}
ELSE
c1&=4
c2&=8
t20=yt%-{adrve3%+4}
t21=zt%-{adrve3%+8}
ENDIF
t00={adrve3%+c1&}-{adrve1%+c1&}
t01={adrve3%+c2&}-{adrve1%+c2&}
t10={adrve3%+c1&}-{adrve2%+c1&}
t11={adrve3%+c2&}-{adrve2%+c2&}
'
deeldet=t00*t11-t10*t01
IF deeldet<>0
dd6&=WORD{V:deeldet+6}
det1=t20*t11-t21*t10
IF (WORD{V:det1+6} XOR dd6&)<0
IF ABS(det1)<ABS(deeldet)
  det2=t00*t21-t01*t20
  IF (WORD{V:det2+6} XOR dd6&)<0
    IF ABS(det2)<ABS(deeldet)
      svlaksnij&=-1
    ENDIF
  ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
RETURN
'
ENDFUNC
RBOX shade
> PROCEDURE shadez
adrcolh%=0
afmix2&=afmix&
afmax2&=afmax&
IF skybuf% AND (pic=sfra& OR pic=0)
afmix2&=-afmx&
afmax2&=afmx&
ENDIF
zbuf=0.5
IF fout&=0
OPENW #6
waitsignal(0)
~C:clrbuf%(-1,-1,-1)
WORD{sndata%+38}=d&
FOR y&=ymax& DOWNTO ymin&
WORD{sndata%+36}=y&
IF (y&>=afmiy& AND y&<=afmay&) OR skybuf%
IF skybuf% OR schrbuf&
IF skybuf%
  ~C:fillbuf24%(ymax&-y&)
ENDIF
point24%=buf24%+4*(afmix2&+xofs&)
ENDIF
fase(-y&+afmy&)
svlako&=-32002
'
temp&=2*(ymax&-y&)
'
IF ali&
x1%=4*putzp&*temp&
temp%=x1%+4*2*(afmx&+afmix2&)
ELSE
x1%=putzp&*temp&
temp%=x1%+2*(afmx&+afmix2&)
ENDIF
adrscz%=adrz%+2*temp%
adrscp%=adrp%+temp%
'
'
IF (icomp&=0) OR (anim&=0) OR (((y&+cfra&) AND 1)=0)
IF halob&
  adrcolh%=@allocblock(6*(afmax2&-afmix2&+1),&H10001)
  ' okee("adrhalo "+STR$({adrha%}))
  a%=adrha%
  adrcol%=0
  FOR x&=1 TO totveha&
    IF BYTE{a%+4}=0
      a1%={a%}
      IF y&<=WORD{a1%+6}
        IF y&>=WORD{a1%+4}
          shadehalobj
        ELSE
          BYTE{a%+4}=1
        ENDIF
      ENDIF
    ENDIF
    ADD a%,6
  NEXT x&
  adrcolhs%=adrcolh%
  adrscz%=adrz%+2*temp%
  adrscp%=adrp%+temp%
ENDIF
'
FOR x&=afmix2& TO afmax2&
  WORD{sndata%+34}=x&
  IF ali&                !pixstruct
    ~C:readz%()
    poly%=pixelbuf%
    IF WORD{poly%+10}<>alimax&
      rps&=0
      gps&=0
      bps&=0
      tps&=0
      WHILE WORD{poly%+10}<>-1
        {V:zbuf}={poly%+2}
        IF zpaint&=0
          shadepixel(WORD{poly%})
        ELSE
          shadepixelpaint(WORD{poly%})
        ENDIF
        s&=WORD{poly%+10}
        ADD rps&,r&*s&
        ADD gps&,g&*s&
        ADD bps&,b&*s&
        ADD tps&,tr&*s&
        ' ADD tps&,s&
        ADD poly%,12
      WEND
      ' IF tps&<>alimax&
      ' okee("abcd")
      ' ENDIF
      r&=SHR(rps&,alishift&)
      g&=SHR(gps&,alishift&)
      b&=SHR(bps&,alishift&)
      tr&=SHR(tps&,alishift&)
    ELSE
      {V:zbuf}={poly%+2}
      IF zpaint&=0
        shadepixel(WORD{poly%})
      ELSE
        shadepixelpaint(WORD{poly%})
      ENDIF
    ENDIF
    '
    ADD adrscz%,4*4
    ADD adrscp%,2*4
  ELSE
    {V:zbuf}={adrscz%}
    IF zpaint&=0
      shadepixel(WORD{adrscp%})
    ELSE
      shadepixelpaint(WORD{adrscp%})
    ENDIF
    '
    ADD adrscz%,4
    ADD adrscp%,2
  ENDIF
  IF halob&
    ADD r&,WORD{adrcolhs%}
    ADD g&,WORD{adrcolhs%+2}
    ADD b&,WORD{adrcolhs%+4}
    ADD adrcolhs%,6
  ENDIF
  ~C:colorcalc2%(tr&,r&,g&,b&,xofs&+x&,yofs&-y&)
  IF {{msga%}}
    @decodemsg(GetMsg(msgp2%))
    IF menu2%=&H45
      afbreek&=-1
      EXIT IF afbreek&
    ENDIF
  ENDIF
  ADD point24%,4
NEXT x&
~C:clrbuf%(xofs&+x&,yofs&-y&,ymax&-y&)
IF halob&
  freeblock(adrcolh%)
ENDIF
ENDIF
ENDIF
EXIT IF afbreek&
NEXT y&
ENDIF
RETURN
> PROCEDURE shadepixel(svlak&)
tr&=0
IF svlak&=-1               !grond
IF svlako&<>svlak&
x1=zbuf
IF x1<>1
x3=d&*x1/(1-x1)
ELSE
x1=x1+0.00001
x3=d&*x1/(1-x1)
ENDIF
IF ABS(x3)>&H2000000
x3=&H2000000
coz%=&H2000000
ELSE
coz%=ABS(x3)
ENDIF
x3=(x3+d&)/d&
cox%=xps*x&*x3
coy%=yps*y&*x3
x3g=cox%
x3gd=xps*x3
setshadevars(gcol%)
xn&=grond0&
yn&=grond1&
zn&=grond2&
xno&=xn&
yno&=yn&
zno&=zn&
svlako&=-1
ELSE
ADD x3g,x3gd
cox%=x3g
xn&=xno&
yn&=yno&
zn&=zno&
ENDIF
shadelamplusint
ELSE IF svlak&=0
IF skybuf%
tr&=BYTE{point24%}
r&=BYTE{point24%+3}
g&=BYTE{point24%+2}
b&=BYTE{point24%+1}
ELSE
tr&=255
IF genlock& AND NOT (schrbuf&)
r&=ro1&
g&=gr1&
b&=bl1&
ELSE
IF skymode& AND 5
view0&=x&
view1&=y&
view2&=d&
IF tracetype&=1
  ADD view2&,cfra&
ENDIF
~C:normalwrd%(L:V:view0&,L:V:view1&,L:V:view2&)
sky
ELSE
r&=ro1&
g&=gr1&
b&=bl1&
ENDIF
ENDIF
IF halo&
FOR l&=1 TO totlampren&
a%=la%(l&)
IF {a%+78} AND {a%+30}>0
  halo
ENDIF
NEXT l&
ENDIF
ENDIF
ELSE
IF svlak&>clipvlak&+spheren&
{sndata%+64}={V:zbuf}
IF svlak&<>svlako&        !poly
adrpo%=poly%(svlak&-clipvlak&-spheren&)
setshadevars({adrpo%+4})
snfl&=0
SELECT lace&
CASE 0,3
CASE 1
snfl&=16
CASE 2
snfl&=64
ENDSELECT
svlako&=svlak&
ENDIF
~C:calcsnijps%(snfl&,L:adrpo%-4)  !vanwege vlaknormaal
ELSE IF svlak&>clipvlak&
IF svlak&<>svlako&        !perf sphere
adrzs%=adrzsphere%+46*(svlak&-clipvlak&-1)
setshadevars({adrzs%+42})
radius&=WORD{adrzs%+28}
rsquare%=radius&*radius&
y1s&=WORD{adrzs%+32}-SHL(y&,4)
ysquare%=y1s&*y1s&
rfac={adrzs%}
rfac=rfac/32767
svlako&=svlak&
ENDIF
shadezsphere
ELSE
obj&=0
{sndata%+64}={V:zbuf}
IF svlako&<>svlak&
a&=svlak&-1
adrvl%=blovl%(SHR(a&,8))+m28&(a& AND 255)
adrve1%={adrvl%}
adrve2%={adrvl%+4}
adrve3%={adrvl%+8}
setshadevars({adrvl%+18})
IF skybuf%=0
env&=0
ENDIF
~C:calcsnijps%(snfl&+1,L:adrvl%)
svlako&=svlak&
ELSE
IF env&=0
~C:calcsnijps%(snfl&,L:adrvl%)
ENDIF
ENDIF
IF viewmode& AND env&=0
~C:normalwrd%(L:V:xn&,L:V:yn&,L:V:zn&)
IF texco& AND 2
~C:normalwrd%(L:V:orxn&,L:V:oryn&,L:V:orzn&)
ENDIF
ENDIF
ENDIF
IF env&
r&=BYTE{point24%+3}
g&=BYTE{point24%+2}
b&=BYTE{point24%+1}
ELSE
v1&=xps*x&
v2&=yps*y&
v3&=d&
~C:normalwrd%(L:V:v1&,L:V:v2&,L:V:v3&)
shadelamplusint
IF halo&
FOR l&=1 TO totlampren&
a%=la%(l&)
IF {a%+78} AND {a%+30}>0
  inpr&=WORD{a%+76}
  IF inpr&>100
    halo
  ENDIF
ENDIF
NEXT l&
ENDIF
IF trace&
IF mirr& OR tran&
IF (rs&+bs&+gs&)<&H300
  rq&=rs&
  gq&=gs&
  bq&=bs&
  c&(0)=r&-rs&
  c&(1)=g&-gs&
  c&(2)=b&-bs&
  fr&=0
  f&=0
  IF mirr&
    i&=-SHR(xn&*v1&+yn&*v2&+zn&*v3&,15)
    m1&=v1&/2+SHR(xn&*i&,15)
    m2&=v2&/2+SHR(yn&*i&,15)
    m3&=v3&/2+SHR(zn&*i&,15)
    ~C:normalwrd%(L:V:m1&,L:V:m2&,L:V:m3&)
    f&=mirr&
    fr&=miro&
    fg&=migr&
    fb&=mibl&
  ENDIF
  IF tran&
    IF ang&
      IF mirr&
        v1&=v1&/2-SHR(ang&*m1&,9)
        v2&=v2&/2-SHR(ang&*m2&,9)
        v3&=v3&/2-SHR(ang&*m3&,9)
      ELSE
        i&=-SHR(xn&*v1&+yn&*v2&+zn&*v3&,15)
        m1&=SHR(v1&,1)+SHR(xn&*i&,15)
        m2&=SHR(v2&,1)+SHR(yn&*i&,15)
        m3&=SHR(v3&,1)+SHR(zn&*i&,15)
        ~C:normalwrd%(L:V:m1&,L:V:m2&,L:V:m3&)
        v1&=SHR(v1&,1)-SHR(ang&*m1&,9)
        v2&=SHR(v2&,1)-SHR(ang&*m2&,9)
        v3&=SHR(v3&,1)-SHR(ang&*m3&,9)
      ENDIF
      ~C:normalwrd%(L:V:v1&,L:V:v2&,L:V:v3&)
    ENDIF
    traceray(tran&,0,svlak&,ro&,gr&,bl&,v1&,v2&,v3&,cox%,coy%,coz%,c&())
  ENDIF
  IF f&
    traceray(f&,0,svlak&,fr&,fg&,fb&,m1&,m2&,m3&,cox%,coy%,coz%,c&())
  ENDIF
  r&=c&(0)+rq&
  g&=c&(1)+gq&
  b&=c&(2)+bq&
ENDIF
ENDIF
' ELSE IF mirr&
' i&=-SHR(xn&*v1&+yn&*v2&+zn&*v3&,15)
' m1&=v1&/2+SHR(xn&*i&,15)
' m2&=v2&/2+SHR(yn&*i&,15)
' m3&=v3&/2+SHR(zn&*i&,15)
' ~C:normalwrd%(L:V:m1&,L:V:m2&,L:V:m3&)
' c&(0)=r&-rs&
' c&(1)=g&-gs&
' c&(2)=b&-bs&
' traceray(mirr&,-1,svlak&,miro&,migr&,mibl&,m1&,m2&,m3&,cox%,coy%,coz%,c&())
' r&=c&(0)+rs&
' g&=c&(1)+gs&
' b&=c&(2)+bs&
ENDIF
ENDIF
ENDIF
RETURN
> PROCEDURE shadepixelpaint(svlak&)
tr&=0
IF svlak&=0
IF skybuf%
tr&=BYTE{point24%}
r&=BYTE{point24%+3}
g&=BYTE{point24%+2}
b&=BYTE{point24%+1}
ELSE
r&=ro1&
g&=gr1&
b&=bl1&
tr&=255
ENDIF
ELSE IF svlak&=-1               !grond
r&=ro4&
g&=gr4&
b&=bl4&
ELSE
IF svlak&<>svlako&
a&=0
IF svlak&<=clipvlak&
IF svlako&<>svlak&
a&=svlak&-1
adrvl%=blovl%(SHR(a&,8))+m28&(a& AND 255)
IF {adrvl%+18}=-461777
  r&=WORD{adrvl%+12}
  g&=WORD{adrvl%+14}
  b&=WORD{adrvl%+16}
  a&=-1
ELSE
  setshadevars({adrvl%+18})
  xn&=WORD{adrvl%+12}
  yn&=WORD{adrvl%+14}
  zn&=WORD{adrvl%+16}
  {adrvl%+18}=-461777
ENDIF
svlako&=svlak&
ENDIF
ELSE                              !perf sphere
adrvl%=0
IF svlak&<>svlako&
adrzs%=adrzsphere%+46*(svlak&-clipvlak&-1)
setshadevars({adrzs%+42})
radius&=WORD{adrzs%+28}
rsquare%=radius&*radius&
y1s&=WORD{adrzs%+32}-SHL(y&,4)
ysquare%=y1s&*y1s&
rfac={adrzs%}/32767
svlako&=svlak&
ENDIF
SELECT lace&
CASE 0,3
x1&=WORD{adrzs%+30}-SHL(x&,4)
CASE 1
x1&=WORD{adrzs%+30}-SHL(x&,5)
CASE 2
ENDSELECT
xsquare%=x1&*x1&
zsquare%=rsquare%-xsquare%-ysquare%
IF zsquare%<0
zsquare%=0
ENDIF
z&=SQR(zsquare%)
xn&=x1&
yn&=y1s&
zn&=z&
~C:normalwrd%(L:V:xn&,L:V:yn&,L:V:zn&)
ENDIF
IF a&<>-1
IF shless&
r&=ro&
g&=gr&
b&=bl&
ELSE
r&=0
g&=0
b&=0
inpr%=0
inprspecr%=0
FOR l&=1 TO totlampren&
  adrla%=la%(l&)
  lx&=WORD{adrla%+62}
  ly&=WORD{adrla%+64}
  lz&=WORD{adrla%+66}
  inpr&=SHR(xn&*lx&+yn&*ly&+zn&*lz&,15)
  inpr&=SHR(inpr&*kshade&,8)
  inprspec&=0
  IF inpr&>0
    IF kspec&
      x1&=SHR(lx&,2)
      x2&=SHR(ly&,2)
      x3&=SHR(32767+lz&,2)
      ~C:normalwrd%(L:V:x1&,L:V:x2&,L:V:x3&)
      t&=SHR(xn&*x1&+yn&*x2&+zn&*x3&,15)
      IF t&>speclimit&
        IF spec&>63
          spec&=63
        ENDIF
        b1&=SHR(t&*t&,15)
        b2&=SHR(b1&*b1&,15)
        b3&=SHR(b2&*b2&,15)
        b4&=SHR(b3&*b3&,15)
        b5&=SHR(b4&*b4&,15)
        een&=32767
        IF spec& AND 1
          een&=t&
        ENDIF
        IF spec& AND 2
          een&=SHR(een&*b1&,15)
        ENDIF
        IF spec& AND 4
          een&=SHR(een&*b2&,15)
        ENDIF
        IF spec& AND 8
          een&=SHR(een&*b3&,15)
        ENDIF
        IF spec& AND 16
          een&=SHR(een&*b4&,15)
        ENDIF
        IF spec& AND 32
          een&=SHR(een&*b5&,15)
        ENDIF
        inprspec&=SHR(kspec&*een&,8)
        ADD inprspecr%,inprspec&
      ENDIF
    ENDIF
    ADD inpr%,inpr&
  ENDIF
NEXT l&
i&=SHR(inprspecr%,7)
temp&=SHR(inpr%+ambr&,7)
ADD r&,SHR(ro&*temp&,8)+i&
temp&=SHR(inpr%+ambg&,7)
ADD g&,SHR(gr&*temp&,8)+i&
temp&=SHR(inpr%+ambb&,7)
ADD b&,SHR(bl&*temp&,15)+i&
ENDIF
IF adrvl%
WORD{adrvl%+12}=r&
WORD{adrvl%+14}=g&
WORD{adrvl%+16}=b&
ENDIF
ENDIF
ENDIF
ENDIF
RETURN
> PROCEDURE sky
IF BYTE{wrld%+18} AND 2
inprz&=SHR(view1&*grond1&+view2&*grond2&,15)
inprz&=ABS(inprz&)
inprh&=32767-inprz&
ELSE
inprz&=16384+view1&
inprh&=32767-inprz&
ENDIF
IF skymode& AND 4  !tex
ro1&=BYTE{wrld%}
gr1&=BYTE{wrld%+1}
bl1&=BYTE{wrld%+2}
ro2&=BYTE{wrld%+3}
gr2&=BYTE{wrld%+4}
bl2&=BYTE{wrld%+5}
IF skymode& AND 2
a%=workbase%+b.i&+4
tex&=SHR(view0&*WORD{a%}+view1&*WORD{a%+2}+view2&*WORD{a%+4},15)
ADD a%,6
tey&=SHR(view0&*WORD{a%}+view1&*WORD{a%+2}+view2&*WORD{a%+4},15)
ADD a%,6
tez&=SHR(view0&*WORD{a%}+view1&*WORD{a%+2}+view2&*WORD{a%+4},15)
ELSE
tex&=view0&
tey&=view1&
tez&=2000
ENDIF
itot&=256
tex%=wrld%+24
IF BYTE{tex%}
t&=BYTE{tex%}
map1&=BYTE{tex%+4}
tbase%=tex%+8
skytex
ENDIF
IF BYTE{tex%+1}
t&=BYTE{tex%+1}
map1&=BYTE{tex%+5}
tbase%=tex%+12
skytex
ENDIF
IF BYTE{tex%+2}
t&=BYTE{tex%+2}
map1&=BYTE{tex%+6}
tbase%=tex%+16
skytex
ENDIF
IF BYTE{tex%+3}
t&=BYTE{tex%+3}
map1&=BYTE{tex%+7}
tbase%=tex%+20
skytex
ENDIF
inprh&=32767-inprz&
ENDIF
IF skymode& AND 1
r&=SHR(ro1&*inprh&+ro2&*inprz&,15)
g&=SHR(gr1&*inprh&+gr2&*inprz&,15)
b&=SHR(bl1&*inprh&+bl2&*inprz&,15)
ELSE
r&=ro1&
g&=gr1&
b&=bl1&
ENDIF
RETURN
> PROCEDURE shadelamplusint
CLR inprshader%,inprshadeg%,inprshadeb%,inprspecr%,inprspecb%,inprspecg%
schaduwvoeler&=-1
gloco&=0
IF texco&
IF texco& AND 1
i&=-SHR(xn&*v1&+yn&*v2&+zn&*v3&,15)
xr&=WORD(SHR(v1&,1))+SHR(xn&*i&,15)
yr&=WORD(SHR(v2&,1))+SHR(yn&*i&,15)
zr&=WORD(SHR(v3&,1))+SHR(zn&*i&,15)
~C:normalwrd%(L:V:xr&,L:V:yr&,L:V:zr&)
ENDIF
IF texco& AND 8
gloco
ENDIF
x%=adrcol%
' LOCATE 1,1
' PRINT cox&;" "
' PRINT coy&;" "
tex%=x%+c.t&
ro&=BYTE{x%}
gr&=BYTE{x%+1}
bl&=BYTE{x%+2}
kshade&=BYTE{x%+4}
kspec&=BYTE{x%+5}
spec&=BYTE{x%+6}
tran&=BYTE{x%+7}
mirr&=BYTE{x%+8}
spro&=BYTE{x%+11}
spgr&=BYTE{x%+12}
spbl&=BYTE{x%+13}
miro&=BYTE{x%+14}
migr&=BYTE{x%+15}
mibl&=BYTE{x%+16}
itot&=256
IF BYTE{tex%}
t&=BYTE{tex%}
map1&=WORD{tex%+4}
map2&=WORD{tex%+6}
tbase%=tex%+20
objectex
ENDIF
IF BYTE{tex%+1}
t&=BYTE{tex%+1}
map1&=WORD{tex%+8}
map2&=WORD{tex%+10}
tbase%=tex%+24
objectex
ENDIF
IF BYTE{tex%+2}
t&=BYTE{tex%+2}
map1&=WORD{tex%+12}
map2&=WORD{tex%+14}
tbase%=tex%+28
objectex
ENDIF
IF BYTE{tex%+3}
t&=BYTE{tex%+3}
map1&=WORD{tex%+16}
map2&=WORD{tex%+18}
tbase%=tex%+32
objectex
ENDIF
ENDIF
FOR l&=1 TO totlampren&
adrla%=la%(l&)
IF WORD{adrla%+4}=2
lx&=WORD{adrla%+62}
ly&=WORD{adrla%+64}
lz&=WORD{adrla%+66}
lampdist&=WORD{adrla%+72}
ELSE
x%=cox%-{adrla%+22}
y%=coy%-{adrla%+26}
z%=coz%-{adrla%+30}
' t00=x%*x%+y%*y%+z%*z%
' t01={adrla%+6}*{adrla%+6}
' t00=t01/(t00+t01)
' lampdist&=32768*t00
shift&=C:ltow1%(L:V:x%,L:V:y%,L:V:z%)
lx&=x%
ly&=y%
lz&=z%
len%=SHL(SQR(lx&*lx&+ly&*ly&+lz&*lz&),shift&)
temp%={adrla%+6}
ADD len%,temp%
~C:ltow1%(L:V:len%,L:V:len%,L:V:temp%)
len&=len%
' lampdist&=SHR(SWAP(temp%)/len&,1)
lampdist&=SHR(SWAP(temp%),1)/len&
~C:normalwrd%(L:V:lx&,L:V:ly&,L:V:lz&)
ENDIF
rla&=BYTE{adrla%+10}
gla&=BYTE{adrla%+11}
bla&=BYTE{adrla%+12}
tex%=adrla%+l.t&
IF {tex%}
itot&=256
IF BYTE{tex%}
t&=BYTE{tex%}
map1&=WORD{tex%+4}
latex
ENDIF
IF BYTE{tex%+1}
t&=BYTE{tex%+1}
map1&=WORD{tex%+6}
latex
ENDIF
IF BYTE{tex%+2}
t&=BYTE{tex%+2}
map1&=WORD{tex%+8}
latex
ENDIF
IF BYTE{tex%+3}
t&=BYTE{tex%+3}
map1&=WORD{tex%+10}
latex
ENDIF
ENDIF
' rla&=SHR(exp&*rla&,7)
' gla&=SHR(exp&*gla&,7)
' bla&=SHR(exp&*bla&,7)
IF WORD{adrla%+4}=1
b1&=WORD{adrla%+62}
b2&=WORD{adrla%+64}
b3&=WORD{adrla%+66}
inpr&=SHR(b1&*lx&+b2&*ly&+b3&*lz&,15)
limit&=SHL(BYTE{adrla%+14},7)
IF inpr&<limit&
lampdist&=0
ELSE
s&=SHL(BYTE{adrla%+15},7)
b1&=inpr&-limit&
IF b1&<0
inpr&=0
ELSE IF b1&<s& AND s&<>0
b1&=SHR(b1&,1)
i&=SWAP(b1&)/s&
inpr&=SHR(i&*inpr&,15)
ENDIF
lampdist&=SHR(lampdist&*inpr&,15)
ENDIF
ENDIF
WORD{adrla%+76}=lz&
IF shless&=0
inpr&=SHR(xn&*lx&+yn&*ly&+zn&*lz&,15)
inpr&=SHR(inpr&*lampdist&,15)
inpr&=SHR(inpr&*kshade&,8)
ELSE
inpr&=2
ENDIF
IF inpr&>1
IF schaduw&
IF BYTE{adrla%+16} AND 1
' IF viewmode&
' rt&=SHR(f0&*lx&+f1&*ly&+f2&*lz&,15)
' ' rt&=SHR(rt&*lampdist&,15)
' rt&=SHR(rt&*kshade&,8)
' ELSE
' rt&=21
' ENDIF
' IF rt&>20
x2%={adrla%+22}
y2%={adrla%+26}
z2%={adrla%+30}
trace
IF snij&
  inpr&=-shless&
ENDIF
' ELSE
' inpr&=0
' ENDIF
ENDIF
ENDIF
ENDIF
IF snij&=0 AND inpr&>-4000
IF kspec&<>0
x1&=SHR(v1&+lx&,2)
x2&=SHR(v2&+ly&,2)
x3&=SHR(v3&+lz&,2)
~C:normalwrd%(L:V:x1&,L:V:x2&,L:V:x3&)
t&=SHR(xn&*x1&+yn&*x2&+zn&*x3&,15)
IF t&>speclimit&
t&=C:spec%(t&,spec&)
t&=SHR(kspec&*t&,8)
IF t&>0
  t&=SHR(t&*lampdist&,15)
  ' ADD inprspecr%,SHR(t&*rla&*spro&,15)
  ' ADD inprspecg%,SHR(t&*gla&*spgr&,15)
  ' ADD inprspecb%,SHR(t&*bla&*spbl&,15)
  temp&=SHR(rla&*spro&,1)
  ADD inprspecr%,SHR(t&*temp&,14)
  temp&=SHR(gla&*spgr&,1)
  ADD inprspecg%,SHR(t&*temp&,14)
  temp&=SHR(bla&*spbl&,1)
  ADD inprspecb%,SHR(t&*temp&,14)
ENDIF
ENDIF
ENDIF
IF inpr&>0
ADD inprshader%,SHR(rla&*inpr&,8)
ADD inprshadeg%,SHR(gla&*inpr&,8)
ADD inprshadeb%,SHR(bla&*inpr&,8)
ENDIF
ENDIF
NEXT l&
snij&=0
schaduwvoeler&=0
rs&=SHR(inprspecr%,7)
gs&=SHR(inprspecg%,7)
bs&=SHR(inprspecb%,7)
IF shless&=0
ADD inprshader%,ambr&
ADD inprshadeg%,ambg&
ADD inprshadeb%,ambb&
temp&=SHR(inprshader%,7)
r&=SHR(ro&*temp&,8)+rs&
temp&=SHR(inprshadeg%,7)
g&=SHR(gr&*temp&,8)+gs&
temp&=SHR(inprshadeb%,7)
b&=SHR(bl&*temp&,8)+bs&
' r&=SHR(ro&*inprshader%,15)+rs&
' g&=SHR(gr&*inprshadeg%,15)+gs&
' b&=SHR(bl&*inprshadeb%,15)+bs&
ELSE
r&=ro&+rs&
g&=gr&+gs&
b&=bl&+bs&
ENDIF
RETURN
> PROCEDURE shadezsphere
SELECT lace&
CASE 0,3
x1&=WORD{adrzs%+30}-SHL(x&,4)
CASE 1
x1&=WORD{adrzs%+30}-SHL(x&,5)
CASE 2
ENDSELECT
xsquare%=x1&*x1&
zsquare%=rsquare%-xsquare%-ysquare%
IF zsquare%<0
zsquare%=0
ENDIF
z&=SQR(zsquare%)
xn&=x1&
yn&=y1s&
zn&=z&
~C:normalwrd%(L:V:xn&,L:V:yn&,L:V:zn&)
f0&=xn&
f1&=yn&
f2&=zn&
cox%={adrzs%+4}-rfac*xn&
coy%={adrzs%+8}-rfac*yn&
coz%={adrzs%+12}-rfac*zn&
IF texco&
y(0)=xn&
y(1)=yn&
y(2)=zn&
RBOX x()=persinv()*y()
tex&=x(0)
tey&=x(1)
tez&=x(2)
orxn&=tex&
oryn&=tey&
orzn&=tez&
tex&=tex&/2
tey&=tey&/2
tez&=tez&/2
ENDIF
RETURN
> PROCEDURE shade(v&)
IF v&>clipvlak&
snij&=0
svlak&=v&
labda=MIN(t1,t2)
cox%=x1%+labda*(x2%-x1%)
coy%=y1%+labda*(y2%-y1%)
coz%=z1%+labda*(z2%-z1%)
a%=adrzsphere%+46*(v&-clipvlak&-1)
x%={a%+4}-cox%
y%={a%+8}-coy%
z%={a%+12}-coz%
~C:ltow%(L:V:x%,L:V:y%,L:V:z%)
xn&=x%
yn&=y%
zn&=z%
~C:normalwrd%(L:V:xn&,L:V:yn&,L:V:zn&)
setshadevars({a%+42})
IF texco&
y(0)=xn&
y(1)=yn&
y(2)=zn&
RBOX x()=persinv()*y()
tex&=x(0)
tey&=x(1)
tez&=x(2)
orxn&=tex&
oryn&=tey&
orzn&=tez&
tex&=tex&/2
tey&=tey&/2
tez&=tez&/2
ENDIF
ELSE
obj&=0
svlak&=v&
cox%=x1%+labda*(x2%-x1%)
coy%=y1%+labda*(y2%-y1%)
coz%=z1%+labda*(z2%-z1%)
seta1a2a3(v&-1)
setshadevars({adrvl%+18})
adrve1%=ABS(adrve1%)
f0&=WORD{adrvl%+12}
f1&=WORD{adrvl%+14}
f2&=WORD{adrvl%+16}
i%=f0&*v1&+f1&*v2&+f2&*v3&
IF i%>0
f0&=-f0&
f1&=-f1&
f2&=-f2&
ENDIF
IF viewmode&=0
xn&=f0&
yn&=f1&
zn&=f2&
ELSE
contrpuntnorm2(adrve1%)
contrpuntnorm2(adrve2%)
contrpuntnorm2(adrve3%)
l=1+u+v
xn&=l*WORD{adrve3%+12}-u*WORD{adrve1%+12}-v*WORD{adrve2%+12}
yn&=l*WORD{adrve3%+14}-u*WORD{adrve1%+14}-v*WORD{adrve2%+14}
zn&=l*WORD{adrve3%+16}-u*WORD{adrve1%+16}-v*WORD{adrve2%+16}
ENDIF
IF texco&
ro&=roo&
gr&=gro&
bl&=blo&
IF texco& AND 1
l=1+u+v
a1%={adrve1%+30}
a2%={adrve2%+30}
a3%={adrve3%+30}
tex&=l*WORD{a3%}-u*WORD{a1%}-v*WORD{a2%}
tey&=l*WORD{a3%+2}-u*WORD{a1%+2}-v*WORD{a2%+2}
tez&=l*WORD{a3%+4}-u*WORD{a1%+4}-v*WORD{a2%+4}
tex&=SHR(tex&,1)
tey&=SHR(tey&,1)
tez&=SHR(tez&,1)
ENDIF
IF texco& AND 6
IF viewmode&=0
a%={adrvl%+22}
orxn&=WORD{a%}
oryn&=WORD{a%+2}
orzn&=WORD{a%+4}
ELSE
a1%={adrve1%+30}
a2%={adrve2%+30}
a3%={adrve3%+30}
orxn&=l*WORD{a3%+6}-u*WORD{a1%+6}-v*WORD{a2%+6}
oryn&=l*WORD{a3%+8}-u*WORD{a1%+8}-v*WORD{a2%+8}
orzn&=l*WORD{a3%+10}-u*WORD{a1%+10}-v*WORD{a2%+10}
ENDIF
ENDIF
ENDIF
ENDIF
shadelamplusint
RETURN
> PROCEDURE gloco
a%=workbase%+b.i&
x%=cox%
y%=coy%
z%=coz%
~C:matmul%(L:a%,L:V:x%,L:V:y%,L:V:z%)
cox&=x%
coy&=y%
coz&=z%
gloco&=-1
RETURN
> PROCEDURE halo
b3&=xps*(SHL(x&,2)-WORD{a%+84})
b4&=yps*(SHL(y&,2)-WORD{a%+86})
dist%=b3&*b3&+b4&*b4&
IF dist%<{a%+78}
b1&=SQR(dist%)
b2&=WORD{a%+82}
inpr&=SHR(SWAP(b1&)/b2&,6)
IF inpr&<512
inpr&=512-512*SQR(SINQ(0.1758*inpr&))
inpr&=SHR(inpr&*BYTE{a%+13},8)
IF WORD{a%}=1
a1&=xps*(WORD{a%+68}-WORD{a%})
a2&=yps*(WORD{a%+70}-WORD{a%+2})
a3&=4
~C:normalwrd%(L:V:a1&,L:V:a2&,L:V:a3&)
a3&=4
~C:normalwrd%(L:V:b3&,L:V:b4&,L:V:a3&)
lampdist&=inpr&
inpr&=SHR(a1&*b3&+a2&*b4&,15)
limit&=BYTE{a%+14}
IF inpr&<limit&
inpr&=0
ELSE
s&=BYTE{a%+15}
b1&=inpr&-limit&
IF b1&<1
  inpr&=0
ELSE IF b1&<s& AND s&<>0
  b1&=SHR(b1&,1)
  i&=SWAP(b1&)/s&
  inpr&=SHR(i&*inpr&,8)
ENDIF
inpr&=SHR(lampdist&*inpr&,8)
ENDIF
ENDIF
ADD r&,SHR(inpr&*BYTE{a%+10},8)
ADD g&,SHR(inpr&*BYTE{a%+11},8)
ADD b&,SHR(inpr&*BYTE{a%+12},8)
ENDIF
ENDIF
RETURN
> PROCEDURE shadehalobj
IF afbreek&=0 AND BYTE{a1%+8}<>0
rq=@ltosing(a1%+14)
IF rq>0.05
r=@ltosing(a1%)
x1=@ltosing(a1%+18)
y1=@ltosing(a1%+22)
x1&=INT(x1-r)
x2&=INT(x1+r+1)
IF x1&<=afmax2& AND x2&>=afmix2&
IF x1&<afmix2&
x1&=afmix2&
ENDIF
IF x2&>afmax2&
x2&=afmax2&
ENDIF
v&=2*(x1&-afmix2&)
x0%=adrcolh%+3*v&
x1%=adrscz%+2*v&
x2%=adrscp%+v&
IF adrcol%<>{a1%+8}
adrcol%={a1%+8}
kshade&=BYTE{a1%+8}
ro&=BYTE{a1%+9}
gr&=BYTE{a1%+10}
bl&=BYTE{a1%+11}
spec&=BYTE{a%+5}
ENDIF
' IF adrtex%(10)
' adrtex%=adrtex%(10)
' n%=(24*cfra&)/{adrtex%+12}
' d1&={adrtex%+20}
' aantal&={adrtex%+24}
' ENDIF
WHILE x1&<=x2&
g&=-1
IF WORD{x0%}>255
  IF WORD{x0%+2}>255
    IF WORD{x0%+4}>255
      g&=0
    ENDIF
  ENDIF
ENDIF
IF g&
  svlak&=WORD{x2%}
  IF svlak&<>0
    IF svlak&=-32000       !pixstruct
      {V:zbuf}={{x1%}}
      IF {V:zbuf}=0
        svlak&=0
      ELSE
        svlak&=({V:zbuf}<{a1%+26})
      ENDIF
    ELSE
      {V:zbuf}={x1%}
      svlak&=({V:zbuf}<{a1%+26})
    ENDIF
  ENDIF
  IF svlak&=0
    IF spec&=127
      IF x&<totveha&
        a2%={a%+6}
        x2=@ltosing(a2%+18)
        y2=@ltosing(a2%+22)
        a=yps*(y1-y2)
        b=xps*(x2-x1)
        deler=SQR(a^2+b^2)
        IF deler<>0
          IF tracetype&=2
            IF adrtex%
              deler&={adrtex%+4}
              int=SQR((SINQ(@turbulenceint(12*x1&,12*y&,n%))+1))
              b=int*b
            ENDIF
          ENDIF
          c=a*x1+b*y1
          dist=ABS((a*x1&+b*y&-c)/deler)
          IF dist<r
            dist=(dist/r)
            dist=SINQ(90*dist)
            dist=dist^0.25
            inpr&=512-512*dist
            inpr&=SHR(inpr&*kshade&,8)
            WORD{x0%}=WORD{x0%}+SHR(inpr&*ro&,8)
            WORD{x0%+2}=WORD{x0%+2}+SHR(inpr&*gr&,8)
            WORD{x0%+4}=WORD{x0%+4}+SHR(inpr&*bl&,8)
          ENDIF
        ENDIF
      ENDIF
    ELSE
      t1=xps*(x1&-x1)
      t2=yps*(y&-y1)
      dist=(t1^2+t2^2)
      IF dist<rq
        IF dist<0.25
          dist=0
        ELSE
          dist=SQR(dist/rq)
          IF spec&>31
            dist=SINQ(90*dist)
            IF spec&>95
              dist=dist^0.25
            ELSE
              dist=SQR(dist)
            ENDIF
          ENDIF
        ENDIF
        inpr&=512-512*dist
        inpr&=SHR(inpr&*kshade&,8)
        WORD{x0%}=WORD{x0%}+SHR(inpr&*ro&,8)
        WORD{x0%+2}=WORD{x0%+2}+SHR(inpr&*gr&,8)
        WORD{x0%+4}=WORD{x0%+4}+SHR(inpr&*bl&,8)
      ENDIF
    ENDIF
  ENDIF
ENDIF
ADD x0%,6
ADD x1%,4
ADD x2%,2
ADD x1&,1
WEND
ENDIF
IF {{msga%}}
@decodemsg(GetMsg(msgp2%))
IF menu2%=&H45
afbreek&=-1
ENDIF
ENDIF
ELSE
BYTE{a%+4}=1
ENDIF
ENDIF
RETURN
'
ENDFUNC
RBOX display
> PROCEDURE initdisplay
afbreek&=0
IF SCREEN(5) AND pic<2
CLOSEW #6
CLOSES 5
ENDIF
IF pic<2 OR SCREEN(5)=0
ssizecalc
xscherm&=ssx&
yscherm&=ssy&
t%=0
'
IF ham& AND (b.en.w&=0)
ADD t%,2048
b&=6
ELSE
b&=4
IF lace& AND 2
ADD t%,&H8000
ADD xscherm&,xscherm&
ENDIF
ENDIF
IF lace& AND 1
ADD yscherm&,yscherm&
ADD t%,4
ENDIF
'
xofs&=xscherm&/2
yofs&=yscherm&/2
afmx&=xofs&
afmy&=yofs&
xps=1
yps=1
'
SELECT lace&
CASE 1
ADD xps,xps
CASE 2
ADD yps,yps
ENDSELECT
'
IF size&=15
b&=1
ENDIF
'
IF border&
afmix&=((xminb&-320)*(afmx&))/320
afmax&=((xmaxb&-320)*(afmx&))/320
afmiy&=((yminb&-256)*(afmy&))/256
afmay&=((ymaxb&-256)*(afmy&))/256
IF size&>10
IF xminb&=0 AND xmaxb&=639
afmix&=-afmx&
afmax&=afmx&
ENDIF
ENDIF
ELSE
afmix&=-afmx&
afmax&=afmx&
afmiy&=-afmy&
afmay&=afmy&
ENDIF
'
IF afmiy&<afmy&-yscherm&+1
afmiy&=afmy&-yscherm&+1
ENDIF
'
OPENS 5,0,0,xscherm&,yscherm&,b&,t%
' OPENS 5,0,0,320,256,b&,t%
OPENW #6,0,0,xscherm&,yscherm&,&HC0508,&H1000+2048,5
' OPENW #6,0,0,320,256,&HC0508,&H10000+2048,5
TITLEW #6,""
BYTE{WINDOW(6)+55}=0
PLOT 0,0
CLEARW #6
COLOR 15
v&=15
IF ham&
v&=15
ENDIF
FOR y&=0 TO v&
SETCOLOR y&,col&(y&,0),col&(y&,1),col&(y&,2)
NEXT y&
IF render&
schermfront(1,5)
OPENW #4,0,4,640,30,&HC0518,2048+4096+65536+512,1
BYTE{WINDOW(4)+55}=0
TITLEW #4,""
COLOR 1,0
CLEARW #4
border(4)
setfont(4,testfont%)
IF xscherm&<=640 OR (lace& AND 2)=0
~MoveScreen(SCREEN(1),0,482)
ELSE
~MoveScreen(SCREEN(1),0,420)
ENDIF
~RemakeDisplay()
OPENW #6
ELSE
FRONTS 5
ENDIF
ENDIF
activatewindow(WINDOW(6))
IF newpalette&
adrp1%=@allocblock(4097*4,&H10001)
{adrp1%}=4096
p%=*pcol%()
{p%}=adrp1%
adrp2%=@allocblock(4097*4,&H10001)
{adrp2%}=4096
p%=*ppcol%()
{p%}=adrp2%
IF ham&
inithamplot1(5,adrp1%+4)
ENDIF
ELSE
inithamplot2(5)
ENDIF
OPENW #6
msgp2%={WINDOW(6)+86}
msga%=msgp2%+20
IF b.en.w&
OPENS 5
FOR a&=0 TO 15
SETCOLOR a&,a&,a&,a&
NEXT a&
ENDIF
RETURN
> PROCEDURE ssizecalc
IF size&
ssx&=32*size&
ssy&=25.6*size&
IF size&=15
ssx&=640
ssy&=512
ELSE IF size&=14
ssx&=384
ssy&=288
ELSE IF size&=13
ssx&=360
ssy&=288
ELSE IF size&=12
ssx&=368
ssy&=284
ELSE IF size&=11
ssx&=352
ssy&=290
ENDIF
ENDIF
RETURN
> PROCEDURE displaylate
LET putzp&=(2*afmx&+1)
b4&=afmx&
b5&=afmy&
IF WINDOW(4)
initfase("Display",0,0)
ENDIF
IF newpalette& AND ham&=0
histogram
make.palette
ENDIF
display.normaal
IF newpalette& AND afbreek&=0
IF ham&
make.palette
display.normaal
ENDIF
ENDIF
RETURN
> PROCEDURE display.normaal
waitsignal(0)
FOR y&=afmy& DOWNTO -afmy&
y2&=yofs&-y&
~C:displine%(xofs&-afmx&,xofs&+afmx&,y2&)
IF {{msga%}}
@decodemsg(GetMsg(msgp2%))
IF menu2%=&H45
afbreek&=-1
y&=-afmy&
ENDIF
ENDIF
NEXT y&
RETURN
> PROCEDURE histogram
adr%=adrz%+1
FOR y&=afmy& DOWNTO -afmy&
y2&=yofs&-y&
FOR x&=-afmx& TO afmx&
temp%=C:mpoint%(xofs&+x&,y2&)
r&=temp% AND &HFF
g&=SHR(temp%,8) AND &HFF
b&=SWAP(temp%) AND &HFF
col&=C:colorcalc%(r&,g&,b&,x&,y&)
ADD pcol%(col&),1
ADD adr%,4
NEXT x&
NEXT y&
RETURN
> PROCEDURE kader
OPENW #1
IF a&
COLOR 0
BOX xminb&,512-yminb&,xmaxb&,512-ymaxb&
ENDIF
COLOR 1
GRAPHMODE 2
xminb&=MOUSEX
yminb&=MOUSEY
LINE xminb&,0,xminb&,500
LINE 0,yminb&,640,yminb&
WHILE MOUSEK=0
x&=MOUSEX
y&=MOUSEY
IF x&<>xminb&
LINE xminb&,0,xminb&,500
xminb&=x&
LINE xminb&,0,xminb&,500
IF a&
GRAPHMODE 1
TEXT 20,40,STR$(xminb&)+" "+STR$(yminb&)+"  "
GRAPHMODE 3
ENDIF
ENDIF
IF y&<>yminb&
LINE 0,yminb&,640,yminb&
yminb&=y&
LINE 0,yminb&,640,yminb&
IF a&
GRAPHMODE 1
TEXT 20,40,STR$(xminb&)+" "+STR$(yminb&)+"  "
GRAPHMODE 3
ENDIF
ENDIF
WEND
LINE xminb&,0,xminb&,500
LINE 0,yminb&,640,yminb&
WHILE MOUSEK
WEND
xmaxb&=MOUSEX
ymaxb&=MOUSEY
PLOT xminb&,yminb&
BOX xminb&,yminb&,xmaxb&,ymaxb&
WHILE MOUSEK=0
x&=MOUSEX
y&=MOUSEY
IF x&<>xmaxb& OR y&<>ymaxb&
BOX xminb&,yminb&,xmaxb&,ymaxb&
xmaxb&=x&
ymaxb&=y&
BOX xminb&,yminb&,xmaxb&,ymaxb&
IF a&
GRAPHMODE 1
TEXT 20,40,STR$(xminb&)+" "+STR$(yminb&)+" "+STR$(xmaxb&)+" "+STR$(ymaxb&)+"  "
GRAPHMODE 3
ENDIF
ENDIF
WEND
butmuis&=MOUSEK
IF a&
GRAPHMODE 1
ENDIF
BOX xminb&,yminb&,xmaxb&,ymaxb&
GRAPHMODE 1
yminb&=512-yminb&
ymaxb&=512-ymaxb&
IF xmaxb&<xminb&
SWAP xminb&,xmaxb&
ENDIF
IF ymaxb&<yminb&
SWAP yminb&,ymaxb&
ENDIF
WHILE MOUSEK
WEND
RETURN
'
ENDFUNC
RBOX textures
> PROCEDURE objectex
'
IF BTST(map1&,9)
tx&=xr&
ty&=yr&
tz&=zr&
ELSE IF BTST(map1&,10)
tx&=orxn&
ty&=oryn&
tz&=orzn&
ELSE IF BTST(map1&,11)
tx&=tex&
ty&=tey&
tz&=tez&
ELSE IF BTST(map1&,12)
tx&=cox&
ty&=coy&
tz&=coz&
ELSE IF BTST(map1&,13)
tx&=uv1&
ty&=uv2&
tz&=0
ELSE IF BTST(map1&,14)
imatexco(cox%,coy%,coz%)
ENDIF
adrtex%=adrtex%(t&)
IF BYTE{adrtex%}
multitex
IF map1& AND 352 !kleur
b1&=256-intc&
IF map1& AND 256
ro&=SHR(intc&*r&+b1&*ro&,8)
gr&=SHR(intc&*g&+b1&*gr&,8)
bl&=SHR(intc&*b&+b1&*bl&,8)
ENDIF
IF map1& AND 64
spro&=SHR(intc&*r&+b1&*spro&,8)
spgr&=SHR(intc&*g&+b1&*spgr&,8)
spbl&=SHR(intc&*b&+b1&*spbl&,8)
ENDIF
IF map1& AND 32
miro&=SHR(intc&*r&+b1&*miro&,8)
migr&=SHR(intc&*g&+b1&*migr&,8)
mibl&=SHR(intc&*b&+b1&*mibl&,8)
ENDIF
ENDIF
IF map1& AND 128  !normaal
IF norm&=0      !geen norm door tex
i&=BYTE{adrtex%+4}
i&=SHR(i&*int&,1)
fi=i&
WORD{V:fi+6}=WORD{V:fi+6}-8
sco=COSQ(fi)
si=SINQ(fi)
b1&=xn&
b2&=yn&
xn&=b1&*sco+b2&*si
yn&=-b1&*si+b2&*sco
b1&=yn&
b3&=zn&
yn&=b1&*sco+b3&*si
zn&=-b1&*si+b3&*sco
~C:normalwrd%(L:V:xn&,L:V:yn&,L:V:zn&)
ENDIF
ENDIF
IF map1& AND 31  !vars
i&=BYTE{adrtex%+5}
b1&=256-i&
IF map1& AND 1
IF map2& AND 1
b2%=SHL(i&,8)-i&*int&
ELSE
b2%=i&*int&
ENDIF
mirr&=SHR(b2%+mirr&*b1&,8)
ENDIF
IF map1& AND 2
IF map2& AND 2
b2%=SHL(i&,8)-i&*int&
ELSE
b2%=i&*int&
ENDIF
tran&=SHR(b2%+tran&*b1&,8)
ENDIF
IF map1& AND 4
IF map2& AND 4
b2%=SHL(i&,8)-i&*int&
ELSE
b2%=i&*int&
ENDIF
spec&=SHR(b2%+2*spec&*b1&,9)
IF spec&<3
spec&=3
ENDIF
ENDIF
IF map1& AND 8
IF map2& AND 8
b2%=SHL(i&,8)-i&*int&
ELSE
b2%=i&*int&
ENDIF
kspec&=SHR(b2%+kspec&*b1&,8)
ENDIF
IF map1& AND 16
IF map2& AND 16
b2%=SHL(i&,8)-i&*int&
ELSE
b2%=i&*int&
ENDIF
kshade&=SHR(b2%+kshade&*b1&,8)
ENDIF
ENDIF
ENDIF
'
RETURN
> PROCEDURE grotex
tx&=cox&
ty&=coy&
tz&=coz&
adrtex%=adrtex%(t&)
IF BYTE{adrtex%}
multitex
b1&=256-intc&
ro&=SHR(intc&*r&+b1&*ro&,8)
gr&=SHR(intc&*g&+b1&*gr&,8)
bl&=SHR(intc&*b&+b1&*bl&,8)
ENDIF
RETURN
> PROCEDURE skytex
'
adrtex%=adrtex%(t&)
IF BYTE{adrtex%}
IF map1& AND 16
imatexco(view0&,view1&,view2&)
ELSE
tx&=tex&
ty&=tey&
tz&=tez&
ENDIF
multitex
IF map1& AND 1
i&=BYTE{adrtex%+5}
b1&=256-i&
inprz&=SHR(i&*int&,1)+SHR(inprz&*b1&,8)
ENDIF
IF map1& AND 2
b1&=256-intc&
ro1&=SHR(intc&*r&+b1&*ro1&,8)
gr1&=SHR(intc&*g&+b1&*gr1&,8)
bl1&=SHR(intc&*b&+b1&*bl1&,8)
ENDIF
IF map1& AND 4
b1&=256-intc&
ro2&=SHR(intc&*r&+b1&*ro2&,8)
gr2&=SHR(intc&*g&+b1&*gr2&,8)
bl2&=SHR(intc&*b&+b1&*bl2&,8)
ENDIF
ENDIF
RETURN
> PROCEDURE latex
'
IF BTST(map1&,9)
IF gloco&=0
gloco
ENDIF
tx&=cox&
ty&=coy&
tz&=coz&
ELSE IF BTST(map1&,10)
imatexco(cox%,coy%,coz%)
ELSE
tx&=lx&
ty&=ly&
tz&=lz&
ENDIF
adrtex%=adrtex%(t&)
IF BYTE{adrtex%}
multitex
IF map1& AND 4 !kleur
b1&=256-intc&
rla&=SHR(intc&*r&+b1&*rla&,8)
gla&=SHR(intc&*g&+b1&*gla&,8)
bla&=SHR(intc&*b&+b1&*bla&,8)
ENDIF
IF map1& AND 1  !normaal
i&=BYTE{adrtex%+4}
i&=SHR(i&*int&,1)
fi=i&
WORD{V:fi+6}=WORD{V:fi+6}-10
sco=COSQ(fi)
si=SINQ(fi)
b1&=lx&
b2&=ly&
lx&=b1&*sco+b2&*si
ly&=-b1&*si+b2&*sco
b1&=ly&
b3&=lz&
ly&=b1&*sco+b3&*si
lz&=-b1&*si+b3&*sco
~C:normalwrd%(L:V:lx&,L:V:ly&,L:V:lz&)
ENDIF
IF map1& AND 2  !halo
' i&=BYTE{adrtex%+5}
' b1&=256-i&
' IF map1& AND 1
' b2%=i&*int&
' mirr&=SHR(b2%+mirr&*b1&,8)
' ENDIF
ENDIF
ENDIF
RETURN
> PROCEDURE multitex
IF itot&
a%=adrtex%+t.d&
IF WORD{a%}>1
tx&=tx&/WORD{a%}
ENDIF
ADD tx&,WORD{a%+6}
ADD a%,2
IF WORD{a%}>1
ty&=ty&/WORD{a%}
ENDIF
ADD ty&,WORD{a%+6}
ADD a%,2
IF WORD{a%}>1
tz&=tz&/WORD{a%}
ENDIF
ADD tz&,WORD{a%+6}
rgb&=0
norm&=0
'
SELECT BYTE{adrtex%}
CASE 1
kleur
CASE 2
wood
CASE 3
marmer
CASE 4
tover
CASE 5
imagewrap
CASE 6
tiles
CASE 7
blend
CASE 8
stucci
ENDSELECT
'
int&=SHR(int&*itot&,8)
a%=adrtex%+t.c&
IF rgb&
intc&=BYTE{adrtex%+3}
IF BYTE{adrtex%+2} AND 4 !blend
r&=BYTE{a%}
g&=BYTE{a%+1}
b&=BYTE{a%+2}
intc&=SHR(int&*intc&,8)
ELSE IF rgb&=-2 !genlock imawrap
intc&=SHR(int&*intc&,8)
ENDIF
ELSE
r&=BYTE{a%}
g&=BYTE{a%+1}
b&=BYTE{a%+2}
intc&=SHR(int&*BYTE{adrtex%+3},8)
ENDIF
IF BYTE{adrtex%+2} AND 2 !limit
intc&=BYTE{adrtex%+3}
IF int&<BYTE{a%+9}
int&=0
intc&=0
ELSE
IF int&<BYTE{a%+10}
int&=BYTE{a%+9}
ELSE IF int&<BYTE{a%+11}
int&=BYTE{a%+10}
ADD a%,3
ELSE
int&=BYTE{a%+11}
ADD a%,6
ENDIF
r&=BYTE{a%}
g&=BYTE{a%+1}
b&=BYTE{a%+2}
ENDIF
ENDIF
IF BYTE{adrtex%+2} AND 1  !stencil
itot&=SHR(int&*itot&,8)
ENDIF
ENDIF
RETURN
> PROCEDURE imatexco(gx%,gy%,gz%)
IF {tbase%}<>0 AND tbase%<>0
a%={tbase%}+b.i&
~C:matmul%(L:a%,L:V:gx%,L:V:gy%,L:V:gz%)
tx&=gx%
ty&=gy%
tz&=gz%
ELSE
tx&=tex&
ty&=tey&
tz&=tez&
ENDIF
RETURN
'
> PROCEDURE kleur
int&=C:nnoise%(WORD{adrtex%+t.o&},tx&,ty&,tz&,L:hash%)
IF BYTE{adrtex%+1}=0
int&=SHR(int&,7)
ELSE IF BYTE{adrtex%+1}=1
int&=SHR(int&,7)
r&=int&
g&=C:nnoise%(WORD{adrtex%+t.o&},tz&,ty&,tx&,L:hash%)
g&=SHR(g&,7)
b&=255-r&
int&=(r&+g&+b&)/3
rgb&=-1
ELSE IF BYTE{adrtex%+1}=2
int&=SHR(int&*int&,15)
int&=SHR(int&*int&,15)
int&=SHR(int&,7)
ENDIF
RETURN
> PROCEDURE bumpmap
n&={adrtex%+40}
IF n&=0
fi=C:nnoise%({adrtex%+4},tx&,ty&,tz&,L:hash%)
WORD{V:fi+6}=WORD{V:fi+6}-14
fi=fi-0.5
ELSE IF n&=1
x&=x&/{adrtex%+12}
y&=y&/{adrtex%+16}
z&=z&/{adrtex%+20}
fi=SINQ(x&+y&+z&)
ELSE IF n&=2
x&=x&/{adrtex%+12}
y&=y&/{adrtex%+16}
z&=z&/{adrtex%+20}
fi=SINQ(x&)+SINQ(y&)+SINQ(z&)
ELSE IF n&=3
deler&={adrtex%+4}
fi=C:nnoise%(deler&,x&,y&,z&,L:hash%)
aantal&=1
d1&={adrtex%+36}
int=(SINQ(@turbulenceint(x&,y&,z&))+1)/2
fi=int*fi
WORD{V:fi+6}=WORD{V:fi+6}-14
fi=fi-0.5
ELSE IF n&=4
' b1&=@nnoise({adrtex%+4},x&,y&,z&)
' xn&=SHR(xn&+b1&-nnoise({adrtex%+4},x&+{adrtex%+12},y&,z&),1)
' yn&=SHR(yn&+b1&-nnoise({adrtex%+4},x&,y&+{adrtex%+16},z&),1)
' zn&=SHR(zn&+b1&-nnoise({adrtex%+4},x&,y&,z&+{adrtex%+20}),1)
' ~C:normalwrd%(L:V:xn&,L:V:yn&,L:V:zn&)
ELSE IF n&=5
aantal&=1
d1&={adrtex%+36}
deler&={adrtex%+4}
b1&=C:nnoise%(deler&,x&,y&,z&,L:hash%)
b1&=b1&/2
si=SINQ(@turbulenceint(x&,y&,z&))
deler&={adrtex%+4}
b3&=b1&*(si-SINQ(@turbulenceint(x&+{adrtex%+12},y&,z&)))
deler&={adrtex%+4}
b4&=b1&*(si-SINQ(@turbulenceint(x&,y&+{adrtex%+16},z&)))
deler&={adrtex%+4}
b5&=b1&*(si-SINQ(@turbulenceint(x&,y&,z&+{adrtex%+20})))
xn&=SHR(xn&+b3&,1)
yn&=SHR(yn&+b4&,1)
zn&=SHR(zn&+b5&,1)
~C:normalwrd%(L:V:xn&,L:V:yn&,L:V:zn&)
ENDIF
IF n&<4
fi=fi*{adrtex%+8}
sco=COSQ(fi)
si=SINQ(fi)
b1&=xn&
b2&=yn&
xn&=b1&*sco+b2&*si
yn&=-b1&*si+b2&*sco
b1&=yn&
b3&=zn&
yn&=b1&*sco+b3&*si
zn&=-b1&*si+b3&*sco
' ~C:normalwrd%(L:V:xn&,L:V:yn&,L:V:zn&)
ENDIF
RETURN
> PROCEDURE wood
n&=BYTE{adrtex%+1}
a%=adrtex%+t.o&
IF WORD{a%+2}=0
tz&=0
ELSE IF WORD{a%+2}=1
ty&=0
ELSE IF WORD{a%+2}=2
tx&=0
ENDIF
tx&=tx&/WORD{a%+6}
ty&=ty&/WORD{a%+8}
tz&=tz&/WORD{a%+10}
IF n&=0
int=1+SINQ(tx&+ty&+tz&)
WORD{V:int+6}=WORD{V:int+6}+7
int&=int
ELSE IF n&=1
int=1+SINQ(SQR(tx&*tx&+ty&*ty&+tz&*tz&))
WORD{V:int+6}=WORD{V:int+6}+7
int&=int
ELSE IF n&=3
int&=42+42*SINQ(tx&)
ADD int&,42*SINQ(ty&)
ADD int&,84+42*SINQ(tz&)
ELSE IF n&=2
fi&=C:nnoise%(WORD{adrtex%+t.o&},tx&,ty&,tz&,L:hash%)
fi&=SHR(fi&,4)
int=1+SINQ(fi&+tx&+ty&+tz&)
WORD{V:int+6}=WORD{V:int+6}+7
int&=int
ENDIF
RETURN
> PROCEDURE marmer
n&=BYTE{adrtex%+1}
a%=adrtex%+t.o&
n%=ty&/WORD{a%+8}+tz&/WORD{a%+10}+tx&/WORD{a%+6}
deler&=WORD{a%}
d1&=WORD{a%+2}
aantal&=WORD{a%+4}
IF n&=0
int=SQR(2*(SINQ(n%+@turbulenceint(tx&,ty&,tz&))+1))
ELSE
int=1+(SINQ(n%+@turbulenceint(tx&,ty&,tz&)))
ENDIF
WORD{V:int+6}=WORD{V:int+6}+7
int&=int
RETURN
> PROCEDURE tover
a%=adrtex%+t.o&
n&=WORD{a%}
t&=WORD{a%+4}
x=SINQ(tx&+ty&+tz&)
y=COSQ(-tx&+ty&-tz&)
z=-SINQ(tx&-ty&-tz&)
IF n&>0
~C:pow2%(L:V:x,t&)
~C:pow2%(L:V:y,t&)
~C:pow2%(L:V:z,t&)
y=-COSQ(-x-y+z)
~C:pow2%(L:V:y,t&)
IF n&>1
x=COSQ(x-y-z)
~C:pow2%(L:V:x,t&)
IF n&>2
z=SINQ(-x-y-z)
~C:pow2%(L:V:z,t&)
IF n&>3
x=-COSQ(-x+y-z)
~C:pow2%(L:V:x,t&)
IF n&>4
y=-SINQ(-x+y+z)
~C:pow2%(L:V:y,t&)
IF n&>5
z=SINQ(x-y+z)
~C:pow2%(L:V:z,t&)
IF n&>6
  x=-COSQ(x-y+z)
  ~C:pow2%(L:V:x,t&)
  IF n&>7
    y=COSQ(-x+y-z)
    ~C:pow2%(L:V:y,t&)
    IF n&>8
      z=SINQ(-x-y-z)
      ~C:pow2%(L:V:z,t&)
      IF n&>9
        x=-COSQ(x+y+z)
        ~C:pow2%(L:V:x,t&)
        IF n&>10
          y=COSQ(x-y-z)
          ~C:pow2%(L:V:y,t&)
          IF n&>11
            z=SINQ(-x+y+z)
            ~C:pow2%(L:V:z,t&)
          ENDIF
        ENDIF
      ENDIF
    ENDIF
  ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
IF BYTE{adrtex%+1}=1
n&=WORD{a%+2}
x=(128-n&*x) MOD 256
y=(128-n&*y) MOD 256
z=(128-n&*z) MOD 256
r&=INT(x)
g&=INT(y)
b&=INT(z)
ELSE
IF t&<>7
~C:pow2%(L:V:x,7-t&)
~C:pow2%(L:V:y,7-t&)
~C:pow2%(L:V:z,7-t&)
ENDIF
r&=128-x
g&=128-y
b&=128-z
ENDIF
int&=(r&+g&+b&)/3
rgb&=-1
RETURN
> PROCEDURE imagewrap
tabmem%={adrtex%+112}
IF tabmem%
bmhd%={tabmem%+8}
cmap%={tabmem%+12}
tabeladr%={tabmem%+20}
picw&=WORD{bmhd%}
pich&=WORD{bmhd%+2}
n&=BYTE{adrtex%+1}
a%=adrtex%+t.o&
rgb&=-1
IF WORD{a%+4}    !genlock
rgb&=-2
ENDIF
IF n&=1 OR n&=2
b2&=WORD{a%}   !proj type
b3&=WORD{a%+2} !y adjust
IF render&
IF b2&=2
IF b3&
tz&=tz&+SHR(tz&*b3&,8)
ENDIF
xim&=SHR(picw&*(-ty&+16363),15)
yim&=SHR(pich&*(-tz&+16364),15)
ELSE IF b2&=1
IF b3&
tz&=tz&+SHR(tz&*b3&,8)
ENDIF
xim&=SHR(picw&*(tx&+16363),15)
yim&=SHR(pich&*(-tz&+16364),15)
ELSE
IF b3&
ty&=ty&+SHR(ty&*b3&,8)
ENDIF
xim&=SHR(picw&*(tx&+16363),15)
yim&=SHR(pich&*(-ty&+16364),15)
ENDIF
ELSE
IF b3&
ty&=ty&+SHR(ty&*b3&,8)
ENDIF
xim&=SHR(picw&*(tx&+16363),15)
yim&=SHR(pich&*(-ty&+16364),15)
ENDIF
IF n&=2
' rgb&=0
int&=0
b3&=WORD{a%+6}
b4&=WORD{a%+8}
b1&=WORD{a%+10}
ncol1%=C:pointbr%(W:xim&-b3&,W:yim&-b4&,L:bmhd%,L:tabeladr%,L:cmap%)
ncol2%=C:pointbr%(W:xim&+b3&,W:yim&-b4&,L:bmhd%,L:tabeladr%,L:cmap%)
ncol3%=C:pointbr%(W:xim&-b3&,W:yim&+b4&,L:bmhd%,L:tabeladr%,L:cmap%)
ncol4%=C:pointbr%(W:xim&+b3&,W:yim&+b4&,L:bmhd%,L:tabeladr%,L:cmap%)
temp&=BYTE{V:ncol1%+1}+BYTE{V:ncol3%+1}-BYTE{V:ncol2%+1}-BYTE{V:ncol4%+1}
IF temp&
temp=(temp&*b1&)/2048
co=COSQ(temp)
si=SINQ(temp)
b3&=co*xn&-si*zn&
zn&=si*xn&+co*zn&
xn&=b3&
ADD int&,temp&/2
ENDIF
temp&=BYTE{V:ncol1%+1}+BYTE{V:ncol2%+1}-BYTE{V:ncol3%+1}-BYTE{V:ncol4%+1}
IF temp&
temp=(temp&*b1&)/2048
co=COSQ(temp)
si=SINQ(temp)
b3&=co*yn&+si*zn&
zn&=-si*yn&+co*zn&
yn&=b3&
ADD int&,temp&/2
ENDIF
norm&=-1
~C:normalwrd%(L:V:xn&,L:V:yn&,L:V:zn&)
ELSE
SUB yim&,1
pointbr3
r&=BYTE{V:ncol1%+1}+2*BYTE{V:ncol2%+1}+BYTE{V:ncol3%+1}
g&=BYTE{V:ncol1%+2}+2*BYTE{V:ncol2%+2}+BYTE{V:ncol3%+2}
b&=BYTE{V:ncol1%+3}+2*BYTE{V:ncol2%+3}+BYTE{V:ncol3%+3}
int&=b1&
pointbr3
ADD r&,2*BYTE{V:ncol1%+1}+4*BYTE{V:ncol2%+1}+2*BYTE{V:ncol3%+1}
ADD g&,2*BYTE{V:ncol1%+2}+4*BYTE{V:ncol2%+2}+2*BYTE{V:ncol3%+2}
ADD b&,2*BYTE{V:ncol1%+3}+4*BYTE{V:ncol2%+3}+2*BYTE{V:ncol3%+3}
ADD int&,SHL(b1&,1)
pointbr3
ADD r&,BYTE{V:ncol1%+1}+2*BYTE{V:ncol2%+1}+BYTE{V:ncol3%+1}
ADD g&,BYTE{V:ncol1%+2}+2*BYTE{V:ncol2%+2}+BYTE{V:ncol3%+2}
ADD b&,BYTE{V:ncol1%+3}+2*BYTE{V:ncol2%+3}+BYTE{V:ncol3%+3}
ADD int&,b1&
r&=SHR(r&,4)
g&=SHR(g&,4)
b&=SHR(b&,4)
IF rgb&=-2
int&=256-SHL(int&,4)
ELSE
int&=(r&+b&+g&)/3
ENDIF
ENDIF
ELSE IF n&=3                        !cylinder
b1=@atan2(-tx&,ty&)       ! b1 van -pi tot +pi
b1=(b1/PI+1)/2            ! b1 van 1 tot 0
b1=b1*picw&               ! b1 van 0 to picw&
xim2&=b1
afwx2&=FRAC(b1)*&H8000
afwx&=&H7FFF-afwx2&
'
ynn&=-tz&+16384
yim2&=SHR(pich&*ynn&,15)
afwy&=(pich&*ynn&) AND &H7FFF
afwy2&=&H7FFF-afwy&
'
ncol1%=C:pointbr%(W:xim2&,W:yim2&,L:bmhd%,L:tabeladr%,L:cmap%)
ncol2%=C:pointbr%(W:xim2&+1,W:yim2&,L:bmhd%,L:tabeladr%,L:cmap%)
ncol3%=C:pointbr%(W:xim2&,W:yim2&+1,L:bmhd%,L:tabeladr%,L:cmap%)
ncol4%=C:pointbr%(W:xim2&+1,W:yim2&+1,L:bmhd%,L:tabeladr%,L:cmap%)
IF rgb&=-2
IF BYTE{V:ncol1%}=0
int&=64
ENDIF
IF BYTE{V:ncol2%}=0
ADD int&,64
ENDIF
IF BYTE{V:ncol3%}=0
ADD int&,64
ENDIF
IF BYTE{V:ncol4%}=0
ADD int&,64
ENDIF
ENDIF
rim1&=SHR(afwx&*BYTE{V:ncol1%+1}+afwx2&*BYTE{V:ncol2%+1},15)
rim2&=SHR(afwx&*BYTE{V:ncol3%+1}+afwx2&*BYTE{V:ncol4%+1},15)
r&=SHR(afwy2&*rim1&+afwy&*rim2&,15)
'
rim1&=SHR(afwx&*BYTE{V:ncol1%+2}+afwx2&*BYTE{V:ncol2%+2},15)
rim2&=SHR(afwx&*BYTE{V:ncol3%+2}+afwx2&*BYTE{V:ncol4%+2},15)
g&=SHR(afwy2&*rim1&+afwy&*rim2&,15)
'
rim1&=SHR(afwx&*BYTE{V:ncol1%+3}+afwx2&*BYTE{V:ncol2%+3},15)
rim2&=SHR(afwx&*BYTE{V:ncol3%+3}+afwx2&*BYTE{V:ncol4%+3},15)
b&=SHR(afwy2&*rim1&+afwy&*rim2&,15)
IF rgb&=-2
int&=256-int&
ELSE
int&=(r&+b&+g&)/3
ENDIF
ELSE IF n&=4                        !cylinder
o%=adrtex%+124
chng&=FALSE
IF WORD{o%+18}<>WORD{a%+12}
chng&=TRUE
ELSE IF WORD{o%+20}<>WORD{a%+14}
chng&=TRUE
ELSE IF WORD{o%+22}<>WORD{a%+16}
chng&=TRUE
ENDIF
IF chng&
ARRAYFILL mat(),0
mat(0,0)=1
mat(1,1)=1
mat(2,2)=1
matmul(WORD{a%+12},0) !z
matmul(WORD{a%+14},1) !y
matmul(WORD{a%+16},2)   ! x
FOR i&=0 TO 2
FOR j&=0 TO 2
WORD{o%}=&H3FFF*mat(i&,j&)
ADD o%,2
NEXT j&
NEXT i&
WORD{o%}=WORD{a%+12}
WORD{o%+2}=WORD{a%+14}
WORD{o%+4}=WORD{a%+16}
ENDIF
asinhor%={tabmem%+24}
asinver%={tabmem%+28}
{*asinhor&()}=asinhor%
{*asinver&()}=asinver%
xim&=-tx&
yim&=-tz&
zim&=ty&
IF n&<>0
~C:normalwrd%(L:V:xim&,L:V:yim&,L:V:zim&)
ENDIF
o%=adrtex%+124
xnn&=SHR(xim&*WORD{o%}+yim&*WORD{o%+2}+zim&*WORD{o%+4},14)
ADD o%,6
ynn&=SHR(xim&*WORD{o%}+yim&*WORD{o%+2}+zim&*WORD{o%+4},14)
ADD o%,6
znn&=SHR(xim&*WORD{o%}+yim&*WORD{o%+2}+zim&*WORD{o%+4},14)
xim2&=xnn&
zim&=znn&
yim&=0
~C:normalwrd%(L:V:xim2&,L:V:yim&,L:V:zim&)
xim2&=xim2& AND &HFFFE
IF xim2&<>&HFFFF8000
xna&=ABS(xim2&)
ELSE
xna&=&H7FFE
ENDIF
tel&=picw&/8
delta&=tel&/2
WHILE (xna&>=asinhor&(tel&+1)) OR (xna&<asinhor&(tel&))
IF xna&>=asinhor&(tel&+1)
ADD tel&,delta&
ELSE
SUB tel&,delta&
ENDIF
IF delta&>1
delta&=SHR(delta&,1)
ENDIF
WEND
afwx&=SWAP(SHR(xna&-asinhor&(tel&),1))/(asinhor&(tel&+1)-asinhor&(tel&))
afwx2&=&H7FFF-afwx&
IF xim2&>0
xim2&=tel&+picw&/2
SWAP afwx&,afwx2&
ELSE
xim2&=picw&/2-tel&-1
ENDIF
IF xim2&<picw&/2
xim2&=SHR(picw&,1)-xim2&-2
ELSE
xim2&=picw&+SHR(picw&,1)-xim2&
ENDIF
SWAP afwx&,afwx2&
PRINT #1,xim2&
'
ynn&=-tz&+16384
yim2&=SHR(pich&*ynn&,15)
afwy&=(pich&*ynn&) AND &H7FFF
afwy2&=32767-afwy&
'
ncol1%=C:pointbr%(W:xim2&,W:yim2&,L:bmhd%,L:tabeladr%,L:cmap%)
ncol2%=C:pointbr%(W:xim2&+1,W:yim2&,L:bmhd%,L:tabeladr%,L:cmap%)
ncol3%=C:pointbr%(W:xim2&,W:yim2&+1,L:bmhd%,L:tabeladr%,L:cmap%)
ncol4%=C:pointbr%(W:xim2&+1,W:yim2&+1,L:bmhd%,L:tabeladr%,L:cmap%)
IF rgb&=-2
IF BYTE{V:ncol1%}=0
int&=64
ENDIF
IF BYTE{V:ncol2%}=0
ADD int&,64
ENDIF
IF BYTE{V:ncol3%}=0
ADD int&,64
ENDIF
IF BYTE{V:ncol4%}=0
ADD int&,64
ENDIF
ENDIF
rim1&=SHR(afwx&*BYTE{V:ncol1%+1}+afwx2&*BYTE{V:ncol2%+1},15)
rim2&=SHR(afwx&*BYTE{V:ncol3%+1}+afwx2&*BYTE{V:ncol4%+1},15)
r&=SHR(afwy2&*rim1&+afwy&*rim2&,15)
'
rim1&=SHR(afwx&*BYTE{V:ncol1%+2}+afwx2&*BYTE{V:ncol2%+2},15)
rim2&=SHR(afwx&*BYTE{V:ncol3%+2}+afwx2&*BYTE{V:ncol4%+2},15)
g&=SHR(afwy2&*rim1&+afwy&*rim2&,15)
'
rim1&=SHR(afwx&*BYTE{V:ncol1%+3}+afwx2&*BYTE{V:ncol2%+3},15)
rim2&=SHR(afwx&*BYTE{V:ncol3%+3}+afwx2&*BYTE{V:ncol4%+3},15)
b&=SHR(afwy2&*rim1&+afwy&*rim2&,15)
IF rgb&=-2
int&=256-int&
ELSE
int&=(r&+b&+g&)/3
ENDIF
ELSE
o%=adrtex%+124
chng&=FALSE
IF WORD{o%+18}<>WORD{a%+12}
chng&=TRUE
ELSE IF WORD{o%+20}<>WORD{a%+14}
chng&=TRUE
ELSE IF WORD{o%+22}<>WORD{a%+16}
chng&=TRUE
ENDIF
IF chng&
ARRAYFILL mat(),0
mat(0,0)=1
mat(1,1)=1
mat(2,2)=1
matmul(WORD{a%+12},0) !z
matmul(WORD{a%+14},1) !y
matmul(WORD{a%+16},2)   ! x
FOR i&=0 TO 2
FOR j&=0 TO 2
WORD{o%}=&H3FFF*mat(i&,j&)
ADD o%,2
NEXT j&
NEXT i&
WORD{o%}=WORD{a%+12}
WORD{o%+2}=WORD{a%+14}
WORD{o%+4}=WORD{a%+16}
ENDIF
asinhor%={tabmem%+24}
asinver%={tabmem%+28}
{*asinhor&()}=asinhor%
{*asinver&()}=asinver%
xim&=-tx&
yim&=-tz&
zim&=ty&
IF n&<>0
~C:normalwrd%(L:V:xim&,L:V:yim&,L:V:zim&)
ENDIF
o%=adrtex%+124
xnn&=SHR(xim&*WORD{o%}+yim&*WORD{o%+2}+zim&*WORD{o%+4},14)
ADD o%,6
ynn&=SHR(xim&*WORD{o%}+yim&*WORD{o%+2}+zim&*WORD{o%+4},14)
ADD o%,6
znn&=SHR(xim&*WORD{o%}+yim&*WORD{o%+2}+zim&*WORD{o%+4},14)
xim2&=xnn&
zim&=znn&
yim&=0
~C:normalwrd%(L:V:xim2&,L:V:yim&,L:V:zim&)
xim2&=xim2& AND &HFFFE
IF xim2&<>&HFFFF8000
xna&=ABS(xim2&)
ELSE
xna&=&H7FFE
ENDIF
tel&=picw&/8
delta&=tel&/2
WHILE (xna&>=asinhor&(tel&+1)) OR (xna&<asinhor&(tel&))
IF xna&>=asinhor&(tel&+1)
ADD tel&,delta&
ELSE
SUB tel&,delta&
ENDIF
IF delta&>1
delta&=SHR(delta&,1)
ENDIF
WEND
afwx&=SWAP(SHR(xna&-asinhor&(tel&),1))/(asinhor&(tel&+1)-asinhor&(tel&))
afwx2&=&H7FFF-afwx&
IF xim2&>0
xim2&=tel&+picw&/2
SWAP afwx&,afwx2&
ELSE
xim2&=picw&/2-tel&-1
ENDIF
yim2&=-ynn&
yim2&=yim2& AND &HFFFE
IF yim2&<>&HFFFF8000
yna&=ABS(yim2&)
ELSE
yna&=&H7FFE
ENDIF
tel&=pich&/4
delta&=tel&/2
WHILE (yna&>=asinver&(tel&+1)) OR (yna&<asinver&(tel&))
IF yna&>=asinver&(tel&+1)
ADD tel&,delta&
ELSE
SUB tel&,delta&
ENDIF
IF delta&>1
delta&=SHR(delta&,1)
ENDIF
WEND
afwy&=SWAP(SHR(yna&-asinver&(tel&),1))/(asinver&(tel&+1)-asinver&(tel&))
afwy2&=&H7FFF-afwy&
IF yim2&>0
yim2&=tel&+pich&/2
ELSE
yim2&=pich&/2-tel&-1
SWAP afwy&,afwy2&
ENDIF
IF znn&<0
IF xim2&<picw&/2
xim2&=SHR(picw&,1)-xim2&-2
ELSE
xim2&=picw&+SHR(picw&,1)-xim2&
ENDIF
SWAP afwx&,afwx2&
ENDIF
ncol1%=C:pointbr%(W:xim2&,W:yim2&,L:bmhd%,L:tabeladr%,L:cmap%)
ncol2%=C:pointbr%(W:xim2&+1,W:yim2&,L:bmhd%,L:tabeladr%,L:cmap%)
ncol3%=C:pointbr%(W:xim2&,W:yim2&+1,L:bmhd%,L:tabeladr%,L:cmap%)
ncol4%=C:pointbr%(W:xim2&+1,W:yim2&+1,L:bmhd%,L:tabeladr%,L:cmap%)
IF rgb&=-2
IF BYTE{V:ncol1%}=0
int&=64
ENDIF
IF BYTE{V:ncol2%}=0
ADD int&,64
ENDIF
IF BYTE{V:ncol3%}=0
ADD int&,64
ENDIF
IF BYTE{V:ncol4%}=0
ADD int&,64
ENDIF
ENDIF
rim1&=SHR(afwx&*BYTE{V:ncol1%+1}+afwx2&*BYTE{V:ncol2%+1},15)
rim2&=SHR(afwx&*BYTE{V:ncol3%+1}+afwx2&*BYTE{V:ncol4%+1},15)
r&=SHR(afwy2&*rim1&+afwy&*rim2&,15)
'
rim1&=SHR(afwx&*BYTE{V:ncol1%+2}+afwx2&*BYTE{V:ncol2%+2},15)
rim2&=SHR(afwx&*BYTE{V:ncol3%+2}+afwx2&*BYTE{V:ncol4%+2},15)
g&=SHR(afwy2&*rim1&+afwy&*rim2&,15)
'
rim1&=SHR(afwx&*BYTE{V:ncol1%+3}+afwx2&*BYTE{V:ncol2%+3},15)
rim2&=SHR(afwx&*BYTE{V:ncol3%+3}+afwx2&*BYTE{V:ncol4%+3},15)
b&=SHR(afwy2&*rim1&+afwy&*rim2&,15)
IF rgb&=-2
int&=256-int&
ELSE
int&=(r&+b&+g&)/3
ENDIF
ENDIF
ENDIF
RETURN
> PROCEDURE pointbr3
b1&=0
ncol1%=C:pointbr%(W:xim&-1,W:yim&,L:bmhd%,L:tabeladr%,L:cmap%)
IF BYTE{V:ncol1%}=0
ADD b1&,1
ENDIF
ncol2%=C:pointbr%(W:xim&,W:yim&,L:bmhd%,L:tabeladr%,L:cmap%)
IF BYTE{V:ncol2%}=0
ADD b1&,2
ENDIF
ncol3%=C:pointbr%(W:xim&+1,W:yim&,L:bmhd%,L:tabeladr%,L:cmap%)
IF BYTE{V:ncol3%}=0
ADD b1&,1
ENDIF
ADD yim&,1
RETURN
> PROCEDURE tiles
a%=adrtex%+t.o&
r&=WORD{a%+2}
n&=BYTE{adrtex%+1}
int&=0
IF WORD{a%}=0
tz&=0
ELSE IF WORD{a%}=1
ty&=0
ELSE IF WORD{a%}=2
tx&=0
ENDIF
tx&=tx& AND 255
ty&=ty& AND 255
tz&=tz& AND 255
IF n&=0
IF tx&>r&
ADD int&,85
ENDIF
IF ty&>r&
ADD int&,85
ENDIF
IF tz&>r&
ADD int&,85
ENDIF
IF WORD{a%+4}=0
IF ODD(int&)
int&=255
ELSE
int&=0
ENDIF
ENDIF
ELSE IF n&=1
IF tx&>r&
int&=85
ELSE IF ty&>r&
int&=170
ELSE IF tz&>r&
int&=255
ENDIF
IF int& AND WORD{a%+4}=0
int&=255
ENDIF
ELSE IF n&=2
SUB tx&,128
SUB ty&,128
SUB tz&,128
t&=SHR(tx&*tx&+ty&*ty&+tz&*tz&,7)
t&=SHR(170*t&,8)
IF WORD{a%+4}
int&=t&
ELSE
IF t&<r&
int&=255
ENDIF
ENDIF
ELSE IF n&=3
IF WORD{a%}=1
ty&=tz&
ELSE IF WORD{a%}=2
tx&=tz&
ENDIF
t&=ABS(tx&-ty&)
IF t&>r&
ADD int&,64
ENDIF
ty&=256-ty&
t&=ABS(tx&-ty&)
IF t&>r&
ADD int&,64
ENDIF
tx&=256-tx&
t&=ABS(tx&-ty&)
IF t&>r&
ADD int&,64
ENDIF
ty&=256-ty&
t&=ABS(tx&-ty&)
IF t&>r&
ADD int&,64
ENDIF
IF WORD{a%+4}=0
IF t&>127
int&=255
ELSE
int&=0
ENDIF
ENDIF
ENDIF
RETURN
> PROCEDURE blend
a%=adrtex%+t.o&
IF WORD{a%}=1
tx&=ty&
ELSE IF WORD{a%}=2
tx&=tz&
ENDIF
IF WORD{a%+4}
int&=SHR(SHL(tx&,WORD{a%+4})+16384,7)
ELSE
int&=SHR(tx&+16384,7)
ENDIF
IF WORD{a%+2}
int&=256-int&
ENDIF
IF int&<0
int&=0
ELSE IF int&>255
int&=255
ENDIF
RETURN
> PROCEDURE stucci
n&=BYTE{adrtex%+1}
a%=adrtex%+t.o&
deler&=WORD{a%}
b1&=WORD{a%+2}
IF n&>=2
b1&=4*b1&
d1&=WORD{a%+4}
aantal&=2
b2&=@turbulenceint(tx&,ty&,tz&)
IF n&=3
b1&=SHR(b1&*b2&,15)
ENDIF
deler&=WORD{a%}
xn&=SHR(xn&+b2&-@turbulenceint(tx&+b1&,ty&,tz&),1)
deler&=WORD{a%}
yn&=SHR(yn&+b2&-@turbulenceint(tx&,ty&+b1&,tz&),1)
deler&=WORD{a%}
zn&=SHR(zn&+b2&-@turbulenceint(tx&,ty&,tz&+b1&),1)
ELSE
b2&=C:nnoise%(deler&,tx&,ty&,tz&,L:hash%)
IF n&=1
b1&=SHR(b1&*b2&,15)
ENDIF
xn&=SHR(xn&+b2&-C:nnoise%(deler&,tx&+b1&,ty&,tz&,L:hash%),1)
yn&=SHR(yn&+b2&-C:nnoise%(deler&,tx&,ty&+b1&,tz&,L:hash%),1)
zn&=SHR(zn&+b2&-C:nnoise%(deler&,tx&,ty&,tz&+b1&,L:hash%),1)
ENDIF
~C:normalwrd%(L:V:xn&,L:V:yn&,L:V:zn&)
norm&=-1
RETURN
> PROCEDURE inittexture
LOCAL g1&
' De data:tekst(12),min(12),max(12),default(12),col(3)+limit(3)+flag,Div+Add
textudata1:
' color
DATA Noise,* ,* ,* ,* ,* ,* ,* ,* ,* ,* ,"* "
DATA 10,0,0,0,0,0,0,0,0,0,0,0
DATA 20000,0,0,0,0,0,0,0,0,0,0,0
DATA 4000,0,0,0,0,0,0,0,0,0,0,0
DATA &HFF00FF,&HFFFF00,&HFFFF0,64,128,192,2
DATA 1,1,1,0,0,0
textudata2:
' wood
DATA Noise ,Proj ,* ,X rings ,Y rings ,Z rings ,* ,* ,* ,* ,* ,"* "
DATA 10,0,0,1,1,1,0,0,0,0,0,0
DATA 20000,3,0,1000,1000,1000,0,0,0,0,0,0
DATA 4000,3,0,10,40,100,0,0,0,0,0,0
DATA 0,&H95654E,&HDF9C00,64,128,192,0
DATA 1,1,1,0,0,0
textudata3:
' marble
DATA Noise  ,Turbdiv,Turbul  ,X rings,Y rings,Z rings,* ,* ,* ,* ,* ,"* "
DATA 10,1,0,1,1,1,0,0,0,0,0,0
DATA 20000,1000,5,1000,1000,1000,0,0,0,0,0,0
DATA 4000,100,2,40,64,40,0,0,0,0,0,0
DATA 0,&H95654E,&HDF9C00,64,128,192,0
DATA 1,1,1,0,0,0
textudata4:
' magic
DATA Depth ,Overfl ,Turbul ,* ,* ,* ,* ,* ,* ,* ,* ,"* "
DATA 0,1,3,0,0,0,0,0,0,0,0,0
DATA 12,128,9,0,0,0,0,0,0,0,0,0
DATA 5,10,7,0,0,0,0,0,0,0,0,0
DATA &HFF00FF,&HFFFF00,&HFFFF0,64,128,192,0
DATA 100,100,100,0,0,0
textudata5:
' image
DATA Proj ,Y adj ,Genlock ,BumpX ,BumpY ,BumpInt ,X rot ,Y rot ,Z rot ,Frames ,Cycl ,"Sfra "
DATA 0,0,0,1,1,1,-180,-180,-180,0,0,1
DATA 2,255,1,5,5,255,180,180,180,0,1,999
DATA 0,0,0,1,1,255,0,0,0,0,0,1
DATA &HFF00FF,&HFFFF00,&HFFFF0,64,128,192,0
DATA 1,1,1,0,0,0
textudata6:
' tiles
DATA Proj ,Limit ,Blend ,* ,* ,* ,* ,* ,* ,* ,* ,"* "
DATA 0,0,0,0,0,0,0,0,0,0,0,0
DATA 3,255,1,0,0,0,0,0,0,0,0,0
DATA 0,127,0,0,0,0,0,0,0,0,0,0
DATA 0,&HFFFF00,&HFFFF0,64,128,192,0
DATA 20,20,20,0,0,0
textudata7:
' blend
DATA Proj ,Neg ,Compr ,* ,* ,* ,* ,* ,* ,* ,* ,"* "
DATA 0,0,0,0,0,0,0,0,0,0,0,0
DATA 2,1,4,0,10,0,0,0,0,0,0,4
DATA 0,0,0,0,0,0,0,0,0,0,0,0
DATA &HFF00FF,&HFFFF00,&HFFFF0,64,128,192,0
DATA 1,1,1,0,0,0
textudata8:
' stucci
DATA Noise ,Int ,TurbDiv ,* ,* ,* ,* ,* ,* ,* ,* ,"* "
DATA 10,0,1,0,0,0,0,0,0,0,0,0
DATA 10000,1000,800,0,10,0,0,0,0,0,0,0
DATA 2000,200,100,0,0,0,0,0,0,0,0,0
DATA &HFF00FF,&HFFFF00,&HFFFF0,64,128,192,0
DATA 1,1,1,0,0,0
textudata9:
textudata10:
textudata11:
textudata12:
SELECT texture&
CASE 1
RESTORE textudata1
CASE 2
RESTORE textudata2
CASE 3
RESTORE textudata3
CASE 4
RESTORE textudata4
CASE 5
RESTORE textudata5
CASE 6
RESTORE textudata6
CASE 7
RESTORE textudata7
CASE 8
RESTORE textudata8
CASE 9
RESTORE textudata9
CASE 10
RESTORE textudata10
CASE 11
RESTORE textudata11
CASE 12,13,14,15
RESTORE textudata12
ENDSELECT
BMOVE adrtex%(0),wtex%,152
IF texture&=0
FOR g1&=0 TO 11
textu$(g1&)="* "
texmin&(g1&)=0
texmax&(g1&)=0
texdef&(g1&)=0
NEXT g1&
ELSE
FOR g1&=0 TO 11
READ textu$(g1&)
NEXT g1&
FOR g1&=0 TO 11
READ texmin&(g1&)
NEXT g1&
FOR g1&=0 TO 11
READ texmax&(g1&)
NEXT g1&
FOR g1&=0 TO 11
READ texdef&(g1&)
NEXT g1&
READ a%
BMOVE V:a%+1,wtex%+t.c&,3
READ a%
BMOVE V:a%+1,wtex%+t.c&+3,3
READ a%
BMOVE V:a%+1,wtex%+t.c&+6,3
READ g1&
BYTE{wtex%+t.c&+9}=g1&
READ g1&
BYTE{wtex%+t.c&+10}=g1&
READ g1&
BYTE{wtex%+t.c&+11}=g1&
READ g1&
BYTE{wtex%+2}=g1&
FOR g1&=0 TO 5
READ b1&
WORD{wtex%+t.d&+2*g1&}=b1&
NEXT g1&
ENDIF
RETURN
> PROCEDURE init.imwrap(asinhor%,asinver%)
LOCAL g1&
{*asinhor&()}=asinhor%
{*asinver&()}=asinver%
FOR g1&=0 TO picw&/4-1
asinhor&(g1&)=&H7FFF*(SINQ((g1&*90)/(picw&/4)))
NEXT g1&
asinhor&(g1&)=&H7FFF
FOR g1&=0 TO pich&/2-1
asinver&(g1&)=&H7FFF*(SINQ((g1&*90)/(pich&/2)))
NEXT g1&
asinver&(g1&)=&H7FFF
RETURN
> PROCEDURE matmul(hoek&,gx&)
'
SWAP gx&,x&
'
ARRAYFILL tmat(),0
w1=SINQ(hoek&)
v1=COSQ(hoek&)
tmat(x&,x&)=v1
tmat(x&,(x&+1) MOD 3)=w1
tmat((x&+1) MOD 3,x&)=-w1
tmat((x&+1) MOD 3,(x&+1) MOD 3)=v1
tmat((x&+2) MOD 3,(x&+2) MOD 3)=1
RBOX t2mat()=tmat()*mat()
RBOX mat()=t2mat()
'
SWAP gx&,x&
'
RETURN
'
ENDFUNC
RBOX files
> PROCEDURE sluit
BYTE{SCREEN(1)+184+5}=3
IF key.int&
~RemIntServer(3,key.int%)
key.int&=FALSE
ENDIF
IF fra.int&
~RemIntServer(5,fra.int%)
fra.int&=TRUE
ENDIF
'
IF spr%
~FreeSprite(spr%)
CLR spr%
ENDIF
IF iiffbase%<>0
~CloseLibrary(iiffbase%)
CLR iiffbase%
ENDIF
IF handle%
~Close(handle%)
CLR handle%
ENDIF
IF sbhandle%
~Close(sbhandle%)
CLR sbhandle%
ENDIF
WHILE firstblock%
nextblock%={firstblock%}
freeblock(firstblock%)
firstblock%=nextblock%
WEND
clfont(testfont%)
IF SCREEN(5)
CLOSES 5
ENDIF
CLOSES 2
CLOSES 1
CLOSES 12
~SetTaskPri(FindTask(0),10)
EDIT
RETURN
> PROCEDURE fout
IF render&
OPENW #4
ELSE
OPENW #1
ENDIF
FRONTS 1
PRINT
PRINT ERR$(ERR)
WHILE MOUSEK=0
WEND
sluit
RETURN
> PROCEDURE openfile
fout&=0
fil$=file$+CHR$(0)
handle%=Open(V:fil$,1005) !1006 om file
IF handle%=0
fout&=-1
ELSE
~Seek(handle%,0,1)
filelen%=Seek(handle%,0,-1)
memlen%=filelen%
buf%=@allocblock(memlen%,&H10001)
IF buf%=0
okee("Not enough memory")
fout&=1
ELSE
~Read(handle%,buf%,filelen%)
ENDIF
~Close(handle%)
CLR handle%
ENDIF
RETURN
'
> PROCEDURE schrijfscene
IF sdir$=""
sdir$="ram:"
ENDIF
OPENS 1
OPENW #1
hifiselect(0,"SAVE SCENE",sdir$,sfile$)
IF fi$<>""
IF RIGHT$(fi$,6)<>".trace"
fi$=fi$+".trace"
ENDIF
sdir$=di$
sfile$=fi$
a%=-1
IF EXIST(di$+fi$)
okee("   SAVE OVER?")
ENDIF
IF a%
fil$=di$+fi$+CHR$(0)
handle%=Open(V:fil$,1006) !1006 om file
IF handle%=0
fout&=-1
okee("Can't write file")
ELSE
setviewdata(1)
a$="FORM    TRa2TOBL"
~Write(handle%,V:a$,16)
a%=4
~Write(handle%,V:a%,4)
~Write(handle%,V:a%,4) !hoeveelheid baseblokken
schr.view
schr.render
'
a$="PALE"+MKL$(96)
~Write(handle%,V:a$,8)
~Write(handle%,V:col&(0,0),96)
'
schr.stri
a$="WRLD"+MKL$(100)
~Write(handle%,V:a$,8)
~Write(handle%,wrld%,100)
'
b1&=0
base%=firstbase%
WHILE base%
schr.base
base%={base%}
WEND
'
IF totex&
a$="TEXT"+MKL$(totex&*110)
~Write(handle%,V:a$,8)
FOR a&=1 TO totex&
~Write(handle%,adrtex%(a&),110)
NEXT a&
ENDIF
'
base%=firstbase%
WHILE base%
IF WORD{base%+4}=1
vv%={{base%+b.d&}}
IF vv%
IF BYTE{vv%+v.3&+1} AND 1 !flag weggeschreven
BYTE{vv%+v.3&+1}=BYTE{vv%+v.3&+1}-1
ENDIF
ENDIF
ELSE IF WORD{base%+4}=7
vv%={{base%+b.d&}+o.p&}
IF vv%
IF BYTE{vv%+p.f&} AND 1 !flag weggeschreven
BYTE{vv%+p.f&}=BYTE{vv%+p.f&}-1
ENDIF
ENDIF
ENDIF
base%={base%}
WEND
a%=Seek(handle%,4,-1)-12
~Write(handle%,V:a%,4) !filelengte
~Seek(handle%,20,-1)   !aantal blokken
a%=b1&
~Write(handle%,V:a%,4)
~Close(handle%)
CLR handle%
ENDIF
ENDIF
ENDIF
RETURN
> PROCEDURE schr.view
a%=firstview%
a&=0
WHILE a%
ADD a&,1
a%={a%}
WEND
a$="VIEW"+MKL$(100*a&)
~Write(handle%,V:a$,8)
a%=firstview%
WHILE a%
~Write(handle%,a%,100)
a%={a%}
WEND
RETURN
> PROCEDURE schr.render
a$="REND"+MKL$(64)
~Write(handle%,V:a$,8)
s%=-2*dither&
BYTE{V:s%}=size&
' s%=BSET(s%,-4*genlock&)
s%=BSET(s%,-5*b.en.w&)
s%=BSET(s%,-6*newpalette&)
ADD s%,SHL(lace&,7)
' IF lace&
' s%=BSET(s%,7)
' ENDIF
' IF lace&=-2
' s%=BSET(s%,8)
' ENDIF
s%=BSET(s%,-9*ham&)
s%=BSET(s%,-10*schaduw&)
s%=BSET(s%,-11*trace&)
s%=BSET(s%,-12*border&)
s%=BSET(s%,-13*skybuf&)
s%=BSET(s%,-14*ali&)
s%=BSET(s%,-15*script&)
s%=BSET(s%,-16*zpaint&)
s%=BSET(s%,-17*disc&)
s%=BSET(s%,-18*plotbuf&)
s%=BSET(s%,-19*makebuf&)
s%=BSET(s%,-20*osa&)
s%=BSET(s%,-21*diskc&)
s%=BSET(s%,-22*icomp&)
s%=BSET(s%,-23*anim5&)
~Write(handle%,V:s%,4)
'
s%=0  !extra flag
ADD s%,SHL(-bits24&,0)
~Write(handle%,V:s%,4)
'
BYTE{V:bcsrgb+7}=genlock&
~Write(handle%,V:bcsrgb,8)
~Write(handle%,V:sfra&,4)
~Write(handle%,V:cfra&,4)
~Write(handle%,V:efra&,4)
~Write(handle%,V:xminb&,2)
~Write(handle%,V:xmaxb&,2)
~Write(handle%,V:yminb&,2)
~Write(handle%,V:ymaxb&,2)
~Write(handle%,V:lay&,2)
~Write(handle%,V:sview&,2)
~Write(handle%,V:tracetype&,2)
~Write(handle%,V:tradep&,2)
~Write(handle%,V:opar%,4)
~Write(handle%,V:tpar%,4)
~Write(handle%,V:ssx&,2)
~Write(handle%,V:ssy&,2)
s%=0
~Write(handle%,V:s%,4)
~Write(handle%,V:s%,4)
RETURN
> PROCEDURE schr.stri
a$="24B$"+MKL$(LEN(buf24$))
~Write(handle%,V:a$,8)
s%=LEN(buf24$)
~Write(handle%,V:buf24$,s%)
'
a$="SKB$"+MKL$(LEN(skybuf$))
~Write(handle%,V:a$,8)
s%=LEN(skybuf$)
~Write(handle%,V:skybuf$,s%)
'
a$="PIC$"+MKL$(LEN(picsdir$))
~Write(handle%,V:a$,8)
s%=LEN(picsdir$)
~Write(handle%,V:picsdir$,s%)
a$="SCR$"+MKL$(LEN(script$))
~Write(handle%,V:a$,8)
s%=LEN(script$)
~Write(handle%,V:script$,s%)
RETURN
> PROCEDURE schr.base
a$="BASE"+MKL$(256+4)
~Write(handle%,V:a$,8)
~Write(handle%,V:base%,4)
~Write(handle%,base%,256)
ADD b1&,1
ob%={base%+b.d&}
IF ob%
len%={ob%-8}-16
a$="DATA"+MKL$(len%+4)
~Write(handle%,V:a$,8)
~Write(handle%,V:ob%,4)
~Write(handle%,ob%,len%)
ADD b1&,1
IF WORD{base%+4}=1
IF {ob%}
vv%={ob%}
IF BYTE{vv%+v.3&+1} AND 1
ELSE
schr.data(vv%)
BYTE{vv%+v.3&+1}=BYTE{vv%+v.3&+1}+1
ENDIF
ENDIF
ELSE IF WORD{base%+4}=7
IF {ob%+o.p&}
vv%={ob%+o.p&}
IF BYTE{vv%+p.f&} AND 1
ELSE
schr.data(vv%)
schr.data({vv%+p.d&})
BYTE{vv%+p.f&}=BYTE{vv%+p.f&}+1
ENDIF
ENDIF
ELSE IF WORD{base%+4}=-2
schr.data({ob%})
schr.data({ob%+4})
schr.data({ob%+12})
ENDIF
ENDIF
RETURN
> PROCEDURE schr.data(adr%)
IF adr%
len%={adr%-8}-16
a$="DATA"+MKL$(len%+4)
~Write(handle%,V:a$,8)
~Write(handle%,V:adr%,4)
~Write(handle%,adr%,len%)
ADD b1&,1
ENDIF
RETURN
'
> PROCEDURE sculptlezer
fout&=0
IF fi$<>""
geenedges&=1
fil$=di$+fi$+CHR$(0)
handle%=Open(V:fil$,1005) !1006 om file
IF handle%=0
fout&=1
ELSE
~Read(handle%,V:s%,4)
IF s%<>CVL("FORM")
okee("Can't read file")
ELSE
~Read(handle%,V:leng%,4)
~Read(handle%,V:s%,4)
IF s%<>CVL("SC3D")
okee("No Sculpt file")
fout&=1
ELSE
sfile$=fi$
sdir$=di$
FOR c&=0 TO 2
min%(c&)=2^28
max%(c&)=-2^28
NEXT c&
temp%=@allocblock(100,&H10001)
vlak&=0
WHILE Read(handle%,V:s%,4)
~Read(handle%,V:len%,4)
IF s%=CVL("VERT")
tot&=len%/12
t%=@allocblock(tot&*12,&H10001)
t00%=t%
FOR a&=1 TO tot&
~Read(handle%,t00%,12)
b1&=0
FOR c&=0 TO 2
  IF min%(c&)>{t00%+b1&}
    min%(c&)={t00%+b1&}
  ENDIF
  IF max%(c&)<{t00%+b1&}
    max%(c&)={t00%+b1&}
  ENDIF
  ADD b1&,4
NEXT c&
ADD t00%,12
NEXT a&
ELSE IF s%=CVL("FACE")
vlak&=len%/16
vv%=@allocblock(32+12*tot&+16*vlak&,&H10001)
{vv%}=tot&
{vv%+4}=vlak&
WORD{vv%+8}=1
BMOVE t%,vv%+32,12*tot&
freeblock(t%)
colt&=0
adrvl%=vv%+32+12*tot&
ARRAYFILL rt%(),0
rt%(1,0)=-1
c&=1
FOR a&=1 TO vlak&
~Read(handle%,temp%,16)
WORD{adrvl%}={temp%}
WORD{adrvl%+2}={temp%+4}
WORD{adrvl%+4}={temp%+8}
{adrvl%+6}={temp%+12}
IF WORD{adrvl%}=0
  WORD{adrvl%}=WORD{adrvl%+2}
  WORD{adrvl%+2}=0
ENDIF
s%={adrvl%+6}
FOR c&=1 TO colt&
  IF s%=rt%(c&,0)
    c&=colt&+1
  ENDIF
NEXT c&
IF c&=colt&+1
  INC colt&
  rt%(colt&,0)=s%
ENDIF
ADD adrvl%,16
NEXT a&
ELSE
EXIT IF Seek(handle%,len%,0)=-1
ENDIF
WEND
~Close(handle%)
CLR handle%
freeblock(temp%)
temp%=0
IF vlak&
addbase(0)
WORD{base%+4}=1
ADD totobj&,1
BYTE{base%+b.f&}=12
BYTE{base%+b.f&+1}=42
x%=(min%(0)+max%(0))/2
y%=(min%(1)+max%(1))/2
z%=(min%(2)+max%(2))/2
okee("Original location?")
IF a%
{base%+b.v&}=x%
{base%+b.v&+4}=y%
{base%+b.v&+8}=z%
ELSE
{base%+b.v&}=muis%(0)
{base%+b.v&+4}=muis%(1)
{base%+b.v&+8}=muis%(2)
ENDIF
WORD{base%+b.l&}=SHL(1,layact&-1)
WORD{base%+b.sf&}=1
FLOAT{base%+b.q&}=1
FLOAT{base%+b.m&}=1
FLOAT{base%+b.m&+32}=1
FLOAT{base%+b.m&+64}=1
ob%=@allocblock(80+64*colt&,&H10001)
{base%+b.d&}=ob%
{ob%}=vv%
BYTE{ob%+o.c&}=colt&
BYTE{ob%+o.c&+1}=1
{vv%+v.2&}=(max%(0)-min%(0))/2
{vv%+v.2&+4}=(max%(1)-min%(1))/2
{vv%+v.2&+8}=(max%(2)-min%(2))/2
a$=LEFT$(fi$,LEN(fi$)-6)
newname
'
a%=MAX({vv%+v.2&},{vv%+v.2&+4},{vv%+v.2&+8})
fac=32767
fac=fac/a%
SINGLE{vv%+v.4&}=1/fac
adrve%=vv%+32
FOR a&=1 TO tot&
WORD{adrve%}=fac*({adrve%}-x%)
WORD{adrve%+2}=fac*({adrve%+4}-y%)
WORD{adrve%+4}=fac*({adrve%+8}-z%)
ADD adrve%,12
NEXT a&
adrvl%=vv%+32+12*tot&+6
FOR a&=1 TO vlak&
s%={adrvl%}
FOR c&=1 TO colt&
IF rt%(c&,0)=s%
  BYTE{adrvl%+9}=c&-1  !+9 want +6
  c&=colt&
ENDIF
NEXT c&
ADD adrvl%,16
NEXT a&
FOR b&=1 TO colt&
a%=ob%+80+64*(b&-1)
{a%}=rt%(b&,0)
IF BYTE{a%+3}<>0
BYTE{a%+3}=13
ELSE
BYTE{a%+3}=12
ENDIF
{a%+4}=&HC8C83200
{a%+8}=&HF0F0
{a%+12}=&HF0F0F0F0
{a%+16}=&HF0000000
{a%+c.t&+4}=&H9000000
{a%+c.t&+8}=&H9000000
{a%+c.t&+12}=&H9000000
{a%+c.t&+16}=&H9000000
NEXT b&
adrve%=vv%+32
adrvl%=adrve%+12*tot&
edges
normalen
ob%={base%+b.d&}
calcu&=-1
tekenbase
ob%={base%+b.d&}
calcu&=0
ELSE
okee("No faces!")
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
RETURN
> PROCEDURE pdrawlezer
' nog corrigeren : controle of bezier cyclies is
vorm&=0
DIM pp%(500,3)
file$=di$+fi$
IF file$<>""
@openfile
IF fout&=0
IF {buf%}=CVL("PDPF") OR {buf%}=CVL("PDFF")
min%(0)=20202020
min%(1)=20202020
max%(0)=-20202020
max%(1)=-20202020
a%=buf%+8
fileeind%=buf%+filelen%
WHILE a%<fileeind%
a%=@findchunk(a%,fileeind%,CVL("OBJ "))
EXIT IF a%=0
'
IF {a%+8}=CVL("BEZ4")
ADD vorm&,1
'
a%=@findchunk(a%,fileeind%,CVL("DBOX"))
EXIT IF a%=0
pp%(vorm&,0)={a%+8}   !DBOX
pp%(vorm&,1)={a%+12}
'
a%=@findchunk(a%,fileeind%,CVL("FILL"))
EXIT IF a%=0
g&=WORD{a%+8}         !g&=1 is gat
'
a%=@findchunk(a%,fileeind%,CVL("DATA"))
EXIT IF a%=0
'
IF {a%+4}<24
SUB vorm&,1
ELSE
makeclipbez
'
x2%=2^30
y2%=2^30
b3&=0
point%=pp%(vorm&,2)
x1%={point%}
y1%={point%+4}
FOR p&=1 TO pp%(vorm&,3)
x%={point%}
y%={point%+4}
min%(0)=MIN(min%(0),x%)
max%(0)=MAX(max%(0),x%)
min%(1)=MIN(min%(1),y%)
max%(1)=MAX(max%(1),y%)
IF y%<=y2%
  IF (y%=y2% AND x%<x2%) OR y%<y2%
    x2%=x%
    y2%=y%
    b3&=p&  !het bovenste meest linkse punt
  ENDIF
ENDIF
ADD point%,8
NEXT p&
IF x1%=x% AND y1%=y%   !polygoon
SUB pp%(vorm&,3),1
ELSE                   !curve
ENDIF
IF b3&
adr%=pp%(vorm&,2)
controlelinksrechts
ENDIF
'
ENDIF
ELSE
ADD a%,{a%+4}+8
ENDIF
WEND
tot&=0
FOR a&=1 TO vorm&
ADD tot&,pp%(a&,3)
NEXT a&
IF vorm&>0
addbase(0)
WORD{base%+4}=7
ADD totobj&,1
BYTE{base%+b.f&}=12
BYTE{base%+b.f&+1}=42
x1%=(min%(0)+max%(0))/2
y1%=(min%(1)+max%(1))/2
z1%=(min%(2)+max%(2))/2
{base%+b.v&}=muis%(0)
{base%+b.v&+4}=muis%(1)
{base%+b.v&+8}=muis%(2)
WORD{base%+b.l&}=SHL(1,layact&-1)
WORD{base%+b.sf&}=1
FLOAT{base%+b.q&}=1
FLOAT{base%+b.m&}=1
FLOAT{base%+b.m&+32}=1
FLOAT{base%+b.m&+64}=1
ob%=@allocblock(80+3*64,&H10001)
{base%+b.d&}=ob%
' {ob%}=0
BYTE{ob%+o.c&}=3
BYTE{ob%+o.c&+1}=1
a$=fi$
newname
'
vv%=@allocblock(64+6*tot&+2*vorm&,&H10001)
{ob%+o.p&}=vv%
WORD{vv%}=tot&
WORD{vv%+2}=vorm&
WORD{vv%+4}=1
{vv%+6}=(max%(0)-min%(0))/2
{vv%+10}=(max%(1)-min%(1))/2
fac=MAX({vv%+6},{vv%+10})
fac=32760/fac
SINGLE{vv%+18}=1/fac
WORD{vv%+34}=-32767
'
adr%=vv%+64
FOR v&=1 TO vorm&
WORD{adr%}=pp%(v&,3)
ADD adr%,2
IF pp%(v&,3)
IF pp%(v&,2)
a%=pp%(v&,2)
FOR a&=1 TO pp%(v&,3)
  WORD{adr%}=fac*({a%}-x1%)
  WORD{adr%+2}=-fac*({a%+4}-y1%)
  ADD a%,8
  ADD adr%,6
NEXT a&
freeblock(pp%(v&,2))
ENDIF
ENDIF
NEXT v&
a%=ob%+80
{a%}=&HF0F0F000
BYTE{a%+3}=12
{a%+4}=&HC8C83200
{a%+8}=&HF0F0
{a%+12}=&HF0F0F0F0
{a%+16}=&HF0000000
{a%+c.t&+4}=&H9000000
{a%+c.t&+8}=&H9000000
{a%+c.t&+12}=&H9000000
{a%+c.t&+16}=&H9000000
BMOVE a%,a%+64,64
BYTE{a%+64+3}=13
BMOVE a%,a%+128,64
BYTE{a%+128+3}=13
calcu&=-1
tekenbase
calcu&=0
ENDIF
freeblock(buf%)
CLR buf%
ELSE
okee("Unknown file")
ENDIF
ENDIF
ENDIF
ERASE pp%()
RETURN
> PROCEDURE makeclipbez
LOCAL g1%,g2%,g3%,g4%,g5%,g1&,g2&,g3&
'
g1%=a%
ADD a%,8
g2&=WORD{a%}-1
ADD a%,2
g1&=32                         ! max aantal punten
'
g2%=@allocblock(g1&*g2&*2*4,&H10001)
g4%=@allocblock(g1&*2*4,&H10001)
g3%=0
pp%(vorm&,2)=g2%
'
IF (g2%<>0) AND (g4%<>0)
FOR p&=1 TO g2&
g3&=TRUE
'
' IF x2&-x1&=x4&-x3& AND y2&-y1&=y4&-y3&
IF ABS({a%+16}-{a%}-{a%+24}+{a%+32})<=3  ! deze vergelijking controleren
IF ABS({a%+20}-{a%+4}-{a%+28}+{a%+36})<=3
g3&=FALSE             ! rechte lijn handles, begin en eindpunt invoegen
'
{g2%}={a%}+pp%(vorm&,0)
{g2%+4}={a%+4}+pp%(vorm&,1)
ADD g2%,8
ADD g3%,1
'
{g2%}={a%+24}+pp%(vorm&,0)
{g2%+4}={a%+28}+pp%(vorm&,1)
ADD g2%,8
ADD g3%,1
ENDIF
ENDIF
'
IF g3&
{g2%}={a%}+pp%(vorm&,0)                 !altijd handlepunt invoegen
{g2%+4}={a%+4}+pp%(vorm&,1)
ADD g2%,8
ADD g3%,1
'
IF {a%}={a%+16} AND {a%+24}={a%+32}
IF {a%+4}={a%+20} AND {a%+28}={a%+36}
g3&=FALSE             ! geen handles
ENDIF
ENDIF
'
IF g3&
x1={a%}+pp%(vorm&,0)
x2={a%+16}+pp%(vorm&,0)
x3={a%+32}+pp%(vorm&,0)
x4={a%+24}+pp%(vorm&,0)
makeclippoints(g4%)
'
x1={a%+4}+pp%(vorm&,1)
x2={a%+20}+pp%(vorm&,1)
x3={a%+36}+pp%(vorm&,1)
x4={a%+28}+pp%(vorm&,1)
makeclippoints(g4%+4)
'
x1={a%}-2*{a%+16}+{a%+32}
x2=({a%+24}-{a%}+3*({a%+16}-{a%+32}))/g1&
y1={a%+4}-2*{a%+20}+{a%+36}
y2=({a%+28}-{a%+4}+3*({a%+20}-{a%+36}))/g1&
'
buig=0
FOR b&=1 TO g1&-1       ! eerst aantal punten dat moet worden gemaakt berekenen
ADD x1,x2
ADD y1,y2
ADD buig,ABS(x1)+ABS(y1)
NEXT b&
'
max=20000
b&=INT(buig/max)
IF b&
x1={a%}-2*{a%+16}+{a%+32}
y1={a%+4}-2*{a%+20}+{a%+36}
max=buig/(b&+1)+0.01
buig=0
'
g5%=g4%
FOR b&=1 TO g1&-1       ! niet het eerste, niet het laatste punt
ADD x1,x2
ADD y1,y2
'
ADD buig,ABS(x1)+ABS(y1)
IF buig>max
SUB buig,max
{g2%}={g5%}
{g2%+4}={g5%+4}
ADD g2%,8
ADD g3%,1
ENDIF
ADD g5%,8
NEXT b&
ENDIF
ENDIF
ENDIF
ADD a%,24
NEXT p&
pp%(vorm&,3)=g3%
ELSE
pp%(vorm&,3)=0
ENDIF
IF g4%
freeblock(g4%)
ENDIF
a%=g1%
RETURN
> PROCEDURE makeclippoints(g2%)
y1=x1
y2=3*(x2-x1)/g1&
y3=3*(x1-2*x2+x3)/(g1&*g1&)
y4=(x4-x1+3*(x2-x3))/(g1&*g1&*g1&)
'
x1=y1
x2=y2+y3+y4
x3=2*y3+6*y4
x4=6*y4
'
FOR b&=1 TO g1&
{g2%}=x1
ADD g2%,8
ADD x1,x2
ADD x2,x3
ADD x3,x4
NEXT b&
RETURN
> PROCEDURE controlelinksrechts
drielijn&=1
pconst=0
p&=pp%(vorm&,3)
b2&=b3&-1
IF b2&=0
b2&=p&
ENDIF
' PRINT
WHILE pconst=0
b4&=b3&+drielijn&
IF b4&>p&
b4&=1
ENDIF
x1={adr%+8*(b2&-1)}
x2={adr%+8*(b3&-1)}
x%={adr%+8*(b4&-1)}
y1={adr%+8*(b2&-1)+4}
y2={adr%+8*(b3&-1)+4}
y%={adr%+8*(b4&-1)+4}
' PRINT x1%;" ";y1%
' PRINT x2%;" ";y2%
' PRINT x%;" ";y%
pconst=(x2-x1)*y1+(y1-y2)*x1-(x2-x1)*y%-(y1-y2)*x%
ADD drielijn&,1
EXIT IF drielijn&>p&
WEND
IF pconst<0
achtervl&=0
ELSE
achtervl&=1
ENDIF
' PRINT
' PRINT "acht: ";achtervl&,"drielijn: ";drielijn&;" ";pconst
IF (g&=1 AND achtervl&=0) OR (g&<>1 AND achtervl&=1)
adrve1%=adr%
adrve2%=adr%+8*(p&-1)
WHILE adrve1%<adrve2%
x1%={adrve1%}
y1%={adrve1%+4}
{adrve1%}={adrve2%}
{adrve1%+4}={adrve2%+4}
{adrve2%}=x1%
{adrve2%+4}=y1%
ADD adrve1%,8
ADD adrve2%,-8
WEND
ENDIF
RETURN
'
> PROCEDURE leesscene
fout&=0
IF fi$<>""
IF RIGHT$(fi$,6)=".scene"
sculptlezer
ELSE IF RIGHT$(fi$,6)=".trace"
fil$=di$+fi$+CHR$(0)
handle%=Open(V:fil$,1005) !1006 om file
IF handle%=0
fout&=1
ELSE
~Read(handle%,V:s%,4)
IF s%<>CVL("FORM")
okee("Can't read file")
ELSE
~Read(handle%,V:filelen%,4)
~Read(handle%,V:s%,4)
IF s%<>CVL("TRa2")
IF LEFT$(MKL$(s%),2)="TR"
okee("Old Traces file!")
ELSE
okee("No Traces file!")
ENDIF
ELSE
sdir$=di$
sfile$=fi$
main&=1
sluitwin(4)
sluitwin(3)
setbutton(main&,5)
setbutton(maino&,5)
maino&=main&
basact%=0
IF app& AND 128
app1&=128
ELSE
wisalles
app1&=-1
ENDIF
~Read(handle%,V:s%,4) !TOBL
~Read(handle%,V:s%,4)
~Read(handle%,V:s%,4)
b1&=s%  !aantal blokken
ablock%=0
IF b1&
ablock%=@allocblock(8*b1&+16,&H10001)
ELSE
ablock%=@allocblock(16,&H10001)
ENDIF
t00%=ablock%
WHILE Read(handle%,V:s%,4)
~Read(handle%,V:len%,4)
IF s%=CVL("VIEW")
IF (len% MOD 100)=0 AND (app& AND 129)>app1&
  lees.view
ELSE
  EXIT IF Seek(handle%,len%,0)=-1
ENDIF
ELSE IF s%=CVL("BASE")
IF (app& AND 128+28)>app1&
  lees.base
ELSE
  EXIT IF Seek(handle%,len%,0)=-1
ENDIF
ELSE IF s%=CVL("DATA")
IF (app& AND 128+28)>app1&
  lees.data
ELSE
  EXIT IF Seek(handle%,len%,0)=-1
ENDIF
ELSE IF s%=CVL("REND")
IF len%=64 AND (app& AND 128+32)>app1&
  lees.render
ELSE
  EXIT IF Seek(handle%,len%,0)=-1
ENDIF
ELSE IF s%=CVL("PALE")
IF len%=96 AND (app& AND 128+32)>app1&
  ~Read(handle%,V:col&(0,0),96)
  OPENS 2
  FOR y&=1 TO 15
    SETCOLOR y&,col&(y&,0),col&(y&,1),col&(y&,2)
  NEXT y&
  inithamplot2(2)
  OPENS 1
ELSE
  EXIT IF Seek(handle%,len%,0)=-1
ENDIF
ELSE IF s%=CVL("24B$")
IF (app& AND 128+32)>app1&
  buf24$=SPACE$(len%)
  ~Read(handle%,V:buf24$,len%)
ELSE
  EXIT IF Seek(handle%,len%,0)=-1
ENDIF
ELSE IF s%=CVL("SKB$")
IF (app& AND 128+32)>app1&
  skybuf$=SPACE$(len%)
  ~Read(handle%,V:skybuf$,len%)
ELSE
  EXIT IF Seek(handle%,len%,0)=-1
ENDIF
ELSE IF s%=CVL("PIC$")
IF (app& AND 128+32)>app1&
  picsdir$=SPACE$(len%)
  ~Read(handle%,V:picsdir$,len%)
ELSE
  EXIT IF Seek(handle%,len%,0)=-1
ENDIF
ELSE IF s%=CVL("SCR$")
IF (app& AND 128+32)>app1&
  script$=SPACE$(len%)
  ~Read(handle%,V:script$,len%)
ELSE
  EXIT IF Seek(handle%,len%,0)=-1
ENDIF
ELSE IF s%=CVL("WRLD")
IF len%=100 AND (app& AND 130)>app1&
  ~Read(handle%,wrld%,100)
ELSE
  EXIT IF Seek(handle%,len%,0)=-1
ENDIF
ELSE IF s%=CVL("TEXT")
IF app& AND 128
  EXIT IF Seek(handle%,len%,0)=-1
ELSE
  totex&=len%/110
  FOR a&=1 TO totex&
    adrtex%(a&)=@allocblock(152,&H10001)
    ~Read(handle%,adrtex%(a&),110)
  NEXT a&
ENDIF
ELSE
EXIT IF Seek(handle%,len%,0)=-1
ENDIF
EXIT IF fout&
WEND
~Close(handle%)
CLR handle%
IF fout&
okee("FOUT IN FILE")
t00%=ablock%+4
base%=firstbase%
IF base%
IF base%={t00%}
  firstbase%=0
  lastbase%=0
ELSE
  WHILE base%
    EXIT IF {base%}={t00%}
    base%={base%}
  WEND
  lastbase%=base%
  {base%}=0
ENDIF
ENDIF
WHILE {t00%}
freeblock({t00%})
ADD t00%,8
WEND
ELSE  !aan elkaar knopen
base%={ablock%+4}
WHILE base%
soort&=WORD{base%+4}
{base%+b.d&}=@newadr({base%+b.d&})
{base%+b.p&}=@newadr({base%+b.p&})
{base%+b.t&}=@newadr({base%+b.t&})
{base%+b.w&}=@newadr({base%+b.w&})
ob%={base%+b.d&}
IF soort&=1
  {ob%}=@newadr({ob%})
ELSE IF soort&=7
  {ob%+o.p&}=@newadr({ob%+o.p&})
  vv%={ob%+o.p&}
  IF BYTE{vv%+p.f&} AND 1
  ELSE
    {vv%+p.d&}=@newadr({vv%+p.d&})
    BYTE{vv%+p.f&}=BYTE{vv%+p.f&}+1
  ENDIF
ELSE IF soort&=-2
  {ob%}=@newadr({ob%})
  {ob%+4}=@newadr({ob%+4})
  {ob%+12}=@newadr({ob%+12})
  IF {ob%}
    {ob%+8}=0
    {ob%+m.pd&}=0
    {ob%+m.fd&}=0
    rekenpad(14)
  ENDIF
ENDIF
IF (soort& AND 1) OR soort&=2
  IF soort&=1 OR soort&=7
    a%={base%+b.d&}+80+c.t&+20
    colt&=BYTE{{base%+b.d&}+o.c&}
  ELSE IF soort&=2
    a%={base%+b.d&}+l.t&+16
    colt&=1
  ELSE
    a%={base%+b.d&}+32+c.t&+20
    colt&=1
  ENDIF
  FOR a&=1 TO colt&
    IF app& AND 128
      {a%-20}=0
    ENDIF
    FOR b&=0 TO 3
      a1%=a%+4*b&
      IF app& AND 128  !geen tex
        {a1%}=0
      ELSE
        {a1%}=@newadr({a1%})
      ENDIF
    NEXT b&
    ADD a%,64
  NEXT a&
ENDIF
base%={base%}
WEND
opar%=@newadr(opar%)
tpar%=@newadr(tpar%)
a%=wrld%+32
FOR b&=0 TO 7
a1%=a%+4*b&
{a1%}=@newadr({a1%})
IF b&=3
  a%=wrld%+40
ENDIF
NEXT b&
' corrigeer ima
IF app& AND 128
ELSE
b1&=0
FOR a&=1 TO totex&
  IF BYTE{adrtex%(a&)}=5  !imawrap
    a%=wtex%
    BMOVE adrtex%(a&),a%,152
    l&=BYTE{a%+68}
    IF (l&>41)
      okee("error in imastring")
      pfile$=""
    ELSE IF l&=0
      pfile$=""
    ELSE
      pfile$=SPACE$(l&)
      BMOVE a%+70,V:pfile$,l&
    ENDIF
    IF pfile$<>""
      FOR b&=1 TO b1&
        IF textu$(b&)=pfile$
          {wtex%+112}=rt%(b&,0)
          {wtex%+116}=rt%(b&,1)
          adr%=wtex%
          WORD{adr%+124}=&H3FFF
          WORD{adr%+132}=&H3FFF
          WORD{adr%+140}=&H3FFF
          BMOVE wtex%,adrtex%(a&),152
          b&=b1&+1
        ENDIF
      NEXT b&
      IF b1&=0 OR b&=b1&+1
        actex&=a&
        @readwrapfile
        IF fout&=0
          INC b1&
          rt%(b1&,0)={wtex%+112}
          rt%(b1&,1)={wtex%+116}
          textu$(b1&)=pfile$
        ELSE
          okee("error na readwrapfile")
        ENDIF
      ENDIF
    ENDIF
  ENDIF
NEXT a&
ENDIF
ENDIF
IF ablock%
freeblock(ablock%)
ENDIF
IF persp&=-2
bepaalphitheta(1)
ELSE
bepaalphitheta(0)
ENDIF
base%=firstbase%
WHILE base%
IF WORD{base%+4}=7
ob%={base%+b.d&}
vv%={ob%+o.p&}
IF BYTE{vv%+p.f&} AND 1
  BYTE{vv%+p.f&}=BYTE{vv%+p.f&}-1
ENDIF
ENDIF
base%={base%}
WEND
calcphitheta
basact%=firstbase%
fastprojektie
ssizecalc
ENDIF
ENDIF
ENDIF
IF handle%
~Close(handle%)
CLR handle%
ENDIF
ELSE
pdrawlezer
ENDIF
ENDIF
RETURN
> PROCEDURE lees.view
IF {firstview%}
view%={firstview%}
WHILE view%
freeblock(view%)
view%={view%}
WEND
ENDIF
a%=firstview%
~Read(handle%,a%,100)
IF {a%}<>0
tot&=len%/100
FOR a&=2 TO tot&
view%=@allocblock(100,&H10001)
~Read(handle%,view%,100)
{a%}=view%
a%=view%
NEXT a&
ENDIF
RETURN
> PROCEDURE lees.render
~Read(handle%,V:s%,4)
size&=BYTE{V:s%}
dither&=-(s% AND 14)/2
' genlock&=BTST(s%,4)
b.en.w&=BTST(s%,5)
newpalette&=BTST(s%,6)
' lace&=BTST(s%,7)
' IF BTST(s%,8)
' lace&=-2
' ENDIF
lace&=(SHR(s%,7) AND 3)
ham&=BTST(s%,9)
schaduw&=BTST(s%,10)
trace&=BTST(s%,11)
border&=BTST(s%,12)
skybuf&=BTST(s%,13)
ali&=BTST(s%,14)
script&=BTST(s%,15)
zpaint&=BTST(s%,16)
disc&=BTST(s%,17)
plotbuf&=BTST(s%,18)
makebuf&=BTST(s%,19)
osa&=BTST(s%,20)
diskc&=BTST(s%,21)
icomp&=BTST(s%,22)
anim5&=BTST(s%,23)
'
~Read(handle%,V:s%,4)  !extra flag
bits24&=BTST(s%,0)
'
~Read(handle%,V:bcsrgb,8)
genlock&=BYTE{V:bcsrgb+7}
~Read(handle%,V:sfra&,4)
~Read(handle%,V:cfra&,4)
~Read(handle%,V:efra&,4)
~Read(handle%,V:xminb&,2)
~Read(handle%,V:xmaxb&,2)
~Read(handle%,V:yminb&,2)
~Read(handle%,V:ymaxb&,2)
~Read(handle%,V:lay&,2)
~Read(handle%,V:sview&,2)
~Read(handle%,V:tracetype&,2)
~Read(handle%,V:tradep&,2)
~Read(handle%,V:opar%,4)
~Read(handle%,V:tpar%,4)
~Read(handle%,V:ssx&,2)
~Read(handle%,V:ssy&,2)
'
~Read(handle%,V:s%,4)
~Read(handle%,V:s%,4)
leesviewdata(sview&)
RETURN
> PROCEDURE lees.base
~Read(handle%,t00%,4)
b%=@allocblock(256,&H10001)
IF b%=0
okee("Not enough memory")
fout&=1
ELSE
{t00%+4}=b%
ADD t00%,8
~Read(handle%,b%,256)
IF lastbase%
{lastbase%}=b%
lastbase%=b%
{b%}=0
ELSE
firstbase%=b%
lastbase%=b%
{b%}=0
ENDIF
soort&=WORD{b%+4}
IF soort& AND 1
ADD totobj&,1
ELSE IF soort&=2
ADD totlamp&,1
ELSE IF soort&<0
ADD totmove&,1
ENDIF
ENDIF
RETURN
> PROCEDURE lees.data
~Read(handle%,t00%,4)
ob%=@allocblock(len%-4,&H10001)
IF ob%=0
okee("Not enough memory")
fout&=1
ELSE
{t00%+4}=ob%
ADD t00%,8
~Read(handle%,ob%,len%-4)
ENDIF
RETURN
'
ENDFUNC
FUNCTION view
> PROCEDURE bepaalphitheta(mode&)
IF hie& OR render&
IF opar%
{workbase%+b.p&}=opar%
WORD{workbase%+b.sf&}=WORD{opar%+b.sf&}
parentbase(workbase%)
WORD{workbase%+b.sf&}=1
obs%(0)=xt%
obs%(1)=yt%
obs%(2)=zt%
IF persp&=-2 OR render&
mode&=-1
ENDIF
ENDIF
IF tpar%
WORD{workbase%+b.sf&}=WORD{tpar%+b.sf&}
{workbase%+b.p&}=tpar%
parentbase(workbase%)
WORD{workbase%+b.sf&}=1
tar%(0)=xt%
tar%(1)=yt%
tar%(2)=zt%
IF persp&=-2 OR render&
mode&=-1
ENDIF
ENDIF
ENDIF
IF mode&
IF obs%(0)=tar%(0)
ADD obs%(0),2
IF obs%(1)=tar%(1)
ADD obs%(1),1
ENDIF
ENDIF
dia=SQR((obs%(0)-tar%(0))^2+(obs%(1)-tar%(1))^2+(obs%(2)-tar%(2))^2)
teller=obs%(1)-tar%(1)
deler=obs%(0)-tar%(0)
theta=ATN(teller/deler)
phi=@acos((obs%(2)-tar%(2))/dia)
philus:
IF obs%(0)-tar%(0)<>ROUND(dia*SIN(phi)*COS(theta))
theta=theta+0.5*PI
IF obs%(2)-tar%(2)<>ROUND(dia*COS(phi))
phi=PI+phi
ENDIF
GOTO philus
ENDIF
IF obs%(2)-tar%(2)<>ROUND(dia*COS(phi))
phi=PI+phi
GOTO philus
ENDIF
rho%=INT(3*dia)
d%=20*lens&
calcphitheta
ENDIF
RETURN
> PROCEDURE calcphitheta
v1=SIN(theta)
w1=COS(theta)
v2=SIN(phi)
w2=COS(phi)
w1w2=w1*w2
w1v2=w1*v2
v1w2=v1*w2
v1v2=v1*v2
'
RBOX tmat()
x1=SINQ(10)
y1=COSQ(10)
tmat(0,0)=1
tmat(1,1)=x1
tmat(2,1)=y1
tmat(1,2)=-y1
tmat(2,2)=x1
persmat(0,0)=-v1
persmat(0,1)=w1
persmat(0,2)=0
persmat(1,0)=-w1w2
persmat(1,1)=-v1w2
persmat(1,2)=v2
persmat(2,0)=-w1v2
persmat(2,1)=-v1v2
persmat(2,2)=-w2
RBOX persinv()=persmat()
SWAP persinv(0,1),persinv(1,0)
SWAP persinv(2,1),persinv(1,2)
SWAP persinv(0,2),persinv(2,0)
'
v1&=-32767*v1
w1&=32767*w1
w1w2&=-32767*w1w2
v1w2&=-32767*v1w2
v2&=32767*v2
w1v2&=-32767*w1v2
v1v2&=-32767*v1v2
w2&=-32767*w2
initm22d
'
RETURN
> PROCEDURE initm22d
WORD{m2data%}=persp&              ! persp&
WORD{m2data%+2}=view&
'
IF persp&=-2
d&=lens&*20
{m2data%+48}=30*d&
{m2data%+52}=d%
{m2data%+4}=obs%(0)             ! centrum
{m2data%+8}=obs%(1)
{m2data%+12}=obs%(2)
m2cx%=obs%(0)
m2cy%=obs%(1)
m2cz%=obs%(2)
ELSE
d&=dproj*lens&*20
rho%=3*dia/dproj
{m2data%+48}=-0.8*rho%
{m2data%+52}=rho%
{m2data%+4}=xc%
{m2data%+8}=yc%
{m2data%+12}=zc%
m2cx%=xc%
m2cy%=yc%
m2cz%=zc%
ENDIF
'
IF persp&
rhod=1/d&
rhod&=SHR&(WORD{V:rhod},1)
rshift&=1022-WORD{V:rhod+6}
IF rshift&>18
rhod&=SHR&(rhod&,rshift&-18)
rshift&=18
ENDIF
ELSE
x1=d&
rhod=x1/rho%
rhod&=SHR&(WORD{V:rhod},1)
rshift&=1022-WORD{V:rhod+6}
IF rshift&>12
rhod&=SHR&(rhod&,rshift&-12)
rshift&=12
ENDIF
ENDIF
'
WORD{m2data%+16}=rshift&
WORD{m2data%+18}=rhod&
'
IF persp&
WORD{m2data%+30}=v1&
WORD{m2data%+32}=w1&
WORD{m2data%+34}=0
WORD{m2data%+36}=w1w2&
WORD{m2data%+38}=v1w2&
WORD{m2data%+40}=v2&
WORD{m2data%+42}=w1v2&
WORD{m2data%+44}=v1v2&
WORD{m2data%+46}=w2&
ELSE
j1&=SHR(v1&*rhod&,15)
j2&=SHR(w1&*rhod&,15)
j3&=SHR(w1w2&*rhod&,15)
j4&=SHR(v1w2&*rhod&,15)
j5&=SHR(v2&*rhod&,15)
'
WORD{m2data%+2}=view&
WORD{m2data%+20}=j5&
WORD{m2data%+22}=j4&
WORD{m2data%+24}=j3&
WORD{m2data%+26}=j2&
WORD{m2data%+28}=j1&
ENDIF
'
WORD{m2data%+56}=d&
WORD{m2data%+58}=318
WORD{m2data%+60}=254
~C:m2dcomp%()
'
RBOX persmat2()=persmat()
'
IF persp&
persmat2(2,0)=rhod*persmat2(2,0)      ! z=(z+r%)/d& => z=z/d&+r%/d&
persmat2(2,1)=rhod*persmat2(2,1)      ! => z=z*rhod , m2az%=r%*rhod
persmat2(2,2)=rhod*persmat2(2,2)
m2az%=rhod*{m2data%+52}
ELSE
RBOX persmat2(),rhod
m2az%=0
ENDIF
'
WORD{m3data%}=persp&
{m3data%+2}=rhod*({m2data%+48}+{m2data%+52}) ! z=(d2%+r%)/d& =viewplane z
WORD{m3data%+6}=318
WORD{m3data%+8}=254
'
RETURN
> PROCEDURE setviewdata(g1&)
a%=firstview%
a1%=firstview%
WHILE a%
EXIT IF WORD{a%+4}=g1&
a1%=a%
a%={a%}
WEND
IF a%=0
a%=@allocblock(100,&H10001)
IF a1%<>0
{a1%}=a%
ENDIF
WORD{a%+4}=g1&
ENDIF
BMOVE V:obs%(0),a%+6,12
BMOVE V:tar%(0),a%+18,12
WORD{a%+30}=lens&
WORD{a%+32}=view&
WORD{a%+34}=persp&
SINGLE{a%+36}=phi
SINGLE{a%+40}=theta
SINGLE{a%+44}=dproj
{a%+48}=grid%
{a%+52}=xc%
{a%+56}=yc%
{a%+60}=zc%
BMOVE V:muis%(0),a%+64,12
WORD{a%+76}=lay&
RETURN
> PROCEDURE leesviewdata(g1&)
a%=firstview%
WHILE a%
EXIT IF WORD{a%+4}=g1&
a%={a%}
WEND
IF a%=0
okee("No data stored!")
but&=0
ELSE
BMOVE a%+6,V:obs%(0),12
BMOVE a%+18,V:tar%(0),12
dia=SQR((obs%(0)-tar%(0))^2+(obs%(1)-tar%(1))^2+(obs%(2)-tar%(2))^2)
lens&=WORD{a%+30}
view&=WORD{a%+32}
persp&=WORD{a%+34}
phi=SINGLE{a%+36}
theta=SINGLE{a%+40}
dproj=SINGLE{a%+44}
grid%={a%+48}
xc%={a%+52}
yc%={a%+56}
zc%={a%+60}
BMOVE a%+64,V:muis%(0),12
lay&=WORD{a%+76}
FOR a&=0 TO 14
setbutton(a&+7,5)
IF BTST(lay&,a&)
layact&=a&+1
ENDIF
NEXT a&
ENDIF
RETURN
> PROCEDURE proj2
IF WINDOW(11)=0
GRAPHMODE 1
OPENW #1
CLEARW #1
IF hie&
bepaalphitheta(0)
ENDIF
IF persp&=0 AND (view&=31 OR view&=29 OR view&=61)
grid
ENDIF
tekengrond
totvlak&=0
totvert&=0
'
rastp1%=SCREEN(1)+84
BYTE{SCREEN(1)+184+5}=3
WORD{rastp1%+24}=&H404
CLEARW #12
SWAP bitpl3%,bitpl12%
{SCREEN(1)+184+16}=bitpl12%
{SCREEN(12)+184+8}=bitpl3%
CLEARW #12
' rastp2%={WINDOW(1)+50}
rastp2%=SCREEN(12)+84
SETCOLOR 4,0
SETCOLOR 5,0
SETCOLOR 6,0
SETCOLOR 7,0
~RemakeDisplay()
'
ELSE
rastp1%=SCREEN(pic1%)+84             ! win 9/10/11 voor wireanim
ENDIF
'
~SetDrMd(rastp1%,1)
'
base%=firstbase%
WHILE base%
IF WORD{base%+b.l&} AND lay&
a&=0
IF WORD{base%+4}<>1 AND WORD{base%+4}<>7
ELSE IF but&=67
a&=1
ELSE IF but&=68 OR (BYTE{base%+b.f&} AND 1)
a&=1
ELSE
'  ob%={base%+b.d&}
' a&=1-BYTE{ob%+o.dt&}
ENDIF
IF a&=0
tekenbase
ELSE
parentbase(base%)
COLOR 1
ob%={base%+b.d&}
IF ob%
b11&=BYTE{ob%+o.e&}
IF b11&
b10&=BYTE{ob%+o.e&+1}
step&=WORD{ob%+o.e&+2}
l&=WORD{ob%+o.e&+4}
sf&=WORD{base%+b.sf&}
ENDIF
IF WORD{base%+4}=1
vv%={ob%}
fac=SINGLE{vv%+v.4&}
v&={vv%}
adrve%=vv%+32
ELSE
vv%={ob%+o.p&}
fac=SINGLE{vv%+18}
v&=WORD{vv%}
adrve%=vv%+64
vorm&=WORD{vv%+2}
ENDIF
RBOX mat(),fac
a%=c_clp%
IF WORD{base%+4}=7
RBOX tmat()=mat()
initpolyvert
ADD totvert&,b4&*v&
ADD totvlak&,b4&*v&
FOR a&=1 TO vorm&
p&=WORD{adrve%}
ADD adrve%,2
calcpolyvert
a1%=adrven%+12*b4&*(p&-1)
a2%=adrven%
b5&=12*b4&
a%=c_clp%
FOR b&=1 TO p&
b3&=0
FOR c&=1 TO b4&
  ' PAUSE 2
  x1%={a1%+b3&}
  y1%={a1%+b3&+4}
  z1%={a1%+b3&+8}
  x2%={a2%+b3&}
  y2%={a2%+b3&+4}
  z2%={a2%+b3&+8}
  IF C:mto2d%(L:x1%,L:y1%,L:z1%,L:x2%,L:y2%,L:z2%)
    ' COLOR 1
    LINE 320+WORD{a%},256-WORD{a%+2},320+WORD{a%+4},256-WORD{a%+6}
    ' COLOR 2
    ' PLOT 320+WORD{a%},256-WORD{a%+2}
    ' PLOT 320+WORD{a%+4},256-WORD{a%+6}
  ENDIF
  IF c&>1
    IF C:mto2d%(L:x1%,L:y1%,L:z1%,L:{a1%+b3&-12},L:{a1%+b3&-8},L:{a1%+b3&-4})
      ' COLOR 1
      LINE 320+WORD{a%},256-WORD{a%+2},320+WORD{a%+4},256-WORD{a%+6}
      ' COLOR 2
      ' PLOT 320+WORD{a%},256-WORD{a%+2}
      ' PLOT 320+WORD{a%+4},256-WORD{a%+6}
    ENDIF
  ENDIF
  ADD b3&,12
NEXT c&
IF b&=1
  a1%=adrven%
ELSE
  ADD a1%,b5&
ENDIF
ADD a2%,b5&
EXIT IF MOUSEK
NEXT b&
freeblock(adrven%)
NEXT a&
ELSE
ADD totvert&,v&
adrven%=@allocblock(24*v&,&H10001)
a%=adrven%
'
RBOX tmat()=persmat2()*mat()
SUB xt%,m2cx%
SUB yt%,m2cy%
SUB zt%,m2cz%
x1%=persmat2(0,0)*xt%+persmat2(0,1)*yt%+persmat2(0,2)*zt%
y1%=persmat2(1,0)*xt%+persmat2(1,1)*yt%+persmat2(1,2)*zt%
IF persp&
z1%=persmat2(2,0)*xt%+persmat2(2,1)*yt%+persmat2(2,2)*zt%+m2az%
FOR a&=0 TO v&-1
x2=WORD{adrve%}
y2=WORD{adrve%+2}
z2=WORD{adrve%+4}
{a%}=x1%+tmat(0,0)*x2+tmat(0,1)*y2+tmat(0,2)*z2
{a%+4}=y1%+tmat(1,0)*x2+tmat(1,1)*y2+tmat(1,2)*z2
{a%+8}=z1%+tmat(2,0)*x2+tmat(2,1)*y2+tmat(2,2)*z2
ADD a%,24
ADD adrve%,12
NEXT a&
ELSE
FOR a&=0 TO v&-1
x2=WORD{adrve%}
y2=WORD{adrve%+2}
z2=WORD{adrve%+4}
{a%}=x1%+tmat(0,0)*x2+tmat(0,1)*y2+tmat(0,2)*z2
{a%+4}=y1%+tmat(1,0)*x2+tmat(1,1)*y2+tmat(1,2)*z2
ADD a%,24
ADD adrve%,12
NEXT a&
ENDIF
'
v&={vv%+4}
adrvl%=vv%+32+12*{vv%}
ADD totvlak&,v&
col&=0
IF main&=3
IF base%=basact% AND WINDOW(11)=0
col&=-1
OPENW #1
COLOR 2
ENDIF
ENDIF
rastp%=rastp1%
'
FOR a&=0 TO v&-1
g&=-1
IF b11&=1
g&=@build(cfra&,a&)
ENDIF
IF g&
a1&=WORD{adrvl%}
a2&=WORD{adrvl%+2}
a3&=WORD{adrvl%+4}
a1%=adrven%+24*a1&
a2%=adrven%+24*a2&
a3%=adrven%+24*a3&
IF col&
  IF (BYTE{adrvl%+15} AND 31)=colact&-1
    rastp%=rastp2%
  ELSE
    rastp%=rastp1%
  ENDIF
ENDIF
b1&=0
a0%=adrvl%+15
IF BTST(BYTE{a0%},7)=0
  IF C:mto2dq%(L:a1%,L:a2%)
    WORD{rastp%+36}=320+WORD{c_clp2%}
    WORD{rastp%+38}=256-WORD{c_clp2%+2}
    ~Draw(rastp%,320+WORD{c_clp2%+4},256-WORD{c_clp2%+6})
  ENDIF
ENDIF
IF BTST(BYTE{a0%},6)=0
  IF C:mto2dq%(L:a3%,L:a2%)
    WORD{rastp%+36}=320+WORD{c_clp2%}
    WORD{rastp%+38}=256-WORD{c_clp2%+2}
    ~Draw(rastp%,320+WORD{c_clp2%+4},256-WORD{c_clp2%+6})
  ENDIF
ENDIF
IF BTST(BYTE{a0%},5)=0
  IF C:mto2dq%(L:a1%,L:a3%)
    WORD{rastp%+36}=320+WORD{c_clp2%}
    WORD{rastp%+38}=256-WORD{c_clp2%+2}
    ~Draw(rastp%,320+WORD{c_clp2%+4},256-WORD{c_clp2%+6})
  ENDIF
ENDIF
ENDIF
ADD adrvl%,16
EXIT IF MOUSEK
NEXT a&
freeblock(adrven%)
ENDIF
ENDIF
ENDIF
ENDIF
base%={base%}
WEND
IF WINDOW(11)=0
WORD{rastp1%+24}=-1
BYTE{SCREEN(1)+184+5}=2
'
{SCREEN(12)+184+12}=bitpl12%
BYTE{SCREEN(12)+184+5}=2
temp%=SCREEN(12)+184                 ! bitplanes omwisselen
point%={temp%+8}
{temp%+8}={temp%+12}
{temp%+12}=point%
'
point2%=@allocblock(100,&H10001)
IF point2%                           ! gele bitplane uit zwarte wissen
{point2%}={SCREEN(1)+184}
BYTE{point2%+5}=1
{point2%+8}=bitpl3%
~BltBitMapRastPort(point2%,0,0,SCREEN(12)+84,0,0,639,511,&H20)
freeblock(point2%)
ENDIF
'
' samenvoegen
~BltBitMapRastPort(SCREEN(12)+184,0,0,{WINDOW(1)+50},0,0,639,511,&HE0)
~RemakeDisplay()
{temp%+12}={temp%+8}                ! terug wisselen
{temp%+8}=point%
' wissen
~BltBitMapRastPort(SCREEN(12)+184,0,0,{WINDOW(1)+50},0,0,639,511,&H20)
CLEARW #12
BYTE{SCREEN(12)+184+5}=1
'
SETCOLOR 4,BYTE{V:wf5%},BYTE{V:wf5%+1},BYTE{V:wf5%+2}
SETCOLOR 5,BYTE{V:wf5%},BYTE{V:wf5%+1},BYTE{V:wf5%+2}
SETCOLOR 6,BYTE{V:wf5%},BYTE{V:wf5%+1},BYTE{V:wf5%+2}
SETCOLOR 7,BYTE{V:wf5%},BYTE{V:wf5%+1},BYTE{V:wf5%+2}
'
tekendinges(3,tar%())
tekendinges(4,muis%())
IF persp&<>-2
tekendinges(1,obs%())
ELSE IF border&
COLOR 1
BOX xminb&,512-yminb&,xmaxb&,512-ymaxb&
ENDIF
ENDIF
IF main&=5
memcalc
ENDIF
RETURN
> PROCEDURE initpolyvert
tot&=WORD{vv%}
vorm&=WORD{vv%+2}
n&=WORD{vv%+24}
adr45%={vv%+36}
rt%(4,0)=0
IF n&
t00=n&
t00=t00/100
x1%=-t00*WORD{vv%+30}
y1%=-t00*WORD{vv%+32}
z1%=-t00*WORD{vv%+34}
dx1%=tmat(0,0)*x1%+tmat(0,1)*y1%+tmat(0,2)*z1%
dy%=tmat(1,0)*x1%+tmat(1,1)*y1%+tmat(1,2)*z1%
dz%=tmat(2,0)*x1%+tmat(2,1)*y1%+tmat(2,2)*z1%
rt%(4,0)=32767*t00  ! diepte voor bij calczpoly
ENDIF
IF adr45%
t01=WORD{vv%+26}
t01=0.16484*t01
t02=-WORD{vv%+28}
t02=0.16384*t02
ADD rt%(4,0),(32767*WORD{vv%+28})/200  ! diepte voor bij calczpoly
IF n&
z1=WORD{vv%+28}
z1=z1/n&
rt%(2,0)=-(2+z1)*dx1%   !45 omklap vector
rt%(2,1)=-(2+z1)*dy%
rt%(2,2)=-(2+z1)*dz%
z1=-WORD{vv%+26}
z1=z1/n&
rt%(3,0)=-(2+z1)*dx1%   !45 omklap vector
rt%(3,1)=-(2+z1)*dy%
rt%(3,2)=-(2+z1)*dz%
ENDIF
ENDIF
b4&=1
IF n&
ADD b4&,1
IF adr45%
IF WORD{vv%+26}=2*n&
ADD b4&,1
ELSE
ADD b4&,2
ENDIF
ENDIF
ELSE IF adr45%
ADD b4&,1
ENDIF
RETURN
> PROCEDURE calcpolyvert
x1&=WORD{adrve%+6*(p&-1)}
y1&=WORD{adrve%+2+6*(p&-1)}
z1&=WORD{adrve%+4+6*(p&-1)}
x2%=xt%+tmat(0,0)*x1&+tmat(0,1)*y1&+tmat(0,2)*z1&
y2%=yt%+tmat(1,0)*x1&+tmat(1,1)*y1&+tmat(1,2)*z1&
z2%=zt%+tmat(2,0)*x1&+tmat(2,1)*y1&+tmat(2,2)*z1&
adrven%=@allocblock(b4&*p&*12,&H10001)
t%=adrven%
FOR b&=1 TO p&
x1&=WORD{adrve%}
y1&=WORD{adrve%+2}
z1&=WORD{adrve%+4}
IF adr45%
x3&=t01*WORD{adr45%}
y3&=t01*WORD{adr45%+2}
z3&=t01*WORD{adr45%+4}
x2&=t02*WORD{adr45%}
y2&=t02*WORD{adr45%+2}
z2&=t02*WORD{adr45%+4}
ADD adr45%,6
ENDIF
IF n&
IF adr45%
x=x1&+x2&
y=y1&+y2&
z=z1&+z2&
{t%}=dx1%+xt%+tmat(0,0)*x+tmat(0,1)*y+tmat(0,2)*z
{t%+4}=dy%+yt%+tmat(1,0)*x+tmat(1,1)*y+tmat(1,2)*z
{t%+8}=dz%+zt%+tmat(2,0)*x+tmat(2,1)*y+tmat(2,2)*z
ADD t%,12
x=x1&+x3&
y=y1&+y3&
z=z1&+z3&
{t%}=dx1%+xt%+tmat(0,0)*x+tmat(0,1)*y+tmat(0,2)*z
{t%+4}=dy%+yt%+tmat(1,0)*x+tmat(1,1)*y+tmat(1,2)*z
{t%+8}=dz%+zt%+tmat(2,0)*x+tmat(2,1)*y+tmat(2,2)*z
ADD t%,12
IF b4&=4
{t%}={t%-12}+rt%(3,0)
{t%+4}={t%-8}+rt%(3,1)
{t%+8}={t%-4}+rt%(3,2)
ADD t%,12
{t%}={t%-36}+rt%(2,0)
{t%+4}={t%-32}+rt%(2,1)
{t%+8}={t%-28}+rt%(2,2)
ADD t%,12
ELSE IF b4&=3
{t%}={t%-24}+rt%(2,0)
{t%+4}={t%-20}+rt%(2,1)
{t%+8}={t%-16}+rt%(2,2)
ADD t%,12
ENDIF
ELSE
x1%=xt%+tmat(0,0)*x1&+tmat(0,1)*y1&+tmat(0,2)*z1&
y1%=yt%+tmat(1,0)*x1&+tmat(1,1)*y1&+tmat(1,2)*z1&
z1%=zt%+tmat(2,0)*x1&+tmat(2,1)*y1&+tmat(2,2)*z1&
{t%}=x1%+dx1%
{t%+4}=y1%+dy%
{t%+8}=z1%+dz%
ADD t%,12
{t%}=x1%-dx1%
{t%+4}=y1%-dy%
{t%+8}=z1%-dz%
ADD t%,12
ENDIF
ELSE IF adr45%
x=x1&+x2&
y=y1&+y2&
z=z1&+z2&
{t%}=xt%+tmat(0,0)*x+tmat(0,1)*y+tmat(0,2)*z
{t%+4}=yt%+tmat(1,0)*x+tmat(1,1)*y+tmat(1,2)*z
{t%+8}=zt%+tmat(2,0)*x+tmat(2,1)*y+tmat(2,2)*z
ADD t%,12
x=x1&+x3&
y=y1&+y3&
z=z1&+z3&
{t%}=xt%+tmat(0,0)*x+tmat(0,1)*y+tmat(0,2)*z
{t%+4}=yt%+tmat(1,0)*x+tmat(1,1)*y+tmat(1,2)*z
{t%+8}=zt%+tmat(2,0)*x+tmat(2,1)*y+tmat(2,2)*z
ADD t%,12
ELSE
{t%}=xt%+tmat(0,0)*x1&+tmat(0,1)*y1&+tmat(0,2)*z1&
{t%+4}=yt%+tmat(1,0)*x1&+tmat(1,1)*y1&+tmat(1,2)*z1&
{t%+8}=zt%+tmat(2,0)*x1&+tmat(2,1)*y1&+tmat(2,2)*z1&
ADD t%,12
ENDIF
ADD adrve%,6
NEXT b&
RETURN
> PROCEDURE bliksort
lire&=-1
dist%=120120120
v1&=-1
proj2
lire&=0
IF v1&=-1
okee("No sort")
ELSE
ob%={basact%+b.d&}
vv%={ob%}
v&={vv%}
adrve%=vv%+32
vlak&={vv%+4}
adrvl%=vv%+32+12*v&
teller&=1
WORD{vv%+32+12*v1&+6}=1
a&=0
WHILE a&=0
a%=adrvl%
a&=-1
FOR b&=1 TO vlak&
a1%=adrve%+12*WORD{a%}+6
a2%=adrve%+12*WORD{a%+2}+6
a3%=adrve%+12*WORD{a%+4}+6
IF WORD{a1%}=teller& OR WORD{a2%}=teller& OR WORD{a3%}=teller&
IF WORD{a1%}=0
WORD{a1%}=teller&+1
a&=0
ENDIF
IF WORD{a2%}=0
WORD{a2%}=teller&+1
a&=0
ENDIF
IF WORD{a3%}=0
WORD{a3%}=teller&+1
a&=0
ENDIF
ENDIF
ADD a%,16
NEXT b&
ADD teller&,1
WEND
okee("Aantal: "+STR$(teller&))
ENDIF
RETURN
PROCEDURE fastprojektie
GRAPHMODE 1
OPENW #1
CLEARW #1
IF hie&
bepaalphitheta(0)
ENDIF
IF persp&=0 AND (view&=31 OR view&=29 OR view&=61)
grid
ENDIF
tekengrond
' IF FALSE
' waitsignal(1)
' SELECT menu2%
' CASE 29,30,31,45,46,47,61,62,63,&H4A,&H5E,15
'  keypr1&=-1
' DEFAULT
' keypr1&=0
' ENDSELECT
' ELSE
' keypr1&=0
' ENDIF
IF keypr1&=0
COLOR 1
base%=firstbase%
WHILE base%
IF WORD{base%+b.l&} AND lay&
tekenbase
ENDIF
base%={base%}
WEND
tekendinges(3,tar%())
tekendinges(4,muis%())
IF persp&<>-2
tekendinges(1,obs%())
ELSE IF border&
COLOR 1
BOX xminb&,512-yminb&,xmaxb&,512-ymaxb&
ENDIF
ENDIF
RETURN
> PROCEDURE tekengrond
DEFLINE &H2222
COLOR 1
IF persp&=0 AND (view&=31 OR view&=29 OR view&=61)
IF view&=31 OR view&=29
y1&=-(dproj*d%*zc%)/rho%
DEFLINE 1
IF y1&>-256 AND y1&<256
LINE 0,256-y1&,640,256-y1&
ENDIF
ENDIF
ELSE
zd%=dia/3
t%=5*zd%
t01%=-t%
FOR a&=-5 TO 5
x1%=tar%(0)+t01%
y1%=tar%(1)-t%
x2%=x1%
y2%=tar%(1)+t%
moveto2d(x1%,y1%,0,x2%,y2%,0)
x1%=tar%(0)-t%
y1%=tar%(1)+t01%
x2%=tar%(0)+t%
y2%=y1%
moveto2d(x1%,y1%,0,x2%,y2%,0)
ADD t01%,zd%
NEXT a&
' ENDIF
IF persp&=-2
gr(1)=-1000*v2
gr(2)=-1000*w2
IF gr(1)<>0
y=-gr(2)*d&/gr(1)
IF y>-256 AND y<256
y1&=y
LINE 0,256+y1&,640,256+y1&
ENDIF
ENDIF
ENDIF
ENDIF
DEFLINE 1
RETURN
> PROCEDURE grid
COLOR 1
DEFLINE &H2222
a&=0
x&=0
x=dproj*d%/rho%
b1&=INT(grid%*x)
IF b1&>16
xofs&=INT(xc%*x)
yofs&=INT(yc%*x)
zofs&=INT(zc%*x)
IF view&=61
xofs&=320-xofs&
yofs&=256+yofs&
ELSE IF view&=29
xofs&=320-xofs&
yofs&=256+zofs&
ELSE IF view&=31
xofs&=320-yofs&
yofs&=256+zofs&
ENDIF
x&=xofs&
WHILE x&>=0
LINE x&,0,x&,500
SUB x&,b1&
WEND
x&=xofs&+b1&
WHILE x&<640
LINE x&,0,x&,500
ADD x&,b1&
WEND
y&=yofs&
WHILE y&>=0
LINE 0,y&,640,y&
SUB y&,b1&
WEND
y&=yofs&+b1&
WHILE y&<500
LINE 0,y&,640,y&
ADD y&,b1&
WEND
ENDIF
DEFLINE 1
RETURN
> PROCEDURE tekendinges(soort&,VAR t%())
' soort: 1=obs 2=lamp 3=target 4=sprite
' negatief=geselecteerd & grabber
LOCAL b1&,b&
b1&=0
b2&=0
IF soort&<0
soort&=ABS(soort&)
COLOR 1
b2&=-1
ENDIF
IF C:mto2d%(L:t%(0),L:t%(1),L:t%(2),L:t%(0),L:t%(1),L:t%(2))
x1&=320+WORD{c_clp%}
y1&=256-WORD{c_clp%+2}
IF soort&=3
IF b2&
PUT x1&-3,y1&-2,sym$(11),&H60
ELSE
PUT x1&-3,y1&-2,sym$(10)
ENDIF
ELSE IF soort&=2
b1&=2*WORD{{base%+b.d&}+4}+4
IF BYTE{base%+b.f&} AND 1
ADD b1&,1
ENDIF
IF moving&=1
PUT x1&-8,y1&-8,sym$(b1&),&H60
ELSE
PUT x1&-8,y1&-8,sym$(b1&)
ENDIF
ELSE IF soort&=1
IF b2&
PUT x1&-7,y1&-3,sym$(1),&H60
ELSE
PUT x1&-7,y1&-3,sym$(0)
ENDIF
ENDIF
ELSE
x1&=3200
ENDIF
IF soort&=4
xmo&=x1&
ymo&=y1&
IF x1&<>3200
sprof&=0
~MoveSprite(vpspr%,spr.mem%,x1&-14,y1&-12)
ELSE
sprof&=-1
~MoveSprite(vpspr%,spr.mem%,-14,-7)
ENDIF
ELSE
IF moving&=1
COLOR 4
ELSE IF moving&=0
IF soort&=2
COLOR 2
IF BYTE{base%+b.f&} AND 1
COLOR 3
ENDIF
ELSE
COLOR 2
ENDIF
ENDIF
DEFLINE &H2222
moveto2d(t%(0),t%(1),t%(2),t%(0),t%(1),0)
IF soort&=2
ob%={base%+b.d&}
IF WORD{ob%+4}
IF calcu&
{ob%+22}=mat(0,2)*dia/3
{ob%+26}=mat(1,2)*dia/3
{ob%+30}=mat(2,2)*dia/3
ENDIF
x%={ob%+22}
y%={ob%+26}
z%={ob%+30}
moveto2d(t%(0),t%(1),t%(2),t%(0)-x%,t%(1)-y%,t%(2)-z%)
ENDIF
ENDIF
ENDIF
DEFLINE 1
IF moving&=0
' COLOR 1
ENDIF
RETURN
> PROCEDURE persp(gx%,gy%,gz%)
LOCAL g1%,x1%,x2%
'
SWAP g1%,a%
SWAP gx%,x%
SWAP gy%,y%
SWAP gz%,z%
'
IF speed&
x&=x%
y&=y%
ELSE
IF persp&=0 AND (view&=31 OR view&=29 OR view&=61)
x1=d&
x1=x1/rho%
x1%=x%-xc%
x2%=y%-yc%
IF view&=29
x2%=z%-zc%
ELSE IF view&=31
x1%=y%-yc%
x2%=z%-zc%
ENDIF
x&=320+x1*x1%
y&=256-x1*x2%
perspz%=rho%
ELSE
IF persp&=-2
x(0)=x%-obs%(0)
x(1)=y%-obs%(1)
x(2)=z%-obs%(2)
RBOX y()=persmat()*x()
ADD y(2),d&
ELSE
x(0)=x%-xc%
x(1)=y%-yc%
x(2)=z%-zc%
RBOX y()=persmat()*x()
ADD y(2),rho%
IF persp&=0
y(2)=rho%
ENDIF
ENDIF
x&=1000*SGN(y(2))*SGN(y(0))
y&=-1000*SGN(y(1))*SGN(y(2))
IF y(2)>0
a%=INT(d&*(y(0)/y(2)))
IF ABS(a%)<1000
x&=320+a%
a%=INT(d&*(y(1)/y(2)))
IF ABS(a%)<1000
y&=256-a%
ENDIF
ENDIF
ENDIF
perspz%=y(2)
ENDIF
ENDIF
'
SWAP g1%,a%
SWAP gx%,x%
SWAP gy%,y%
SWAP gz%,z%
'
RETURN
> PROCEDURE showviewvolume
COLOR 1
IF persp&<>-2 AND main&<>6
x(0)=obs%(0)-xc%
x(1)=obs%(1)-yc%
x(2)=obs%(2)-zc%
RBOX y()=persmat()*x()
IF persp&
x1%=d&*y(0)/(y(2)+rho%)
y1%=d&*y(1)/(y(2)+rho%)
ELSE
x1%=d&*y(0)/rho%
y1%=d&*y(1)/rho%
ENDIF
IF ABS(x1%)<400
IF ABS(y1%)<400
t01=theta
t11=phi
bepaalphitheta(1)
calcphitheta
z1=dia/100
x(2)=lens&*z1
FOR a&=1 TO 4
IF a&=2 OR a&=3
z1=-z1
ENDIF
x(0)=16*z1
z1=ABS(z1)
IF a&=3 OR a&=4
z1=-z1
ENDIF
x(1)=12.8*z1
z1=ABS(z1)
RBOX y()=persinv()*x()
rt%(a&,0)=y(0)+obs%(0)
rt%(a&,1)=y(1)+obs%(1)
rt%(a&,2)=y(2)+obs%(2)
NEXT a&
theta=t01
phi=t11
calcphitheta
FOR a&=1 TO 4
x(0)=rt%(a&,0)-xc%
x(1)=rt%(a&,1)-yc%
x(2)=rt%(a&,2)-zc%
RBOX y()=persmat()*x()
IF persp&
x2%=d&*y(0)/(y(2)+rho%)
y2%=d&*y(1)/(y(2)+rho%)
ELSE
x2%=d&*y(0)/rho%
y2%=d&*y(1)/rho%
ENDIF
b1&=0
WHILE ABS(x2%)<400 AND ABS(y2%)<400
INC b1&
x2%=2*(x2%-x1%)+x1%
y2%=2*(y2%-y1%)+y1%
EXIT IF b1&=2
WEND
cliplijn(x1%,y1%,x2%,y2%)
NEXT a&
ENDIF
ENDIF
ENDIF
RETURN
> PROCEDURE showspotvolume
COLOR 1
x1=theta
y1=phi
base%=firstbase%
WHILE base%
IF WORD{base%+4}=2
ob%={base%+b.d&}
IF WORD{ob%+4}=1
parentbase(base%)
x1%=-mat(0,2)*dia/2
y1%=-mat(1,2)*dia/2
z1%=-mat(2,2)*dia/2
a%=base%+b.r&
fi=BYTE{ob%+14}
fi=fi/256
fi=@acos(fi)
t00=COS(fi)
t01=COS(-fi)
t10=SIN(fi)
t11=SIN(-fi)
x2%=x1%
y2%=t00*y1%+t10*z1%
z2%=-t10*y1%+t00*z1%
a1%=t00*x2%+t10*y2%
a2%=-t10*x2%+t00*y2%
a3%=z2%
moveto2d({a%},{a%+4},{a%+8},{a%}+a1%,{a%+4}+a2%,{a%+8}+a3%)
a1%=t01*x2%+t11*y2%
a2%=-t11*x2%+t01*y2%
moveto2d({a%},{a%+4},{a%+8},{a%}+a1%,{a%+4}+a2%,{a%+8}+a3%)
' moveto2d({a%},{a%+4},{a%+8},a1%,a2%,a3%)
'
x2%=x1%
y2%=t01*y1%+t11*z1%
z2%=-t11*y1%+t01*z1%
a1%=t01*x2%+t11*y2%
a2%=-t11*x2%+t01*y2%
a3%=z2%
moveto2d({a%},{a%+4},{a%+8},{a%}+a1%,{a%+4}+a2%,{a%+8}+a3%)
'  moveto2d({a%},{a%+4},{a%+8},a1%,a2%,a3%)
a1%=t00*x2%+t10*y2%
a2%=-t10*x2%+t00*y2%
moveto2d({a%},{a%+4},{a%+8},{a%}+a1%,{a%+4}+a2%,{a%+8}+a3%)
'   moveto2d({a%},{a%+4},{a%+8},a1%,a2%,a3%)
'
x2%=t00*x1%+t10*z1%
y2%=y1%
z2%=-t10*x1%+t00*z1%
a1%=t00*x2%+t10*y2%
a2%=-t10*x2%+t00*y2%
a3%=z2%
moveto2d({a%},{a%+4},{a%+8},{a%}+a1%,{a%+4}+a2%,{a%+8}+a3%)
'    moveto2d({a%},{a%+4},{a%+8},a1%,a2%,a3%)
a1%=t01*x2%+t11*y2%
a2%=-t11*x2%+t01*y2%
moveto2d({a%},{a%+4},{a%+8},{a%}+a1%,{a%+4}+a2%,{a%+8}+a3%)
'     moveto2d({a%},{a%+4},{a%+8},a1%,a2%,a3%)
'
x2%=t01*x1%+t11*z1%
y2%=y1%
z2%=-t11*x1%+t01*z1%
a1%=t01*x2%+t11*y2%
a2%=-t11*x2%+t01*y2%
a3%=z2%
moveto2d({a%},{a%+4},{a%+8},{a%}+a1%,{a%+4}+a2%,{a%+8}+a3%)
'      moveto2d({a%},{a%+4},{a%+8},a1%,a2%,a3%)
a1%=t00*x2%+t10*y2%
a2%=-t10*x2%+t00*y2%
moveto2d({a%},{a%+4},{a%+8},{a%}+a1%,{a%+4}+a2%,{a%+8}+a3%)
'       moveto2d({a%},{a%+4},{a%+8},a1%,a2%,a3%)
xt%=0
yt%=0
zt%=0
ENDIF
ENDIF
base%={base%}
WEND
theta=x1
phi=y1
calcphitheta
RETURN
> PROCEDURE moveto2d(x1%,y1%,z1%,x2%,y2%,z2%)
IF C:mto2d%(L:x1%,L:y1%,L:z1%,L:x2%,L:y2%,L:z2%)
x1&=WORD{c_clp%}
y1&=WORD{c_clp%+2}
x2&=WORD{c_clp%+4}
y2&=WORD{c_clp%+6}
LINE 320+x1&,256-y1&,320+x2&,256-y2&
ENDIF
RETURN
> PROCEDURE pointo2d(x1%,y1%,z1%)
LOCAL s&,gx&,gy&
'
SWAP gx&,x&
SWAP gy&,y&
'
IF persp&=-2
r%=d%
d2%=30*d&
SUB x1%,obs%(0)
SUB y1%,obs%(1)
SUB z1%,obs%(2)
ELSE
d2%=-0.8*rho%
r%=rho%
SUB x1%,xc%
SUB y1%,yc%
SUB z1%,zc%
ENDIF
IF persp&=0
IF view&=31 OR view&=29 OR view&=61
IF view&=29
y1%=z1%
ELSE IF view&=31
x1%=y1%
y1%=z1%
ENDIF
shift&=C:ltow1%(L:V:x1%,L:V:y1%,L:V:y1%)
x1&=x1%
y1&=y1%
s&=15-shift&+rshift&
ELSE
shift&=C:ltow1%(L:V:x1%,L:V:y1%,L:V:z1%)
s&=15-shift&+rshift&
c1&=x1%
c2&=y1%
z1&=z1%
x1&=SHR(v1&*c1&+w1&*c2&,15)
y1&=SHR(w1w2&*c1&+v1w2&*c2&+v2&*z1&,15)
ENDIF
IF x1&<0
x1&=320-SHR(-rhod&*x1&,s&)
ELSE
x1&=320+SHR(rhod&*x1&,s&)
ENDIF
IF y1&<0
y1&=256+SHR(-rhod&*y1&,s&)
ELSE
y1&=256-SHR(rhod&*y1&,s&)
ENDIF
IF x1&>0 AND x1&<640 AND y1&>0 AND y1&<500
ELSE
y1&=3200
x1&=3200
ENDIF
z1=rho%
ELSE
shift&=C:ltow%(L:V:x1%,L:V:y1%,L:V:z1%)
x1&=x1%
y1&=y1%
z1&=z1%
x1%=v1&*x1&+w1&*y1&
x1%=C:shr%(L:x1%,15-shift&)
y1%=w1w2&*x1&+v1w2&*y1&+v2&*z1&
y1%=C:shr%(L:y1%,15-shift&)
z1%=w1v2&*x1&+v1v2&*y1&+w2&*z1&
z1%=C:shr%(L:z1%,15-shift&)
'
x1&=3200
y1&=3200
z1=z1%+r%
IF z1%>d2%
'
ADD z1%,r%
a%=z1%/d&
shift&=C:ltow%(L:V:a%,L:V:a%,L:V:a%)
z1&=a%
IF z1&
a0%=x1%/z1&
x1&=320+C:shr%(L:a0%,shift&)
a0%=y1%/z1&
y1&=256-C:shr%(L:a0%,shift&)
'
IF x1&>0 AND x1&<640 AND y1&>0 AND y1&<500
ELSE
y1&=3200
x1&=3200
ENDIF
ENDIF
ENDIF
ENDIF
'
SWAP gx&,x&
SWAP gy&,y&
'
RETURN
'
> PROCEDURE parentbase(g1%)
SWAP base%,g1%
xt%={base%+b.v&}
yt%={base%+b.v&+4}
zt%={base%+b.v&+8}
qb&=BTST(BYTE{base%+b.f&},2)+1
mb&=BTST(BYTE{base%+b.f&},3)+1
IF qb&
q(0,0)=FLOAT{base%+b.q&}
q(0,1)=FLOAT{base%+b.q&+8}
q(0,2)=FLOAT{base%+b.q&+16}
q(0,3)=FLOAT{base%+b.q&+24}
quadtomat(0,imat())
ENDIF
BMOVE base%+b.m&,V:bmat(0,0),72
IF qb& AND mb&
IF BTST(BYTE{base%+b.f&+1},0)
RBOX mat()=bmat()*imat()
ELSE
RBOX mat()=imat()*bmat()
ENDIF
ELSE IF qb&
RBOX mat()=imat()
ELSE
RBOX mat()=bmat()
ENDIF
IF hie&
b%={base%+b.p&}
fo&=0
IF b%
xt%={base%+b.o&}
yt%={base%+b.o&+4}
zt%={base%+b.o&+8}
fo&=-1  ! doet originmatrix
RBOX omat()
omat(0,0)=1
omat(1,1)=1
omat(2,2)=1
WHILE b%
IF WORD{b%+4}=-2
IF BTST(BYTE{b%+b.f&+1},0)
quatmofirst
' matmofirst
ELSE
' matmofirst
quatmofirst
ENDIF
ENDIF
qb&=BTST(BYTE{b%+b.f&},2)+1
mb&=BTST(BYTE{b%+b.f&},3)+1
IF BTST(BYTE{b%+b.f&+1},0)
quatfirst
matfirst
ELSE
matfirst
quatfirst
ENDIF
pa%=@calcpath(b%,base%,cfra&)
IF pa%
IF qb& AND mb&
IF BTST(BYTE{b%+b.f&+1},0)
RBOX cmat()=bmat()*imat()
ELSE
RBOX cmat()=imat()*bmat()
ENDIF
ELSE IF qb&
RBOX cmat()=imat()
ELSE IF mb&
RBOX cmat()=bmat()
ENDIF
IF BTST(BYTE{b%+b.f&+1},7)
qa={pa%}
qb={pa%+4}
qc={pa%+8}
IF qb& OR mb&
qaa=cmat(0,0)*qa+cmat(0,1)*qb+cmat(0,2)*qc
qab=cmat(1,0)*qa+cmat(1,1)*qb+cmat(1,2)*qc
qac=cmat(2,0)*qa+cmat(2,1)*qb+cmat(2,2)*qc
ADD xt%,mat(0,0)*qaa+mat(0,1)*qab+mat(0,2)*qac
ADD yt%,mat(1,0)*qaa+mat(1,1)*qab+mat(1,2)*qac
ADD zt%,mat(2,0)*qaa+mat(2,1)*qab+mat(2,2)*qac
ELSE
ADD xt%,mat(0,0)*qa+mat(0,1)*qb+mat(0,2)*qc
ADD yt%,mat(1,0)*qa+mat(1,1)*qb+mat(1,2)*qc
ADD zt%,mat(2,0)*qa+mat(2,1)*qb+mat(2,2)*qc
ENDIF
ELSE
IF qb& OR mb&
ADD xt%,cmat(0,0)*{pa%}+cmat(0,1)*{pa%+4}+cmat(0,2)*{pa%+8}
ADD yt%,cmat(1,0)*{pa%}+cmat(1,1)*{pa%+4}+cmat(1,2)*{pa%+8}
ADD zt%,cmat(2,0)*{pa%}+cmat(2,1)*{pa%+4}+cmat(2,2)*{pa%+8}
ELSE
ADD xt%,{pa%}
ADD yt%,{pa%+4}
ADD zt%,{pa%+8}
ENDIF
ENDIF
ENDIF
IF {b%+b.p&}
ADD xt%,{b%+b.o&}
ADD yt%,{b%+b.o&+4}
ADD zt%,{b%+b.o&+8}
b%={b%+b.p&}
ELSE
ADD xt%,{b%+b.v&}
ADD yt%,{b%+b.v&+4}
ADD zt%,{b%+b.v&+8}
b%=0
ENDIF
WEND
IF fo&
p%=base%+b.o&
{base%+b.r&+12}=omat(0,0)*{p%}+omat(0,1)*{p%+4}+omat(0,2)*{p%+8}
{base%+b.r&+16}=omat(1,0)*{p%}+omat(1,1)*{p%+4}+omat(1,2)*{p%+8}
{base%+b.r&+20}=omat(2,0)*{p%}+omat(2,1)*{p%+4}+omat(2,2)*{p%+8}
ENDIF
ENDIF
IF {base%+b.t&} !track
calctrack(base%)
ENDIF
ENDIF
SWAP base%,g1%
RETURN
> PROCEDURE quatfirst
IF qb&
q(0,0)=FLOAT{b%+b.q&}
q(0,1)=FLOAT{b%+b.q&+8}
q(0,2)=FLOAT{b%+b.q&+16}
q(0,3)=FLOAT{b%+b.q&+24}
quadtomat(0,imat())
IF BTST(BYTE{b%+b.f&+1},1)
x%=xt%
y%=yt%
z%=zt%
xt%=imat(0,0)*x%+imat(0,1)*y%+imat(0,2)*z%
yt%=imat(1,0)*x%+imat(1,1)*y%+imat(1,2)*z%
zt%=imat(2,0)*x%+imat(2,1)*y%+imat(2,2)*z%
IF fo&
RBOX cmat()=omat()
RBOX omat()=imat()*cmat()
ENDIF
ENDIF
b1&=0
IF BTST(BYTE{b%+b.f&+1},2)
b1&=1
ELSE IF BTST(BYTE{b%+b.f&+1},3)
b1&=2
ENDIF
IF b1&
IF b1&=1
RBOX cmat()=mat()*imat()
ELSE
RBOX cmat()=imat()*mat()
ENDIF
RBOX mat()=cmat()
ENDIF
ENDIF
RETURN
> PROCEDURE matfirst
BMOVE b%+b.m&,V:bmat(0,0),72
IF mb&
IF BTST(BYTE{b%+b.f&+1},4)
x%=xt%
y%=yt%
z%=zt%
xt%=bmat(0,0)*x%+bmat(0,1)*y%+bmat(0,2)*z%
yt%=bmat(1,0)*x%+bmat(1,1)*y%+bmat(1,2)*z%
zt%=bmat(2,0)*x%+bmat(2,1)*y%+bmat(2,2)*z%
IF fo&
RBOX cmat()=omat()
RBOX omat()=bmat()*cmat()
ENDIF
ENDIF
b1&=0
IF BTST(BYTE{b%+b.f&+1},5)
b1&=1
ELSE IF BTST(BYTE{b%+b.f&+1},6)
b1&=2
ENDIF
IF b1&
IF b1&=1
RBOX cmat()=mat()*bmat()
ELSE
RBOX cmat()=bmat()*mat()
ENDIF
RBOX mat()=cmat()
ENDIF
ENDIF
RETURN
> PROCEDURE quatmofirst
ob%={b%+b.d&}
b1&=0
IF WORD{ob%+m.qf&}
calcfillquat
b1&=-1
ELSE IF WORD{ob%+m.qfo&}
followpath
b1&=-1
ENDIF
IF b1&
quadtomat(0,tmat())
IF BTST(BYTE{b%+b.f&+1},1)
x%=xt%
y%=yt%
z%=zt%
xt%=tmat(0,0)*x%+tmat(0,1)*y%+tmat(0,2)*z%
yt%=tmat(1,0)*x%+tmat(1,1)*y%+tmat(1,2)*z%
zt%=tmat(2,0)*x%+tmat(2,1)*y%+tmat(2,2)*z%
IF fo&
RBOX cmat()=omat()
RBOX omat()=tmat()*cmat()
ENDIF
ENDIF
b1&=0
IF BTST(BYTE{b%+b.f&+1},2)
b1&=1
ELSE IF BTST(BYTE{b%+b.f&+1},3)
b1&=2
ENDIF
IF b1&
IF b1&=1
RBOX cmat()=mat()*tmat()
ELSE
RBOX cmat()=tmat()*mat()
ENDIF
RBOX mat()=cmat()
ENDIF
ENDIF
RETURN
> PROCEDURE matmofirst
BMOVE b%+b.m&,V:tmat(0,0),72
IF BTST(BYTE{b%+b.f&+1},4)
x%=xt%
y%=yt%
z%=zt%
xt%=tmat(0,0)*x%+tmat(0,1)*y%+tmat(0,2)*z%
yt%=tmat(1,0)*x%+tmat(1,1)*y%+tmat(1,2)*z%
zt%=tmat(2,0)*x%+tmat(2,1)*y%+tmat(2,2)*z%
IF fo&
RBOX cmat()=omat()
RBOX omat()=tmat()*cmat()
ENDIF
ENDIF
b1&=0
IF BTST(BYTE{b%+b.f&+1},5)
b1&=1
ELSE IF BTST(BYTE{b%+b.f&+1},6)
b1&=2
ENDIF
IF b1&
IF b1&=1
RBOX cmat()=mat()*tmat()
ELSE
RBOX cmat()=tmat()*mat()
ENDIF
RBOX mat()=cmat()
ENDIF
RETURN
> PROCEDURE calcfillquat
b1&=WORD{ob%+m.qf&}
b2&=WORD{ob%+m.qf&+2}
b3&=WORD{ob%+m.qf&+4}
'
fr&=WORD{ob%+m.f&}
s&=WORD{base%+b.sf&}
t00=0
WHILE s&>cfra&
IF BTST(BYTE{ob%+m.f&+2},0)=0
s&=cfra&
ELSE
s&=-fr&+s&
ENDIF
WEND
IF BTST(BYTE{ob%+m.f&+2},0)=0
IF cfra&>s&+fr&
s&=cfra&-fr&
ENDIF
c&=cfra&-s&
ELSE
c&=((cfra&-s&) MOD fr&)
ENDIF
'
IF c&>0
b1=@ease(c&,fr&,b2&,b3&)
'
b1=PI*b1*b1&/360
co=COS(b1)
si=SIN(b1)/32767
q(0,0)=co
q(0,1)=si*WORD{ob%+m.qf&+8}
q(0,2)=si*WORD{ob%+m.qf&+10}
q(0,3)=si*WORD{ob%+m.qf&+12}
ELSE
q(0,0)=1
q(0,1)=0
q(0,2)=0
q(0,3)=0
ENDIF
RETURN
> PROCEDURE calcfillquato
b1&=WORD{ob%+m.qf&}
b2&=WORD{ob%+m.qf&+2}
b3&=WORD{ob%+m.qf&+4}
'
fr&=WORD{ob%+m.f&}
s&=WORD{base%+b.sf&}
WHILE s&>fr&
IF BTST(BYTE{ob%+m.f&+2},0)=0
s&=fr&
ELSE
s&=-fr&+s&
ENDIF
WEND
IF BTST(BYTE{ob%+m.f&+2},0)=0
IF cfra&>=s&+fr&
s&=cfra&-fr&+1
ENDIF
ENDIF
c&=((cfra&-s&) MOD fr&)
'
b1=@ease(c&,fr&,b2&,b3&)
'
b1=0.5*b1*b1&
co=COSQ(b1)
si=SINQ(b1)/32767
q(0,0)=co
q(0,1)=si*WORD{ob%+m.qf&+8}
q(0,2)=si*WORD{ob%+m.qf&+10}
q(0,3)=si*WORD{ob%+m.qf&+12}
RETURN
> PROCEDURE followpath
'
t1%=@calcpath(b%,base%,cfra&)
t2%=@calcpath(b%,base%,cfra&+1)
IF t1%
IF t1%=t2%
IF t1%={ob%+8}
ADD t2%,12
ELSE
ADD t1%,-12
ENDIF
ENDIF
x2%={t2%}-{t1%}
y2%={4+t2%}-{4+t1%}
z2%={8+t2%}-{8+t1%}
l=SQR(x2%^2+y2%^2+z2%^2)
IF l<>0
len=SQR(x2%^2+y2%^2)
IF len<>0
x2=x2%/len
y2=y2%/len
b1=ACOS(ROUND(y2,7))
IF x2>0
b1=2*PI-b1
ENDIF
ADD b1,PI
co=COS(b1/2)
si=SIN(b1/2)
ELSE
co=1
si=0
b1=0
ENDIF
q(0,0)=co
q(0,1)=0
q(0,2)=0
q(0,3)=si
x2=x2%/l
y2=y2%/l
z2=z2%/l
x1=-SIN(b1)
y1=COS(b1)
z1=0
xn=z2*y1-z1*y2
yn=x2*z1-x1*z2
zn=y2*x1-y1*x2
len=SQR(xn^2+yn^2+zn^2)
IF len<>0
xn=-xn/len
yn=-yn/len
zn=-zn/len
b1=ACOS(ROUND(x2*x1+y2*y1+z2*z1,7))
SUB b1,PI
b1=-b1
co=COS(b1/2)
si=SIN(b1/2)
ENDIF
q(4,0)=co
q(4,1)=si*xn
q(4,2)=si*yn
q(4,3)=si*zn
quadmul(4,0,0)
ELSE
q(0,0)=1
q(0,1)=0
q(0,2)=0
q(0,3)=0
ENDIF
ENDIF
RETURN
> PROCEDURE calctrack(g1%)
SWAP b1%,g1%
x1=mat(2,0)
y1=mat(2,1)
z1=mat(2,2)
b%={b1%+b.t&}+b.r&
x2%={b%}-xt%
y2%={b%+4}-yt%
z2%={b%+8}-zt%
l=SQR(x1^2+y1^2+z1^2)
IF l<>0
x1=x1/l
y1=y1/l
z1=z1/l
l=SQR(x2%^2+y2%^2+z2%^2)
IF l<>0
x2=x2%/l
y2=y2%/l
z2=z2%/l
xn=z2*y1-z1*y2
yn=x2*z1-x1*z2
zn=y2*x1-y1*x2
len=SQR(xn^2+yn^2+zn^2)
xn=-xn/len
yn=-yn/len
zn=-zn/len
b1=ACOS(ROUND(x2*x1+y2*y1+z2*z1,7))
SUB b1,PI
b1=-b1
co=COS(b1/2)
si=SIN(b1/2)
q(0,0)=co
q(0,1)=si*xn
q(0,2)=si*yn
q(0,3)=si*zn
quadtomat(0,imat())
RBOX cmat()=imat()*mat()
RBOX mat()=cmat()
ENDIF
ENDIF
SWAP b1%,g1%
RETURN
> PROCEDURE tekenbase
IF calcu& OR WORD{base%+4}=-2  !move mat voor spline
parentbase(base%)
{base%+b.r&}=xt%      !rotatieco
{base%+b.r&+4}=yt%
{base%+b.r&+8}=zt%
ELSE
xt%={base%+b.r&}
yt%={base%+b.r&+4}
zt%={base%+b.r&+8}
ENDIF
q&=0
IF moving&=0
COLOR 1
col&=1
IF BYTE{base%+b.f&} AND 1
COLOR 3
col&=3
ENDIF
ELSE IF moving&=1
COLOR 4
col&=4
ENDIF
IF WORD{base%+4}=1 OR WORD{base%+4}=7  !object/polybase
IF calcu&
IF WORD{base%+4}=1
vv%={{base%+b.d&}}
x%={vv%+v.2&}
y%={vv%+v.2&+4}
z%={vv%+v.2&+8}
ELSE
vv%={{base%+b.d&}+o.p&}
x%={vv%+6}
y%={vv%+10}
z%={vv%+14}
ENDIF
{kub%}=x%*mat(0,0)
{kub%+4}=y%*mat(0,1)
{kub%+8}=z%*mat(0,2)
{kub%+12}=x%*mat(1,0)
{kub%+16}=y%*mat(1,1)
{kub%+20}=z%*mat(1,2)
{kub%+24}=x%*mat(2,0)
{kub%+28}=y%*mat(2,1)
{kub%+32}=z%*mat(2,2)
adr%={base%+b.d&}+o.f&
BMOVE kub%,adr%,36
ELSE
adr%={base%+b.d&}+o.f&
BMOVE adr%,kub%,36
ENDIF
' b1&=BYTE{{base%+b.d&}+o.c&+1}  !fastdraw type
' IF b1& AND 1
tekenkub
' ENDIF
ELSE IF WORD{base%+4}=2  !lamp
sn%(0)=xt%
sn%(1)=yt%
sn%(2)=zt%
tekendinges(2,sn%())
ELSE IF WORD{base%+4}=3  !perf sphere
adr%={base%+b.d&}
IF calcu&
r%={adr%+4}
r%=r%*SQR(mat(0,0)^2+mat(1,0)^2+mat(2,0)^2)
{adr%+8}=r%
ELSE
r%={adr%+8}
ENDIF
tekensphere
ELSE IF WORD{base%+4}=-2  !Move base
ob%={base%+b.d&}
IF ob%
vv%={ob%}
IF vv%  !bezierpad
np&=WORD{vv%}  !wordt ook voor editspline gebruikt
cyclic&=BTST(BYTE{vv%+2},0)
s%=spline%+72
a1%=vv%+4+36*(np&-2)-12
mb&=-1
IF @eenh.mat(V:mat(0,0))
mb&=0
ENDIF
b1&=3
FOR a%=vv%+4 TO a1% STEP 12
IF mb&
{s%}=mat(0,0)*{a%}+mat(0,1)*{a%+4}+mat(0,2)*{a%+8}
{s%+4}=mat(1,0)*{a%}+mat(1,1)*{a%+4}+mat(1,2)*{a%+8}
{s%+8}=mat(2,0)*{a%}+mat(2,1)*{a%+4}+mat(2,2)*{a%+8}
ELSE
{s%}={a%}
{s%+4}={a%+4}
{s%+8}={a%+8}
ENDIF
IF b1&=3
b1&=0
{s%}={s%}+xt%
{s%+4}={s%+4}+yt%
{s%+8}={s%+8}+zt%
ENDIF
ADD b1&,1
ADD s%,12
NEXT a%
cyclic
IF cyclic&
tekenstuk(2,np&-1,col&)
ELSE
tekenstuk(2,np&-2,col&)
ENDIF
IF base%=ebase%
drawdp(2,3)
ENDIF
q&=0
ELSE
q&=-1
IF moving&=-1
IF C:mto2d%(L:xt%,L:yt%,L:zt%,L:xt%,L:yt%,L:zt%)
x1&=320+WORD{c_clp%}-4
y1&=256-WORD{c_clp%+2}-4
PUT x1&,y1&,sym$(16)
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
IF hie&
IF {base%+b.p&}  !orlines
IF lay& AND WORD{{base%+b.p&}+b.l&}
DEFLINE &HF0F0
IF WORD{{base%+b.p&}+4}=-2
ob%={{base%+b.p&}+b.d&}
IF {ob%}  !ouder is bezierpad
b%=base%+b.r&
moveto2d({b%}-{b%+12},{b%+4}-{b%+16},{b%+8}-{b%+20},{b%},{b%+4},{b%+8})
ELSE
b%={base%+b.p&}+b.r&
moveto2d({b%},{b%+4},{b%+8},{base%+b.r&},{base%+b.r&+4},{base%+b.r&+8})
ENDIF
ELSE
b%={base%+b.p&}+b.r&
moveto2d({b%},{b%+4},{b%+8},{base%+b.r&},{base%+b.r&+4},{base%+b.r&+8})
ENDIF
ENDIF
ENDIF
IF {base%+b.t&}  !tracklines
IF lay& AND WORD{{base%+b.t&}+b.l&}
DEFLINE &H3000
b%={base%+b.t&}+b.r&
moveto2d({b%},{b%+4},{b%+8},{base%+b.r&},{base%+b.r&+4},{base%+b.r&+8})
ENDIF
ENDIF
DEFLINE 1
ENDIF
'  symbooltjes
IF moving&<>-1
IF C:mto2d%(L:xt%,L:yt%,L:zt%,L:xt%,L:yt%,L:zt%)
x1&=320+WORD{c_clp%}
y1&=256-WORD{c_clp%+2}
IF WORD{base%+4}<>2
IF BYTE{base%+b.f&} AND 1
b1&=3
ELSE
b1&=2
ENDIF
IF q&
ADD b1&,13
SUB x1&,2
SUB y1&,2
ENDIF
IF moving&
COLOR 0
IF q&
PUT x1&-2,y1&-2,sym$(b1&),&H60
ENDIF
PBOX x1&-2,y1&-2,x1&+2,y1&+2
ELSE
PUT x1&-2,y1&-2,sym$(b1&)
ENDIF
ENDIF
ELSE
x1&=3200
ENDIF
WORD{base%+b.s&}=x1&
WORD{base%+b.s&+2}=y1&
ENDIF
RETURN
> PROCEDURE tekenkub
FOR c&=0 TO 3
x%=xt%
y%=yt%
z%=zt%
SELECT c&
CASE 1,2
ADD x%,{kub%}
ADD y%,{kub%+12}
ADD z%,{kub%+24}
DEFAULT
SUB x%,{kub%}
SUB y%,{kub%+12}
SUB z%,{kub%+24}
ENDSELECT
SELECT c&
CASE 0,1
ADD x%,{kub%+4}
ADD y%,{kub%+16}
ADD z%,{kub%+28}
DEFAULT
SUB x%,{kub%+4}
SUB y%,{kub%+16}
SUB z%,{kub%+28}
ENDSELECT
x1%=x%-{kub%+8}
y1%=y%-{kub%+20}
z1%=z%-{kub%+32}
x2%=x%+{kub%+8}
y2%=y%+{kub%+20}
z2%=z%+{kub%+32}
moveto2d(x1%,y1%,z1%,x2%,y2%,z2%)
IF c&
moveto2d(x1%,y1%,z1%,x3%,y3%,z3%)
moveto2d(x2%,y2%,z2%,x4%,y4%,z4%)
ELSE
x3%=2*{kub%+4}
y3%=2*{kub%+16}
z3%=2*{kub%+28}
moveto2d(x1%,y1%,z1%,x1%-x3%,y1%-y3%,z1%-z3%)
moveto2d(x2%,y2%,z2%,x2%-x3%,y2%-y3%,z2%-z3%)
ENDIF
x3%=x1%
y3%=y1%
z3%=z1%
x4%=x2%
y4%=y2%
z4%=z2%
NEXT c&
RETURN
> PROCEDURE tekenpira
xg%=xt%+{kub%+8}
yg%=yt%+{kub%+20}
zg%=zt%+{kub%+32}
FOR c&=0 TO 3
x%=xt%
y%=yt%
z%=zt%
SELECT c&
CASE 1,2
ADD x%,{kub%}
ADD y%,{kub%+12}
ADD z%,{kub%+24}
DEFAULT
SUB x%,{kub%}
SUB y%,{kub%+12}
SUB z%,{kub%+24}
ENDSELECT
SELECT c&
CASE 0,1
ADD x%,{kub%+4}
ADD y%,{kub%+16}
ADD z%,{kub%+28}
DEFAULT
SUB x%,{kub%+4}
SUB y%,{kub%+16}
SUB z%,{kub%+28}
ENDSELECT
x1%=x%-{kub%+8}
y1%=y%-{kub%+20}
z1%=z%-{kub%+32}
moveto2d(x1%,y1%,z1%,xg%,yg%,zg%)
IF c&
moveto2d(x1%,y1%,z1%,x3%,y3%,z3%)
ELSE
x3%=2*{kub%+4}
y3%=2*{kub%+16}
z3%=2*{kub%+28}
moveto2d(x1%,y1%,z1%,x1%-x3%,y1%-y3%,z1%-z3%)
ENDIF
x3%=x1%
y3%=y1%
z3%=z1%
NEXT c&
RETURN
> PROCEDURE tekensphere
FOR a&=0 TO 360 STEP 20
x%=r%*COSQ(a&)
y%=-r%*SINQ(a&)
x1%=xt%+persinv(0,0)*x%+persinv(0,1)*y%
y1%=yt%+persinv(1,0)*x%+persinv(1,1)*y%
z1%=zt%+persinv(2,0)*x%+persinv(2,1)*y%
IF a&
moveto2d(x2%,y2%,z2%,x1%,y1%,z1%)
ENDIF
x2%=x1%
y2%=y1%
z2%=z1%
NEXT a&
RETURN
'
> PROCEDURE roteerscene
LOCAL vd&,pd&
imafac=2*17000
tranmir&=0
initfase("Rotate",0,0)
dx=d&/xps
dy=d&/yps
FOR a&=1 TO totex&
a%=adrtex%(a&)
IF BYTE{a%}=5
ADD a%,t.o&
IF WORD{a%+18}
c&=WORD{a%+18}
c1&=WORD{a%+20}
s&=WORD{a%+22}
WHILE s&>cfra&
IF c1&=0
s&=cfra&
ELSE
SUB s&,c&
ENDIF
WEND
IF c1&=0
IF cfra&>=s&+c&
s&=cfra&-c&+1
ENDIF
ENDIF
s&=1+((cfra&-s&) MOD c&)
a%=wtex%
BMOVE adrtex%(a&),a%,152
l&=BYTE{a%+68}
pfile$=SPACE$(l&)
BMOVE a%+70,V:pfile$,l&
sel.wrap.file
pfile$=idir$+RIGHT$("000"+STR$(s&),4)
actex&=a&
@readwrapfile
IF fout&
okee("Can't find: "+pfile$)
ENDIF
ENDIF
ENDIF
NEXT a&
'   imat voor gloco
gshift&=WORD{wrld%+72}
a%=workbase%+b.i&
{a%-12}=obs%(0)
{a%-8}=obs%(1)
{a%-4}=obs%(2)
BYTE{a%}=0
BYTE{a%+1}=32+gshift&
BYTE{a%+2}=32+gshift&
BYTE{a%+3}=32+gshift&
ADD a%,4
FOR b1&=0 TO 2
FOR b2&=0 TO 2
WORD{a%}=INT(32767*persinv(b1&,b2&)+0.5)
ADD a%,2
NEXT b2&
NEXT b1&
'
CLR totlampren&,spheren&,polyren&,halob&,totveha&,adrha%,pd&,vd&
adrha%=0
base%=firstbase%
WHILE base%
IF WORD{base%+b.l&} AND lay&
ob%={base%+b.d&}
IF WORD{base%+4}=3
IF WORD{ob%+32+18} !halob
ELSE
ADD spheren&,1
ENDIF
ELSE IF WORD{base%+4}=7
ADD polyren&,1
vv%={ob%+o.p&}
IF WORD{vv%+24}
ADD polyren&,1
ENDIF
ENDIF
IF {base%+b.t&}
parentbase({base%+b.t&})
{{base%+b.t&}+b.r&}=xt%
{{base%+b.t&}+b.r&+4}=yt%
{{base%+b.t&}+b.r&+8}=zt%
ENDIF
ENDIF
base%={base%}
WEND
IF spheren&
adrzsphere%=@allocblock(46*spheren&,&H10001)
adrzs%=adrzsphere%
ENDIF
IF polyren&
ERASE poly%()
DIM poly%(polyren&)
ENDIF
polyren&=0
base%=firstbase%
WHILE base%
IF (WORD{base%+b.l&} AND lay&) OR (BYTE{base%+b.i&}<>0)
IF WORD{base%+4}>0 OR BYTE{base%+b.i&}
parentbase(base%)
{base%+b.r&}=xt%
{base%+b.r&+4}=yt%
{base%+b.r&+8}=zt%
RBOX tmat()=persmat()*mat()
RBOX cmat()=tmat()  !imat
x%=xt%-obs%(0)
y%=yt%-obs%(1)
z%=zt%-obs%(2)
xt%=x%*persmat(0,0)+persmat(0,1)*y%+persmat(0,2)*z%
yt%=x%*persmat(1,0)+persmat(1,1)*y%+persmat(1,2)*z%
zt%=x%*persmat(2,0)+persmat(2,1)*y%+persmat(2,2)*z%
IF WORD{base%+b.l&} AND lay&
IF WORD{base%+4}=7      !poly
initobject
calczpoly
ELSE IF WORD{base%+4}=3 !sphere
initobject
calczsphere
ELSE IF WORD{base%+4}=2 !lamp
ADD totlampren&,1
la%(totlampren&)=@allocblock(100,&H10001)
initlamp
ELSE IF WORD{base%+4}=1 !object
initobject
b1&=0
t00=SQR(cmat(0,0)^2+cmat(1,0)^2+cmat(2,0)^2)
t01=SQR(cmat(0,1)^2+cmat(1,1)^2+cmat(2,1)^2)
t02=SQR(cmat(0,2)^2+cmat(1,2)^2+cmat(2,2)^2)
t00=MAX(t00,t01,t02)
n&=-1
IF t00==t01
IF t01==t02
n&=0
ENDIF
ENDIF
t00=32767/t00
FOR b&=0 TO 2
FOR c&=0 TO 2
ps&(b1&)=INT(t00*cmat(c&,b&))!hier getransponeerd
INC b1&
NEXT c&
NEXT b&
vv%={{base%+b.d&}}
fac=SINGLE{vv%+v.4&}
RBOX tmat(),fac
RBOX cmat(),1/fac
totve&={vv%}
adrve%=vv%+32
eff&=BYTE{ob%+o.e&}
IF eff&
b10&=BYTE{ob%+o.e&+1}
step&=WORD{ob%+o.e&+2}
l&=WORD{ob%+o.e&+4}
sf&=WORD{base%+b.sf&}
ENDIF
IF halob&
IF adrha%
t%=adrha%
adrha%=@allocblock(6*(totveha&+totve&),&H10001)
BMOVE t%,adrha%,6*totveha&
adrve1%=adrha%+6*totveha&
freeblock(t%)
ELSE
adrha%=@allocblock(6*totve&,&H10001)
adrve1%=adrha%
ENDIF
ADD totveha&,totve&
ENDIF
t10=0
t11=0
t12=0
FOR p&=0 TO totve&-1
x1&=WORD{adrve%}
y1&=WORD{adrve%+2}
z1&=WORD{adrve%+4}
adr%=blove%(SHR(pd&,8))
IF adr%=0
adr%=@allocblock(256*34,&H10001)
blove%(SHR(pd&,8))=adr%
ENDIF
ADD adr%,m34&(pd& AND 255)
{adr%}=tmat(0,0)*x1&+tmat(0,1)*y1&+tmat(0,2)*z1&+xt%
{adr%+4}=tmat(1,0)*x1&+tmat(1,1)*y1&+tmat(1,2)*z1&+yt%
{adr%+8}=tmat(2,0)*x1&+tmat(2,1)*y1&+tmat(2,2)*z1&+zt%
IF halob&
x0={adr%}
x1={adr%+4}
x2={adr%+8}+d&
IF x2=0
  x2=1
ENDIF
t00=(dx*x0)/x2
{adr%+18}=@singtol(V:t00)
t01=(dy*x1)/x2
{adr%+22}=@singtol(V:t01)
t02=(x2-d&)/x2
OPENW #1
{adr%+26}={V:t02}
g&=-1
IF eff&
  g&=@build(cfra&,WORD{adrve%+6})
ENDIF
IF g&
  r=ABS(0.5*(d&*hasize&)/x2)
ELSE
  r=0
ENDIF
addhalovert
{adr%+30}=CVL("HALO")
ELSE
'
a1&=WORD{adrve%+6}  !roteer puntnormaal
a2&=WORD{adrve%+8}
a3&=WORD{adrve%+10}
WORD{adr%+12}=SHR(a1&*ps&(0)+a2&*ps&(1)+a3&*ps&(2),15)
WORD{adr%+14}=SHR(a1&*ps&(3)+a2&*ps&(4)+a3&*ps&(5),15)
WORD{adr%+16}=SHR(a1&*ps&(6)+a2&*ps&(7)+a3&*ps&(8),15)
IF n&
  ~C:normalwrd%(L:adr%+12,L:adr%+14,L:adr%+16)
ENDIF
{adr%+30}=adrve%
ENDIF
ADD pd&,1
ADD adrve%,12
NEXT p&
IF halob&=0
tot&={vv%+4}
adrvl%=vv%+32+12*{vv%}
FOR b&=0 TO tot&-1
IF WORD{adrvl%}>=0
  g&=-1
  IF eff&
    g&=@build(cfra&,b&)
  ENDIF
  IF g&
    adr%=blovl%(SHR(vd&,8))
    IF adr%=0
      adr%=@allocblock(256*28,&H10001)
      blovl%(SHR(vd&,8))=adr%
    ENDIF
    ADD adr%,m28&(vd& AND 255)
    a1&=pd&-totve&+WORD{adrvl%}
    a2&=pd&-totve&+WORD{adrvl%+2}
    a3&=pd&-totve&+WORD{adrvl%+4}
    {adr%}=blove%(SHR(a1&,8))+m34&(a1& AND 255)
    {adr%+4}=blove%(SHR(a2&,8))+m34&(a2& AND 255)
    {adr%+8}=blove%(SHR(a3&,8))+m34&(a3& AND 255)
    a1&=WORD{adrvl%+6}   !roteer vlaknormaal
    a2&=WORD{adrvl%+8}
    a3&=WORD{adrvl%+10}
    WORD{adr%+12}=SHR(a1&*ps&(0)+a2&*ps&(1)+a3&*ps&(2),15)
    WORD{adr%+14}=SHR(a1&*ps&(3)+a2&*ps&(4)+a3&*ps&(5),15)
    WORD{adr%+16}=SHR(a1&*ps&(6)+a2&*ps&(7)+a3&*ps&(8),15)
    IF n&
      ~C:normalwrd%(L:adr%+12,L:adr%+14,L:adr%+16)
    ENDIF
    {adr%+18}=ob%+80+SHL(BYTE{adrvl%+15} AND 31,6)
    '
    {adr%+22}=adrvl%+6  !orig normaal
    f0&=WORD{adr%+12}
    f1&=WORD{adr%+14}
    f2&=WORD{adr%+16}
    IF ABS(f2&)>=ABS(f0&) AND ABS(f2&)>=ABS(f1&)
      snproj&=0
    ELSE IF ABS(f1&)>=ABS(f0&) AND ABS(f1&)>=ABS(f2&)
      snproj&=1
    ELSE
      snproj&=2
    ENDIF
    BYTE{adr%+26}=snproj&+SHL(BYTE{adrvl%+14},2)
    '
    ADD vd&,1
  ENDIF
ENDIF
ADD adrvl%,16
NEXT b&
ENDIF
ENDIF
ELSE
IF WORD{base%+4}=1  ! wordruimte in imat
vv%={{base%+b.d&}}
fac=SINGLE{vv%+v.4&}
RBOX cmat(),1/fac
ENDIF
ENDIF
IF BYTE{base%+b.i&} OR WORD{base%+4}=7
{base%+b.i&-12}=-xt%
{base%+b.i&-8}=-yt%
{base%+b.i&-4}=-zt%
b%=base%+b.i&+1
b1%=base%+b.i&+4
RBOX t2mat()=cmat()
calcimat(0)
calcimat(1)
calcimat(2)
ENDIF
ENDIF
ENDIF
base%={base%}
WEND
totvlakren&=vd&
totvertren&=pd&
WHILE {{msga%}}
@decodemsg(GetMsg(msgp2%))
IF menu2%=&H45
afbreek&=-1
ENDIF
WEND
'
IF afbreek&=0
render&=-1
IF tracetype&=1
normalenrender
ENDIF
piraclip
initfase("Projection",0,0)
FOR a&=0 TO clipvert&-1
IF (a& AND 255)=0
adr%=blove%(SHR(a&,8))
ENDIF
IF {adr%+30}<>CVL("HALO")
x0={adr%}
x1={adr%+4}
x2={adr%+8}+d&
IF x2=0
x2=1
ENDIF
t00=(dx*x0)/x2
{adr%+18}=@singtol(V:t00)
t01=(dy*x1)/x2
{adr%+22}=@singtol(V:t01)
t02=(x2-d&)/x2
{adr%+26}={V:t02}
ENDIF
ADD adr%,34
NEXT a&
WHILE {{msga%}}
@decodemsg(GetMsg(msgp2%))
IF menu2%=&H45
afbreek&=-1
ENDIF
WEND
IF afbreek&=0
initfase("Normals",0,0)
FOR a&=0 TO totvlakren&-1    !klap normaal
adrvl%=blovl%(SHR(a&,8))+m28&(a& AND 255)
adrve1%={adrvl%}
adrve2%={adrvl%+4}
adrve3%={adrvl%+8}
IF adrve1%>0
x1=@ltosing(adrve1%+18)-@ltosing(adrve2%+18)
x2=@ltosing(adrve2%+18)-@ltosing(adrve3%+18)
y1=@ltosing(adrve1%+22)-@ltosing(adrve2%+22)
y2=@ltosing(adrve2%+22)-@ltosing(adrve3%+22)
z=x1*y2-y1*x2
ELSE
adrve1%=ABS(adrve1%)
f0&=WORD{adrvl%+12}
f1&=WORD{adrvl%+14}
f2&=WORD{adrvl%+16}
x%={adrve1%}
y%={adrve1%+4}
z%={adrve1%+8}
shift&=C:ltow1%(L:V:x%,L:V:y%,L:V:z%)
x&=x%  !vector vanuit origin (=observer)
y&=y%
z&=z%
~C:normalwrd%(L:V:x&,L:V:y&,L:V:z&)
z=-(f0&*x&+f1&*y&+f2&*z&)
ENDIF
IF z>0
BYTE{adrvl%+26}=(BYTE{adrvl%+26} XOR &X11100)
WORD{adrvl%+12}=-WORD{adrvl%+12}
WORD{adrvl%+14}=-WORD{adrvl%+14}
WORD{adrvl%+16}=-WORD{adrvl%+16}
ENDIF
NEXT a&
WHILE {{msga%}}
@decodemsg(GetMsg(msgp2%))
IF menu2%=&H45
afbreek&=-1
ENDIF
WEND
ENDIF
ENDIF
RETURN
> PROCEDURE initobject
ob%={base%+b.d&}
IF WORD{base%+4}=3
colt&=1
a%=ob%+32
ELSE
colt&=BYTE{ob%+o.c&}
a%=ob%+80
ENDIF
FOR a&=1 TO colt&
si&=BYTE{a%+5}
spec&=BYTE{a%+6}
IF si&<>0 AND spec&<>0
htest=((1/si&)^(1/spec&))
WORD{V:htest+6}=WORD{V:htest+6}+15
WORD{a%+20}=htest
ELSE
WORD{a%+20}=32767
ENDIF
ro&=BYTE{a%}
gr&=BYTE{a%+1}
bl&=BYTE{a%+2}
kshade&=BYTE{a%+4}
IF BYTE{a%+7} OR BYTE{a%+8}
tranmir&=trace&
ENDIF
texco&=0
tex%=a%+c.t&
FOR c&=0 TO 3
IF BYTE{tex%+c&}
IF WORD{base%+4}=7   !test poly tex
IF a&=1
IF SHR(WORD{tex%+4+4*c&},9) AND 22
WORD{tex%+4+4*c&}=WORD{tex%+4+4*c&} AND 511
WORD{tex%+4+4*c&}=WORD{tex%+4+4*c&}+16384
IF {tex%+20+4*c&}=0
{tex%+20+4*c&}=base%
BYTE{base%+b.i&}=BYTE{base%+b.i&}+1
ENDIF
ENDIF
ENDIF
ENDIF
IF SHR(WORD{tex%+4+4*c&},9) AND 32
IF {tex%+20+4*c&}=0
{tex%+20+4*c&}=base%
BYTE{base%+b.i&}=BYTE{base%+b.i&}+1
ENDIF
ENDIF
texco&=texco& OR WORD{tex%+4+4*c&}
ENDIF
NEXT c&
texco&=SHR(texco&,9)
BYTE{a%+17}=texco&
viewmode&=BYTE{a%+3} AND 1
snfl&=2*viewmode&  !c:calcsnijps%() flag
IF texco&
IF texco& AND 2
ADD snfl&,4
ENDIF
IF texco& AND 4
ADD snfl&,8
ENDIF
ENDIF
IF viewmode& OR BTST(texco&,2) OR BTST(texco&,4)
ADD snfl&,32
ENDIF
IF lace&=1
ADD snfl&,16
ELSE IF lace&=2
ADD snfl&,64
ENDIF
BYTE{a%+25}=snfl&
s&=BYTE{a%+10}
BYTE{a%+22}=SHR(s&*BYTE{wrld%+6},8)
BYTE{a%+23}=SHR(s&*BYTE{wrld%+7},8)
BYTE{a%+24}=SHR(s&*BYTE{wrld%+8},8)
hasize&=1000*WORD{a%+18}
IF WORD{a%+18}
halob&=-1
ENDIF
WORD{a%+c.l&}=WORD{base%+b.l&}
ADD a%,64
NEXT a&
RETURN
> PROCEDURE initlamp
a%=la%(totlampren&)
ob%={base%+b.d&}
BMOVE ob%,a%,70
x2=zt%+d&
{a%+22}=xt%
{a%+26}=yt%
{a%+30}=zt%
WORD{a%}=(dx*xt%)/x2
WORD{a%+84}=(4*dx*xt%)/x2
WORD{a%+2}=(dy*yt%)/x2
WORD{a%+86}=(4*dy*yt%)/x2
IF BYTE{a%+16} AND 2
halo&=-1
x={a%+22}+{a%+6}/4
x=WORD{a%}-4*d&*x/x2
x1=x^2
IF x1>&H1FFFFFFF
x1=&H1FFFFFFF
ENDIF
{a%+78}=x1
WORD{a%+82}=ABS(x)
ENDIF
IF WORD{a%+4}
x1%=-32767*tmat(0,2)
y1%=-32767*tmat(1,2)
z1%=-32767*tmat(2,2)
~C:ltow%(L:V:x1%,L:V:y1%,L:V:z1%)
WORD{a%+62}=x1%
WORD{a%+64}=y1%
WORD{a%+66}=z1%
~C:normalwrd%(L:a%+62,L:a%+64,L:a%+66)
lampdist={a%+6}/(100000+{a%+6})
WORD{a%+72}=32767*lampdist
x2=zt%+d&-dia*tmat(2,2)
WORD{a%+68}=((-dia*tmat(0,2)+xt%)*dx)/x2
WORD{a%+70}=((-dia*tmat(1,2)+yt%)*dy)/x2
ELSE
x%=tar%(0)-{base%+b.r&}
y%=tar%(1)-{base%+b.r&+4}
z%=tar%(2)-{base%+b.r&+8}
len=SQR(x%^2+y%^2+z%^2+1)/32767
y(0)=x%/len
y(1)=y%/len
y(2)=z%/len
RBOX x()=persmat()*y()
WORD{a%+62}=TRUNC(x(0))
WORD{a%+64}=TRUNC(x(1))
WORD{a%+66}=TRUNC(x(2))
ENDIF
RETURN
> PROCEDURE calczsphere
ob%={base%+b.d&}
r%={ob%+4}
r%=r%*SQR(mat(0,0)^2+mat(1,0)^2+mat(2,0)^2)
IF halob&
totve&=1
IF adrha%
t%=adrha%
adrha%=@allocblock(6*(totveha&+totve&),&H10001)
BMOVE t%,adrha%,6*totveha&
adrve1%=adrha%+6*totveha&
freeblock(t%)
ELSE
adrha%=@allocblock(6*totve&,&H10001)
adrve1%=adrha%
ENDIF
ADD totveha&,totve&
adr%=blove%(SHR(pd&,8))
IF adr%=0
adr%=@allocblock(256*34,&H10001)
blove%(SHR(pd&,8))=adr%
ENDIF
ADD adr%,m34&(pd& AND 255)
ADD pd&,1
'
x0=xt%
x1=yt%
x2=zt%+d&
t00=(dx*x0)/x2
{adr%+18}=@singtol(V:t00)
t01=(dy*x1)/x2
{adr%+22}=@singtol(V:t01)
t02=(x2-d&)/x2
{adr%+26}={V:t02}
r=ABS((d&*r%)/x2)
addhalovert
ELSE
a%=adrzs%
{a%}=r%
{a%+4}=xt%
{a%+8}=yt%
{a%+12}=zt%
x2=zt%+d&
SINGLE{a%+16}=(dx*xt%)/x2
SINGLE{a%+20}=(dy*yt%)/x2
SINGLE{a%+24}=(d&*{a%})/x2
WORD{a%+28}=INT(16*SINGLE{a%+24}+1)
WORD{a%+30}=INT(16*SINGLE{a%+16})
WORD{a%+32}=INT(16*SINGLE{a%+20})
x3=x2
IF x3>{a%}
z0=(x3-d&)/x3
z1=(x3-d&-{a%})/(x3-{a%})
SINGLE{a%+34}=z1-z0
SINGLE{a%+38}=z0
ENDIF
{a%+42}=ob%+32
ADD adrzs%,46
ENDIF
RETURN
> PROCEDURE calczpoly
IF cfra&=1
herbereken45
ENDIF
ob%={base%+b.d&}
vv%={ob%+o.p&}
tot&=WORD{vv%}
vorm&=WORD{vv%+2}
fac=SINGLE{vv%+18}
n&=WORD{vv%+24}
xn%=tmat(0,0)*WORD{vv%+30}+tmat(0,1)*WORD{vv%+32}+tmat(0,2)*WORD{vv%+34}
yn%=tmat(1,0)*WORD{vv%+30}+tmat(1,1)*WORD{vv%+32}+tmat(1,2)*WORD{vv%+34}
zn%=tmat(2,0)*WORD{vv%+30}+tmat(2,1)*WORD{vv%+32}+tmat(2,2)*WORD{vv%+34}
~C:ltow%(L:V:xn%,L:V:yn%,L:V:zn%)
xn&=xn%
yn&=yn%
zn&=zn%
~C:normalwrd%(L:V:xn&,L:V:yn&,L:V:zn&)
RBOX tmat(),fac
RBOX cmat(),1/fac
initpolyvert
p1%=@allocblock(48+tot&*24+vorm&*2,&H10001)
ADD polyren&,1
poly%(polyren&)=p1%
{p1%}={vv%}
{p1%+4}=ob%+80  !kleurblok
WORD{p1%+8}=xn&
WORD{p1%+10}=yn&
WORD{p1%+12}=zn&
IF b4&>1 AND n&
p2%=@allocblock(48+tot&*24+vorm&*2,&H10001)
ADD polyren&,1
poly%(polyren&)=p2%
{p2%}={vv%}
{p2%+4}=ob%+80  !kleurblok
{p2%+8}={p1%+8}
WORD{p2%+12}=WORD{p1%+12}
ELSE
p2%=p1%
ENDIF
'
adrve%=vv%+64
a1%=p1%+48
a2%=p2%+48
FOR a&=1 TO vorm&
p&=WORD{adrve%}
WORD{a1%}=p&
ADD a1%,2
IF b4&>1 AND n&
WORD{a2%}=p&
ADD a2%,2
ENDIF
ADD adrve%,2
IF p&
calcpolyvert
a%=adrven%
b5&=12*b4&
FOR b&=1 TO p&
{a1%}={a%}
{a1%+4}={a%+4}
{a1%+8}={a%+8}
ADD a1%,24
ADD a%,b5&
IF b4&>1 AND n&
{a2%}={a%-12}
{a2%+4}={a%-8}
{a2%+8}={a%-4}
ADD a2%,24
ENDIF
NEXT b&
IF b4&>1
a0%=adrven%
IF b4&=2 AND adr45%
adrcol%=ob%+80+128
ELSE
adrcol%=ob%+80+64
ENDIF
polyzijvlakken
IF b4&>2
IF b4&=3
adrcol%=ob%+80+128
ELSE
adrcol%=ob%+80+64
ENDIF
a0%=adrven%+12
polyzijvlakken
ENDIF
IF b4&=4
adrcol%=ob%+80+128
a0%=adrven%+24
polyzijvlakken
ENDIF
ENDIF
freeblock(adrven%)
ENDIF
NEXT a&
'
a&=0
IF b4&>1 AND n&
SUB polyren&,1
ENDIF
FOR f1&=0 TO -(b4&>1 AND n&<>0)
clippirapoly  !doet ook proj
'
IF l&<>2
'
z%=ABS(rt%(4,0))
IF f1&=1
z%=-z%
ENDIF
x1=xt%+tmat(0,2)*z%
y1=yt%+tmat(1,2)*z%
z1=zt%+tmat(2,2)*z%+d&
IF z1==0
z1=1
ENDIF
x1=(dx*x1)/z1
y1=(dy*y1)/z1
t10=(z1-d&)/z1
'
x2=xt%+tmat(0,0)*1000+tmat(0,2)*z%
y2=yt%+tmat(1,0)*1000+tmat(1,2)*z%
z2=zt%+tmat(2,0)*1000+tmat(2,2)*z%+d&
IF z2==0
z2=1
ENDIF
x2=(dx*x2)/z2
y2=(dy*y2)/z2
t11=(z2-d&)/z2
'
x3=xt%+tmat(0,1)*1000+tmat(0,2)*z%
y3=yt%+tmat(1,1)*1000+tmat(1,2)*z%
z3=zt%+tmat(2,1)*1000+tmat(2,2)*z%+d&
IF z3==0
z3=1
ENDIF
x3=(dx*x3)/z3
y3=(dy*y3)/z3
t12=(z3-d&)/z3
'
IF ali&
x1=4*x1
y1=4*y1
x2=4*x2
y2=4*y2
x3=4*x3
y3=4*y3
ENDIF
x11=x1-x2
x22=x2-x3
y11=y1-y2
y22=y2-y3
z1=t10-t11
z2=t11-t12
x0=y11*z2-z1*y22
y0=z1*x22-x11*z2
z0=x11*y22-y11*x22
a%=poly%(polyren&)
xx1=x0*x1+y0*y1+z0*t10
' OPEN "o",#1,"ram:log"+STR$(polyren&)
' PRINT #1,"x1 ";x1
' PRINT #1,"x2 ";x2
' PRINT #1,"x3 ";x3
' PRINT #1,"y1 ";y1
' PRINT #1,"y2 ";y2
' PRINT #1,"y3 ";y3
' PRINT #1,"t10 ";t10
' PRINT #1,"t11 ";t11
' PRINT #1,"t12 ";t12
' CLOSE #1
IF z0<>0
FLOAT{a%+14}=-x0/z0
FLOAT{a%+22}=-y0/z0
FLOAT{a%+30}=xx1/z0
'                      klap normaal
xn&=WORD{a%+8}
yn&=WORD{a%+10}
zn&=WORD{a%+12}
x%=xt%
y%=yt%
z%=zt%
shift&=C:ltow1%(L:V:x%,L:V:y%,L:V:z%)
x&=x%  !vector vanuit origin (=observer)
y&=y%
z&=z%
~C:normalwrd%(L:V:x&,L:V:y&,L:V:z&)
z%=-(xn&*x&+yn&*y&+zn&*z&)
IF z%>0
WORD{a%+8}=-WORD{a%+8}
WORD{a%+10}=-WORD{a%+10}
WORD{a%+12}=-WORD{a%+12}
ENDIF
ELSE
' okee("Vieze poly z")
freeblock(poly%(polyren&))
DELETE poly%(polyren&)
SUB polyren&,1
ENDIF
ENDIF
IF b4&<>1 AND f1&=0 AND n&<>0
ADD polyren&,1
ENDIF
NEXT f1&
RETURN
> PROCEDURE polyzijvlakken
FOR b&=1 TO p&
adr%=@addvert(pd&)
{adr%}={a0%}
{adr%+4}={a0%+4}
{adr%+8}={a0%+8}
{adr%+30}=adr%
ADD pd&,1
adr%=@addvert(pd&)
{adr%}={a0%+12}
{adr%+4}={a0%+16}
{adr%+8}={a0%+20}
{adr%+30}=adr%
ADD pd&,1
x1%={a0%}-{a0%+12}
y1%={a0%+4}-{a0%+16}
z1%={a0%+8}-{a0%+20}
IF b&=1
adr%=a0%+b5&*(p&-1)
x2%={a0%}-{adr%}
y2%={a0%+4}-{adr%+4}
z2%={a0%+8}-{adr%+8}
ELSE
adr%=a0%-b5&
x2%={a0%}-{adr%}
y2%={a0%+4}-{adr%+4}
z2%={a0%+8}-{adr%+8}
ENDIF
IF x2%=0 AND y2%=0 AND z2%=0
IF b&=2
adr%=a0%+b5&*(p&-2)
ELSE
adr%=adr%-b5&
ENDIF
x2%={a0%}-{adr%}
y2%={a0%+4}-{adr%+4}
z2%={a0%+8}-{adr%+8}
ENDIF
calcnorm
IF ABS(zn&)>=ABS(xn&) AND ABS(zn&)>=ABS(yn&)
snproj&=0
ELSE IF ABS(yn&)>=ABS(xn&) AND ABS(yn&)>=ABS(zn&)
snproj&=1
ELSE
snproj&=2
ENDIF
'
adr%=@addface(vd&)
ADD vd&,1
{adr%}=@addvert(pd&-1)
{adr%+4}=@addvert(pd&-2)
IF b&=1
{adr%+8}=@addvert(pd&-3+2*p&)
ELSE
{adr%+8}=@addvert(pd&-3)
ENDIF
WORD{adr%+12}=xn&
WORD{adr%+14}=yn&
WORD{adr%+16}=zn&
{adr%+18}=adrcol%
{adr%+22}=adr%+12
BYTE{adr%+26}=snproj&
adr%=@addface(vd&)
ADD vd&,1
{adr%}=@addvert(pd&-2)
IF b&=1
{adr%+4}=@addvert(pd&-4+2*p&)
{adr%+8}=@addvert(pd&-3+2*p&)
ELSE
{adr%+4}=@addvert(pd&-4)
{adr%+8}=@addvert(pd&-3)
ENDIF
WORD{adr%+12}=xn&
WORD{adr%+14}=yn&
WORD{adr%+16}=zn&
{adr%+18}=adrcol%
{adr%+22}=adr%+12
BYTE{adr%+26}=snproj&
ADD a0%,b5&
NEXT b&
IF BYTE{ob%+64+80+3} AND 1    !puno's
b1&=pd&-2*p&
b2&=vd&-2*p&
FOR b&=1 TO p&
adrvl1%=@addface(b2&)+12
IF b&=p&
adrvl2%=@addface(vd&-2*p&)+12
ELSE
adrvl2%=@addface(b2&+2)+12
ENDIF
t%=@addvert(b1&)+12
WORD{t%}=(WORD{adrvl1%}+WORD{adrvl2%})/2
WORD{t%+2}=(WORD{adrvl1%+2}+WORD{adrvl2%+2})/2
WORD{t%+4}=(WORD{adrvl1%+4}+WORD{adrvl2%+4})/2
~C:normalwrd%(L:t%,L:t%+2,L:t%+4)
a%=@addvert(b1&+1)+12
{a%}={t%}
WORD{a%+4}=WORD{t%+4}
ADD b1&,2
ADD b2&,2
NEXT b&
ENDIF
RETURN
> PROCEDURE addhalovert
{adrve1%}=adr%
BYTE{adrve1%+5}=spec&
{adr%}=@singtol(V:r)
WORD{adr%+4}=INT(t01-r)
WORD{adr%+6}=INT(t01+r+1)
BYTE{adr%+8}=kshade&
BYTE{adr%+9}=ro&
BYTE{adr%+10}=gr&
BYTE{adr%+11}=bl&
IF x2<4*d&         !clippen
BYTE{adrve1%+4}=1
ELSE IF WORD{adr%+4}>afmy&
BYTE{adrve1%+4}=1
ELSE IF WORD{adr%+6}<-afmy&
BYTE{adrve1%+4}=1
ELSE
x1&=INT(t00-r)
x2&=INT(t00+r+1)
IF x1&>afmx&
BYTE{adrve1%+4}=1
ELSE IF x2&<-afmx&
BYTE{adrve1%+4}=1
ENDIF
ENDIF
r=r*r
{adr%+14}=@singtol(V:r)
ADD adrve1%,6
RETURN
> PROCEDURE calcimat(g1&)
t00=SQR(cmat(g1&,0)^2+cmat(g1&,1)^2+cmat(g1&,2)^2)
s&=0
IF t00>1
WHILE t00>1
ADD s&,-1
t00=t00/2
WEND
b1&=SHL(1,-s&)
cmat(g1&,0)=cmat(g1&,0)/b1&
cmat(g1&,1)=cmat(g1&,1)/b1&
cmat(g1&,2)=cmat(g1&,2)/b1&
ELSE IF t00<0.5
WHILE t00<0.5
ADD s&,1
t00=t00*2
WEND
b1&=SHL(1,s&)
cmat(g1&,0)=cmat(g1&,0)*b1&
cmat(g1&,1)=cmat(g1&,1)*b1&
cmat(g1&,2)=cmat(g1&,2)*b1&
ENDIF
BYTE{b%}=32+s&
WORD{b1%}=INT(16384*cmat(g1&,0))
WORD{b1%+2}=INT(16384*cmat(g1&,1))
WORD{b1%+4}=INT(16384*cmat(g1&,2))
ADD b%,1
ADD b1%,6
RETURN
'
ENDFUNC
RBOX clip
> PROCEDURE piraclip
initfase("Clipping",0,0)
clipvert&=totvertren&
clipvlak&=totvlakren&
IF totvlakren&
clve&=clipvert&
t00=lens&-4
t00=t00/16
t01=lens&-4
t01=t01/12.8
' eerst naar rechthoekige pira scalen
FOR a&=0 TO clipvert&-1
IF (a& AND 255)=0
adr%=blove%(SHR(a&,8))
ENDIF
{adr%+18}=t00*{adr%}
{adr%+22}=t01*{adr%+4}
ADD adr%,34
NEXT a&
d2%=2*d%
adrvl1%=@allocblock(32*28,&H10001)
adrve%=@allocblock(96*34,&H10001)
FOR a&=0 TO totvlakren&-1
IF (a& AND 255)=0
t20%=blovl%(SHR(a&,8))
ENDIF
c1&=@testclip({t20%})
c2&=@testclip({t20%+4})
c3&=@testclip({t20%+8})
IF c1& OR c2& OR c3&  !niet in het midden
IF c1& AND c2& AND c3&  !helemaal eruit
{t20%}=-{t20%}
ELSE
clvl&=1
clve&=0
BMOVE t20%,adrvl1%,28
FOR b&=0 TO 2
IF b&=0
c&=(c1& AND 16) OR (c2& AND 16) OR (c3& AND 16)
ELSE IF b&=1
c&=(c1& AND 3) OR (c2& AND 3) OR (c3& AND 3)
ELSE
c&=(c1& AND 12) OR (c2& AND 12) OR (c3& AND 12)
ENDIF
IF c&
c&=clvl&
FOR v&=0 TO c&-1
adrvl%=adrvl1%+v&*28
adrve1%={adrvl%}
IF adrve1%>0
adrve2%={adrvl%+4}
adrve3%={adrvl%+8}
b1&=0
b2&=0  !clipvlag
b3&=0  !clipvlag
IF b&=0
  clippl(adrve1%,adrve2%)
  clippl(adrve2%,adrve3%)
  clippl(adrve3%,adrve1%)
ELSE IF b&=1
  clippr(adrve1%,adrve2%)
  clippr(adrve2%,adrve3%)
  clippr(adrve3%,adrve1%)
ELSE
  clipp(adrve1%,adrve2%)
  clipp(adrve2%,adrve3%)
  clipp(adrve3%,adrve1%)
ENDIF
IF b2&=0 AND b3&=-1
  ' er helemaal in
ELSE IF b3&=0
  {adrvl%}=-{adrvl%}
  ' er helemaal uit
ELSE  !clippen
  b1&=0
  b2&=0
  maakvertpira(adrve1%,adrve2%)
  b2&=1
  maakvertpira(adrve2%,adrve3%)
  b2&=2
  maakvertpira(adrve3%,adrve1%)
  {adrvl%}=-{adrvl%}
  IF b1&>2
    FOR b3&=3 TO b1&
      adr%=adrvl1%+28*clvl&
      ADD clvl&,1
      {adr%}=p%(0,0)
      {adr%+4}=p%(b3&-2,0)
      {adr%+8}=p%(b3&-1,0)
    NEXT b3&
  ENDIF
ENDIF
ENDIF
NEXT v&
ENDIF
NEXT b&
IF {adrvl1%}<0
{t20%}=-{t20%}
ENDIF
a%=adrvl1%+28
FOR b&=2 TO clvl&
IF {a%}>0
adr%=@addface(clipvlak&)
WORD{adr%+18}=a&
ADD clipvlak&,1
zoekdubbels({a%},0)
zoekdubbels({a%+4},4)
zoekdubbels({a%+8},8)
ENDIF
ADD a%,28
NEXT b&
ENDIF
ENDIF
ADD t20%,28
NEXT a&
freeblock(adrvl1%)
freeblock(adrve%)
'  schrijfclip
ENDIF
RETURN
> PROCEDURE clippl(g1%,g2%)
u1=0
u2=1
labda(b1&,0)=-1
labda(b1&,1)=-1
dz%={g2%+8}-{g1%+8}
IF @cliptest(-dz%,{g1%+8}-d2%)
b3&=-1
IF u2<1
labda(b1&,1)=u2
b2&=-1
ELSE
labda(b1&,1)=1
ENDIF
IF u1>0
labda(b1&,0)=u1
b2&=-1
ELSE
labda(b1&,0)=0
ENDIF
ENDIF
ADD b1&,1
RETURN
> PROCEDURE clippr(g1%,g2%)
u1=0
u2=1
labda(b1&,0)=-1
labda(b1&,1)=-1
dx%={g2%+18}-{g1%+18}
dz%={g2%+8}-{g1%+8}
IF @cliptest(-dx%-dz%,{g1%+18}+{g1%+8})
IF @cliptest(dx%-dz%,{g1%+8}-{g1%+18})
b3&=-1
IF u2<1
labda(b1&,1)=u2
b2&=-1
ELSE
labda(b1&,1)=1
ENDIF
IF u1>0
labda(b1&,0)=u1
b2&=-1
ELSE
labda(b1&,0)=0
ENDIF
ENDIF
ENDIF
ADD b1&,1
RETURN
> PROCEDURE clipp(g1%,g2%)
u1=0
u2=1
labda(b1&,0)=-1
labda(b1&,1)=-1
dz%={g2%+8}-{g1%+8}
dy%={g2%+22}-{g1%+22}
IF @cliptest(-dy%-dz%,{g1%+22}+{g1%+8})
IF @cliptest(dy%-dz%,{g1%+8}-{g1%+22})
b3&=-1
IF u2<1
labda(b1&,1)=u2
b2&=-1
ELSE
labda(b1&,1)=1
ENDIF
IF u1>0
labda(b1&,0)=u1
b2&=-1
ELSE
labda(b1&,0)=0
ENDIF
ENDIF
ENDIF
ADD b1&,1
RETURN
> PROCEDURE maakvertpira(g1%,g2%)
l1=labda(b2&,0)
l2=labda(b2&,1)
IF l1<>-1
IF l1<>0
a%=adrve%+34*clve&
p%(b1&,0)=a%
ADD clve&,1
{a%}={g1%}+l1*({g2%}-{g1%})
{a%+4}={g1%+4}+l1*({g2%+4}-{g1%+4})
{a%+8}={g1%+8}+l1*({g2%+8}-{g1%+8})
WORD{a%+12}=WORD{g1%+12}+l1*(WORD{g2%+12}-WORD{g1%+12})
WORD{a%+14}=WORD{g1%+14}+l1*(WORD{g2%+14}-WORD{g1%+14})
WORD{a%+16}=WORD{g1%+16}+l1*(WORD{g2%+16}-WORD{g1%+16})
{a%+18}=t00*{a%}
{a%+22}=t01*{a%+4}
ELSE
p%(b1&,0)=g1%
ENDIF
ADD b1&,1
ENDIF
IF l2<>-1
IF l2<>1
a%=adrve%+34*clve&
p%(b1&,0)=a%
ADD clve&,1
{a%}={g1%}+l2*({g2%}-{g1%})
{a%+4}={g1%+4}+l2*({g2%+4}-{g1%+4})
{a%+8}={g1%+8}+l2*({g2%+8}-{g1%+8})
WORD{a%+12}=WORD{g1%+12}+l1*(WORD{g2%+12}-WORD{g1%+12})
WORD{a%+14}=WORD{g1%+14}+l1*(WORD{g2%+14}-WORD{g1%+14})
WORD{a%+16}=WORD{g1%+16}+l1*(WORD{g2%+16}-WORD{g1%+16})
{a%+18}=t00*{a%}
{a%+22}=t01*{a%+4}
ADD b1&,1
ENDIF
ENDIF
RETURN
> PROCEDURE zoekdubbels(g1%,g1&)
IF {g1%+30}
b2&=-1
adrve1%=g1%
ELSE
adrve1%=@addvert(totvertren&)
b2&=0
FOR b1&=totvertren& TO clipvert&-1
IF (b1& AND 255)=0
adrve1%=blove%(SHR(b1&,8))
ENDIF
IF {adrve1%}={g1%}
IF {adrve1%+4}={g1%+4}
IF {adrve1%+8}={g1%+8}
b2&=-1
ENDIF
ENDIF
ENDIF
EXIT IF b2&
ADD adrve1%,34
NEXT b1&
ENDIF
IF b2&
{adr%+g1&}=adrve1%
ELSE
{adr%+g1&}=@addvert(clipvert&)
ADD clipvert&,1
BMOVE g1%,{adr%+g1&},18
a1%={adr%+g1&}
~C:normalwrd%(L:a1%+12,L:a1%+14,L:a1%+16)
ENDIF
RETURN
> PROCEDURE clippirapoly
t00=lens&-4
t00=t00/16
t01=lens&-4
t01=t01/12.8
IF render&
d%=d&
ENDIF
'         eerst poly vervormen naar pira
c1&=0
c2&=31
a%=poly%(polyren&)+48
FOR b&=1 TO vorm&
p&=WORD{a%}
ADD a%,2
FOR c&=1 TO p&
{a%}=t00*{a%}
{a%+4}=t01*{a%+4}
b1&=@testclip2(a%)
c1&=(c1& OR b1&)
c2&=(c2& AND b1&)
ADD a%,24
NEXT c&
NEXT b&
'
l&=0
IF c1&=0           !er helemaal in
ELSE IF c2&<>0     !er helemaal uit
l&=2
freeblock(poly%(polyren&))
DELETE poly%(polyren&)
SUB polyren&,1
ELSE               !clippen
d2%=2*d%
FOR a&=1 TO 2
IF a&=0
c3&=c1& AND 16
ELSE IF a&=1
c3&=c1& AND 3
ELSE
c3&=c1& AND 12
ENDIF
IF c3&
a%=poly%(polyren&)
tot&=WORD{a%}
vorm&=WORD{a%+2}
ADD a%,48
temp%=@allocblock(tot&*26,&H10001)  !edgeslijst
t%=temp%
FOR b&=1 TO vorm&
p&=WORD{a%}
ADD a%,2
IF p&
WORD{t%}=4
a1%=a%+(p&-1)*24
FOR c&=1 TO p&
{t%+2}={a1%}
{t%+6}={a1%+4}
{t%+10}={a1%+8}
{t%+14}={a%}
{t%+18}={a%+4}
{t%+22}={a%+8}
ADD t%,26
a1%=a%
ADD a%,24
NEXT c&
ENDIF
NEXT b&
t%=temp%
c3&=0
FOR b&=1 TO tot&
u1=0
u2=1
dx%={t%+14}-{t%+2}
dy%={t%+18}-{t%+6}
dz%={t%+22}-{t%+10}
c2&=0
IF a&=0
IF @cliptest(-dz%,{t%+10}-d2%)
c2&=-1
ENDIF
ELSE IF a&=1
IF @cliptest(-dx%-dz%,{t%+2}+{t%+10})
IF @cliptest(dx%-dz%,{t%+10}-{t%+2})
c2&=-1
ENDIF
ENDIF
ELSE
IF @cliptest(-dy%-dz%,{t%+6}+{t%+10})
IF @cliptest(dy%-dz%,{t%+10}-{t%+6})
c2&=-1
ENDIF
ENDIF
ENDIF
IF c2&
IF u2<1
WORD{t%}=WORD{t%}+2
{t%+14}={t%+2}+u2*dx%
{t%+18}={t%+6}+u2*dy%
{t%+22}={t%+10}+u2*dz%
ADD c3&,1
ENDIF
IF u1>0
WORD{t%}=WORD{t%}+1
{t%+2}={t%+2}+u1*dx%
{t%+6}={t%+6}+u1*dy%
{t%+10}={t%+10}+u1*dz%
ADD c3&,1
ENDIF
ELSE
IF WORD{t%}
WORD{t%}=-WORD{t%}
ELSE
WORD{t%}=-1
ENDIF
SUB c3&,2
ENDIF
ADD t%,26
NEXT b&
' maak nieuwe poly
p1%=@allocblock(48+(tot&+c3&/2)*24+vorm&*2,&H10001)
a%=poly%(polyren&)
BMOVE a%,p1%,48
freeblock(a%)
poly%(polyren&)=p1%
WORD{p1%}=0
a1%=p1%+48
t%=temp%
t2t%=0
max%=p1%+48+(tot&+c3&/2)*24+vorm&*2
FOR b&=1 TO tot&
IF ABS(WORD{t%}) AND 4
IF t2t%
WORD{p1%}=WORD{p1%}+WORD{t2t%}
ENDIF
t2t%=a1%
ADD a1%,2
ENDIF
IF WORD{t%}>-1  !goede of geclipte edge
{a1%}={t%+2}
{a1%+4}={t%+6}
{a1%+8}={t%+10}
ADD a1%,24
WORD{t2t%}=WORD{t2t%}+1
IF WORD{t%} AND 2
{a1%}={t%+14}
{a1%+4}={t%+18}
{a1%+8}={t%+22}
ADD a1%,24
WORD{t2t%}=WORD{t2t%}+1
ENDIF
ENDIF
ADD t%,26
IF a1%>max%+24
okee("fout in polyclip!")
sluit
ENDIF
NEXT b&
IF t2t%
WORD{p1%}=WORD{p1%}+WORD{t2t%}
ENDIF
freeblock(temp%)
ENDIF
NEXT a&
ENDIF
'           poly terugscalen  en projektie
IF l&<>2
t00=1/t00
t01=1/t01
a%=poly%(polyren&)+48
FOR b&=1 TO vorm&
p&=WORD{a%}
ADD a%,2
FOR c&=1 TO p&
{a%}=t00*{a%}
{a%+4}=t01*{a%+4}
x0={a%}
x1={a%+4}
x2={a%+8}+d&
IF x2=0
x2=1
ENDIF
t10=(dx*x0)/x2
{a%+12}=@singtol(V:t10)
t11=(dy*x1)/x2
{a%+16}=@singtol(V:t11)
t12=(x2-d&)/x2
{a%+20}={V:t12}
ADD a%,24
NEXT c&
NEXT b&
ENDIF
RETURN
> PROCEDURE zoekdubbelsplane(VAR g1%)
'
SWAP g1%,a%
'
FOR b&=totvertren& TO clipvert&-1
adr%=blove%(SHR(b&,8))+m34&(b& AND 255)
IF LONG{adr%}=LONG{a%}
IF LONG{adr%+4}=LONG{a%+4}
a%=adr%
b&=clipvert&
ENDIF
ENDIF
NEXT b&
'
SWAP g1%,a%
'
RETURN
> PROCEDURE zoekdubbelsvolume(VAR s%)
FOR b&=totvertren& TO clipvert&-1
adrve%=blove%(SHR(b&,8))+m34&(b& AND 255)
IF {adrve%+18}={s%+18}
IF {adrve%+22}={s%+22}
IF {adrve%+26}={s%+26}
s%=adrve%
b&=clipvert&
SUB clipvert&,1
ENDIF
ENDIF
ENDIF
NEXT b&
RETURN
> PROCEDURE cliplijn(x1%,y1%,x2%,y2%)
c1&=0
IF x1%<-320
ADD c1&,4
ELSE IF x1%>320
ADD c1&,8
ENDIF
IF y1%<-256
ADD c1&,2
ELSE IF y1%>256
ADD c1&,1
ENDIF
c2&=0
IF x2%<-320
ADD c2&,4
ELSE IF x2%>320
ADD c2&,8
ENDIF
IF y2%<-256
ADD c2&,2
ELSE IF y2%>256
ADD c2&,1
ENDIF
IF c1& OR c2&
IF c1& AND c2&
ELSE
u1&=0
u2&=32767
i&=-1
dx%=x2%-x1%
IF (c1& AND 12) OR (c2& AND 12)
i&=@cliptestli(-dx%,x1%+320)
IF i&
i&=@cliptestli(dx%,320-x1%)
ENDIF
ENDIF
IF i&
dy%=y2%-y1%
IF (c1& AND 3) OR (c2& AND 3)
i&=@cliptestli(-dy%,y1%+256)
IF i&
i&=@cliptestli(dy%,256-y1%)
ENDIF
ENDIF
IF i&
IF u2&<32767
x2%=x1%+C:lifmul%(L:dx%,u2&)
y2%=y1%+C:lifmul%(L:dy%,u2&)
ENDIF
IF u1&>0
x1%=x1%+C:lifmul%(L:dx%,u1&)
y1%=y1%+C:lifmul%(L:dy%,u1&)
ENDIF
LINE 320+x1%,256-y1%,320+x2%,256-y2%
ENDIF
ENDIF
ENDIF
ELSE
LINE 320+x1%,256-y1%,320+x2%,256-y2%
ENDIF
RETURN
> PROCEDURE schrijfclip
OPEN "o",#1,"ram:rt"
PRINT #1,"3DG1"
PRINT #1,3*clipvlak&
FOR a&=1 TO clipvlak&
seta1a2a3(a&-1)
adrve1%=ABS(adrve1%)
PRINT #1,{adrve1%};" ";{adrve1%+4};" ";{adrve1%+8}
PRINT #1,{adrve2%};" ";{adrve2%+4};" ";{adrve2%+8}
PRINT #1,{adrve3%};" ";{adrve3%+4};" ";{adrve3%+8}
NEXT a&
b1&=0
FOR a&=1 TO clipvlak&
seta1a2a3(a&-1)
IF {adrvl%}>0
PRINT #1,"3 ";b1&;" ";b1&+1;" ";b1&+2;" ";12
ENDIF
ADD b1&,3
NEXT a&
CLOSE #1
sluit
RETURN
> PROCEDURE schrpoly
adr%=poly%(polyren&)
OPEN "o",#1,"ram:rt"
PRINT #1,"3DG1"
PRINT #1,WORD{adr%}
vorm&=WORD{adr%+2}
a%=adr%+48
FOR b&=1 TO vorm&
p&=WORD{a%}
ADD a%,2
IF p&>=100 OR p&<0
okee("fout in schrijf")
CLOSE #1
sluit
ENDIF
FOR c&=1 TO p&
PRINT #1,STR$({a%})+" "+STR$({a%+4})+" "+STR$({a%+8})
' t00=@ltosing(a%+12)
' t01=@ltosing(a%+16)
' PRINT #1,STR$(t00)+" "+STR$(t01)+" 0"
ADD a%,24
NEXT c&
NEXT b&
a%=adr%+48
t&=0
FOR b&=1 TO vorm&
p&=WORD{a%}
ADD a%,2
PRINT #1,STR$(p&)+" ";
FOR c&=1 TO p&
PRINT #1,STR$(c&+t&-1)+" ";
ADD a%,24
NEXT c&
PRINT #1,"12"
ADD t&,p&
NEXT b&
CLOSE #1
sluit
RETURN
'
ENDFUNC
RBOX normalen
> PROCEDURE edges
DIM edv&(tot&,5)
ARRAYFILL edv&(),-2
a%=adrvl%
FOR a&=1 TO vlak&
a1&=WORD{a%}
a2&=WORD{a%+2}
a3&=WORD{a%+4}
a4&=BYTE{a%+15} AND 31
addedge(a1&,a2&)
IF t&
ADD a4&,128
ENDIF
addedge(a2&,a3&)
IF t&
ADD a4&,64
ENDIF
addedge(a3&,a1&)
IF t&
ADD a4&,32
ENDIF
BYTE{a%+15}=a4&
ADD a%,16
NEXT a&
ERASE edv&()
RETURN
> PROCEDURE normalen
pi.5=PI*0.5
s%=2^14
DIM z&(tot&+1)
adrco%=@allocblock(12+vlak&*6,&H10001)
adrno%=@allocblock(12+tot&*12,&H10001)
IF pumanorm&
adrpu%=@allocblock(12+tot&*12,&H10001)
ENDIF
adrvl1%=adrvl%
FOR a&=1 TO vlak&
a1&=WORD{adrvl%}
a2&=WORD{adrvl%+2}
a3&=WORD{adrvl%+4}
adrve1%=adrve%+12*a1&
adrve2%=adrve%+12*a2&
adrve3%=adrve%+12*a3&
x1&=WORD{adrve1%}
y1&=WORD{adrve1%+2}
z1&=WORD{adrve1%+4}
x2&=WORD{adrve2%}
y2&=WORD{adrve2%+2}
z2&=WORD{adrve2%+4}
x3&=WORD{adrve3%}
y3&=WORD{adrve3%+2}
z3&=WORD{adrve3%+4}
x&=(x1&-x2&)/2
y&=(y1&-y2&)/2
z&=(z1&-z2&)/2
x2&=(x2&-x3&)/2
y2&=(y2&-y3&)/2
z2&=(z2&-z3&)/2
x3&=(x3&-x1&)/2
y3&=(y3&-y1&)/2
z3&=(z3&-z1&)/2
x1&=x&
y1&=y&
z1&=z&
~C:normalwrd%(L:V:x1&,L:V:y1&,L:V:z1&)
~C:normalwrd%(L:V:x2&,L:V:y2&,L:V:z2&)
~C:normalwrd%(L:V:x3&,L:V:y3&,L:V:z3&)
c1&=SHR(x1&*x3&+y1&*y3&+z1&*z3&,15)
c2&=SHR(x1&*x2&+y1&*y2&+z1&*z2&,15)
c3&=SHR(x2&*x3&+y2&*y3&+z2&*z3&,15)
c1&=WORD{adraco%+512-2*WORD(SHR(c1&,7))}
c2&=WORD{adraco%+512-2*WORD(SHR(c2&,7))}
c3&=WORD{adraco%+512-2*WORD(SHR(c3&,7))}
WORD{adrco%+6*a&}=c1&
WORD{adrco%+6*a&+2}=c2&
WORD{adrco%+6*a&+4}=c3&
IF pumanorm&
b1&=(WORD{adrve1%}+WORD{adrve2%}+WORD{adrve3%})/3
b2&=(WORD{adrve1%+2}+WORD{adrve2%+2}+WORD{adrve3%+2})/3
b3&=(WORD{adrve1%+4}+WORD{adrve2%+4}+WORD{adrve3%+4})/3
x1&=b1&-WORD{adrve1%}
x2&=b1&-WORD{adrve2%}
x3&=b1&-WORD{adrve3%}
y1&=b2&-WORD{adrve1%+2}
y2&=b2&-WORD{adrve2%+2}
y3&=b2&-WORD{adrve3%+2}
z1&=b3&-WORD{adrve1%+4}
z2&=b3&-WORD{adrve2%+4}
z3&=b3&-WORD{adrve3%+4}
~C:normalwrd%(L:V:x1&,L:V:y1&,L:V:z1&)
~C:normalwrd%(L:V:x2&,L:V:y2&,L:V:z2&)
~C:normalwrd%(L:V:x3&,L:V:y3&,L:V:z3&)
a1%=adrpu%+12*a1&
a2%=adrpu%+12*a2&
a3%=adrpu%+12*a3&
{a1%}={a1%}+WORD(SHR(c1&*x1&,15))
{a2%}={a2%}+WORD(SHR(c2&*x2&,15))
{a3%}={a3%}+WORD(SHR(c3&*x3&,15))
{a1%+4}={a1%+4}+WORD(SHR(c1&*y1&,15))
{a2%+4}={a2%+4}+WORD(SHR(c2&*y2&,15))
{a3%+4}={a3%+4}+WORD(SHR(c3&*y3&,15))
{a1%+8}={a1%+8}+WORD(SHR(c1&*z1&,15))
{a2%+8}={a2%+8}+WORD(SHR(c2&*z2&,15))
{a3%+8}={a3%+8}+WORD(SHR(c3&*z3&,15))
ADD z&(a1&),1
ADD z&(a2&),1
ADD z&(a3&),1
ENDIF
ADD adrvl%,16
NEXT a&
IF pumanorm&
a%=adrpu%
FOR a&=0 TO tot&-1
len={a%}^2+{a%+4}^2+{a%+8}^2
IF len<124 OR z&(a&)=1
z&(a&)=0
ENDIF
ADD a%,12
NEXT a&
ENDIF
adrvl%=adrvl1%
FOR a&=1 TO vlak&
a1&=WORD{adrvl%}
IF a1&>=0
a2&=WORD{adrvl%+2}
a3&=WORD{adrvl%+4}
adrve1%=adrve%+12*a1&
adrve2%=adrve%+12*a2&
adrve3%=adrve%+12*a3&
x1%=(WORD{adrve1%}-WORD{adrve2%})
x2%=(WORD{adrve2%}-WORD{adrve3%})
y1%=(WORD{adrve1%+2}-WORD{adrve2%+2})
y2%=(WORD{adrve2%+2}-WORD{adrve3%+2})
z1%=(WORD{adrve1%+4}-WORD{adrve2%+4})
z2%=(WORD{adrve2%+4}-WORD{adrve3%+4})
calcnorm
sig&=1
WORD{adrvl%+6}=xn&
WORD{adrvl%+8}=yn&
WORD{adrvl%+10}=zn&
svlak&=a&
adrve1%=adrno%+12*a1&
adrve2%=adrno%+12*a2&
adrve3%=adrno%+12*a3&
a%=adrco%+6*a&
c1&=WORD{a%}
c2&=WORD{a%+2}
c3&=WORD{a%+4}
contrpuntnorm(adrve1%,a1&)
IF sig&<0
c1&=-c1&
ENDIF
{adrve1%}={adrve1%}+WORD(SHR(c1&*xn&,15))
{adrve1%+4}={adrve1%+4}+WORD(SHR(c1&*yn&,15))
{adrve1%+8}={adrve1%+8}+WORD(SHR(c1&*zn&,15))
contrpuntnorm(adrve2%,a2&)
IF sig&<0
c2&=-c2&
ENDIF
{adrve2%}={adrve2%}+WORD(SHR(c2&*xn&,15))
{adrve2%+4}={adrve2%+4}+WORD(SHR(c2&*yn&,15))
{adrve2%+8}={adrve2%+8}+WORD(SHR(c2&*zn&,15))
contrpuntnorm(adrve3%,a3&)
IF sig&<0
c3&=-c3&
ENDIF
{adrve3%}={adrve3%}+WORD(SHR(c3&*xn&,15))
{adrve3%+4}={adrve3%+4}+WORD(SHR(c3&*yn&,15))
{adrve3%+8}={adrve3%+8}+WORD(SHR(c3&*zn&,15))
ENDIF
ADD adrvl%,16
NEXT a&
adrve1%=adrno%
adrve2%=adrve%+6
FOR a&=0 TO tot&-1
x0%=LONG{adrve1%}
y0%=LONG{adrve1%+4}
z0%=LONG{adrve1%+8}
~C:ltow%(L:V:x0%,L:V:y0%,L:V:z0%)
xn&=x0%
yn&=y0%
zn&=z0%
~C:normalwrd%(L:V:xn&,L:V:yn&,L:V:zn&)
WORD{adrve2%}=xn&
WORD{adrve2%+2}=yn&
WORD{adrve2%+4}=zn&
ADD adrve2%,12
ADD adrve1%,12
NEXT a&
'
adrvl%=adrvl1%   !contr puntnormaal voor shade
FOR a&=1 TO vlak&
a1&=WORD{adrvl%}
a2&=WORD{adrvl%+2}
a3&=WORD{adrvl%+4}
f0&=WORD{adrvl%+6}
f1&=WORD{adrvl%+8}
f2&=WORD{adrvl%+10}
a1%=adrve%+12*a1&+6
a2%=adrve%+12*a2&+6
a3%=adrve%+12*a3&+6
b1&=0
t%=f0&*WORD{a1%}+f1&*WORD{a1%+2}+f2&*WORD{a1%+4}
IF t%<0
b1&=1
ENDIF
t%=f0&*WORD{a2%}+f1&*WORD{a2%+2}+f2&*WORD{a2%+4}
IF t%<0
ADD b1&,2
ENDIF
t%=f0&*WORD{a3%}+f1&*WORD{a3%+2}+f2&*WORD{a3%+4}
IF t%<0
ADD b1&,4
ENDIF
BYTE{adrvl%+14}=b1&
ADD adrvl%,16
NEXT a&
'
ERASE z&()
freeblock(adrno%)
freeblock(adrco%)
IF pumanorm&
freeblock(adrpu%)
ENDIF
RETURN
> PROCEDURE normalenrender
pi.5=PI*0.5
s%=2^14
DIM z&(totvertren&+1)
adrco%=@allocblock(12+totvlakren&*6,&H10001)
pumanorm&=0
FOR a&=1 TO totvlakren&
adrvl%=@addface(a&-1)
adrve1%={adrvl%}
adrve2%={adrvl%+4}
adrve3%={adrvl%+8}
x1%={adrve1%}
y1%={adrve1%+4}
z1%={adrve1%+8}
x2%={adrve2%}
y2%={adrve2%+4}
z2%={adrve2%+8}
x3%={adrve3%}
y3%={adrve3%+4}
z3%={adrve3%+8}
x%=(x1%-x2%)/2
y%=(y1%-y2%)/2
z%=(z1%-z2%)/2
x2%=(x2%-x3%)/2
y2%=(y2%-y3%)/2
z2%=(z2%-z3%)/2
x3%=(x3%-x1%)/2
y3%=(y3%-y1%)/2
z3%=(z3%-z1%)/2
x1%=x%
y1%=y%
z1%=z%
~C:ltow%(L:V:x1%,L:V:y1%,L:V:z1%)
x1&=x1%
y1&=y1%
z1&=z1%
~C:ltow%(L:V:x2%,L:V:y2%,L:V:z2%)
x2&=x2%
y2&=y2%
z2&=z2%
~C:ltow%(L:V:x3%,L:V:y3%,L:V:z3%)
x3&=x3%
y3&=y3%
z3&=z3%
~C:normalwrd%(L:V:x1&,L:V:y1&,L:V:z1&)
~C:normalwrd%(L:V:x2&,L:V:y2&,L:V:z2&)
~C:normalwrd%(L:V:x3&,L:V:y3&,L:V:z3&)
c1&=SHR(x1&*x3&+y1&*y3&+z1&*z3&,15)
c2&=SHR(x1&*x2&+y1&*y2&+z1&*z2&,15)
c3&=SHR(x2&*x3&+y2&*y3&+z2&*z3&,15)
c1&=WORD{adraco%+512-2*WORD(SHR(c1&,7))}
c2&=WORD{adraco%+512-2*WORD(SHR(c2&,7))}
c3&=WORD{adraco%+512-2*WORD(SHR(c3&,7))}
WORD{adrco%+6*a&}=c1&
WORD{adrco%+6*a&+2}=c2&
WORD{adrco%+6*a&+4}=c3&
NEXT a&
FOR a&=1 TO totvertren&
adrve%=@addvert(a&-1)
{adrve%+18}=0  !hier komt tijdelijk puno
{adrve%+22}=0
{adrve%+26}=0
NEXT a&
a1&=0
a2&=0
a3&=0
FOR a&=1 TO totvlakren&
adrvl%=@addface(a&-1)
adrve1%={adrvl%}
adrve2%={adrvl%+4}
adrve3%={adrvl%+8}
x1%=({adrve1%}-{adrve2%})
x2%=({adrve2%}-{adrve3%})
y1%=({adrve1%+4}-{adrve2%+4})
y2%=({adrve2%+4}-{adrve3%+4})
z1%=({adrve1%+8}-{adrve2%+8})
z2%=({adrve2%+8}-{adrve3%+8})
calcnorm
sig&=1
xn&=-xn&
yn&=-yn&
zn&=-zn&
WORD{adrvl%+12}=xn&
WORD{adrvl%+14}=yn&
WORD{adrvl%+16}=zn&
svlak&=a&
ADD adrve1%,18
ADD adrve2%,18
ADD adrve3%,18
a%=adrco%+6*a&
c1&=WORD{a%}
c2&=WORD{a%+2}
c3&=WORD{a%+4}
contrpuntnorm(adrve1%,a1&)
IF sig&<0
c1&=-c1&
ENDIF
{adrve1%}={adrve1%}+WORD(SHR(c1&*xn&,15))
{adrve1%+4}={adrve1%+4}+WORD(SHR(c1&*yn&,15))
{adrve1%+8}={adrve1%+8}+WORD(SHR(c1&*zn&,15))
contrpuntnorm(adrve2%,a2&)
IF sig&<0
c2&=-c2&
ENDIF
{adrve2%}={adrve2%}+WORD(SHR(c2&*xn&,15))
{adrve2%+4}={adrve2%+4}+WORD(SHR(c2&*yn&,15))
{adrve2%+8}={adrve2%+8}+WORD(SHR(c2&*zn&,15))
contrpuntnorm(adrve3%,a3&)
IF sig&<0
c3&=-c3&
ENDIF
{adrve3%}={adrve3%}+WORD(SHR(c3&*xn&,15))
{adrve3%+4}={adrve3%+4}+WORD(SHR(c3&*yn&,15))
{adrve3%+8}={adrve3%+8}+WORD(SHR(c3&*zn&,15))
NEXT a&
FOR a&=0 TO totvertren&-1
adrve%=@addvert(a&)
x0%=LONG{adrve%+18}
y0%=LONG{adrve%+22}
z0%=LONG{adrve%+26}
~C:ltow%(L:V:x0%,L:V:y0%,L:V:z0%)
xn&=x0%
yn&=y0%
zn&=z0%
~C:normalwrd%(L:V:xn&,L:V:yn&,L:V:zn&)
WORD{adrve%+12}=xn&
WORD{adrve%+14}=yn&
WORD{adrve%+16}=zn&
NEXT a&
'
ERASE z&()
freeblock(adrco%)
RETURN
> PROCEDURE contrpuntnorm(g1%,g1&)
'
SWAP g1%,adr4%
SWAP g1&,a4&
'
sig&=1
IF z&(a4&)<>0
a%=adrpu%+12*a4&
x0%=LONG{a%}
y0%=LONG{a%+4}
z0%=LONG{a%+8}
' ~C:ltow1%(L:V:x0%,L:V:y0%,L:V:z0%)
inpr=xn&*x0%+yn&*y0%+zn&*z0%
IF inpr<0
sig&=-1
ENDIF
ELSE
x0%=LONG{adr4%}
y0%=LONG{adr4%+4}
z0%=LONG{adr4%+8}
~C:ltow1%(L:V:x0%,L:V:y0%,L:V:z0%)
x1&=x0%
y1&=y0%
z1&=z0%
inpr%=xn&*x1&+yn&*y1&+zn&*z1&
IF inpr%<0
sig&=-1
ENDIF
ENDIF
'
SWAP g1%,adr4%
SWAP g1&,a4&
'
RETURN
> PROCEDURE contrpuntnorm2(g1%)
SWAP g1%,adr4%
'
x1&=WORD{adr4%+12}
x2&=WORD{adr4%+14}
x3&=WORD{adr4%+16}
IF f0&*x1&+f1&*x2&+f2&*x3&<0
WORD{adr4%+12}=-x1&
WORD{adr4%+14}=-x2&
WORD{adr4%+16}=-x3&
ENDIF
'
SWAP g1%,adr4%
RETURN
> PROCEDURE calcnorm
~C:ltow2%(6,1,L:V:x1%,L:V:y1%,L:V:z1%,L:V:x2%,L:V:y2%,L:V:z2%)
x1&=x1%
y1&=y1%
z1&=z1%
x2&=x2%
y2&=y2%
z2&=z2%
xn%=y1&*z2&-z1&*y2&
yn%=z1&*x2&-x1&*z2&
zn%=x1&*y2&-y1&*x2&
~C:ltow%(L:V:xn%,L:V:yn%,L:V:zn%)
xn&=xn%
yn&=yn%
zn&=zn%
~C:normalwrd%(L:V:xn&,L:V:yn&,L:V:zn&)
RETURN
> PROCEDURE herberekennorm
okee("RECALC NORMALS")
IF a%<>0
base%=firstbase%
WHILE base%
IF lay& AND WORD{base%+b.l&}
IF BYTE{base%+b.f&} AND 1
IF WORD{base%+4}=1
ob%={base%+b.d&}
IF ob%
vv%={ob%}
IF vv%
tot&={vv%}
vlak&={vv%+4}
adrve%=vv%+32
adrvl%=vv%+32+12*tot&
normalen
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
base%={base%}
WEND
ENDIF
RETURN
> PROCEDURE addedge(a1&,a2&)
t&=0
IF edv&(a1&,0)=a2&
t&=-1
ELSE IF edv&(a1&,1)=a2&
t&=-1
ELSE IF edv&(a1&,2)=a2&
t&=-1
ELSE IF edv&(a2&,0)=a1&
t&=-1
ELSE IF edv&(a2&,1)=a1&
t&=-1
ELSE IF edv&(a2&,2)=a1&
t&=-1
ENDIF
IF t&=0
IF edv&(a1&,0)=-2
edv&(a1&,0)=a2&
ELSE IF edv&(a1&,1)=-2
edv&(a1&,1)=a2&
ELSE IF edv&(a1&,2)=-2
edv&(a1&,2)=a2&
ELSE IF edv&(a2&,0)=-2
edv&(a2&,0)=a1&
ELSE IF edv&(a2&,1)=-2
edv&(a2&,1)=a1&
ELSE IF edv&(a2&,2)=-2
edv&(a2&,2)=a1&
ENDIF
ENDIF
RETURN
'
ENDFUNC
'
FUNCTION funkties
> PROCEDURE activatewindow(wi%)
IF wi%
IF {_IntBase+52}<>wi%
IF WINDOW({_IntBase+52})
IF WINDOW({_IntBase+52})<>8
~ActivateWindow(wi%)
ENDIF
ENDIF
ENDIF
ENDIF
RETURN
> PROCEDURE seta1a2a3(g1&)
adrvl%=blovl%(SHR(g1&,8))+m28&(g1& AND 255)
adrve1%={adrvl%}
adrve2%={adrvl%+4}
adrve3%={adrvl%+8}
RETURN
> PROCEDURE mplot(x%,y%,k%)
plotreg%(0)=x%
plotreg%(1)=y%
plotreg%(7)=k%
RCALL machplot%+32,plotreg%()
RETURN
> PROCEDURE rastplot(wi%)
wi%=WINDOW(wi%)
IF wi%
plotreg%(8)={{wi%+50}+4}
ELSE
plotreg%(8)=0
ENDIF
RETURN
> PROCEDURE sluitwin(g1%)
'
SWAP g1%,a%
'
OPENS 1
IF a%=4
IF WINDOW(4)
BMOVE adrtex%(0),wtex%,152
IF {WINDOW(4)+120}
freeblock({WINDOW(4)+120})
ENDIF
CLOSEW #4
IF WINDOW(3)
OPENW #3
activatewindow(WINDOW(3))
ENDIF
copkleur
ENDIF
ELSE IF a%=3
IF WINDOW(3)
IF {WINDOW(3)+120}
freeblock({WINDOW(3)+120})
ENDIF
CLOSEW #3
ENDIF
OPENW #1
activatewindow(WINDOW(1))
copkleur
IF maino&=5
briconsat
ENDIF
ENDIF
'
SWAP g1%,a%
'
RETURN
> PROCEDURE freeblock(adres%)
IF {adres%-4}=CVL("BLCK") OR {adres%+12}=CVL("BLCK")
IF {adres%-4}=CVL("BLCK")
block%=adres%-16
ELSE
block%=adres%
ENDIF
nextblock%={block%}
prevblock%={block%+4}
IF nextblock%=0
' lastblock
IF prevblock%
{prevblock%}=0
ELSE
firstblock%=0
ENDIF
lastblock%=prevblock%
ELSE IF prevblock%=0
' firstblock
IF nextblock%
{nextblock%+4}=0
ENDIF
firstblock%=nextblock%
ELSE
{prevblock%}=nextblock%
{nextblock%+4}=prevblock%
ENDIF
{block%+12}=CVL("FREE")
~FreeMem(block%,{block%+8})
ELSE
okee("No Block!")
ENDIF
RETURN
> PROCEDURE freelist(g2%,g1%)
$F%
LOCAL g1&,g3%,g4%
'            freelist(lstbase%,node%)
SWAP g1%,point%
SWAP g2%,lstbase%
SWAP g4%,point2%
'
IF {point%+4}<>CVL("FREE")
point2%={lstbase%}
g3%={point2%+8}               ! einde
WHILE point2%
EXIT IF point%>point2% AND point%<g3%
point2%={point2%}
g3%={point2%+8}
WEND
IF point2%
g3%=point2%
g1&=CARD{lstbase%+14}
ADD point2%,16
point2%=point%-point2%
g1&=point2% MOD g1&
IF g1&=0
IF CARD{lstbase%+16} AND 1
point2%=lstbase%+8
WHILE {point2%}<>point%
point2%={point2%}
EXIT IF point2%=0
WEND
IF point2%
{point2%}={point%}          ! uit gebruikte lijst halen
ELSE
okee("List corrupt!")
ENDIF
ENDIF
point2%=g3%
{point%+4}=CVL("FREE")
{point%}={point2%+4}            ! in vrije lijst hangen
{point2%+4}=point%
'
CARD{point2%+14}=CARD{point2%+14}-1
'
IF CARD{point2%+14}=0           ! helemaal vrij !
point%=lstbase%
WHILE {point%}<>point2%
point%={point%}
WEND
{point%}={point2%}
freeblock(point2%)
ENDIF
ELSE
point2%=0
ENDIF
ENDIF
IF point2%=0
okee("No Node!")
ENDIF
ELSE
okee("Node free twice!")
ENDIF
'
SWAP g4%,point2%
SWAP g2%,lstbase%
SWAP g1%,point%
RETURN
> PROCEDURE endlist(g1%)
LOCAL g2%
SWAP g1%,lstbase%
SWAP g2%,point%
IF g1%
WHILE {lstbase%}
point%={lstbase%}
{lstbase%}={point%}
freeblock(point%)
WEND
freeblock(lstbase%)
ENDIF
SWAP g2%,point%
SWAP g1%,lstbase%
RETURN
> PROCEDURE leesflags(g1%)
qf&=BTST(BYTE{g1%+b.f&+1},0)
qo&=BTST(BYTE{g1%+b.f&+1},1)
qm&=0
IF BTST(BYTE{g1%+b.f&+1},2)
qm&=1
ELSE IF BTST(BYTE{g1%+b.f&+1},3)
qm&=2
ENDIF
mo&=BTST(BYTE{g1%+b.f&+1},4)
mm&=0
IF BTST(BYTE{g1%+b.f&+1},5)
mm&=1
ELSE IF BTST(BYTE{g1%+b.f&+1},6)
mm&=2
ENDIF
lm&=BTST(BYTE{g1%+b.f&+1},7)
RETURN
> PROCEDURE setshadevars(g1%)
SWAP g1%,a%
'
adrcol%=a%
ro&=BYTE{a%}
gr&=BYTE{a%+1}
bl&=BYTE{a%+2}
viewmode&=BYTE{a%+3} AND 1
shadob&=BTST(BYTE{a%+3},3)
shless&=BTST(BYTE{a%+3},4)
env&=BTST(BYTE{a%+3},5)
kshade&=BYTE{a%+4}
kspec&=BYTE{a%+5}
spec&=BYTE{a%+6}
tran&=BYTE{a%+7}
mirr&=BYTE{a%+8}
ang&=BYTE{a%+9}
spro&=BYTE{a%+11}
spgr&=BYTE{a%+12}
spbl&=BYTE{a%+13}
miro&=BYTE{a%+14}
migr&=BYTE{a%+15}
mibl&=BYTE{a%+16}
texco&=BYTE{a%+17}
speclimit&=WORD{a%+20}
ambr&=SHL(BYTE{a%+22},7)
ambg&=SHL(BYTE{a%+23},7)
ambb&=SHL(BYTE{a%+24},7)
snfl&=BYTE{a%+25}
olay&=WORD{a%+c.l&}
'
SWAP g1%,a%
RETURN
> PROCEDURE initnoise
RANDOMIZE 120120
FOR a&=0 TO 255
BYTE{hash%+a&}=a&
NEXT a&
FOR a&=0 TO 255
b&=RAND(256)
c&=BYTE{hash%+b&}
BYTE{hash%+b&}=BYTE{hash%+a&}
BYTE{hash%+a&}=c&
NEXT a&
a%=hash%+256
FOR a&=0 TO 255
DO
x&=RAND(65535)
y&=RAND(65535)
z&=RAND(65535)
t&=x&
~C:normalwrd%(L:V:x&,L:V:y&,L:V:z&)
LOOP UNTIL ABS(x&)>ABS(t&)
WORD{a%}=x&
WORD{a%+2}=y&
WORD{a%+4}=z&
ADD a%,6
NEXT a&
RETURN
> PROCEDURE hashvec(gx&,gy&,gz&)
hx&=gz& AND 255
hx&=BYTE{hash%+hx&}
ADD hx&,gy&
hx&=hx& AND 255
hx&=BYTE{hash%+hx&}
ADD hx&,gx&
hx&=hx& AND 255
hx&=256+6*BYTE{hash%+hx&}
hz&=WORD{hash%+hx&+4}
hy&=WORD{hash%+hx&+2}
hx&=WORD{hash%+hx&}
RETURN
> PROCEDURE wordruimte(g1%)
a%=MAX({g1%+v.2&},{g1%+v.2&+4},{g1%+v.2&+8})
fac=32767
fac=fac/a%
SINGLE{g1%+v.4&}=1/fac
v&={g1%}
adrve%=g1%+32
FOR a&=1 TO v&
WORD{adrve%}=fac*{adrve%}
WORD{adrve%+2}=fac*{adrve%+4}
WORD{adrve%+4}=fac*{adrve%+8}
ADD adrve%,12
NEXT a&
RETURN
'
ENDFUNC
RBOX iff
> PROCEDURE checkiff(point%)
start%=point%
CLR bmhd%,cmap%,body%,camg%
form$=MKL$({ADD(point%,8)})
IF (form$="ILBM") OR (form$="ANIM")
IF form$="ANIM"
ADD point%,12
ENDIF
ADD point%,12
find_camg(point%)
'
WHILE NOT (point%>=start%+memlen%) OR (bmhd%<>0 AND body%<>0)
check_chunk
WEND
'
ENDIF
RETURN
> PROCEDURE check_chunk
len%={ADD(point%,4)}
ADD point%,8
SELECT MKL$({SUB(point%,8)})
CASE "BMHD"
bmhd%=point%
picw&=CARD{point%}
pich&=CARD{ADD(point%,2)}
picd&=BYTE{ADD(point%,8)}
picc&=BYTE{ADD(point%,10)}
CASE "CMAP"
cmap%=point%
CASE "BODY"
body%=point%
ENDSELECT
ADD point%,len%+(len% AND 1)
RETURN
> PROCEDURE getpalette(file$)
LOCAL g1%,g2%,g1&,g2&
IF LEN(file$)
dosfile$=file$+CHR$(0)
handle%=Open(V:dosfile$,1005)
IF handle%
g1%=@allocblock(256,&H1)
IF g1%
~Read(handle%,g1%,12)
IF {g1%}=CVL("FORM") AND ({g1%+8}=CVL("ILBM") OR {g1%+8}=CVL("ANIM") OR {g1%+8}=CVL("TRA1"))
IF {g1%+8}<>CVL("ILBM")
~Read(handle%,g1%,12)
ENDIF
WHILE Read(handle%,g1%,8)=8 AND g1&=0
IF {g1%}<>CVL("CMAP")
EXIT IF Seek(handle%,{g1%+4},0)=-1
ELSE
g2&={g1%+4}
IF g2&>256
g2&=256
ENDIF
~Read(handle%,g1%,g2&)
g2&=g2&/3
IF g2&>16
g2&=16
ENDIF
g2%=g1%
FOR g1&=0 TO g2&-1
col&(g1&,0)=SHR(BYTE{g2%},4)
col&(g1&,1)=SHR(BYTE{g2%+1},4)
col&(g1&,2)=SHR(BYTE{g2%+2},4)
ADD g2%,3
NEXT g1&
ENDIF
WEND
ENDIF
freeblock(g1%)
ELSE
okee("Not enough memory")
ENDIF
~Close(handle%)
CLR handle%
IF g1&=0
okee("Couldn't get palette")
ENDIF
ELSE
okee("Couldn't open file")
ENDIF
ENDIF
RETURN
> PROCEDURE schrijfiff(naam$,scherm&)
IF SCREEN(scherm&) OR scherm&<0
naam$=naam$+CHR$(0)
IF scherm&<>-3                      ! append: waardes niet verandern
si_reg%(1)=V:naam$
si_reg%(2)=0
si_reg%(3)=_DosBase
ENDIF
IF scherm&>-1
si_reg%(0)=SCREEN(scherm&)
RCALL schrijfiff%,si_reg%()
ELSE IF scherm&=-1                  ! buffer in een keer wegschrijven
si_reg%(0)=s24%
RCALL schrijfiff%,si_reg%()
ELSE IF scherm&=-2                  ! open buffer
si_reg%(0)=s24%
si_reg%(2)=1
RCALL schrijfiff%,si_reg%()
IF si_reg%(0)<>0                   ! error
okee("Can't write buffer")
afbreek&=-1
ENDIF
ELSE IF scherm&=-3                  ! append buffer
IF si_reg%(0)=0                   ! geen error geweest
RCALL schrijfpart%,si_reg%()
IF si_reg%(0)<>0
okee("Can't write buffer")
afbreek&=-1
ENDIF
ENDIF
ENDIF
ENDIF
RETURN
> PROCEDURE exit
exit!=TRUE
RETURN
> PROCEDURE inl_load(adres%,len%)
inl$="ram:rt.inl"
FRONTS 0
OPENS 0
FILESELECT "Load inline","Load","ram:",inl$
inl$=inl$+CHR$(0)
inlhandle%=Open(V:inl$,1005)
IF inlhandle%
~Read(inlhandle%,adres%,len%)
~Close(inlhandle%)
inlhandle%=0
ENDIF
RETURN
> PROCEDURE laadinl(memiff%,venster%)
IF MKL$(LPEEK(memiff%))<>"FORM"
PRINT "Geen IFF-file"
ELSE
@haaladressen(venster%)
reg%(9)=memiff%
reg%(8)=bitmap%
reg%(14)=iiffbase%
RCALL iiffbase%-60,reg%()
IF reg%(0)=0
sluit
ENDIF
ENDIF
RETURN
> PROCEDURE haaladressen(venster%)
rastp%=LPEEK(WINDOW(venster%)+50)
bitmap%=LPEEK(rastp%+4)
vp%=LPEEK(WINDOW(venster%)+46)+44
cmap%=LPEEK(vp%+4)
ctable%=LPEEK(cmap%+4)
RETURN
'
ENDFUNC
RBOX spline2d
'
> PROCEDURE splinemenu
busy2d&=TRUE
IF menu1%=&H200                ! closew
IF win&=8
IF lst2d%
s2dwrite
endlist(lst2d%)
ENDIF
REPEAT
waitsignal(0)
UNTIL ret&=FALSE
CLOSEW #8
CLR wi2d%,lst2d%,adr2d%,dist2d%,key2d%
ENDIF
ELSE
IF wi2d%
IF basact% AND WORD{basact%+4}=-2         ! moet eigenlijk controleren
'                                       ! op uberhaupt 'n spline
ob%={basact%+b.d&}
IF {ob%}
'
IF adr2d%<>ob%+4                      ! ander splineadres
IF adr2d%
s2dwrite
ENDIF
adr2d%=ob%+4
dist2d%=ob%+m.fd&
key2d%=ob%+m.pd&
base2d%=basact%
s2dread
redraw2d
ENDIF
'
IF BYTE{{key2d%}+2} AND 1          ! er is iets veranderd
redraw2d
ENDIF
'
' PRINT HEX$(menu1%,8)
SELECT menu1%
CASE &H4                    ! refresh
redraw2d
CASE 8                      ! muis
IF MOUSEK=2
IF (WORD{wi2d%+12} OR WORD{wi2d%+14})>0
IF WORD{wi2d%+12}<=WORD{wi2d%+10}
IF WORD{wi2d%+14}<=WORD{wi2d%+8}
nearest2d
IF handle&
handle2d
ENDIF
WHILE MOUSEK=2
waitsignal(1)
WEND
ENDIF
ENDIF
ENDIF
ENDIF
CASE &H400                  ! toets
' menu1%=0
ENDSELECT
ENDIF
ELSE
IF menu1%<>&H80000               ! ongelijk deactivate
~ActivateWindow(WINDOW(1))
ENDIF
ENDIF
ENDIF
ENDIF
busy2d&=FALSE
RETURN
> PROCEDURE s2dwrite
'
IF flags2d& AND &H1                   ! spline is veranderd
IF lst2d%
point%=@allocblock(np2d&*s.2ds&+s.2bs&,&H1)
IF point%
IF {adr2d%}                       ! eigenlijk moet gecontroleerd worden of object nog bestaat
freeblock({adr2d%})
ENDIF
{adr2d%}=point%
'
CARD{point%}=np2d&
'
flags2d&=flags2d& AND NOT 1
CARD{point%+2}=flags2d&
'
{point%+4}={wi2d%+4}
{point%+8}={wi2d%+8}
WORD{point%+12}=sx2d&
WORD{point%+14}=sy2d&
'
point2%=point%+s.2bs&
point%={lst2d%+8}
'
FOR b1&=1 TO np2d&
BMOVE point%+4,point2%,s.2ds&
point%={point%}
IF (point%=0) XOR (b1&=np2d&) ! point% moet alleen 0 zijn bij laatste
okee("Error in list!")
point%={lst2d%+8}
WHILE point%
PRINT point%
point%={point%}
WEND
ENDIF
ADD point2%,s.2ds&
NEXT b1&
makedist2d
base%=base2d%
rekenpad(8)
ELSE
okee("Couldn't write spline!")
ENDIF
ENDIF
ENDIF
'
RETURN
> PROCEDURE s2dread
LOCAL g1%,g2%
SWAP g1%,point%
SWAP g2%,point2%
IF lst2d%
endlist(lst2d%)
ENDIF
lst2d%=@startlist(10,s.2ds&,&H1,1)
IF lst2d%
point%={adr2d%}
'
IF point%
'
np2d&=CARD{point%}
flags2d&=CARD{point%+2}
sx2d&=WORD{point%+12}
sy2d&=WORD{point%+14}
'
ADD point%,s.2bs&
FOR b1&=1 TO np2d&
point2%=@insertlist(lst2d%,-1)
EXIT IF point2%=0
BMOVE point%,point2%,s.2ds&
ADD point%,s.2ds&
NEXT b1&
IF point2%=0
endlist(lst2d%)
CLR lst2d%
ENDIF
ELSE
point%=@insertlist(lst2d%,-1)
point2%=@insertlist(lst2d%,-1)
'
FOR b1&=s.2ds&-2 TO 0 STEP -2
WORD{point%+b1&}=0
NEXT b1&
{point%+8}=-21845             ! -1/3
{point%+12}=-21845
{point%+24}=21845
{point%+28}=21845
'
BMOVE point%,point2%,s.2ds&
'
{point%+16}=-1
{point%+20}=0
'
{point2%+16}=65536
{point2%+20}=65535
'
np2d&=2
flags2d&=0
sx2d&=0
sy2d&=0
ENDIF
ap2d&=1
'
ENDIF
IF lst2d%=0
okee("Not enough memory")
ENDIF
SWAP g1%,point%
SWAP g2%,point2%
RETURN
> PROCEDURE fit2d
b1&=CARD{{key2d%}+10}                  ! aantal frames
b2&=CARD{wi2d%+8}-30                 ! breedte venster
b2&=b2&/b1&
IF b2&<3
b2&=3
ENDIF
'
w2d&=b1&*b2&
h2d&=CARD{wi2d%+10}-28
'
sx2d=w2d&/65536
sy2d=(h2d&-5)/65536
'
ox2d&=SHR(CARD{wi2d%+8}-30,1)
oy2d&=h2d&/2
'
ox2d%=32768
oy2d%=32768
RETURN
> PROCEDURE makedist2d
LOCAL g1%,g2%
'
SWAP g1%,point%
SWAP g2%,point2%
'
IF dist2d%<>0 AND {key2d%}
frames&=CARD{{key2d%}+10}
ddist=frames&/65535
'
point%=@allocblock(6+4*frames&,&H10001)
IF point%
IF {dist2d%}
freeblock({dist2d%})
ENDIF
{dist2d%}=point%
CARD{point%}=frames&
ADD point%,2
point2%={adr2d%}+s.2bs&
'
OPENW #1
FOR a&=2 TO np2d&
'
x1%={point2%+16}
x2%={point2%+24}
y1%={point2%+20}
y2%={point2%+28}
'
ADD point2%,s.2ds&
'
x4%={point2%+16}
x3%={point2%+8}
y4%={point2%+20}
y3%={point2%+12}
bezier(x1%,x2%,x3%,x4%,xmem%)
bezier(y1%,y2%,y3%,y4%,ymem%)
'
x%=xmem%
y%=ymem%
x1%={x%}
y1%={y%}
'
x1=x1%*ddist                    ! x1 is floatframe
x1&=INT(x1)
'
ADD x%,4
ADD y%,4
'
FOR b&=1 TO points&
x2%={x%}
y2%={y%}
x2=x2%*ddist
x2&=INT(x2)
'
ADD x%,4
ADD y%,4
'
IF x2%>x1%                    ! vooruit in de tijd
IF x1&<>x2&                 ! over een frame heen
dx=(y2%-y1%)/(x2-x1)
WHILE x1&<>x2&
xn&=x1&+1
IF xn&>=0 AND xn&<=frames&  ! binnen bereik
SINGLE{point%+4*xn&}=y1%+(xn&-x1)*dx
' PRINT xn&,SINGLE{point%+4*xn&}
ENDIF
x1&=xn&
WEND
ENDIF
ELSE
~DisplayBeep(0)
ENDIF
'
x1%=x2%
y1%=y2%
x1&=x2&
x1=x2
NEXT b&
'
NEXT a&
'
ELSE
okee("Couldn't make disttab!")
ENDIF
ENDIF
'
SWAP g2%,point2%
SWAP g1%,point%
RETURN
> PROCEDURE makedist2dext(g1%)
LOCAL g2%,g3%,g4%,g1&
'
SWAP g2%,dist2d%
SWAP g3%,key2d%
SWAP g4%,adr2d%
SWAP g1&,np2d&
'
adr2d%=g1%+4
dist2d%=g1%+m.fd&
key2d%=g1%+m.pd&
np2d&=CARD{{adr2d%}}
'
makedist2d
'
SWAP g1&,np2d&
SWAP g4%,adr2d%
SWAP g3%,key2d%
SWAP g2%,dist2d%
RETURN
> PROCEDURE initfloats(g1%,g2%)
SWAP g1%,point%
SWAP g2%,point2%
'
z0={point%+16}+{point%+24}
z1={point2%+16}+{point2%+8}
z2={point2%+16}
'
x0={point%+16}
x1=3*(-x0+z0)
x2=3*(x0-2*z0+z1)
x3=-x0+3*(z0-z1)+z2
'
z0={point%+20}+{point%+28}
z1={point2%+20}+{point2%+12}
z2={point2%+20}
'
y0={point%+20}
y1=3*(-y0+z0)
y2=3*(y0-2*z0+z1)
y3=-y0+3*(z0-z1)+z2
'
x%=ABS({point%+24})+ABS({point2%+8})  ! x% is lengte spline in de x-richting
ADD x%,ABS({point%+16}+{point%+24}-{point2%+16}-{point2%+8})
dx=x%/ddist
'
SWAP g2%,point2%
SWAP g1%,point%
RETURN
> PROCEDURE redraw2d
IF {key2d%}
fit2d
'
OPENW #8
PLOT 0,0
CLEARW #8
'
COLOR 1
'
b1&=CARD{{key2d%}+10}                  ! aantal frames
persp2d(0,0)
b3&=x&
b2&=w2d&/b1&
'
FOR a&=0 TO b1&
IF b3&>0 AND b3&<640
b5&=a& MOD 10
IF b5&=0
a$=STR$(a&)
TEXT b3&-8,h2d&+12,LEFT$(a$,1)
TEXT b3&+1,h2d&+12,RIGHT$(a$,LEN(a$)-1)
LINE b3&,h2d&,b3&,h2d&+10
ELSE IF b5&=5
LINE b3&,h2d&,b3&,h2d&+5
ELSE
LINE b3&,h2d&,b3&,h2d&+3
ENDIF
ENDIF
ADD b3&,b2&
NEXT a&
'
point%={key2d%}+16
'
persp2d(0,0)
b1&=x&
persp2d(65536,0)
b2&=x&
'
temp=65536/SINGLE{{key2d%}+6}
totlen=0
IF y&>0 AND y&<512
LINE b1&,y&,b2&,y&
LINE b1&,y&+1,b2&,y&+1
IF b1&>12
TEXT b1&-12,y&+3,0
ELSE
TEXT 0,y&+3,0
ENDIF
ENDIF
b3&=0
ADD b3&,1
'
WHILE CARD{point%}
ADD totlen,SINGLE{point%+4}
persp2d(0,totlen*temp+0.5)
IF y&>0 AND y&<512
LINE b1&,y&,b2&,y&
LINE b1&,y&+1,b2&,y&+1
IF b1&>12
TEXT b1&-12,y&+3,b3&
ELSE
TEXT 0,y&+3,b3&
ENDIF
ENDIF
ADD b3&,1
ADD point%,8
WEND
'
teken2d(1,np2d&-1,3)
drawact2d(2,3)
'
BYTE{{key2d%}+2}=BYTE{{key2d%}+2} AND NOT 1          ! roger
ENDIF
RETURN
> PROCEDURE persp2d(g1%,g2%)
x&=ox2d&+sx2d*(g1%-ox2d%)+0.5
y&=oy2d&-sy2d*(g2%-oy2d%)+0.5
RETURN
> PROCEDURE perspinv2d(g1&,g2&)
x%=ox2d%+INT((g1&-ox2d&)/sx2d+0.5)
y%=oy2d%-INT((g2&-oy2d&)/sy2d+0.5)
RETURN
> PROCEDURE teken2d(g1&,g2&,g3&)
LOCAL g1%,g2%,g3%
SWAP g2%,x%
SWAP g3%,y%
'
OPENW #8
COLOR g3&
'
g1%=@findlist(lst2d%,g1&)
IF g1%
SUB g1%,4
IF {g1%}
FOR b1&=g1& TO g2&
reken2d(g1%)
'
x%=xmem%
y%=ymem%
FOR b2&=0 TO points&
x&={x%}
y&={y%}
IF b2&
PLOT x&,y&
PLOT x&,y&+1
ELSE
PBOX x&-1,y&-1,x&+1,y&+1
ENDIF
ADD x%,4
ADD y%,4
NEXT b2&
'
g1%={g1%}
NEXT b1&
PBOX x&-1,y&-1,x&+1,y&+1
ENDIF
ENDIF
'
SWAP g3%,y%
SWAP g2%,x%
RETURN
> PROCEDURE drawact2d(col1&,col2&)
LOCAL g1%,g1&,g2&
g1%=@findlist(lst2d%,ap2d&)
OPENW #8
IF g1%
persp2d({g1%+16},{g1%+20})
g1&=x&
g2&=y&
'
COLOR col1&
persp2d({g1%+16}+{g1%+8},{g1%+20}+{g1%+12})
LINE x&,y&,g1&,g2&
PBOX x&-1,y&-1,x&+1,y&+1
'
persp2d({g1%+16}+{g1%+24},{g1%+20}+{g1%+28})
LINE x&,y&,g1&,g2&
PBOX x&-1,y&-1,x&+1,y&+1
'
COLOR col2&
PBOX g1&-1,g2&-1,g1&+1,g2&+1
ENDIF
RETURN
> PROCEDURE reken2d(g1%)
SWAP g1%,point%
'
ADD point%,4
'
persp2d({point%+16},{point%+20})
x1&=x&
y1&=y&
persp2d({point%+16}+{point%+24},{point%+20}+{point%+28})
x2&=x&
y2&=y&
point%={point%-4}+4
'
persp2d({point%+16}+{point%+8},{point%+20}+{point%+12})
x3&=x&
y3&=y&
persp2d({point%+16},{point%+20})
'
~C:bezier%(x1&,x2&,x3&,x&,resol&,L:xmem%,L:0,0)
~C:bezier%(y1&,y2&,y3&,y&,resol&,L:ymem%,L:0,0)
'
SWAP g1%,point%
RETURN
> PROCEDURE nearest2d
LOCAL g1%,g2%
SWAP point%,g2%
'
drawact2d(0,3)
dpo&=ap2d&
OPENW #8
xm&=MOUSEX
ym&=MOUSEY
'
mafst%=100
g1%=@findlist(lst2d%,ap2d&)
'
IF g1%
persp2d({g1%+16}+{g1%+8},{g1%+20}+{g1%+12})
mafst%=(xm&-x&)^2+(ym&-y&)^2
handle&=-1
persp2d({g1%+16}+{g1%+24},{g1%+20}+{g1%+28})
temp%=(xm&-x&)^2+(ym&-y&)^2
IF temp%<mafst%
mafst%=temp%
handle&=1
ENDIF
ENDIF
IF mafst%>30
mafst%=1000000
ap2d&=0
b&=1
point%={lst2d%+8}
WHILE point%
persp2d({point%+16+4},{point%+20+4})
temp%=(xm&-x&)^2+(ym&-y&)^2
IF temp%<mafst%
mafst%=temp%
ap2d&=b&
ENDIF
ADD b&,1
point%={point%}
WEND
handle&=FALSE
ENDIF
drawact2d(2,3)
'
SWAP point%,g2%
RETURN
> PROCEDURE handle2dnieuw
LOCAL g1%
'
OPENW #8
LOCATE 1,2
PRINT handle&
SWAP point%,g1%
point%=@findlist(lst2d%,ap2d&)
IF point%
hxo1%={point%+8}
hyo1%={point%+12}
hxo2%={point%+24}
hyo2%={point%+28}
'
afsto=SQR(hxo1%^2+hyo1%^2)
IF afsto=0
afsto=1
ENDIF
afstn=SQR(hxo2%^2+hyo2%^2)
IF afstn=0
afstn=1
ENDIF
'
perspinv2d(MOUSEX,MOUSEY)
hzo1%=x%
hzo2%=y%
'
IF start&<1
start&=1
ENDIF
IF eind&>=np2d&
eind&=np2d&-1
ENDIF
'
WHILE MOUSEK=2
teken2d(start&,eind&,0)
drawact2d(0,0)
'
perspinv2d(MOUSEX,MOUSEY)
IF menu3% AND 3
IF handle&=1
{point%+8}={point%+8}+x%-hzo1%
{point%+12}={point%+12}+y%-hzo2%
ELSE
{point%+24}={point%+24}+(x%-hzo1%)
{point%+28}={point%+28}+(y%-hzo2%)
ENDIF
ELSE
IF handle&=1
{point%+8}={point%+8}-(x%-hzo1%)
{point%+12}={point%+12}-(y%-hzo2%)
'
{point%+24}={point%+24}+(x%-hzo1%)*afstn/afsto
{point%+28}={point%+28}+(y%-hzo2%)*afstn/afsto
ELSE
{point%+8}={point%+8}+(x%-hzo1%)*afsto/afstn
{point%+12}={point%+12}+(y%-hzo2%)*afsto/afstn
'
{point%+24}={point%+24}-(x%-hzo1%)
{point%+28}={point%+28}-(y%-hzo2%)
ENDIF
ENDIF
'
hzo1%=x%
hzo2%=y%
'
IF menu1%=&H400
IF menu2%=&H21
IF menu3% AND 3
lscale=1
ELSE
gscale=1
ENDIF
ELSE IF menu2%=&H13
IF menu3% AND 3
lhoek=0
ELSE
ghoek=0
ENDIF
ENDIF
ENDIF
start&=ap2d&-1
eind&=ap2d&
'
teken2d(start&,eind&,3)
drawact2d(2,3)
waitsignal(1)
WEND
IF MOUSEK=3
{point%+8}=hxo1%
{point%+12}=hyo1%
{point%+24}=hxo2%
{point%+28}=hyo2%
teken2d(b1&,b2&,3)
drawact2d(2,3)
ELSE
flags2d&=flags2d& OR 1
ENDIF
ENDIF
SWAP point%,g1%
RETURN
> PROCEDURE handle2d
LOCAL g1%
'
OPENW #8
SWAP point%,g1%
point%=@findlist(lst2d%,ap2d&)
IF point%
LOCATE 1,2
persp2d({point%+16},{point%+20})
xc&=x&
yc&=y&
yn&=MOUSEY
xn&=MOUSEX
ghoek=0
gscale=1
lhoek=0
lscale=1
dx2&=xn&-xc&
dy2&=yn&-yc&
hxo1%={point%+8}
hyo1%={point%+12}
hxo2%={point%+24}
hyo2%={point%+28}
afsto=SQR(dx2&*dx2&+dy2&*dy2&)
IF afsto<>0
WHILE MOUSEK=2
dx1&=dx2&
dy1&=dy2&
x&=MOUSEX
y&=MOUSEY
'
dx2&=x&-xc&
dy2&=y&-yc&
afstn=SQR(dx2&*dx2&+dy2&*dy2&)
xn&=x&
yn&=y&
deler=SQR((dx1&^2+dy1&^2)*(dx2&^2+dy2&^2))
IF deler<>0
choek=(dx1&*dx2&+dy1&*dy2&)/deler
dhoek=DEG(ACOS(choek)*SGN(dx1&*dy2&-dx2&*dy1&))
'
IF menu3% AND 3
lhoek=lhoek+dhoek
IF (afsto<>0) AND (afstn<>0)
lscale=lscale*afstn/afsto
afsto=afstn
ENDIF
ELSE
ghoek=ghoek+dhoek
IF (afsto<>0) AND (afstn<>0)
gscale=gscale*afstn/afsto
afsto=afstn
ENDIF
ENDIF
'
IF menu1%=&H400
IF menu2%=&H21
IF menu3% AND 3
lscale=1
ELSE
gscale=1
ENDIF
ELSE IF menu2%=&H13
IF menu3% AND 3
lhoek=0
ELSE
ghoek=0
ENDIF
ENDIF
ENDIF
' global
start&=ap2d&-1
eind&=ap2d&
'
IF start&<1
start&=1
ENDIF
IF eind&>=np2d&
eind&=np2d&-1
ENDIF
si=SINQ(ghoek)*gscale
co=COSQ(ghoek)*gscale
teken2d(start&,eind&,0)
drawact2d(0,0)
'
hx1=hxo1%*co+si*hyo1%
hy1=-hxo1%*si+co*hyo1%
'
hx2=hxo2%*co+si*hyo2%
hy2=-hxo2%*si+co*hyo2%
'
' local
IF (lhoek<>0) OR (lscale<>1)
si=SINQ(lhoek)*lscale
co=COSQ(lhoek)*lscale
IF handle&=-1
temp=hx1
hx1=hx1*co-si*hy1
hy1=temp*si+co*hy1
ELSE
temp=hx2
hx2=hx2*co-si*hy2
hy2=temp*si+co*hy2
ENDIF
ENDIF
'
{point%+8}=hx1
{point%+12}=hy1
{point%+24}=hx2
{point%+28}=hy2
'
teken2d(start&,eind&,3)
drawact2d(2,3)
ENDIF
waitsignal(1)
WEND
IF MOUSEK=3
{point%+8}=hxo1%
{point%+12}=hyo1%
{point%+24}=hxo2%
{point%+28}=hyo2%
teken2d(b1&,b2&,3)
drawact2d(2,3)
ELSE
flags2d&=flags2d& OR 1
ENDIF
ENDIF
ENDIF
SWAP point%,g1%
RETURN
ENDFUNC
RBOX animatie
> PROCEDURE rekenpad(g1&)
'
' 1 is tekenen
' 2 is berekenen 3dspline
' 4 is berekenen 2dspline
' 8 is samenvoegen
'
IF WORD{base%+4}=-2
IF {base%+b.d&}
ob%={base%+b.d&}
IF {ob%}  !er is splinedata
'
vv%={ob%}
cyclic&=BTST(BYTE{vv%+2},0)
frames&=WORD{ob%+m.f&}
IF NOT cyclic&
SUB frames&,1
ENDIF
'
IF g1& AND 2
np&=WORD{vv%}
s%=spline%+72
BMOVE vv%+4,spline%+72,36*(np&-2)
IF frames&>1
cyclic
IF cyclic&
eind&=np&-1
ELSE
eind&=np&-2
ENDIF
'
OPENW #1
' LOCATE 1,2
' PRINT "start berekenen"
lencalc
ENDIF
ENDIF
'
'
IF g1& AND 4
IF {ob%+m.pd&}              ! er is een afstands tabel
' PRINT "ease"
IF {ob%+4}
makedist2dext(ob%)
ELSE
' PRINT "lineair"
dist%=@allocblock(4*frames&+6,1)
IF dist%
CARD{dist%}=frames&
point%=dist%+2
FOR lframes&=0 TO frames&
IF frames&
SINGLE{point%}=65536*lframes&/frames&
ELSE
SINGLE{point%}=0
ENDIF
ADD point%,4
NEXT lframes&
IF {ob%+m.fd&}
freeblock({ob%+m.fd&})
ENDIF
{ob%+m.fd&}=dist%
ENDIF
ENDIF
ENDIF
ENDIF
'
'
IF g1& AND 8
IF {ob%+m.pd&}<>0 AND {ob%+m.fd&}<>0
coords%=@allocblock(12*frames&+124,&H10001)
IF coords%
c%=coords%
' PRINT "samenvoegen"
FOR lframes&=1 TO frames&+1
finddist(lframes&,{ob%+m.fd&},{ob%+m.pd&})
{c%}=xcn%
{c%+4}=ycn%
{c%+8}=zcn%
ADD c%,12
NEXT lframes&
' PRINT "klaar      "
'
IF {ob%+8}
freeblock({ob%+8})
ENDIF
{ob%+8}=coords%
ELSE
okee("Couldn't generate Coords")
ENDIF
ENDIF
ENDIF
'
'
IF g1&=1
GRAPHMODE 3
IF {ob%+8}
parentbase(base%)
WHILE MOUSEK<>2
adr%={ob%+8}
FOR a&=0 TO frames&
x1%=xt%+{adr%}*mat(0,0)+{adr%+4}*mat(0,1)+{adr%+8}*mat(0,2)
y1%=yt%+{adr%}*mat(1,0)+{adr%+4}*mat(1,1)+{adr%+8}*mat(1,2)
z1%=zt%+{adr%}*mat(2,0)+{adr%+4}*mat(2,1)+{adr%+8}*mat(2,2)
persp(x1%,y1%,z1%)
PBOX x&-2,y&-2,x&+2,y&+2
VSYNC
VSYNC
VSYNC
PBOX x&-2,y&-2,x&+2,y&+2
EXIT IF MOUSEK=2
ADD adr%,12
NEXT a&
EXIT IF MOUSEK=2
IF cyclic&=0
PAUSE 10
ENDIF
WEND
ENDIF
GRAPHMODE 1
ENDIF
ENDIF
ENDIF
ENDIF
RETURN
> PROCEDURE bezier(g1%,g2%,g3%,g4%,mem%)
LOCAL g5%,g6%
'
ADD g2%,g1%
ADD g3%,g4%
g5%=g1%
g6%=g1%
'
IF g2%<g5%
g5%=g2%
ELSE IF g2%>g6%
g6%=g2%
ENDIF
IF g3%<g5%
g5%=g3%
ELSE IF g3%>g6%
g6%=g3%
ENDIF
IF g4%<g5%
g5%=g4%
ELSE IF g4%>g6%
g6%=g4%
ENDIF
'
gem%=(g5%+g6%)/2
SUB g1%,gem%
SUB g2%,gem%
SUB g3%,gem%
SUB g4%,gem%
shift&=C:ltow2%(4,0,L:V:g1%,L:V:g2%,L:V:g3%,L:V:g4%)
~C:bezier%(g1%,g2%,g3%,g4%,resol&,L:mem%,L:gem%,shift&)
RETURN
> PROCEDURE bezier_f(b&,u)
v=1-u
'
x1=v^3
x2=3*u*v*v
y1=3*u*u*v
y2=u^3
'
temp%=spline%+b&*36
FOR c&=1 TO 3
{c%}=x1*{temp%}+x2*({temp%+24}+{temp%})+y1*({temp%+48}+{temp%+36})+y2*{temp%+36}
ADD temp%,4
ADD c%,4
NEXT c&
RETURN
> PROCEDURE beziers
temp%=spline%+b&*36
bezier({temp%},{temp%+24},{temp%+48},{temp%+36},xmem%)
ADD temp%,4
bezier({temp%},{temp%+24},{temp%+48},{temp%+36},ymem%)
ADD temp%,4
bezier({temp%},{temp%+24},{temp%+48},{temp%+36},zmem%)
x%=xmem%
y%=ymem%
z%=zmem%
RETURN
> PROCEDURE calcnext
x1%={x%}
ADD x%,4
y1%={y%}
ADD y%,4
z1%={z%}
ADD z%,4
dx%=x1%-xo%
dy%=y1%-yo%
dz%=z1%-zo%
ddist=SQR(dx%^2+dy%^2+dz%^2)
RETURN
> PROCEDURE finddist(g1&,g1%,g2%)
' finddist(frame&,framedist%,paddist%)
SUB g1&,1
IF g1&>=0 AND CARD{g1%}>=g1&
dist=SINGLE{g1%+2+4*g1&}
ELSE IF g1&<=0
dist=SINGLE{g1%+2}                  ! eerste frame
ELSE
dist=SINGLE{g1%+2+4*CARD{g1%}}      ! laatste frame
ENDIF
'
IF dist<1.0E-14
dist=1.0E-14
ENDIF
IF dist>=65536
dist=65535.9                ! PATCH
ENDIF
'
dist=dist*SINGLE{g2%+6}/65536
' PRINT SINGLE{g2%+6},dist
totdist=0
point%=g2%+16
point2%=g2%+CARD{g2%+4}
WHILE totdist+SINGLE{point%+4}<dist  ! kijk in welk stuk je moet wezen
ADD totdist,SINGLE{point%+4}
ADD point2%,CARD{point%}
ADD point%,8
EXIT IF CARD{point%}=0
WEND
'
IF CARD{point%}<>0
temp&=CARD{g2%}
WHILE totdist+SINGLE{point2%}<dist
ADD totdist,SINGLE{point2%}
ADD point2%,temp&
WEND
ddist=SINGLE{point2%}
IF ddist
xo%={point2%-12}
yo%={point2%-8}
zo%={point2%-4}
'
x1%={point2%+4}
y1%={point2%+8}
z1%={point2%+12}
'
temp=(dist-totdist)/ddist
xcn%=xo%+(x1%-xo%)*temp+0.5
ycn%=yo%+(y1%-yo%)*temp+0.5
zcn%=zo%+(z1%-zo%)*temp+0.5
ELSE
xcn%={point2%+4}
ycn%={point2%+8}
zcn%={point2%+12}
ENDIF
ELSE
~DisplayBeep(0)
OPENW #1
CLR xcn%,ycn%,zcn%
ENDIF
RETURN
> PROCEDURE lencalc
LOCAL g1%
IF {ob%+m.pd&}=0 OR 1=1    ! nog geen afstandsdata
OPENW #1
' PRINT "lencalc"
IF {ob%+m.pd&}
freeblock({ob%+m.pd&})
ENDIF
point%=@allocblock((eind&-1)*(8+16+16*points&)+18,1)
{ob%+m.pd&}=point%
IF point%
CARD{point%}=16
FOR a&=2 TO 14 STEP 2
WORD{point%+a&}=0
NEXT a&
CARD{point%+10}=frames&
BYTE{point%+2}=1                  ! signaal voor 2dspline verandering
'
point2%=point%+(eind&-1)*8+2+16
CARD{point%+4}=point2%-point%
ADD point%,16
'
xo%={spline%+72}
yo%={spline%+76}
zo%={spline%+80}
'
FOR b&=2 TO eind&
beziers
totdist=0
'
g1%=point2%
WORD{point%+2}=points&
'
FOR a&=0 TO points&
calcnext
IF b&=2 AND a&=0
ddist=0
ENDIF
ADD totdist,ddist
xo%=x1%
yo%=y1%
zo%=z1%
'
SINGLE{point2%}=ddist
{point2%+4}=xo%
{point2%+8}=yo%
{point2%+12}=zo%
ADD point2%,16
NEXT a&
CARD{point%}=point2%-g1%
SINGLE{point%+4}=totdist
ADD point%,8
NEXT b&
CARD{point%}=0
'
point%={ob%+m.pd&}+16
totdist=0
REPEAT
ADD totdist,SINGLE{point%+4}
ADD point%,8
UNTIL CARD{point%}=0
SINGLE{{ob%+m.pd&}+6}=totdist
ENDIF
ENDIF
RETURN
'         Divers
> PROCEDURE handlepoints
temp%=spline%+dp&*36
'
hx1%={temp%+12}+{temp%}
hy1%={temp%+16}+{temp%+4}
hz1%={temp%+20}+{temp%+8}
hx2%={temp%+24}+{temp%}
hy2%={temp%+28}+{temp%+4}
hz2%={temp%+32}+{temp%+8}
RETURN
> PROCEDURE tekenstuk(start&,eind&,col&)
IF moving&=0
COLOR col&
ENDIF
x&=-10
temp%=spline%+start&*36
persp({temp%},{temp%+4},{temp%+8})
x4&=x&
y4&=y&
'
FOR b&=start& TO eind&
x1&=x4&
y1&=y4&
persp({temp%+24}+{temp%},{temp%+28}+{temp%+4},{temp%+32}+{temp%+8})
x2&=x&
y2&=y&
ADD temp%,36
persp({temp%+12}+{temp%},{temp%+16}+{temp%+4},{temp%+20}+{temp%+8})
x3&=x&
y3&=y&
persp({temp%},{temp%+4},{temp%+8})
x4&=x&
y4&=y&
~C:bezier%(x1&,x2&,x3&,x4&,resol&,L:xmem%,L:0,0)
~C:bezier%(y1&,y2&,y3&,y4&,resol&,L:ymem%,L:0,0)
x%=xmem%
y%=ymem%
x1&={x%}
y1&={y%}
PLOT x1&,y1&
PBOX x1&-1,y1&-1,x1&+1,y1&+1
ADD x%,4
ADD y%,4
FOR a&=1 TO points&
x1&={x%}
y1&={y%}
IF line&
DRAW  TO x1&,y1&
ELSE
PLOT x1&,y1&
PLOT x1&,y1&+1
ENDIF
ADD x%,4
ADD y%,4
NEXT a&
NEXT b&
PBOX x1&-1,y1&-1,x1&+1,y1&+1
RETURN
> PROCEDURE drawdp(col1&,col2&)
IF dp&>1
handlepoints
temp%=spline%+dp&*36
persp({temp%},{temp%+4},{temp%+8})
xdp&=x&
ydp&=y&
IF moving&=0
COLOR col1&
ENDIF
persp(hx2%,hy2%,hz2%)
BOX x&-1,y&-1,x&+1,y&+1
LINE x&,y&,xdp&,ydp&
persp(hx1%,hy1%,hz1%)
BOX x&-1,y&-1,x&+1,y&+1
LINE x&,y&,xdp&,ydp&
IF moving&=0
COLOR col2&
ENDIF
PBOX xdp&-1,ydp&-1,xdp&+1,ydp&+1
ENDIF
RETURN
> PROCEDURE cyclic
IF cyclic&
BMOVE spline%+72,spline%+np&*36,72
BMOVE spline%+(np&-2)*36,spline%,72
ELSE
temp%=spline%+(np&-2)*36
FOR t&=0 TO 1
FOR temp&=0 TO 2
{temp%+72}=SHL({temp%+36},1)-{temp%}
ADD temp%,4
NEXT temp&
ADD temp%,24
NEXT t&
'
temp%=spline%
FOR t&=0 TO 1
FOR temp&=0 TO 2
{temp%}=SHL({temp%+36},1)-{temp%+72}
ADD temp%,4
NEXT temp&
ADD temp%,24
NEXT t&
'
ENDIF
RETURN
'         Handles
> PROCEDURE calchandles(b&)
cyclic
calchandle(b&-1)
calchandle(b&)
calchandle(b&+1)
RETURN
> PROCEDURE calchandle(b&)
temp%=spline%+36*b&
dx={temp%}-{temp%-36}
dy={temp%+4}-{temp%-32}
dz={temp%+8}-{temp%-28}
len1=SQR(dx*dx+dy*dy+dz*dz)
'
dx1={temp%+36}-{temp%}
dy1={temp%+40}-{temp%+4}
dz1={temp%+44}-{temp%+8}
len2=SQR(dx1*dx1+dy1*dy1+dz1*dz1)
'
IF len1=0
len1=1
ENDIF
IF len2=0
len2=1
ENDIF
vx=dx1/len2+dx/len1
vy=dy1/len2+dy/len1
vz=dz1/len2+dz/len1
lenh=2.71*SQR(vx*vx+vy*vy+vz*vz)
IF lenh<>0
len1=len1/lenh
len2=len2/lenh
{temp%+12}=-vx*len1
{temp%+16}=-vy*len1
{temp%+20}=-vz*len1
{temp%+24}=vx*len2
{temp%+28}=vy*len2
{temp%+32}=vz*len2
ENDIF
RETURN
> PROCEDURE changehandles
temp2%=spline%+dp&*36
xco%={temp2%}
yco%={temp2%+4}
zco%={temp2%+8}
persp(xco%,yco%,zco%)
xc&=x&
yc&=y&
yn&=MOUSEY
xn&=MOUSEX
ghoek=0
gscale=1
lhoek=0
lscale=1
dx2&=xn&-xc&
dy2&=yn&-yc&
hxo1%={temp2%+12}
hyo1%={temp2%+16}
hzo1%={temp2%+20}
hxo2%={temp2%+24}
hyo2%={temp2%+28}
hzo2%={temp2%+32}
afsto=SQR(dx2&*dx2&+dy2&*dy2&)
IF afsto<>0
WHILE MOUSEK=2
dx1&=dx2&
dy1&=dy2&
IF menu2%<90 AND menu2%>0
i$="a"
IF menu2%=64
i$=" "
ENDIF
ENDIF
x&=MOUSEX
y&=MOUSEY
'
dx2&=x&-xc&
dy2&=y&-yc&
afstn=SQR(dx2&*dx2&+dy2&*dy2&)
xn&=x&
yn&=y&
deler=SQR((dx1&^2+dy1&^2)*(dx2&^2+dy2&^2))
IF deler<>0
choek=(dx1&*dx2&+dy1&*dy2&)/deler
dhoek=DEG(ACOS(choek)*SGN(dx1&*dy2&-dx2&*dy1&))
'
IF menu3% AND 3
lhoek=lhoek+dhoek
IF (afsto<>0) AND (afstn<>0)
lscale=lscale*afstn/afsto
afsto=afstn
ENDIF
ELSE
ghoek=ghoek+dhoek
IF (afsto<>0) AND (afstn<>0)
gscale=gscale*afstn/afsto
afsto=afstn
ENDIF
ENDIF
'
IF menu1%=&H400
IF menu2%=&H21
IF menu3% AND 3
lscale=1
ELSE
gscale=1
ENDIF
ELSE IF menu2%=&H13
IF menu3% AND 3
lhoek=0
ELSE
ghoek=0
ENDIF
ENDIF
ENDIF
' global
b1&=dp&-1
b2&=dp&
IF NOT cyclic&
IF b1&<2
b1&=2
ENDIF
IF b2&>np&-2
b2&=np&-2
ENDIF
ENDIF
si=SINQ(ghoek)*gscale
co=COSQ(ghoek)*gscale
tekenstuk(b1&,b2&,0)
drawdp(0,0)
'
rotatehandle(hxo1%,hyo1%,hzo1%)
hx1=y(0)
hy1=y(1)
hz1=y(2)
'
rotatehandle(hxo2%,hyo2%,hzo2%)
hx2=y(0)
hy2=y(1)
hz2=y(2)
'
' local
IF (lhoek<>0) OR (lscale<>1)
si=SINQ(lhoek)*lscale
co=COSQ(lhoek)*lscale
IF hand&=1
rotatehandle(hx1,hy1,hz1)
hx1=y(0)
hy1=y(1)
hz1=y(2)
ELSE
rotatehandle(hx2,hy2,hz2)
hx2=y(0)
hy2=y(1)
hz2=y(2)
ENDIF
ENDIF
'
{temp2%+12}=hx1
{temp2%+16}=hy1
{temp2%+20}=hz1
{temp2%+24}=hx2
{temp2%+28}=hy2
{temp2%+32}=hz2
'
tekenstuk(b1&,b2&,3)
drawdp(2,3)
ENDIF
waitsignal(1)
WEND
IF MOUSEK=3
{temp2%+12}=hxo1%
{temp2%+16}=hyo1%
{temp2%+20}=hzo1%
{temp2%+24}=hxo2%
{temp2%+28}=hyo2%
{temp2%+32}=hzo2%
ENDIF
ENDIF
RETURN
> PROCEDURE rotatehandle(x,y,z)
IF speed&
y(0)=x*co-si*y
y(1)=si*x+co*y
y(2)=0
ELSE
x(0)=x
x(1)=y
x(2)=z
RBOX y()=persmat()*x()
x(0)=y(0)*co+y(1)*si
x(1)=-si*y(0)+y(1)*co
x(2)=y(2)
RBOX y()=persinv()*x()
ENDIF
RETURN
'
ENDFUNC
RBOX compressie
'
> PROCEDURE initint(adres%,data&)
{adres%}=0
{adres%+4}=0
BYTE{adres%+8}=2                ! Type
BYTE{adres%+9}=100              ! Pri
{adres%+14}=adres%+data&        ! Data
{adres%+18}=adres%+100          ! Code
RETURN
'
> PROCEDURE laadanim(file$)
'
IF file$<>"" AND RIGHT$(file$,1)<>":" AND RIGHT$(file$,1)<>"/" AND EXIST(file$)
dosfile$=file$+CHR$(0)
handle%=Open(V:dosfile$,1005)
~Seek(handle%,0,1)
filelen%=Seek(handle%,0,-1)
animem%=@allocblock(100,&H10001)
IF animem%=0
~Close(handle%)
CLR handle%
okee("Not enough memory")
ELSE
~Read(handle%,animem%,12)
SUB filelen%,12
'
IF MKL$({ADD(animem%,8)})<>"TRA1"
okee("No TRACE file !")
ELSE
~Read(handle%,animem%,8)
SUB filelen%,8
len%={animem%+4}+8
mem2%=@allocblock(len%+4,&H10001)
IF mem2%
animbase%=mem2%
animblock%=mem2%
{mem2%+4}={animem%}
{mem2%+8}={animem%+4}
~Read(handle%,mem2%+8+4,len%-8)
SUB filelen%,len%-8
WHILE filelen%>0
{animem%}=0
~Read(handle%,animem%,8)
SUB filelen%,8
IF {animem%}<>CVL("DLTA")
REPEAT
~DisplayBeep(0)
UNTIL MOUSEK
ELSE
len%={animem%+4}
mem2%=@allocblock(len%+4,&H10001)
IF mem2%
{animblock%}=mem2%
animblock%=mem2%
~Read(handle%,mem2%+4,len%)
SUB filelen%,len%
ENDIF
ENDIF
WEND
ENDIF
ENDIF
'
~Close(handle%)
CLR handle%
freeblock(animem%)
CLR animem%
ENDIF
ELSE
sluit
ENDIF
RETURN
> PROCEDURE schrijfanim(file$)
dosfile$=file$+CHR$(0)
handle%=Open(V:dosfile$,1006)
'
animem%=0
IF anim5&
soort%=CVL("ANIM")
anhd%=@allocblock(60,&H10001)
{anhd%}=CVL("FORM")
{anhd%+8}=CVL("ILBM")
{anhd%+12}=CVL("ANHD")
{anhd%+16}=40
BYTE{anhd%+20}=5
WORD{anhd%+22}=w&
WORD{anhd%+24}=h&
BYTE{anhd%+37}=1
ELSE
soort%=CVL("TRA1")
ENDIF
'
esc&=FALSE
REPEAT
IF handle%
animem%=@allocblock(20,&H10001)
IF animem%=0
~Close(handle%)
CLR handle%
ALERT 0,"Not enough memory",0,"OK",v&
ELSE
{animem%}=CVL("FORM")
{animem%+8}=soort%
EXIT IF Write(handle%,animem%,12)<>12
EXIT IF Write(handle%,animbase%+4,{animbase%-8}-20)<>{animbase%-8}-20
animblock%={animbase%}
{animem%}=CVL("DLTA")
WHILE animblock%
esc&=FALSE
len%=({animblock%-8}-20+1) AND NOT 1
IF compres&=3
{anhd%+4}=len%+60
EXIT IF Write(handle%,anhd%,60)<>60
ENDIF
{animem%+4}=len%
EXIT IF Write(handle%,animem%,8)<>8
EXIT IF Write(handle%,animblock%+4,len%)<>len%
animblock%={animblock%}
esc&=TRUE
WEND
'
IF esc&
esc&=FALSE
len%=Seek(handle%,4,-1)-8
EXIT IF Write(handle%,V:len%,4)<>4
esc&=TRUE
ENDIF
ENDIF
ENDIF
UNTIL anim5&<>-3274                  ! Dummy voor Exit
'
IF handle%
~Close(handle%)
CLR handle%
ENDIF
IF animem%
freeblock(animem%)
CLR animem%
ENDIF
RETURN
> PROCEDURE schrijfanimo(file$)
dosfile$=file$+CHR$(0)
handle%=Open(V:dosfile$,1006)
IF handle%
animem%=@allocblock(20,&H10001)
IF animem%=0
~Close(handle%)
CLR handle%
okee("Not enough memory")
ELSE
{animem%}=CVL("FORM")
{animem%+8}=CVL("TRA1")
~Write(handle%,animem%,12)
~Write(handle%,animbase%+4,{animbase%-8}-20)
animblock%={animbase%}
{animem%}=CVL("DLTA")
WHILE animblock%
len%={animblock%-8}-20
{animem%+4}=len%
~Write(handle%,animem%,8)
~Write(handle%,animblock%+4,len%)
animblock%={animblock%}
WEND
'
~Close(handle%)
CLR handle%
freeblock(animem%)
ENDIF
ENDIF
RETURN
> PROCEDURE appendanim(file$)
dosfile$=file$+CHR$(0)
handle%=Open(V:dosfile$,1004)
IF handle%
~Seek(handle%,0,1)
animem%=@allocblock(20,&H10001)
IF animem%=0
okee("Not enough memory")
ELSE
{animem%}=CVL("DLTA")
len%=(({new.animblock%-8}-20)+1) AND NOT (1)      !moet even zijn !
{animem%+4}=len%
'
IF anim5&
anhd%=@allocblock(60,&H10001)
IF anhd%
{anhd%}=CVL("FORM")
{anhd%+4}=len%+60
{anhd%+8}=CVL("ILBM")
{anhd%+12}=CVL("ANHD")
{anhd%+16}=40
BYTE{anhd%+20}=5
WORD{anhd%+22}=w&
WORD{anhd%+24}=h&
BYTE{anhd%+37}=1
~Write(handle%,anhd%,60)
freeblock(anhd%)
~Write(handle%,animem%,8)
~Write(handle%,new.animblock%+4,len%)
ELSE
okee("Not enough memory")
ENDIF
ELSE
~Write(handle%,animem%,8)
~Write(handle%,new.animblock%+4,len%)
ENDIF
len%=Seek(handle%,4,-1)-8
~Write(handle%,V:len%,4)
'
freeblock(animem%)
ENDIF
~Close(handle%)
CLR handle%
ENDIF
RETURN
> PROCEDURE appendanimo(file$)
dosfile$=file$+CHR$(0)
handle%=Open(V:dosfile$,1004)
IF handle%
~Seek(handle%,0,1)
animem%=@allocblock(20,&H10001)
IF animem%=0
okee("Not enough memory")
ELSE
{animem%}=CVL("DLTA")
len%={new.animblock%-8}-20
{animem%+4}=len%
~Write(handle%,animem%,8)
~Write(handle%,new.animblock%+4,len%)
'
freeblock(animem%)
ENDIF
~Close(handle%)
CLR handle%
ENDIF
RETURN
> PROCEDURE laadiff(s%,file$,ram%)
LOCAL point%
esc&=FALSE
animem%=0
IF ram%=0
dosfile$=file$+CHR$(0)
handle%=Open(V:dosfile$,1005)
IF handle%
~Seek(handle%,0,1)
filelen%=Seek(handle%,0,-1)
animem%=@allocblock(filelen%+4,&H10001)
IF animem%
~Read(handle%,animem%+4,filelen%)
ENDIF
~Close(handle%)
CLR handle%
ELSE
okee("File not found")
esc&=TRUE
ENDIF
ELSE
animem%=ram%
filelen%=10000
ENDIF
'
IF animem%
point%=animem%+4
'
IF MKL$({ADD(point%,8)})<>"ILBM" AND MKL$({ADD(point%,8)})<>"ANIM" AND MKL$({ADD(point%,8)})<>"TRA1"
okee("No ILBM file !")
esc&=TRUE
ELSE
IF MKL$({ADD(point%,8)})="ANIM"
ADD point%,12
ENDIF
IF MKL$({ADD(point%,8)})="TRAC"
ADD point%,12
ENDIF
ADD point%,12
CLR bmhd!,cmap!,body!,camg!
find_camg(point%)
'
WHILE NOT (point%>=animem%+filelen%) OR (bmhd! AND cmap! AND body!)
@read_chunk
WEND
'
ENDIF
IF (ram%=0) AND fre&
freeblock(animem%)
ENDIF
ELSE
IF esc&=FALSE
okee("No Mem to load image")
ENDIF
esc&=TRUE
ENDIF
RETURN
'
> PROCEDURE find_camg(point%)
REPEAT
len%={ADD(point%,4)}
IF MKL$({point%})="CAMG"
ADD point%,8
camg!=TRUE
camg%={point%}
ADD point%,len%+(len% AND 1)
ELSE
ADD point%,len%+(len% AND 1)+8   ! skip chunk
ENDIF
UNTIL (point%>=animem%+filelen%) OR camg!
RETURN
> PROCEDURE read_chunk
len%={ADD(point%,4)}
ADD point%,8
SELECT MKL$({SUB(point%,8)})
CASE "BMHD"
@read_bmhd
CASE "CMAP"
@read_cmap
CASE "BODY"
@read_body
ENDSELECT
ADD point%,len%+(len% AND 1)
RETURN
> PROCEDURE read_bmhd
bmhd!=TRUE
bmhd%=point%
w&=CARD{point%}
h&=CARD{ADD(point%,2)}
d|=BYTE{ADD(point%,8)}
c|=BYTE{ADD(point%,10)}
sw&=CARD{ADD(point%,16)}
sh&=CARD{ADD(point%,18)}
IF d|<7
IF camg!
viewm%=camg%
ELSE
CLR viewm%
IF sw&>420
viewm%=OR(viewm%,&H8000)
ENDIF
IF sh&>356
viewm%=OR(viewm%,4)
ENDIF
ENDIF
IF viewm% AND &H8000
IF d|>4
d|=4
ENDIF
ELSE
IF d|>6
d|=6
ENDIF
ENDIF
cols&=BSET(0,d|)
IF ram%=0
OPENS s%,0,0,w&,h&,d|,viewm%
ENDIF
ELSE IF s%=-1
IF d|=24 OR d|=32
make24buf(d|,w&,h&,viewm%,h&)
cmap!=TRUE
ENDIF
ELSE IF s%=-2
cmap!=TRUE
ENDIF
RETURN
> PROCEDURE make24buf(d|,w&,h&,viewm%,bmh&)
IF bmh&<0
bmh&=1
ENDIF
IF bm24%
temp&=BYTE{bm24%+5}
temp%=bm24%+8
FOR a&=1 TO temp&
IF {temp%}
freeblock({temp%})
{temp%}=0
ENDIF
ADD temp%,4
NEXT a&
ELSE
s24%=@allocblock(400,&H10001)
IF s24%
bm24%=s24%+184
ENDIF
ENDIF
IF bm24%
rb&=SHR(w&+7,3)
WORD{s24%+14}=h&
WORD{bm24%}=rb&
WORD{bm24%+2}=bmh&
BYTE{bm24%+5}=d|
temp2%=rb&*bmh&
temp%=bm24%+8
IF d|<>12
FOR a&=1 TO d|
{temp%}=@allocblock(temp2%,&H10001)
ADD temp%,4
NEXT a&
ELSE
BYTE{bm24%+5}=24
FOR b&=0 TO 2
{temp%}=0
{temp%+4}=0
{temp%+8}=0
{temp%+12}=0
ADD temp%,16
FOR a&=1 TO 4
{temp%}=@allocblock(temp2%,&H10001)
ADD temp%,4
NEXT a&
NEXT b&
ENDIF
{bmplot%}=bm24%
{bmham%+20}=bm24%
'
IF buf24%
freeblock(buf24%-32)
CLR buf24%
ENDIF
IF d|
buf24%=@allocblock(rb&*8*4+64,&H10001)
IF buf24%
ADD buf24%,32
ENDIF
ENDIF
'
{bmham%+24}=buf24%
'
~C:mpoint%(0,0)     ! yoffs wissen
WORD{s24%+76}=viewm%
ENDIF
RETURN
> PROCEDURE read_cmap
LOCAL v&,col&
cmap!=TRUE
FOR v&=0 TO PRED(cols&)
v%=ADD(point%,MUL(3,v&))
r|=BYTE{v%} AND &HF0
g|=BYTE{SUCC(v%)} AND &HF0
b|=BYTE{ADD(v%,2)} AND &HF0
'
col&=SHL(r|,4)+g|+SHR(b|,4)
OPENS s%
SETCOLOR v&,col&
NEXT v&
RETURN
> PROCEDURE read_body
LOCAL rr%,pp%
'
body!=TRUE
IF c|=1
IF d|<7
li_reg%(8)=SCREEN(s%)+184
ELSE
li_reg%(8)=bm24%
ENDIF
li_reg%(9)=point%
li_reg%(11)=bmhd%
li_reg%(12)=-1
IF s%<>-2                   ! sky.buf laden
RCALL laadiff%,li_reg%()
ENDIF
ENDIF
RETURN
'
> PROCEDURE exor(s1%,s2%)
LOCAL rastp1%,bitm2%,width&,heigth&
' s1% gaat eraan
IF (SCREEN(s1%)<>0) AND (SCREEN(s2%)<>0)
rastp1%=SCREEN(s1%)+84
bitm2%=SCREEN(s2%)+184
width&=WORD{bitm2%}*8
heigth&=WORD{bitm2%+2}
~BltBitMapRastPort(bitm2%,0,0,rastp1%,0,0,width&,heigth&,&H60)
ENDIF
RETURN
> PROCEDURE kompro(s1&,s2&)
LOCAL point%,bitm1%,bitm2%,words%,wordso%,depth&,bitpl1%,bitpl2%,code%
' in s1& staat xor data in s2& originele data
IF (SCREEN(s1&)<>0) AND (SCREEN(s2&)<>0)
compmem%=@allocblock(250000,&H1)
IF compmem%
point%=compmem%
bitm1%=SCREEN(s1&)+192
bitm2%=SCREEN(s2&)+192
words%=WORD{bitm1%-8}*(WORD{bitm1%-6})
wordso%=SHR(words%+(words% AND 1),1)
depth&=BYTE{bitm1%-3}
FOR a&=1 TO depth&
bitpl1%={bitm1%}
bitpl2%={bitm2%}
words%=wordso%
ADD bitm1%,4
ADD bitm2%,4
IF WORD{bitpl1%}=0
code%=-1
ELSE
code%=1
ENDIF
ADD bitpl1%,2
SUB words%,1
REPEAT
IF code%<0
WHILE WORD{bitpl1%}=0
SUB code%,1
SUB words%,1
EXIT IF words%=0
ADD bitpl1%,2
WEND
SUB bitpl2%,2*code%
ADD bitpl1%,2
SUB words%,1
WHILE code%<-32768
WORD{point%}=-32768
ADD point%,2
ADD code%,32768
WEND
WORD{point%}=code%
ADD point%,2
code%=1
ELSE
WHILE {bitpl1%}<>0
SUB words%,1
ADD code%,1
EXIT IF words%=0
ADD bitpl1%,2
WEND
ADD bitpl1%,2
SUB words%,1
WHILE code%>32767
WORD{point%}=32767
ADD point%,2
FOR b&=1 TO 32767
WORD{point%}=WORD{bitpl2%}
ADD point%,2
ADD bitpl2%,2
NEXT b&
SUB code%,32767
WEND
WORD{point%}=code%
ADD point%,2
FOR b&=1 TO code%
WORD{point%}=WORD{bitpl2%}
IF WORD{point%}=WORD{point%-2}
ADD comtel&,1
ENDIF
ADD point%,2
ADD bitpl2%,2
NEXT b&
code%=-1
ENDIF
UNTIL words%<=0
IF words%=0
IF code%=1
WORD{point%}=code%
ADD point%,2
WORD{point%}=WORD{bitpl2%}
ADD point%,2
ENDIF
ENDIF
WORD{point%}=0
ADD point%,2
NEXT a&
new.animblock%=@allocblock(point%-compmem%+4,&H10001)
IF new.animblock%
BMOVE compmem%,new.animblock%+4,point%-compmem%
IF animblock%
{animblock%}=new.animblock%
animblock%=new.animblock%
ENDIF
ELSE
esc&=TRUE
ENDIF
freeblock(compmem%)
CLR compmem%
ELSE
esc&=TRUE
ENDIF
ENDIF
RETURN
> PROCEDURE kompr(s1&,s2&)
LOCAL point%,bitm1%,bitm2%,words%,wordso%,depth&,bitpl1%,bitpl2%,code%,w&,h&
' in s1& staat xor data in s2& originele data
IF (SCREEN(s1&)<>0) AND (SCREEN(s2&)<>0)
compmem%=@allocblock(250000,&H10001)
IF compmem%
bitm1%=SCREEN(s1&)+192
bitm2%=SCREEN(s2&)+192
depth&=BYTE{bitm1%-3}
w&=WORD{bitm1%-8}
h&=WORD{bitm1%-6}
IF anim5&
point%=compmem%+4*16
FOR a&=1 TO depth&
'
{compmem%+4*a&-4}=point%-compmem%
ccd&=FALSE
'
FOR horz&=0 TO w&-1
bitpl1%={bitm1%}+horz&
bitpl2%={bitm2%}+horz&
'
noops%=point%
ADD point%,1
'
bytes&=h&
total&=0
noops&=0
'
WHILE bytes&>0
bd&=0
IF BYTE{bitpl1%}=0
REPEAT
ADD bd&,1
SUB bytes&,1
EXIT IF bytes&=0
ADD bitpl1%,w&
ADD bitpl2%,w&
UNTIL BYTE{bitpl1%}<>0
'
ADD total&,bd&
IF bytes&
WHILE bd&>127
BYTE{point%}=127
ADD point%,1
SUB bd&,127
ADD noops&,1
WEND
BYTE{point%}=bd&
ADD point%,1
ADD noops&,1
ENDIF
ELSE
ccd&=TRUE
this&=0
prev&=0
REPEAT
this&=BYTE{bitpl1%}=0
EXIT IF this& AND prev&
ADD bd&,1
SUB bytes&,1
ADD bitpl1%,w&
prev&=this&
UNTIL bytes&=0
IF bytes&
SUB bitpl1%,w&
ADD bytes&,1
SUB bd&,1
ENDIF
compcopy(bd&,bitpl2%)
ENDIF
WEND
'
IF total&<>h&
REPEAT
~DisplayBeep(0)
UNTIL MOUSEK
sluit
ENDIF
BYTE{noops%}=noops&
NEXT horz&
'
IF NOT ccd&
point%={compmem%+4*a&-4}+compmem%
{compmem%+4*a&-4}=0
ENDIF
ADD bitm1%,4
ADD bitm2%,4
NEXT a&
ELSE
point%=compmem%
words%=w&*h&
wordso%=SHR(words%+1,1)
FOR a&=1 TO depth&
bitpl1%={bitm1%}
bitpl2%={bitm2%}
words%=wordso%
ADD bitm1%,4
ADD bitm2%,4
IF WORD{bitpl1%}=0
code%=-1
ELSE
code%=1
ENDIF
ADD bitpl1%,2
SUB words%,1
REPEAT
IF code%<0
WHILE WORD{bitpl1%}=0
SUB code%,1
SUB words%,1
EXIT IF words%=0
ADD bitpl1%,2
WEND
SUB bitpl2%,2*code%
ADD bitpl1%,2
SUB words%,1
WHILE code%<-32768
WORD{point%}=-32768
ADD point%,2
ADD code%,32768
WEND
WORD{point%}=code%
ADD point%,2
code%=1
ELSE
WHILE {bitpl1%}<>0
SUB words%,1
ADD code%,1
EXIT IF words%=0
ADD bitpl1%,2
WEND
ADD bitpl1%,2
SUB words%,1
WHILE code%>32767
WORD{point%}=32767
ADD point%,2
FOR b&=1 TO 32767
WORD{point%}=WORD{bitpl2%}
ADD point%,2
ADD bitpl2%,2
NEXT b&
SUB code%,32767
WEND
WORD{point%}=code%
ADD point%,2
FOR b&=1 TO code%
WORD{point%}=WORD{bitpl2%}
IF WORD{point%}=WORD{point%-2}
ADD comtel&,1
ENDIF
ADD point%,2
ADD bitpl2%,2
NEXT b&
code%=-1
ENDIF
UNTIL words%<=0
IF words%=0
IF code%=1
WORD{point%}=code%
ADD point%,2
WORD{point%}=WORD{bitpl2%}
ADD point%,2
ENDIF
ENDIF
WORD{point%}=0
ADD point%,2
NEXT a&
ENDIF
new.animblock%=@allocblock(point%-compmem%+4,&H10001)
IF new.animblock%
BMOVE compmem%,new.animblock%+4,point%-compmem%
IF animblock%
{animblock%}=new.animblock%
animblock%=new.animblock%
ENDIF
ELSE
esc&=TRUE
ENDIF
freeblock(compmem%)
CLR compmem%
ELSE
esc&=TRUE
ENDIF
ENDIF
RETURN
> PROCEDURE compcopy(bytes&,VAR bitpl1%)
LOCAL a&
REPEAT
IF bytes&>2
comp&=BYTE{bitpl1%}
IF comp&=BYTE{bitpl1%+w&} AND comp&=BYTE{bitpl1%+2*w&}    ! compr
'
bd&=2
ADD bitpl1%,2*w&
SUB bytes&,2
'
WHILE BYTE{bitpl1%}=comp&
ADD bitpl1%,w&
ADD bd&,1
SUB bytes&,1
EXIT IF bytes&=0
WEND
ADD total&,bd&
'
WHILE bd&>127
BYTE{point%}=0
BYTE{point%+1}=127
BYTE{point%+2}=comp&
ADD point%,3
SUB bd&,127
ADD noops&,1
WEND
'
BYTE{point%}=0
BYTE{point%+1}=bd&
BYTE{point%+2}=comp&
ADD point%,3
ADD noops&,1
'
ELSE                                  ! copy
'
prev&=0
this&=0
pprev&=0
'
startadr%=bitpl1%
'
ADD bitpl1%,w&
bd&=1
SUB bytes&,1
'
WHILE bytes&
cthis&=BYTE{bitpl1%}
this&=cthis&=comp&
EXIT IF this& AND prev& AND pprev&
comp&=cthis&
ADD bitpl1%,w&
ADD bd&,1
SUB bytes&,1
pprev&=prev&
prev&=this&
WEND
'
IF bytes&
SUB bd&,3
SUB bitpl1%,3*w&
ADD bytes&,3
ENDIF
'
ADD total&,bd&
WHILE bd&>127
BYTE{point%}=255
ADD point%,1
FOR a&=1 TO 127
BYTE{point%}=BYTE{startadr%}
ADD point%,1
ADD startadr%,w&
NEXT a&
SUB bd&,127
ADD noops&,1
WEND
'
BYTE{point%}=bd&+128
ADD point%,1
FOR a&=1 TO bd&
BYTE{point%}=BYTE{startadr%}
ADD point%,1
ADD startadr%,w&
NEXT a&
ADD noops&,1
'
ENDIF
ELSE
BYTE{point%}=bytes&+128
ADD point%,1
FOR a&=1 TO bytes&
BYTE{point%}=BYTE{bitpl1%}
ADD point%,1
ADD bitpl1%,w&
NEXT a&
ADD total&,bytes&
bytes&=0
ADD noops&,1
ENDIF
UNTIL bytes&=0
RETURN
> PROCEDURE startanim(pic1&,pic2&)
LOCAL fre&
esc&=FALSE
schrijfiff("ram:firstpic",pic1&)
fre&=FALSE
animbase%=0
laadiff(pic1&,"ram:firstpic",0)
IF NOT esc&
animbase%=animem%
animblock%=animem%
fre&=TRUE
IF EXIST("ram:firstpic")
KILL "ram:firstpic"
ENDIF
'
exor(pic1&,pic2&)
kompr(pic1&,pic2&)
exor(pic1&,pic2&)
ENDIF
RETURN
> PROCEDURE addanim(pic1&,pic2&)
exor(pic1&,pic2&)
kompr(pic1&,pic2&)
RETURN
> PROCEDURE endanim(pic1&,pic2&,pic3&)
laadiff(pic1&,"",animbase%)
FRONTS pic1&
exor(pic3&,pic1&)
kompr(pic3&,pic1&)
'
IF anim5&
~C:anim5.dec%(L:SCREEN(pic1&)+184,L:-1)
decode%=anim5.dec%
ELSE
decode%=trace.dec%
ENDIF
'
IF NOT esc&
laadiff(pic3&,"",animbase%)
~C:decode%(L:SCREEN(pic3&)+184,L:{animbase%}+4)
FRONTS pic3&
exor(pic2&,pic3&)
kompr(pic2&,pic3&)
ENDIF
IF compmem%
freeblock(compmem%)
CLR compmem%
ENDIF
CLOSES 9
RETURN
> PROCEDURE playanim
LOCAL fre&,s1%,s2%,bitm1%,bitm2%
'
IF key.int%
~AddIntServer(3,key.int%)
key.int&=TRUE
ENDIF
'
IF fra.int%
~AddIntServer(5,fra.int%)
fra.int&=TRUE
ENDIF
'
fre&=FALSE
aspeed&=2
exit&=FALSE
ss&=FALSE
enter&=TRUE
loop&=TRUE
first&=FALSE
'
laadiff(10,"",animbase%)
laadiff(11,"",animbase%)
animblock%={animbase%}
'
s1%=10
bitm1%=SCREEN(s1%)+184
FRONTS s1%
~RemakeDisplay()
s2%=11
bitm2%=SCREEN(s2%)+184
FRONTS s2%
~RemakeDisplay()
'
' task%=FindTask(0)
' ~SetTaskPri(task%,10)
IF anim5&
~C:anim5.dec%(L:SCREEN(10)+184,L:-1)
decode%=anim5.dec%
ELSE
decode%=trace.dec%
ENDIF
picdelta&=0
'
REPEAT
WHILE animblock% AND (exit&=FALSE)
~C:decode%(L:bitm1%,L:animblock%+4)
~FreeSprite(0)
IF ss&
enter&=FALSE
REPEAT
VSYNC
UNTIL enter& OR exit& OR NOT (ss&)
ELSE
REPEAT
IF (aspeed&-picdelta&)>1
VSYNC
ENDIF
UNTIL (picdelta&>=aspeed&) OR exit&
ENDIF
IF NOT loop&
IF first&
laadiff(s2%,"",animbase%)
laadiff(s1%,"",animbase%)
animblock%=animbase%
first&=0
ELSE
IF NOT ss&
IF ({animblock%}=0) OR ({{animblock%}}=0) OR (animblock%={animbase%})
enter&=FALSE
REPEAT
VSYNC
UNTIL enter& OR exit& OR loop&
ENDIF
ENDIF
ENDIF
ENDIF
picdelta&=0
FRONTS s1%
SWAP s1%,s2%
SWAP bitm1%,bitm2%
animblock%={animblock%}
WEND
animblock%={{animbase%}}
UNTIL exit&
'
' ~SetTaskPri(task%,0)
'
IF key.int&
~RemIntServer(3,key.int%)
key.int&=FALSE
ENDIF
'
IF fra.int&
~RemIntServer(5,fra.int%)
fra.int&=TRUE
ENDIF
RETURN
> PROCEDURE diskcompressie
IF spic&<>-1
esc&=FALSE
animbase%=0
fre&=TRUE
IF spic&=cfra&
pic$=picsdir$+RIGHT$("000"+STR$(fpic&),4)
dosfile$=pic$+CHR$(0)
handle%=Open(V:dosfile$,1005)
IF handle%
~Seek(handle%,0,1)
filelen%=Seek(handle%,0,-1)
animem%=@allocblock(filelen%+12,&H10001)
IF animem%
~Read(handle%,animem%+12,filelen%)
ELSE
esc&=TRUE
ENDIF
~Close(handle%)
CLR handle%
'
IF esc&=FALSE
dosfile$=picsdir$+"anim"+CHR$(0)
handle%=Open(V:dosfile$,1006)
IF handle%
{animem%}=CVL("FORM")
{animem%+4}=0
IF anim5&
{animem%+8}=CVL("ANIM")
ELSE
{animem%+8}=CVL("TRA1")
ENDIF
~Write(handle%,animem%,filelen%+12)
~Close(handle%)
CLR handle%
ELSE
okee("Couldn't open anim")
esc&=TRUE
ENDIF
ENDIF
'
IF animem%
freeblock(animem%)
animem%=0
ENDIF
ELSE
okee("File not found")
esc&=TRUE
ENDIF
ELSE
pic$=picsdir$+RIGHT$("000"+STR$(kpic&),4)
ENDIF
animbase%=0
IF NOT esc&
laadiff(6,pic$,0)
exor(6,5)
kompr(6,5)
IF NOT esc&
appendanim(picsdir$+"anim")
IF (kpic&<>fpic&) AND (kpic&<>spic&) AND (kpic&<>-1)
KILL pic$
ENDIF
ENDIF
freeblock(new.animblock%)
CLOSES 6
ENDIF
ENDIF
RETURN
> PROCEDURE makecyclic
IF spic&<>-1
a%=1
IF afbreek& OR fout&
okee("End anim ?")
ENDIF
'
IF a%
esc&=FALSE
fre&=TRUE
animbase%=0
pic1$=picsdir$+RIGHT$("000"+STR$(ppic&),4)
pic2$=picsdir$+RIGHT$("000"+STR$(fpic&),4)
laadiff(6,pic1$,0)
laadiff(5,pic2$,0)
exor(6,5)
kompr(6,5)
IF NOT esc&
appendanim(picsdir$+"anim")
IF ppic&<>spic&
KILL pic1$
ENDIF
IF EXIST(pic2$)
KILL pic2$
ENDIF
ENDIF
freeblock(new.animblock%)
pic1$=picsdir$+RIGHT$("000"+STR$(lpic&),4)
pic2$=picsdir$+RIGHT$("000"+STR$(spic&),4)
laadiff(5,pic1$,0)
laadiff(6,pic2$,0)
animbase%=0
exor(5,6)
kompr(5,6)
exor(5,6)
IF NOT esc&
appendanim(picsdir$+"anim")
KILL pic1$
IF EXIST(pic2$)
KILL pic2$
ENDIF
anim$=picsdir$+"anim"+CHR$(0)
t$="frames: "+STR$(sfra&)+"-"+STR$(lfra&)+CHR$(0)
~SetComment(V:anim$,V:t$)
ENDIF
freeblock(new.animblock%)
CLOSES 6
ENDIF
ENDIF
RETURN
'
ENDFUNC
'                          ****** FUNKTIES
RBOX startlist(g1&,g2&,soort%,g3&)
' g1&=aantal blokken per lijstblock
' g2&=lengte een blok in bytes
' g3&=1 : gebruikte blokken in lijst hangen
IF g3& AND 1
ADD g2&,4           ! ruimte reserveren voor volgorde pointer
ENDIF
IF g2&<8
g2&=8
ENDIF
lstbase%=@allocblock(18,soort%)
g2&=(g2&+1) AND NOT (1)         ! omzetten naar words
IF lstbase%
{lstbase%}=0
{lstbase%+4}=soort%
{lstbase%+8}=0
CARD{lstbase%+12}=g1&
CARD{lstbase%+14}=g2&
CARD{lstbase%+16}=g3&
ENDIF
RETURN lstbase%
ENDFUNC
RBOX alloclist(g1%)
$F%
LOCAL g2%,g3%
' volgorde doet er niet toe
SWAP g1%,lstbase%
SWAP g2%,point%
SWAP g3%,point2%
'
IF lstbase%
point%={lstbase%}
WHILE point%            ! loop lijst af op zoek naar block met vrije sector
EXIT IF {point%+4}
point%={point%}
WEND
IF point%=0
point%=@addlist(lstbase%)
ENDIF
IF point%
point2%={point%+4}
IF {point2%+4}=CVL("FREE")
{point%+4}={point2%}           ! uit vrije lijst halen
'
CARD{point%+14}=CARD{point%+14}+1
point%=point2%
IF {lstbase%+4} AND &H10000
temp&=CARD{lstbase%+14}/2      ! block wissen
FOR b1&=temp&-1 DOWNTO 0
WORD{point2%}=0
ADD point2%,2
NEXT b1&
ELSE
{point%+4}=CVL("USED")
ENDIF
ELSE
okee("Node not free")
ENDIF
ENDIF
ENDIF
'
SWAP g3%,point2%
SWAP g2%,point%
SWAP g1%,lstbase%
RETURN g2%
ENDFUNC
RBOX addlist(g1%)
$F%
LOCAL g1&,g2&,g3&,g2%,g3%
SWAP g3&,b1&
SWAP g1%,lstbase%
SWAP g2%,point%
SWAP g3%,point2%
'
IF lstbase%
g1&=CARD{lstbase%+12}
g2&=CARD{lstbase%+14}
point%=@allocblock(16+g1&*g2&,{lstbase%+4})
IF point%           ! evetueel kleiner proberen
{point%+4}=point%+16
{point%+8}=point%+16+g1&*g2&
CARD{point%+12}=g1&
CARD{point%+14}=0
point2%=point%+16
FOR b1&=g1&-2 DOWNTO 0
{point2%}=point2%+g2&
{point2%+4}=CVL("FREE")
point2%={point2%}
NEXT b1&
{point2%}=0
{point2%+4}=CVL("FREE")
'
{point%}={lstbase%}               ! in lijst hangen
{lstbase%}=point%
ENDIF
ELSE
point%=0
ENDIF
'
SWAP g3%,point2%
SWAP g2%,point%
SWAP g1%,lstbase%
SWAP g3&,b1&
RETURN g2%
ENDFUNC
RBOX insertlist(g1%,g1&)
$F%
LOCAL g2%,g3%
' g1& geeft plaats aan waar adres moet komen
' en komt dan vóór oude waarde op die plek
SWAP g1%,lstbase%
SWAP g2%,point%
SWAP g3%,point2%
'
IF CARD{lstbase%+16} AND 1
point%=lstbase%+8
IF g1&>1
FOR b1&=2 TO g1&
point%={point%}
EXIT IF point%=0
NEXT b1&
ELSE IF g1&=-1
WHILE {point%}
point%={point%}
WEND
ENDIF
IF point%
point2%=@alloclist(lstbase%)
IF point2%
{point2%}={point%}
{point%}=point2%
ENDIF
point%=point2%
ELSE
okee("Node past end!")
ENDIF
ELSE
okee("No Linked list!")
point%=0
ENDIF
'
SWAP g3%,point2%
SWAP g2%,point%
SWAP g1%,lstbase%
RETURN g2%+4
ENDFUNC
RBOX findlist(g1%,g1&)
$F%
LOCAL g2%
SWAP g1%,lstbase%
SWAP g2%,point%
' 1=eerste
' 2=tweede etc
'
IF CARD{lstbase%+16} AND 1
point%={lstbase%+8}
IF g1&>1
FOR b1&=2 TO g1&
point%={point%}
EXIT IF point%=0
NEXT b1&
ELSE IF g1&=-1
WHILE {point%}
point%={point%}
WEND
ENDIF
ELSE
okee("No Linked list!")
point%=0
ENDIF
'
SWAP g2%,point%
SWAP g1%,lstbase%
IF g2%
RETURN g2%+4
ELSE
RETURN 0
ENDIF
ENDFUNC
RBOX findchunk(g1%,g2%,g3%)
$F%
IF g1%<g2%
WHILE {g1%}<>g3%
ADD g1%,{g1%+4}+8
EXIT IF g1%>=g2%
WEND
IF g1%<g2%
RETURN g1%
ENDIF
ENDIF
RETURN 0
ENDFUNC
'
RBOX addface(g1&)
LOCAL adr%
adr%=blovl%(SHR(g1&,8))
IF adr%=0
adr%=@allocblock(256*28,&H10001)
blovl%(SHR(g1&,8))=adr%
ENDIF
ADD adr%,m28&(g1& AND 255)
RETURN adr%
ENDFUNC
RBOX addvert(g1&)
LOCAL adr%
adr%=blove%(SHR(g1&,8))
IF adr%=0
adr%=@allocblock(256*34,&H10001)
blove%(SHR(g1&,8))=adr%
ENDIF
ADD adr%,m34&(g1& AND 255)
RETURN adr%
ENDFUNC
RBOX lay(g1%)
IF WORD{g1%}=32767
g1&=0
ELSE
FOR g1&=1 TO 15
EXIT IF BTST(WORD{g1%},g1&-1)
NEXT g1&
ENDIF
RETURN g1&
ENDFUNC
RBOX ease(g1&,g2&,g3&,g4&) !current,lengte,startease,eindease
$%0
IF g3& OR g4&
IF g1&<g3&
g1=g1&/g3&
qa=g1*g1
b1=g3&*(-g1*qa/3+qa)
ELSE IF g1&>g2&-g4&
g1=(g2&-g1&)/g4&
qa=g1*g1
b1=g2&-(g3&+g4&)/3-g4&*(-g1*qa/3+qa)
ELSE
b1=g1&-g3&/3
ENDIF
b1=b1/(g2&-(g3&+g4&)/3)
ELSE
b1=g1&/g2&
ENDIF
$%3
RETURN b1
ENDFUNC
RBOX build(g1%,g1&)  !vlak & bliks effect
$F%
IF b10& AND 2
g1&=INT((g1&+step&*(g1%-sf&+1))/l&)
ELSE
g1&=-INT((g1&-step&*(g1%-sf&+1))/l&)
ENDIF
IF b10& AND 1
g1&=g1& AND 1
ENDIF
RETURN (g1&=1)
ENDFUNC
RBOX eenh.mat(g1%)
$F%
a&=-1
FOR b1&=0 TO 2
FOR b2&=0 TO 2
IF b1&=b2&
IF {g1%}<>&H80000000
a&=0
ENDIF
IF {g1%+4}<>1023
a&=0
ENDIF
ELSE
IF {g1%}<>0 OR {g1%+4}<>0
a&=0
ENDIF
ENDIF
EXIT IF a&=0
ADD g1%,8
NEXT b2&
EXIT IF a&=0
NEXT b1&
RETURN a&
ENDFUNC
RBOX newadr(adr%)
$F%
IF adr%
t00%=ablock%
WHILE {t00%}
IF adr%={t00%}
adr%={t00%+4}
EXIT IF adr%
ENDIF
ADD t00%,8
WEND
IF {t00%}=0
adr%=0
ENDIF
ENDIF
RETURN adr%
ENDFUNC
RBOX calcpath(g1%,g2%,fr&)
$F%
LOCAL gt%,ga%
ga%=0
IF WORD{g1%+4}=-2 !pad
ob%={g1%+b.d&}
IF ob%
vv%={ob%}
IF vv%
c&=WORD{ob%+m.f&}
s&=WORD{g2%+b.sf&}
IF fr&<1
fr&=1
ENDIF
WHILE s&>fr&
IF BTST(BYTE{ob%+m.f&+2},0)=0
s&=fr&
ELSE
s&=-c&+s&
ENDIF
WEND
IF BTST(BYTE{ob%+m.f&+2},0)=0
IF fr&>=s&+c&
s&=fr&-c&+1
ENDIF
ENDIF
ga%={ob%+8}+12*((fr&-s&) MOD c&)
ENDIF
ENDIF
ENDIF
RETURN ga%
ENDFUNC
RBOX calcquat(q&,ob&,fr&)
$F%
adr%=0
IF WORD{ob%(q&)}=-2
c&=WORD{ob%(q&)+6}
s&=WORD{ob%(ob&)+98}
IF s&>fr&
IF BTST(BYTE{ob%(q&)+120},2)=0
s&=fr&
ELSE
s&=-c&+s&
ENDIF
ENDIF
IF BTST(BYTE{ob%(q&)+120},2)=0
IF fr&>=s&+c&
s&=fr&-c&+1
ENDIF
ENDIF
t%=18*((fr&-s&) MOD c&)
adr%=ob%(a1&)+124+t%+2
ENDIF
RETURN adr%
ENDFUNC
RBOX singtol(adr%)
$F%
WORD{V:temp%}=WORD{adr%}
WORD{V:temp%+2}=WORD{adr%+6}
RETURN temp%
ENDFUNC
RBOX ltosing(adr%)
WORD{V:temp}=WORD{adr%}
{V:temp+2}=0
WORD{V:temp+6}=WORD{adr%+2}
RETURN temp
ENDFUNC
RBOX ltosint(adr%)
$F%
WORD{V:temp}=WORD{adr%}
{V:temp+2}=0
WORD{V:temp+6}=WORD{adr%+2}
RETURN INT(temp)
ENDFUNC
RBOX zltosing(adr%)
temp=0.5
{V:temp}={adr%}
RETURN temp
ENDFUNC
RBOX allocblock(size%,soort%)
$F%
'
' +0 *nextblock
' +4 *prevblock
' +8 size
' +12 "BLCK"
'
IF firstblock%=0
newblock%=AllocMem(size%+16,soort%)
IF newblock%
{newblock%+0}=0
{newblock%+4}=0
{newblock%+8}=size%+16
{newblock%+12}=CVL("BLCK")
firstblock%=newblock%
lastblock%=newblock%
ADD newblock%,16
ENDIF
ELSE
newblock%=AllocMem(size%+16,soort%)
IF newblock%
{newblock%+0}=0
{newblock%+4}=lastblock%
{newblock%+8}=size%+16
{newblock%+12}=CVL("BLCK")
{lastblock%}=newblock%
lastblock%=newblock%
ADD newblock%,16
ENDIF
ENDIF
RETURN newblock%
ENDFUNC
RBOX testclip(g1%)
$F%
SWAP a%,g1%
c&=0
IF {a%+8}<d2%
ADD c&,16
ENDIF
ADD a%,8
IF {a%+10}>0
IF {a%+10}>{a%}
ADD c&,2
ENDIF
ELSE
IF {a%+10}<-{a%}
ADD c&,1
ENDIF
ENDIF
IF {a%+14}>0
IF {a%+14}>{a%}
ADD c&,4
ENDIF
ELSE
IF {a%+14}<-{a%}
ADD c&,8
ENDIF
ENDIF
SWAP a%,g1%
RETURN c&
ENDFUNC
RBOX testclip2(g1%)
$F%
SWAP a%,g1%
c3&=0
IF {a%+8}<d2%
ADD c3&,16
ENDIF
IF {a%}>0
IF {a%}>{a%+8}
ADD c3&,2
ENDIF
ELSE
IF {a%}<-{a%+8}
ADD c3&,1
ENDIF
ENDIF
IF {a%+4}>0
IF {a%+4}>{a%+8}
ADD c3&,4
ENDIF
ELSE
IF {a%+4}<-{a%+8}
ADD c3&,8
ENDIF
ENDIF
SWAP a%,g1%
RETURN c3&
ENDFUNC
RBOX acos(a)
RETURN (ASIN(-a)+0.5*PI)
ENDFUNC
RBOX atan2(g1,g2)
LOCAL g3
IF g2<>0
g3=ATN(g1/g2)
IF g2<0
IF g3>0
RETURN g3-PI
ELSE
RETURN g3+PI
ENDIF
ENDIF
RETURN g3
ELSE
RETURN 0
ENDIF
ENDFUNC
RBOX mpoint(x%,y%)
$F%
plotreg%(0)=x%
plotreg%(1)=y%
RCALL machpoint%+32,plotreg%()
RETURN plotreg%(7)
ENDFUNC
RBOX turbulence(gx&,gy&,z&)
$F%
'
SWAP gx&,x&
SWAP gy&,y&
'
s%=0
x=1
a&=0
WHILE a&<aantal&
ADD s%,x*C:nnoise%(deler&,x& AND x,y& AND x,z&/x,L:hash%)
x=x/2
ADD a&,1
WEND
'
SWAP gx&,x&
SWAP gy&,y&
'
RETURN s% AND d1&
ENDFUNC
RBOX turbulenceint(gx&,gy&,gz&)
$F%
LOCAL s&,t%
'
t%=0
FOR a&=0 TO aantal&-1
s&=C:nnoise%(deler&,gx&,gy&,gz&,L:hash%)
ADD t%,SHR(s&,a&)
deler&=SHR(deler&,1)+1
NEXT a&
'
RETURN t%/d1&
ENDFUNC
RBOX cliptest(p%,q%)
LOCAL p
$F%
i&=-1
IF p%<0
IF q%<p%
i&=0
ELSE
IF q%<0
p=p%
r=q%/p
IF r>u2
i&=0
ELSE IF r>u1
u1=r
ENDIF
ENDIF
ENDIF
ELSE
IF p%>0
IF q%<0
i&=0
ELSE
IF q%<p%
p=p%
r=q%/p
IF r<u1
i&=0
ELSE IF r<u2
u2=r
ENDIF
ENDIF
ENDIF
ELSE
IF q%<0
i&=0
ENDIF
ENDIF
ENDIF
RETURN i&
ENDFUNC
RBOX cliptestli(p%,q%)
$F%
i&=-1
IF p%<0
IF ABS(q%)>-p%
IF q%<0
i&=0
ENDIF
ELSE
~C:ltow%(L:V:p%,L:V:q%,L:V:q%)
p&=p%
q&=q%
r&=SHR(SWAP(q&)/p&,1)
IF r&>u2&
i&=0
ELSE IF r&>u1&
u1&=r&
ENDIF
ENDIF
ELSE
IF p%>0
IF ABS(q%)>p%
IF q%<0
i&=0
ENDIF
ELSE
~C:ltow%(L:V:p%,L:V:q%,L:V:q%)
p&=p%
q&=q%
r&=SHR(SWAP(q&)/p&,1)
IF r&<u1&
i&=0
ELSE IF r&<u2&
u2&=r&
ENDIF
ENDIF
ELSE
IF q%<0
i&=0
ENDIF
ENDIF
ENDIF
RETURN i&
ENDFUNC
RBOX val(file.in$)
LOCAL a&
vallen&=0
WHILE a&<=LEN(file.in$) AND vallen&=0
a&=a&+1
IF MID$(file.in$,a&,1)<>"."
vallen&=VAL?(MID$(file.in$,a&))
ENDIF
WEND
IF MID$(file.in$,a&+vallen&-1,1)="."
vallen&=vallen&-1
ENDIF
val=VAL(RIGHT$(file.in$,LEN(file.in$)-a&+1))
RETURN val
ENDFUNC
RBOX compstr(a$,b$)
FOR a&=0 TO LEN(a$)-1
IF BYTE{V:a$+a&}>96
IF BYTE{V:a$+a&}<123
BYTE{V:a$+a&}=BYTE{V:a$+a&}-32
ENDIF
ENDIF
NEXT a&
a&=0
IF LEN(a$)<LEN(b$)
a&=0
ELSE IF INSTR(a$,b$)
a&=-1
ENDIF
RETURN a&
ENDFUNC
RBOX comp(g1%,g2%)
$F%
'
SWAP g1%,a%
SWAP g2%,b%
'
LOCAL b1&
b1&=0
IF {a%}={b%}
IF {a%+4}={b%+4}
IF {a%+8}={b%+8}
IF WORD{a%+12}=WORD{b%+12}
b1&=-1
ENDIF
ENDIF
ENDIF
ENDIF
'
SWAP g1%,a%
SWAP g2%,b%
'
RETURN b1&
ENDFUNC
